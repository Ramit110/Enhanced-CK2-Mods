/*
 2008 PersonalGrid Corporation <http://personalgrid.com/>
 @package LivePipe UI
 @url http://livepipe.net/control/tabs
 @require prototype.js, livepipe.js
*/
(function(){var a;Kongregate.MessageConnection=function(a){this.initialize(a)};Kongregate.MessageConnection.MESSAGE_EVENT="kongregate:api:message";Kongregate.MessageConnection.prototype={initialize:function(b){a=b.channel_id;this._window=b.window||window;this._targetOrigin=b.target_origin;this._targetWindows=b.target_window?[b.target_window]:[];this._sendListener=b.send_listener;this._retryConnection=b.retry_connection||!1;this._messageListeners=[];this._supportsObjects=Kongregate.PostMessage.supportsObjects();
this._client="string"===typeof this._targetOrigin;this._connected=this._handleMessages=!1},addMessageListener:function(a){this._messageListeners.push(a)},isSupported:function(){return!this.supportsObjects()&&"undefined"===typeof this._window.JSON?!1:"undefined"!==typeof(this._targetWindows[0]||window).postMessage},connected:function(){return this._connected},isClient:function(){return this._client},supportsObjects:function(){return this._supportsObjects},logPrefix:function(){return this._client?"[Game:JS]":
"[Konduit]"},listen:function(){if(this.isSupported()&&!this._listening){this._listening=!0;var a=this;Kongregate.PostMessage.addMessageListener(this._window,function(c){a.onMessageReceived.call(a,c)})}},parseMessage:function(a){try{var c=Kongregate.PostMessage.parseMessage(a);if(c&&c.kongregate_type===Kongregate.MessageConnection.MESSAGE_EVENT)return{opcode:c.opcode,params:c.params}}catch(d){Kongregate.Log.warn(this.logPrefix(),"Error parsing message",a,d)}return null},onMessageReceived:function(a){var c=
a.origin||a.originalEvent.origin;this._targetOrigin&&c!==this._targetOrigin?Kongregate.Log.debug(this.logPrefix(),"Ignoring message from "+c):(c=this.parseMessage(a.data))&&this.processMessage(c,a)},processMessage:function(a,c){Kongregate.Log.debug(this.logPrefix(),"Message received:",a);switch(a.opcode){case KonduitEvent.CONNECT:this.onClientConnected(a.params,c.source);break;case KonduitEvent.CONNECTED:this.onConnectedToServer()}for(var d=0;d<this._messageListeners.length;d++)this._messageListeners[d](a.opcode,
a.params)},sendMessage:function(a,c){this.removeMissingWindows();if(!this.connected()&&a!==KonduitEvent.CONNECT&&a!==KonduitEvent.CONNECTED)Kongregate.Log.debug(this.logPrefix(),"Not sending "+a+", not connected");else{var d={kongregate_type:Kongregate.MessageConnection.MESSAGE_EVENT,opcode:a,params:"string"===typeof c?JSON.parse(c):c};this.supportsObjects()||(d=JSON.stringify(d));for(var e=this._targetOrigin||"*",f=0;f<this._targetWindows.length;f++)this._targetWindows[f].postMessage(d,e);this._sendListener&&
this._sendListener(a,c)}},connect:function(){this.connected()||(this.listen(),Kongregate.Log.debug("Attempting to connect to Kongregate API"),this.sendMessage(KonduitEvent.CONNECT,{chnl:a}),this._retryConnection&&this.retryConnection())},retryConnection:function(){var a=this;setTimeout(function(){a.connect()},5E3)},onClientConnected:function(b,c){b.chnl!==a?Kongregate.Log.warn(this.logPrefix(),"Channel ID mismatch, ignoring connect"):(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),
this.acceptClientConnection(c))},onConnectedToServer:function(){this.connected()||(Kongregate.Log.debug(this.logPrefix(),"API connection established!"),this._connected=!0)},acceptClientConnection:function(a){for(var c=!1,d=this._targetWindows,e=0;e<this._targetWindows.length;e++)if(this._targetWindows[e]===a){Kongregate.Log.warn("Re-initializing duplicate connection");c=!0;break}this._targetWindows=[a];this.sendMessage(KonduitEvent.CONNECTED,{});this._targetWindows=d;c||this._targetWindows.push(a);
this.removeMissingWindows()},removeMissingWindows:function(a){if(!this._client){for(i=this._targetWindows.length-1;0<=i;i--)this._targetWindows[i].top||this._targetWindows.splice(i,1);this._connected=0<this._targetWindows.length}}}})();
Kongregate.PostMessage={addMessageListener:function(a,b){if(a.document.addEventListener)try{a.document.addEventListener.call(a,"message",b,!1)}catch(c){Kongregate.Log.debug("addEventListener failed, using iframe addEventListener: "+c),Kongregate.PostMessage.createIframeEventListener(a,b)}else a.attachEvent?a.attachEvent("onmessage",b):Kongregate.Log.error("Could not add event listener, neither addEventListener or attachEvent found!");return b},removeMessageListener:function(a,b){a.removeEventListener?
a.removeEventListener("message",b):a.detachEvent&&a.detachEvent("onmessage",b)},supportsObjects:function(){var a=document.createElement("iframe"),b=!0;a.src="about:blank";document.body.appendChild(a);try{a.contentWindow.postMessage({toString:function(){b=!1;return""}},"*")}catch(c){}document.body.removeChild(a);return b},parseMessage:function(a){return"string"===typeof a&&"{"===a.charAt(0)?JSON.parse(a):"object"===typeof a?a:null},createIframeEventListener:function(a,b){var c=document.createElement("iframe");
c.src="about:blank";document.head.appendChild(c);c.contentWindow.addEventListener.call(a,"message",b,!1);document.head.removeChild(c)}};if("undefined"==typeof Prototype)throw"Control.Tabs requires Prototype to be loaded.";if("undefined"==typeof Object.Event)throw"Control.Tabs requires Object.Event to be loaded.";
Control.Tabs=Class.create({initialize:function(a,b){if(!$(a))throw"Control.Tabs could not find the element: "+a;this.activeLink=this.activeContainer=!1;this.containers=$H({});this.links=[];Control.Tabs.instances.push(this);this.options={beforeChange:Prototype.emptyFunction,afterChange:Prototype.emptyFunction,hover:!1,linkSelector:"li a",setClassOnContainer:!1,activeClassName:"active",defaultTab:"first",autoLinkExternal:!0,targetRegExp:/#(.+)$/,showFunction:Element.show,hideFunction:Element.hide};
Object.extend(this.options,b||{});(typeof("string"==this.options.linkSelector)?$(a).select(this.options.linkSelector):this.options.linkSelector($(a))).findAll(function(a){return/^#/.exec((Prototype.Browser.WebKit?decodeURIComponent(a.href):a.href).replace((Prototype.Browser.WebKit?decodeURIComponent(window.location.href):window.location.href).split("#")[0],""))}).each(function(a){this.addTab(a)}.bind(this));this.containers.values().each(Element.hide);"first"==this.options.defaultTab?this.setActiveTab(this.links.first()):
"last"==this.options.defaultTab?this.setActiveTab(this.links.last()):this.setActiveTab(this.options.defaultTab);var c=this.options.targetRegExp.exec(window.location);c&&c[1]&&c[1].split(",").each(function(a){this.setActiveTab(this.links.find(function(b){return b.key==a}))}.bind(this));this.options.autoLinkExternal&&$A(document.getElementsByTagName("a")).each(function(a){if(!this.links.include(a)){var b=a.href.replace(window.location.href.split("#")[0],"");"#"==b.substring(0,1)&&this.containers.keys().include(b.substring(1))&&
$(a).observe("click",function(a,b){this.setActiveTab(b.substring(1))}.bindAsEventListener(this,b))}}.bind(this))},addTab:function(a){this.links.push(a);a.key=a.getAttribute("href").replace(window.location.href.split("#")[0],"").split("/").last().replace(/#/,"");var b=$(a.key);if(!b)throw"Control.Tabs: #"+a.key+" was not found on the page.";this.containers.set(a.key,b);Event.observe(a,this.options.hover?"mouseover":"click",function(b){Event.stop(b);this.setActiveTab(a);return!1}.bind(this))},setActiveTab:function(a){if(a||
"undefined"!=typeof a)"string"==typeof a?this.setActiveTab(this.links.find(function(b){return b.key==a})):"number"==typeof a?this.setActiveTab(this.links[a]):!1!==this.notify("beforeChange",this.activeContainer,this.containers.get(a.key))&&(this.activeContainer&&this.options.hideFunction(this.activeContainer),this.links.each(function(a){(this.options.setClassOnContainer?$(a.parentNode):a).removeClassName(this.options.activeClassName)}.bind(this)),(this.options.setClassOnContainer?$(a.parentNode):
a).addClassName(this.options.activeClassName),this.activeContainer=this.containers.get(a.key),this.activeLink=a,this.options.showFunction(this.containers.get(a.key)),this.notify("afterChange",this.containers.get(a.key)))},next:function(){this.links.each(function(a,b){if(this.activeLink==a&&this.links[b+1])throw this.setActiveTab(this.links[b+1]),$break;}.bind(this))},previous:function(){this.links.each(function(a,b){if(this.activeLink==a&&this.links[b-1])throw this.setActiveTab(this.links[b-1]),$break;
}.bind(this))},first:function(){this.setActiveTab(this.links.first())},last:function(){this.setActiveTab(this.links.last())}});Object.extend(Control.Tabs,{instances:[],findByTabId:function(a){return Control.Tabs.instances.find(function(b){return b.links.find(function(b){return b.key==a})})}});Object.Event.extend(Control.Tabs);
(function(a){(function(a,c){"function"===typeof define&&define.amd?define("strophe-base64",function(){return c()}):a.Base64=c()})(this,function(){return{encode:function(a){var c="",d,e,f,h,l,g,q,u=0;do d=a.charCodeAt(u++),e=a.charCodeAt(u++),f=a.charCodeAt(u++),h=d>>2,l=(d&3)<<4|e>>4,g=(e&15)<<2|f>>6,q=f&63,isNaN(e)?(l=(d&3)<<4,g=q=64):isNaN(f)&&(q=64),c=c+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(q);while(u<a.length);return c},decode:function(a){var c="",d,e,f,h,l,g=0;a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(g++)),e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(g++)),h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(g++)),
l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(a.charAt(g++)),d=d<<2|e>>4,e=(e&15)<<4|h>>2,f=(h&3)<<6|l,c+=String.fromCharCode(d),64!=h&&(c+=String.fromCharCode(e)),64!=l&&(c+=String.fromCharCode(f));while(g<a.length);return c}}});(function(a,c){"function"===typeof define&&define.amd?define("strophe-sha1",function(){return c()}):a.SHA1=c()})(this,function(){function a(b,c){b[c>>5]|=128<<24-c%32;b[(c+64>>9<<4)+15]=c;var e=Array(80),f=1732584193,h=-271733879,x=-1732584194,
m=271733878,n=-1009589776,A,v,z,y,p,E,J,O;for(A=0;A<b.length;A+=16){y=f;p=h;E=x;J=m;O=n;for(v=0;80>v;v++){e[v]=16>v?b[A+v]:(e[v-3]^e[v-8]^e[v-14]^e[v-16])<<1|(e[v-3]^e[v-8]^e[v-14]^e[v-16])>>>31;z=f<<5|f>>>27;var r;r=20>v?h&x|~h&m:40>v?h^x^m:60>v?h&x|h&m|x&m:h^x^m;z=d(d(z,r),d(d(n,e[v]),20>v?1518500249:40>v?1859775393:60>v?-1894007588:-899497514));n=m;m=x;x=h<<30|h>>>2;h=f;f=z}f=d(f,y);h=d(h,p);x=d(x,E);m=d(m,J);n=d(n,O)}return[f,h,x,m,n]}function c(c,d){var q=e(c);16<q.length&&(q=a(q,8*c.length));
for(var f=Array(16),h=Array(16),x=0;16>x;x++)f[x]=q[x]^909522486,h[x]=q[x]^1549556828;q=a(f.concat(e(d)),512+8*d.length);return a(h.concat(q),672)}function d(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function e(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;return b}function f(a){for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}function h(a){for(var b="",c,d,e=0;e<4*a.length;e+=3){c=(a[e>>2]>>
8*(3-e%4)&255)<<16|(a[e+1>>2]>>8*(3-(e+1)%4)&255)<<8|a[e+2>>2]>>8*(3-(e+2)%4)&255;for(d=0;4>d;d++)b=8*e+6*d>32*a.length?b+"=":b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c>>6*(3-d)&63)}return b}return{b64_hmac_sha1:function(a,b){return h(c(a,b))},b64_sha1:function(c){return h(a(e(c),8*c.length))},binb2str:f,core_hmac_sha1:c,str_hmac_sha1:function(a,b){return f(c(a,b))},str_sha1:function(c){return f(a(e(c),8*c.length))}}});(function(a,c){"function"===typeof define&&
define.amd?define("strophe-md5",function(){return c()}):a.MD5=c()})(this,function(a){var c=function(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535},d=function(a){for(var b=[],c=0;c<8*a.length;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<c%32;return b},e=function(a,b,d,e,f,g){a=c(c(b,a),c(e,g));return c(a<<f|a>>>32-f,d)},f=function(a,b,c,d,f,g,h){return e(b&c|~b&d,a,b,f,g,h)},h=function(a,b,c,d,f,g,h){return e(b&d|c&~d,a,b,f,g,h)},l=function(a,b,c,d,f,g,h){return e(c^(b|~d),a,b,
f,g,h)},g=function(a,b){a[b>>5]|=128<<b%32;a[(b+64>>>9<<4)+14]=b;for(var d=1732584193,g=-271733879,m=-1732584194,n=271733878,A,v,z,y,p=0;p<a.length;p+=16)A=d,v=g,z=m,y=n,d=f(d,g,m,n,a[p+0],7,-680876936),n=f(n,d,g,m,a[p+1],12,-389564586),m=f(m,n,d,g,a[p+2],17,606105819),g=f(g,m,n,d,a[p+3],22,-1044525330),d=f(d,g,m,n,a[p+4],7,-176418897),n=f(n,d,g,m,a[p+5],12,1200080426),m=f(m,n,d,g,a[p+6],17,-1473231341),g=f(g,m,n,d,a[p+7],22,-45705983),d=f(d,g,m,n,a[p+8],7,1770035416),n=f(n,d,g,m,a[p+9],12,-1958414417),
m=f(m,n,d,g,a[p+10],17,-42063),g=f(g,m,n,d,a[p+11],22,-1990404162),d=f(d,g,m,n,a[p+12],7,1804603682),n=f(n,d,g,m,a[p+13],12,-40341101),m=f(m,n,d,g,a[p+14],17,-1502002290),g=f(g,m,n,d,a[p+15],22,1236535329),d=h(d,g,m,n,a[p+1],5,-165796510),n=h(n,d,g,m,a[p+6],9,-1069501632),m=h(m,n,d,g,a[p+11],14,643717713),g=h(g,m,n,d,a[p+0],20,-373897302),d=h(d,g,m,n,a[p+5],5,-701558691),n=h(n,d,g,m,a[p+10],9,38016083),m=h(m,n,d,g,a[p+15],14,-660478335),g=h(g,m,n,d,a[p+4],20,-405537848),d=h(d,g,m,n,a[p+9],5,568446438),
n=h(n,d,g,m,a[p+14],9,-1019803690),m=h(m,n,d,g,a[p+3],14,-187363961),g=h(g,m,n,d,a[p+8],20,1163531501),d=h(d,g,m,n,a[p+13],5,-1444681467),n=h(n,d,g,m,a[p+2],9,-51403784),m=h(m,n,d,g,a[p+7],14,1735328473),g=h(g,m,n,d,a[p+12],20,-1926607734),d=e(g^m^n,d,g,a[p+5],4,-378558),n=e(d^g^m,n,d,a[p+8],11,-2022574463),m=e(n^d^g,m,n,a[p+11],16,1839030562),g=e(m^n^d,g,m,a[p+14],23,-35309556),d=e(g^m^n,d,g,a[p+1],4,-1530992060),n=e(d^g^m,n,d,a[p+4],11,1272893353),m=e(n^d^g,m,n,a[p+7],16,-155497632),g=e(m^n^d,g,
m,a[p+10],23,-1094730640),d=e(g^m^n,d,g,a[p+13],4,681279174),n=e(d^g^m,n,d,a[p+0],11,-358537222),m=e(n^d^g,m,n,a[p+3],16,-722521979),g=e(m^n^d,g,m,a[p+6],23,76029189),d=e(g^m^n,d,g,a[p+9],4,-640364487),n=e(d^g^m,n,d,a[p+12],11,-421815835),m=e(n^d^g,m,n,a[p+15],16,530742520),g=e(m^n^d,g,m,a[p+2],23,-995338651),d=l(d,g,m,n,a[p+0],6,-198630844),n=l(n,d,g,m,a[p+7],10,1126891415),m=l(m,n,d,g,a[p+14],15,-1416354905),g=l(g,m,n,d,a[p+5],21,-57434055),d=l(d,g,m,n,a[p+12],6,1700485571),n=l(n,d,g,m,a[p+3],10,
-1894986606),m=l(m,n,d,g,a[p+10],15,-1051523),g=l(g,m,n,d,a[p+1],21,-2054922799),d=l(d,g,m,n,a[p+8],6,1873313359),n=l(n,d,g,m,a[p+15],10,-30611744),m=l(m,n,d,g,a[p+6],15,-1560198380),g=l(g,m,n,d,a[p+13],21,1309151649),d=l(d,g,m,n,a[p+4],6,-145523070),n=l(n,d,g,m,a[p+11],10,-1120210379),m=l(m,n,d,g,a[p+2],15,718787259),g=l(g,m,n,d,a[p+9],21,-343485551),d=c(d,A),g=c(g,v),m=c(m,z),n=c(n,y);return[d,g,m,n]};return{hexdigest:function(a){a=g(d(a),8*a.length);for(var b="",c=0;c<4*a.length;c++)b+="0123456789abcdef".charAt(a[c>>
2]>>8*(c%4)+4&15)+"0123456789abcdef".charAt(a[c>>2]>>8*(c%4)&15);return b},hash:function(a){a=g(d(a),8*a.length);for(var b="",c=0;c<32*a.length;c+=8)b+=String.fromCharCode(a[c>>5]>>>c%32&255);return b}}});(function(a,c){"function"===typeof define&&define.amd?define("strophe-utils",function(){return c()}):a.stropheUtils=c()})(this,function(){return{utf16to8:function(a){var c,d,e="",f=a.length;for(c=0;c<f;c++)d=a.charCodeAt(c),0<=d&&127>=d?e+=a.charAt(c):(2047<d?(e+=String.fromCharCode(224|d>>12&15),
e+=String.fromCharCode(128|d>>6&63)):e+=String.fromCharCode(192|d>>6&31),e+=String.fromCharCode(128|d>>0&63));return e},addCookies:function(a){var c,d,e,f,h,l,g;for(c in a||{})g=l=h="",d=a[c],e="object"==typeof d,f=escape(unescape(e?d.value:d)),e&&(h=d.expires?";expires="+d.expires:"",l=d.domain?";domain="+d.domain:"",g=d.path?";path="+d.path:""),document.cookie=c+"="+f+h+l+g}}});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-polyfill",[],function(){return c()});else return c()})(this,
function(){Function.prototype.bind||(Function.prototype.bind=function(a){var c=this,d=Array.prototype.slice,e=Array.prototype.concat,f=d.call(arguments,1);return function(){return c.apply(a?a:this,e.call(f,d.call(arguments,0)))}});Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var d=this.length,e=Number(c)||0,e=0>e?Math.ceil(e):Math.floor(e);for(0>e&&(e+=d);e<d;e++)if(e in this&&
this[e]===a)return e;return-1})});Array.prototype.forEach||(Array.prototype.forEach=function(a,c){var d,e;if(null===this)throw new TypeError(" this is null or not defined");var f=Object(this),h=f.length>>>0;if("function"!==typeof a)throw new TypeError(a+" is not a function");1<arguments.length&&(d=c);for(e=0;e<h;){var l;e in f&&(l=f[e],a.call(d,l,e,f));e++}});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5","strophe-utils",
"strophe-polyfill"],function(){return c.apply(this,arguments)});else{var d=c(a.SHA1,a.Base64,a.MD5,a.stropheUtils);window.Strophe=d.Strophe;window.$build=d.$build;window.$iq=d.$iq;window.$msg=d.$msg;window.$pres=d.$pres;window.SHA1=d.SHA1;window.Base64=d.Base64;window.MD5=d.MD5;window.b64_hmac_sha1=d.SHA1.b64_hmac_sha1;window.b64_sha1=d.SHA1.b64_sha1;window.str_hmac_sha1=d.SHA1.str_hmac_sha1;window.str_sha1=d.SHA1.str_sha1}})(this,function(a,c,d,e){function f(a,b){return new g.Builder(a,b)}function h(a){return new g.Builder("iq",
a)}function l(a){return new g.Builder("presence",a)}var g;g={VERSION:"1.2.12",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",
BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],
ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag:function(a){for(var b=0;b<g.XHTML.tags.length;b++)if(a==g.XHTML.tags[b])return!0;return!1},validAttribute:function(a,b){if("undefined"!==typeof g.XHTML.attributes[a]&&0<g.XHTML.attributes[a].length)for(var c=0;c<g.XHTML.attributes[a].length;c++)if(b==g.XHTML.attributes[a][c])return!0;return!1},validCSS:function(a){for(var b=0;b<g.XHTML.css.length;b++)if(a==
g.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(a,b){g.NS[a]=b},forEachChild:function(a,b,c){var d,e;for(d=0;d<a.childNodes.length;d++)e=a.childNodes[d],e.nodeType==g.ElementType.NORMAL&&(!b||this.isTagEqual(e,
b))&&c(e)},isTagEqual:function(a,b){return a.tagName==b},_xmlGenerator:null,_makeGenerator:function(){var a;void 0===document.implementation.createDocument||document.implementation.createDocument&&document.documentMode&&10>document.documentMode?(a=this._getIEXmlDom(),a.appendChild(a.createElement("strophe"))):a=document.implementation.createDocument("jabber:client","strophe",null);return a},xmlGenerator:function(){g._xmlGenerator||(g._xmlGenerator=g._makeGenerator());return g._xmlGenerator},_getIEXmlDom:function(){for(var a=
null,b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),c=0;c<b.length;c++)if(null===a)try{a=new ActiveXObject(b[c])}catch(d){a=null}else break;return a},xmlElement:function(a){if(!a)return null;var b=g.xmlGenerator().createElement(a),c,d,e;for(c=1;c<arguments.length;c++){var f=arguments[c];if(f)if("string"==typeof f||"number"==typeof f)b.appendChild(g.xmlTextNode(f));else if("object"==typeof f&&
"function"==typeof f.sort)for(d=0;d<f.length;d++){var h=f[d];"object"==typeof h&&("function"==typeof h.sort&&void 0!==h[1]&&null!==h[1])&&b.setAttribute(h[0],h[1])}else if("object"==typeof f)for(e in f)f.hasOwnProperty(e)&&void 0!==f[e]&&null!==f[e]&&b.setAttribute(e,f[e])}return b},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlunescape:function(a){a=a.replace(/\&amp;/g,"&");a=a.replace(/&lt;/g,
"<");a=a.replace(/&gt;/g,">");a=a.replace(/&apos;/g,"'");return a=a.replace(/&quot;/g,'"')},xmlTextNode:function(a){return g.xmlGenerator().createTextNode(a)},xmlHtmlNode:function(a){var b;window.DOMParser?b=(new DOMParser).parseFromString(a,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));return b},getText:function(a){if(!a)return null;var b="";0===a.childNodes.length&&a.nodeType==g.ElementType.TEXT&&(b+=a.nodeValue);for(var c=0;c<a.childNodes.length;c++)a.childNodes[c].nodeType==
g.ElementType.TEXT&&(b+=a.childNodes[c].nodeValue);return g.xmlescape(b)},copyElement:function(a){var b,c;if(a.nodeType==g.ElementType.NORMAL){c=g.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)c.setAttribute(a.attributes[b].nodeName,a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)c.appendChild(g.copyElement(a.childNodes[b]))}else a.nodeType==g.ElementType.TEXT&&(c=g.xmlGenerator().createTextNode(a.nodeValue));return c},createHtml:function(a){var b,c,d,e,f,h,l,z,y,p,E;if(a.nodeType==
g.ElementType.NORMAL)if(e=a.nodeName.toLowerCase(),g.XHTML.validTag(e))try{c=g.xmlElement(e);for(b=0;b<g.XHTML.attributes[e].length;b++)if(f=g.XHTML.attributes[e][b],h=a.getAttribute(f),!("undefined"==typeof h||null===h||""===h||!1===h||0===h))if("style"==f&&"object"==typeof h&&"undefined"!=typeof h.cssText&&(h=h.cssText),"style"==f){l=[];z=h.split(";");for(d=0;d<z.length;d++)y=z[d].split(":"),p=y[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),g.XHTML.validCSS(p)&&(E=y[1].replace(/^\s*/,"").replace(/\s*$/,
""),l.push(p+": "+E));0<l.length&&(h=l.join("; "),c.setAttribute(f,h))}else c.setAttribute(f,h);for(b=0;b<a.childNodes.length;b++)c.appendChild(g.createHtml(a.childNodes[b]))}catch(J){c=g.xmlTextNode("")}else{c=g.xmlGenerator().createDocumentFragment();for(b=0;b<a.childNodes.length;b++)c.appendChild(g.createHtml(a.childNodes[b]))}else if(a.nodeType==g.ElementType.FRAGMENT){c=g.xmlGenerator().createDocumentFragment();for(b=0;b<a.childNodes.length;b++)c.appendChild(g.createHtml(a.childNodes[b]))}else a.nodeType==
g.ElementType.TEXT&&(c=g.xmlTextNode(a.nodeValue));return c},escapeNode:function(a){return"string"!==typeof a?a:a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return"string"!==typeof a?a:a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,
"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=g.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},_handleError:function(a){"undefined"!==
typeof a.stack&&g.fatal(a.stack);a.sourceURL?g.fatal("error: "+this.handler+" "+a.sourceURL+":"+a.line+" - "+a.name+": "+a.message):a.fileName?g.fatal("error: "+this.handler+" "+a.fileName+":"+a.lineNumber+" - "+a.name+": "+a.message):g.fatal("error: "+a.message)},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,
a)},serialize:function(a){var b;if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var c=a.nodeName,d,e;a.getAttribute("_realname")&&(c=a.getAttribute("_realname"));b="<"+c;for(d=0;d<a.attributes.length;d++)"_realname"!=a.attributes[d].nodeName&&(b+=" "+a.attributes[d].nodeName+"='"+g.xmlescape(a.attributes[d].value)+"'");if(0<a.childNodes.length){b+=">";for(d=0;d<a.childNodes.length;d++)switch(e=a.childNodes[d],e.nodeType){case g.ElementType.NORMAL:b+=g.serialize(e);break;case g.ElementType.TEXT:b+=
g.xmlescape(e.nodeValue);break;case g.ElementType.CDATA:b+="<![CDATA["+e.nodeValue+"]]\x3e"}b+="</"+c+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){g._connectionPlugins[a]=b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=g.NS.CLIENT:b||(b={xmlns:g.NS.CLIENT});this.node=this.nodeTree=g.xmlElement(a,b)}};g.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return g.serialize(this.nodeTree)},
up:function(){this.node=this.node.parentNode;return this},root:function(){this.node=this.nodeTree;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&(void 0===a[b]?this.node.removeAttribute(b):this.node.setAttribute(b,a[b]));return this},c:function(a,b,c){a=g.xmlElement(a,b,c);this.node.appendChild(a);"string"!==typeof c&&"number"!==typeof c&&(this.node=a);return this},cnode:function(a){var b,c=g.xmlGenerator();try{b=void 0!==c.importNode}catch(d){b=!1}a=b?c.importNode(a,!0):g.copyElement(a);
this.node.appendChild(a);this.node=a;return this},t:function(a){a=g.xmlTextNode(a);this.node.appendChild(a);return this},h:function(a){var b=document.createElement("body");b.innerHTML=a;for(a=g.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}};g.Handler=function(a,b,c,d,e,f,h){this.handler=a;this.ns=b;this.name=c;this.type=d;this.id=e;this.options=h||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(g.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),
this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.from=this.options.matchBareFromJid?f?g.getBareJidFromJid(f):null:f;this.user=!0};g.Handler.prototype={getNamespace:function(a){(a=a.getAttribute("xmlns"))&&this.options.ignoreNamespaceFragment&&(a=a.split("#")[0]);return a},namespaceMatch:function(a){var b=!1;if(this.ns){var c=this;g.forEachChild(a,null,function(a){c.getNamespace(a)===c.ns&&(b=!0)});b=b||this.getNamespace(a)===this.ns}else return!0;return b},
isMatch:function(a){var b=a.getAttribute("from");this.options.matchBareFromJid&&(b=g.getBareJidFromJid(b));var c=a.getAttribute("type");return this.namespaceMatch(a)&&(!this.name||g.isTagEqual(a,this.name))&&(!this.type||(Array.isArray(this.type)?-1!=this.type.indexOf(c):c==this.type))&&(!this.id||a.getAttribute("id")==this.id)&&(!this.from||b==this.from)?!0:!1},run:function(a){var b=null;try{b=this.handler(a)}catch(c){throw g._handleError(c),c;}return b},toString:function(){return"{Handler: "+this.handler+
"("+this.name+","+this.id+","+this.ns+")}"}};g.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0};g.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};g.Connection=function(a,b){this.service=a;this.options=b||{};var c=this.options.protocol||"";0===a.indexOf("ws:")||
0===a.indexOf("wss:")||0===c.indexOf("ws")?this._proto=new g.Websocket(this):this._proto=new g.Bosh(this);this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._disconnectTimeout=this._idleTimeout=null;this.disconnecting=this.connected=this.authenticated=!1;this.do_authentication=!0;this.restored=
this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100);e.addCookies(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);for(var d in g._connectionPlugins)g._connectionPlugins.hasOwnProperty(d)&&(c=function(){},c.prototype=g._connectionPlugins[d],this[d]=new c,this[d].init(this))};g.Connection.prototype={reset:function(){this._proto._reset();
this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.restored=this.disconnecting=this.connected=this.authenticated=!1;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)});return"string"==
typeof a||"number"==typeof a?b+":"+a:b+""},addProtocolErrorHandler:function(a,b,c){this.protocolErrorHandlers[a][b]=c},connect:function(a,b,c,d,e,f,h){this.jid=a;this.authzid=g.getBareJidFromJid(this.jid);this.authcid=h||g.getNodeFromJid(this.jid);this.pass=b;this.servtype="xmpp";this.connect_callback=c;this.restored=this.authenticated=this.connected=this.disconnecting=!1;this.domain=g.getDomainFromJid(this.jid);this._changeConnectStatus(g.Status.CONNECTING,null);this._proto._connect(d,e,f)},attach:function(a,
b,c,d,e,f,h){if(this._proto instanceof g.Bosh)this._proto._attach(a,b,c,d,e,f,h);else throw{name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'};},restore:function(a,b,c,d,e){if(this._sessionCachingSupported())this._proto._restore(a,b,c,d,e);else throw{name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'};},_sessionCachingSupported:function(){if(this._proto instanceof g.Bosh){if(!JSON)return!1;try{window.sessionStorage.setItem("_strophe_",
"_strophe_"),window.sessionStorage.removeItem("_strophe_")}catch(a){return!1}return!0}return!1},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},nextValidRid:function(a){},send:function(a){if(null!==a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendPresence:function(a,
b,c,d){var e=null,f=this;"function"===typeof a.tree&&(a=a.tree());var g=a.getAttribute("id");g||(g=this.getUniqueId("sendPresence"),a.setAttribute("id",g));if("function"===typeof b||"function"===typeof c){var h=this.addHandler(function(a){e&&f.deleteTimedHandler(e);"error"==a.getAttribute("type")?c&&c(a):b&&b(a)},null,"presence",null,g);d&&(e=this.addTimedHandler(d,function(){f.deleteHandler(h);c&&c(null);return!1}))}this.send(a);return g},sendIQ:function(a,b,c,d){var e=null,f=this;"function"===typeof a.tree&&
(a=a.tree());var g=a.getAttribute("id");g||(g=this.getUniqueId("sendIQ"),a.setAttribute("id",g));if("function"===typeof b||"function"===typeof c){var h=this.addHandler(function(a){e&&f.deleteTimedHandler(e);var d=a.getAttribute("type");if("result"==d)b&&b(a);else if("error"==d)c&&c(a);else throw{name:"StropheError",message:"Got bad IQ type of "+d};},null,"iq",["error","result"],g);d&&(e=this.addTimedHandler(d,function(){f.deleteHandler(h);c&&c(null);return!1}))}this.send(a);return g},_queueData:function(a){if(null===
a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),100)},addTimedHandler:function(a,b){var c=new g.TimedHandler(a,b);this.addTimeds.push(c);return c},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,b,c,d,e,f,h){a=new g.Handler(a,b,c,d,e,f,h);this.addHandlers.push(a);
return a},deleteHandler:function(a){this.removeHandlers.push(a);a=this.addHandlers.indexOf(a);0<=a&&this.addHandlers.splice(a,1)},registerSASLMechanisms:function(a){this.mechanisms={};a=a||[g.SASLAnonymous,g.SASLExternal,g.SASLMD5,g.SASLOAuthBearer,g.SASLPlain,g.SASLSHA1];a.forEach(this.registerSASLMechanism.bind(this))},registerSASLMechanism:function(a){this.mechanisms[a.prototype.name]=a},disconnect:function(a){this._changeConnectStatus(g.Status.DISCONNECTING,a);g.info("Disconnect was called because: "+
a);this.connected?(a=!1,this.disconnecting=!0,this.authenticated&&(a=l({xmlns:g.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a)):(g.info("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect())},_changeConnectStatus:function(a,b){for(var c in g._connectionPlugins)if(g._connectionPlugins.hasOwnProperty(c)){var d=this[c];if(d.statusChanged)try{d.statusChanged(a,
b)}catch(e){g.error(""+c+" plugin caused an exception changing status: "+e)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(f){g._handleError(f),g.error("User connection callback caused an exception: "+f)}},_doDisconnect:function(a){"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout);null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);g.info("_doDisconnect was called");this._proto._doDisconnect();this.restored=
this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(g.Status.DISCONNECTED,a);this.connected=!1},_dataRecv:function(a,b){g.info("_dataRecv called");var c=this._proto._reqToData(a);if(null!==c){this.xmlInput!==g.Connection.prototype.xmlInput&&(c.nodeName===this._proto.strip&&c.childNodes.length?this.xmlInput(c.childNodes[0]):this.xmlInput(c));this.rawInput!==g.Connection.prototype.rawInput&&
(b?this.rawInput(b):this.rawInput(g.serialize(c)));for(var d;0<this.removeHandlers.length;)d=this.removeHandlers.pop(),d=this.handlers.indexOf(d),0<=d&&this.handlers.splice(d,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&this._proto._emptyQueue())this._doDisconnect();else if(d=c.getAttribute("type"),null!==d&&"terminate"==d)this.disconnecting||(d=c.getAttribute("condition"),c=c.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==
d&&0<c.length&&(d="conflict"),this._changeConnectStatus(g.Status.CONNFAIL,d)):this._changeConnectStatus(g.Status.CONNFAIL,"unknown"),this._doDisconnect(d));else{var e=this;g.forEachChild(c,null,function(a){var b,c;c=e.handlers;e.handlers=[];for(b=0;b<c.length;b++){var d=c[b];try{d.isMatch(a)&&(e.authenticated||!d.user)?d.run(a)&&e.handlers.push(d):e.handlers.push(d)}catch(f){g.warn("Removing Strophe handlers due to uncaught exception: "+f.message)}}})}}},mechanisms:{},_connect_cb:function(a,b,c){g.info("_connect_cb was called");
this.connected=!0;var d;try{d=this._proto._reqToData(a)}catch(e){if("badformat"!=e)throw e;this._changeConnectStatus(g.Status.CONNFAIL,"bad-format");this._doDisconnect("bad-format")}if(d&&(this.xmlInput!==g.Connection.prototype.xmlInput&&(d.nodeName===this._proto.strip&&d.childNodes.length?this.xmlInput(d.childNodes[0]):this.xmlInput(d)),this.rawInput!==g.Connection.prototype.rawInput&&(c?this.rawInput(c):this.rawInput(g.serialize(d))),this._proto._connect_cb(d)!==g.Status.CONNFAIL))if(d.getElementsByTagNameNS?
0<d.getElementsByTagNameNS(g.NS.STREAM,"features").length:0<d.getElementsByTagName("stream:features").length||0<d.getElementsByTagName("features").length){a=[];var f,h=d.getElementsByTagName("mechanism");if(0<h.length)for(c=0;c<h.length;c++)f=g.getText(h[c]),this.mechanisms[f]&&a.push(this.mechanisms[f]);0===a.length&&0===d.getElementsByTagName("auth").length?this._proto._no_auth_received(b):!1!==this.do_authentication&&this.authenticate(a)}else this._proto._no_auth_received(b)},sortMechanismsByPriority:function(a){var b,
c,d;for(b=0;b<a.length-1;++b){d=b;for(c=b+1;c<a.length;++c)a[c].prototype.priority>a[d].prototype.priority&&(d=c);d!=b&&(c=a[b],a[b]=a[d],a[d]=c)}return a},_attemptSASLAuth:function(a){a=this.sortMechanismsByPriority(a||[]);for(var b=0,d=!1,b=0;b<a.length;++b)if(a[b].prototype.test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);
this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new a[b];this._sasl_mechanism.onStart(this);a=f("auth",{xmlns:g.NS.SASL,mechanism:this._sasl_mechanism.name});this._sasl_mechanism.isClientFirst&&(b=this._sasl_mechanism.onChallenge(this,null),a.t(c.encode(b)));this.send(a.tree());d=!0;break}return d},_attemptLegacyAuth:function(){null===g.getNodeFromJid(this.jid)?(this._changeConnectStatus(g.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),
this.disconnect("x-strophe-bad-non-anon-jid")):(this._changeConnectStatus(g.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(h({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).tree()))},authenticate:function(a){this._attemptSASLAuth(a)||this._attemptLegacyAuth()},_sasl_challenge_cb:function(a){a=c.decode(g.getText(a));a=this._sasl_mechanism.onChallenge(this,a);var b=f("response",
{xmlns:g.NS.SASL});""!==a&&b.t(c.encode(a));this.send(b.tree());return!0},_auth1_cb:function(a){a=h({type:"set",id:"_auth_2"}).c("query",{xmlns:g.NS.AUTH}).c("username",{}).t(g.getNodeFromJid(this.jid)).up().c("password").t(this.pass);g.getResourceFromJid(this.jid)||(this.jid=g.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(g.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){if(this._sasl_data["server-signature"]){var b;
a=c.decode(g.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"==a[1]&&(b=a[2]);if(b!=this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}g.info("SASL authentication succeeded.");if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);
this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);var d=[],e=function(a,b){for(;a.length;)this.deleteHandler(a.pop());this._sasl_auth1_cb.bind(this)(b);return!1};d.push(this._addSysHandler(function(a){e.bind(this)(d,a)}.bind(this),null,"stream:features",null,null));d.push(this._addSysHandler(function(a){e.bind(this)(d,a)}.bind(this),g.NS.STREAM,"features",null,null));this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=
a;var b,c;for(b=0;b<a.childNodes.length;b++)c=a.childNodes[b],"bind"==c.nodeName&&(this.do_bind=!0),"session"==c.nodeName&&(this.do_session=!0);this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=g.getResourceFromJid(this.jid))?this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).c("resource",{}).t(a).tree()):this.send(h({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:g.NS.BIND}).tree())):this._changeConnectStatus(g.Status.AUTHFAIL,
null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type")){g.info("SASL binding failed.");var b;0<a.getElementsByTagName("conflict").length&&(b="conflict");this._changeConnectStatus(g.Status.AUTHFAIL,b);return!1}a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=g.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(h({type:"set",id:"_session_auth_2"}).c("session",
{xmlns:g.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)));else return g.info("SASL binding failed."),this._changeConnectStatus(g.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(g.info("Session creation failed."),this._changeConnectStatus(g.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&
(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(g.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(g.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(g.Status.AUTHFAIL,
null),this.disconnect("authentication failed"));return!1},_addSysTimedHandler:function(a,b){var c=new g.TimedHandler(a,b);c.user=!1;this.addTimeds.push(c);return c},_addSysHandler:function(a,b,c,d,e){a=new g.Handler(a,b,c,d,e);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){g.info("_onDisconnectTimeout was called");this._changeConnectStatus(g.Status.CONNTIMEOUT,null);this._proto._onDisconnectTimeout();this._doDisconnect();return!1},_onIdle:function(){for(var a,b,c,d;0<
this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var e=(new Date).getTime();d=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)c=b.lastCalled+b.period,0>=c-e?b.run()&&d.push(b):d.push(b);this.timedHandlers=d;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&(this._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this),
100))}};g.SASLMechanism=function(a,b,c){this.name=a;this.isClientFirst=b;this.priority=c};g.SASLMechanism.prototype={test:function(a){return!0},onStart:function(a){this._connection=a},onChallenge:function(a,b){throw Error("You should implement challenge handling!");},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};g.SASLAnonymous=function(){};g.SASLAnonymous.prototype=new g.SASLMechanism("ANONYMOUS",!1,20);g.SASLAnonymous.prototype.test=function(a){return null===
a.authcid};g.SASLPlain=function(){};g.SASLPlain.prototype=new g.SASLMechanism("PLAIN",!0,30);g.SASLPlain.prototype.test=function(a){return null!==a.authcid};g.SASLPlain.prototype.onChallenge=function(a){var b=a.authzid,b=b+"\x00"+a.authcid,b=b+"\x00",b=b+a.pass;return e.utf16to8(b)};g.SASLSHA1=function(){};g.SASLSHA1.prototype=new g.SASLMechanism("SCRAM-SHA-1",!0,50);g.SASLSHA1.prototype.test=function(a){return null!==a.authcid};g.SASLSHA1.prototype.onChallenge=function(f,g,h){g=h||d.hexdigest(1234567890*
Math.random());h="n="+e.utf16to8(f.authcid);h=h+",r="+g;f._sasl_data.cnonce=g;f._sasl_data["client-first-message-bare"]=h;h="n,,"+h;this.onChallenge=function(d,f){var g,h,l,q,u,s,E="c=biws,",J=d._sasl_data["client-first-message-bare"]+","+f+",";s=d._sasl_data.cnonce;for(u=/([a-z]+)=([^,]+)(,|$)/;f.match(u);)switch(q=f.match(u),f=f.replace(q[0],""),q[1]){case "r":g=q[2];break;case "s":h=q[2];break;case "i":l=q[2]}if(g.substr(0,s.length)!==s)return d._sasl_data={},d._sasl_failure_cb();E+="r="+g;J+=
E;h=c.decode(h);h+="\x00\x00\x00\u0001";s=e.utf16to8(d.pass);h=g=a.core_hmac_sha1(s,h);for(u=1;u<l;u++){q=a.core_hmac_sha1(s,a.binb2str(g));for(g=0;5>g;g++)h[g]^=q[g];g=q}h=a.binb2str(h);l=a.core_hmac_sha1(h,"Client Key");g=a.str_hmac_sha1(h,"Server Key");h=a.core_hmac_sha1(a.str_sha1(a.binb2str(l)),J);d._sasl_data["server-signature"]=a.b64_hmac_sha1(g,J);for(g=0;5>g;g++)l[g]^=h[g];return E+=",p="+c.encode(a.binb2str(l))}.bind(this);return h};g.SASLMD5=function(){};g.SASLMD5.prototype=new g.SASLMechanism("DIGEST-MD5",
!1,40);g.SASLMD5.prototype.test=function(a){return null!==a.authcid};g.SASLMD5.prototype._quote=function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};g.SASLMD5.prototype.onChallenge=function(a,b,c){var f=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;c=c||d.hexdigest(""+1234567890*Math.random());for(var g="",h=null,l="",v;b.match(f);)switch(v=b.match(f),b=b.replace(v[0],""),v[2]=v[2].replace(/^"(.+)"$/,"$1"),v[1]){case "realm":g=v[2];break;case "nonce":l=v[2];break;case "host":h=v[2]}b=a.servtype+
"/"+a.domain;null!==h&&(b=b+"/"+h);f=e.utf16to8(a.authcid+":"+g+":"+this._connection.pass);f=d.hash(f)+":"+l+":"+c;h="AUTHENTICATE:"+b;a="charset=utf-8,"+("username="+this._quote(e.utf16to8(a.authcid))+",");a+="realm="+this._quote(g)+",";a+="nonce="+this._quote(l)+",";a+="nc=00000001,";a+="cnonce="+this._quote(c)+",";a+="digest-uri="+this._quote(b)+",";a+="response="+d.hexdigest(d.hexdigest(f)+":"+l+":00000001:"+c+":auth:"+d.hexdigest(h))+",";a+="qop=auth";this.onChallenge=function(){return""};return a};
g.SASLOAuthBearer=function(){};g.SASLOAuthBearer.prototype=new g.SASLMechanism("OAUTHBEARER",!0,60);g.SASLOAuthBearer.prototype.test=function(a){return null!==a.authcid};g.SASLOAuthBearer.prototype.onChallenge=function(a){var b;b="n,a="+a.authzid;b+=",\u0001";b+="auth=Bearer ";b+=a.pass;b+="\u0001";b+="\u0001";return e.utf16to8(b)};g.SASLExternal=function(){};g.SASLExternal.prototype=new g.SASLMechanism("EXTERNAL",!0,10);g.SASLExternal.prototype.onChallenge=function(a){return a.authcid===a.authzid?
"":a.authzid};return{Strophe:g,$build:f,$msg:function(a){return new g.Builder("message",a)},$iq:h,$pres:l,SHA1:a,Base64:c,MD5:d}});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-bosh",["strophe-core"],function(a){return c(a.Strophe,a.$build)});else return c(Strophe,$build)})(this,function(a,c){a.Request=function(c,e,f,h){this.id=++a._requestId;this.xmlData=c;this.data=a.serialize(c);this.func=this.origFunc=e;this.rid=f;this.date=NaN;this.sends=h||0;this.abort=!1;this.dead=
null;this.age=function(){return!this.date?0:(new Date-this.date)/1E3};this.timeDead=function(){return!this.dead?0:(new Date-this.dead)/1E3};this.xhr=this._newXHR()};a.Request.prototype={getResponse:function(){var c=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(c=this.xhr.responseXML.documentElement,"parsererror"==c.tagName)throw a.error("invalid response received"),a.error("responseText: "+this.xhr.responseText),a.error("responseXML: "+a.serialize(this.xhr.responseXML)),"parsererror";
}else if(this.xhr.responseText)throw a.error("invalid response received"),a.error("responseText: "+this.xhr.responseText),"badformat";return c},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};a.Bosh=function(a){this._conn=a;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=
1;this.wait=60;this.window=5;this.errors=0;this.inactivity=null;this._requests=[]};a.Bosh.prototype={strip:null,_buildBody:function(){var d=c("body",{rid:this.rid++,xmlns:a.NS.HTTPBIND});null!==this.sid&&d.attrs({sid:this.sid});this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession();return d},_reset:function(){this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");
this._conn.nextValidRid(this.rid)},_connect:function(c,e,f){this.wait=c||this.wait;this.hold=e||this.hold;this.errors=0;c=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":a.NS.BOSH});f&&c.attrs({route:f});f=this._conn._connect_cb;this._requests.push(new a.Request(c.tree(),this._onRequestStateChange.bind(this,f.bind(this._conn)),c.tree().getAttribute("rid")));this._throttledRequestHandler()},
_attach:function(c,e,f,h,l,g,q){this._conn.jid=c;this.sid=e;this.rid=f;this._conn.connect_callback=h;this._conn.domain=a.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=l||this.wait;this.hold=g||this.hold;this.window=q||this.window;this._conn._changeConnectStatus(a.Status.ATTACHED,null)},_restore:function(c,e,f,h,l){var g=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if("undefined"!==typeof g&&null!==g&&g.rid&&g.sid&&g.jid&&("undefined"===
typeof c||null===c||a.getBareJidFromJid(g.jid)==a.getBareJidFromJid(c)||null===a.getNodeFromJid(c)&&a.getDomainFromJid(g.jid)==c))this._conn.restored=!0,this._attach(g.jid,g.sid,g.rid,e,f,h,l);else throw{name:"StropheSessionError",message:"_restore: no restoreable session."};},_cacheSession:function(){this._conn.authenticated?this._conn.jid&&(this.rid&&this.sid)&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},
_connect_cb:function(c){var e=c.getAttribute("type");if(null!==e&&"terminate"==e)return e=c.getAttribute("condition"),a.error("BOSH-Connection failed: "+e),c=c.getElementsByTagName("conflict"),null!==e?("remote-stream-error"==e&&0<c.length&&(e="conflict"),this._conn._changeConnectStatus(a.Status.CONNFAIL,e)):this._conn._changeConnectStatus(a.Status.CONNFAIL,"unknown"),this._conn._doDisconnect(e),a.Status.CONNFAIL;this.sid||(this.sid=c.getAttribute("sid"));if(e=c.getAttribute("requests"))this.window=
parseInt(e,10);if(e=c.getAttribute("hold"))this.hold=parseInt(e,10);if(e=c.getAttribute("wait"))this.wait=parseInt(e,10);if(c=c.getAttribute("inactivity"))this.inactivity=parseInt(c,10)},_disconnect:function(a){this._sendTerminate(a)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(4294967295*Math.random());this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)},_emptyQueue:function(){return 0===this._requests.length},
_callProtocolErrorHandlers:function(a){a=this._getRequestStatus(a);var b;(b=this._conn.protocolErrorHandlers.HTTP[a])&&b.call(this,a)},_hitError:function(c){this.errors++;a.warn("request errored, status: "+c+", number of errors: "+this.errors);4<this.errors&&this._conn._onDisconnectTimeout()},_no_auth_received:function(c){c=c?c.bind(this._conn):this._conn._connect_cb.bind(this._conn);var e=this._buildBody();this._requests.push(new a.Request(e.tree(),this._onRequestStateChange.bind(this,c.bind(this._conn)),
e.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function(){for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){}},_onIdle:function(){var c=this._conn._data;this._conn.authenticated&&(0===this._requests.length&&0===c.length&&!this._conn.disconnecting)&&(a.info("no requests during idle cycle, sending blank request"),c.push(null));if(!this._conn.paused){if(2>
this._requests.length&&0<c.length){for(var e=this._buildBody(),f=0;f<c.length;f++)null!==c[f]&&("restart"===c[f]?e.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":a.NS.BOSH}):e.cnode(c[f]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new a.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()}0<this._requests.length&&(c=this._requests[0].age(),
null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(a.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),c>Math.floor(a.TIMEOUT*this.wait)&&(a.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(a.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}},_getRequestStatus:function(c,e){var f;if(4==c.xhr.readyState)try{f=c.xhr.status}catch(h){a.error("Caught an error while retrieving a request's status, reqStatus: "+f)}"undefined"==
typeof f&&(f="number"===typeof e?e:0);return f},_onRequestStateChange:function(c,e){a.debug("request id "+e.id+"."+e.sends+" state changed to "+e.xhr.readyState);if(e.abort)e.abort=!1;else if(4===e.xhr.readyState){var f=this._getRequestStatus(e);if(this.disconnecting&&400<=f)this._hitError(f),this._callProtocolErrorHandlers(e);else{if(0<f&&500>f||5<e.sends)this._removeRequest(e),a.debug("request id "+e.id+" should now be removed");if(200==f){var h=this._requests[0]==e;(this._requests[1]==e||h&&0<
this._requests.length&&this._requests[0].age()>Math.floor(a.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0);this._conn.nextValidRid(Number(e.rid)+1);a.debug("request id "+e.id+"."+e.sends+" got 200");c(e);this.errors=0}else 0===f||400<=f&&600>f||12E3<=f?(a.error("request id "+e.id+"."+e.sends+" error "+f+" happened"),this._hitError(f),this._callProtocolErrorHandlers(e),400<=f&&500>f&&(this._conn._changeConnectStatus(a.Status.DISCONNECTING,null),this._conn._doDisconnect())):a.error("request id "+
e.id+"."+e.sends+" error "+f+" happened");(!(0<f&&500>f)||5<e.sends)&&this._throttledRequestHandler()}}},_processRequest:function(c){var e=this,f=this._requests[c],h=this._getRequestStatus(f,-1);if(f.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var l=f.age(),l=!isNaN(l)&&l>Math.floor(a.TIMEOUT*this.wait),g=null!==f.dead&&f.timeDead()>Math.floor(a.SECONDARY_TIMEOUT*this.wait),h=4==f.xhr.readyState&&(1>h||500<=h);if(l||g||h)g&&a.error("Request "+this._requests[c].id+" timed out (secondary), restarting"),
f.abort=!0,f.xhr.abort(),f.xhr.onreadystatechange=function(){},this._requests[c]=new a.Request(f.xmlData,f.origFunc,f.rid,f.sends),f=this._requests[c];if(0===f.xhr.readyState){a.debug("request id "+f.id+"."+f.sends+" posting");try{var q=this._conn.options.contentType||"text/xml; charset=utf-8";f.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0);"undefined"!==typeof f.xhr.setRequestHeader&&f.xhr.setRequestHeader("Content-Type",q);this._conn.options.withCredentials&&(f.xhr.withCredentials=
!0)}catch(u){a.error("XHR open failed.");this._conn.connected||this._conn._changeConnectStatus(a.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}var s=function(){f.date=new Date;if(e._conn.options.customHeaders){var a=e._conn.options.customHeaders,b;for(b in a)a.hasOwnProperty(b)&&f.xhr.setRequestHeader(b,a[b])}f.xhr.send(f.data)};1<f.sends?(c=1E3*Math.min(Math.floor(a.TIMEOUT*this.wait),Math.pow(f.sends,3)),setTimeout(function(){s()},c)):s();f.sends++;this._conn.xmlOutput!==a.Connection.prototype.xmlOutput&&
(f.xmlData.nodeName===this.strip&&f.xmlData.childNodes.length?this._conn.xmlOutput(f.xmlData.childNodes[0]):this._conn.xmlOutput(f.xmlData));this._conn.rawOutput!==a.Connection.prototype.rawOutput&&this._conn.rawOutput(f.data)}else a.debug("_processRequest: "+(0===c?"first":"second")+" request has readyState of "+f.xhr.readyState)}},_removeRequest:function(c){a.debug("removing request");var e;for(e=this._requests.length-1;0<=e;e--)c==this._requests[e]&&this._requests.splice(e,1);c.xhr.onreadystatechange=
function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];null===b.dead&&(b.dead=new Date);this._processRequest(a)},_reqToData:function(a){try{return a.getResponse()}catch(b){if("parsererror"!=b)throw b;this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(c){a.info("_sendTerminate was called");var e=this._buildBody().attrs({type:"terminate"});c&&e.cnode(c.tree());c=new a.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),
e.tree().getAttribute("rid"));this._requests.push(c);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(function(){this._onIdle()}.bind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){this._requests?a.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):a.debug("_throttledRequestHandler called with undefined requests");
this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};return a});(function(a,c){if("function"===typeof define&&define.amd)define("strophe-websocket",["strophe-core"],function(a){return c(a.Strophe,a.$build)});else return c(Strophe,$build)})(this,function(a,c){a.Websocket=function(a){this._conn=a;this.strip="wrapper";var b=a.service;if(0!==b.indexOf("ws:")&&
0!==b.indexOf("wss:")){var c="",c="ws"===a.options.protocol&&"https:"!==window.location.protocol?c+"ws":c+"wss",c=c+("://"+window.location.host),c=0!==b.indexOf("/")?c+(window.location.pathname+b):c+b;a.service=c}};a.Websocket.prototype={_buildStream:function(){return c("open",{xmlns:a.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(c,e){var f;f=c.getElementsByTagNameNS?c.getElementsByTagNameNS(a.NS.STREAM,"error"):c.getElementsByTagName("stream:error");if(0===f.length)return!1;
for(var h=f[0],l=f="",g=0;g<h.childNodes.length;g++){var q=h.childNodes[g];if("urn:ietf:params:xml:ns:xmpp-streams"!==q.getAttribute("xmlns"))break;"text"===q.nodeName?l=q.textContent||q.text:f=q.nodeName}h="WebSocket stream error: ";h=f?h+f:h+"unknown";l&&(h+=" - "+l);a.error(h);this._conn._changeConnectStatus(e,f);this._conn._doDisconnect();return!0},_reset:function(){},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);
this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this)},_connect_cb:function(c){if(this._check_streamerror(c,a.Status.CONNFAIL))return a.Status.CONNFAIL},_handleStreamStart:function(c){var e=!1,f=c.getAttribute("xmlns");"string"!==typeof f?e="Missing xmlns in <open />":f!==a.NS.FRAMING&&(e="Wrong xmlns in <open />: "+f);c=c.getAttribute("version");"string"!==typeof c?e="Missing version in <open />":"1.0"!==
c&&(e="Wrong version in <open />: "+c);return e?(this._conn._changeConnectStatus(a.Status.CONNFAIL,e),this._conn._doDisconnect(),!1):!0},_connect_cb_wrapper:function(c){if(0===c.data.indexOf("<open ")||0===c.data.indexOf("<?xml")){var e=c.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==e&&(e=(new DOMParser).parseFromString(e,"text/xml").documentElement,this._conn.xmlInput(e),this._conn.rawInput(c.data),this._handleStreamStart(e)&&this._connect_cb(e))}else 0===c.data.indexOf("<close ")?(this._conn.rawInput(c.data),
this._conn.xmlInput(c),(c=c.getAttribute("see-other-uri"))?(this._conn._changeConnectStatus(a.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=c,this._connect()):(this._conn._changeConnectStatus(a.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect())):(e=this._streamWrap(c.data),e=(new DOMParser).parseFromString(e,"text/xml").documentElement,this.socket.onmessage=this._onMessage.bind(this),this._conn._connect_cb(e,null,c.data))},
_disconnect:function(d){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){d&&this._conn.send(d);d=c("close",{xmlns:a.NS.FRAMING});this._conn.xmlOutput(d);d=a.serialize(d);this._conn.rawOutput(d);try{this.socket.send(d)}catch(e){a.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){a.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(a){return"<wrapper>"+a+"</wrapper>"},_closeSocket:function(){if(this.socket)try{this.socket.close()}catch(a){}this.socket=
null},_emptyQueue:function(){return!0},_onClose:function(){this._conn.connected&&!this._conn.disconnecting?(a.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):a.info("Websocket closed")},_no_auth_received:function(c){a.error("Server did not send any auth methods");this._conn._changeConnectStatus(a.Status.CONNFAIL,"Server did not send any auth methods");c&&(c=c.bind(this._conn),c());this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(c){a.error("Websocket error "+
c);this._conn._changeConnectStatus(a.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()},_onIdle:function(){var c=this._conn._data;if(0<c.length&&!this._conn.paused){for(var e=0;e<c.length;e++)if(null!==c[e]){var f,h;f="restart"===c[e]?this._buildStream().tree():c[e];h=a.serialize(f);this._conn.xmlOutput(f);this._conn.rawOutput(h);this.socket.send(h)}this._conn._data=[]}},_onMessage:function(c){var e;if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===
c.data)this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),this._conn.xmlInput(c),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===c.data.search("<open ")){if(e=(new DOMParser).parseFromString(c.data,"text/xml").documentElement,!this._handleStreamStart(e))return}else e=this._streamWrap(c.data),e=(new DOMParser).parseFromString(e,"text/xml").documentElement;this._check_streamerror(e,a.Status.ERROR)||(this._conn.disconnecting&&"presence"===e.firstChild.nodeName&&
"unavailable"===e.firstChild.getAttribute("type")?(this._conn.xmlInput(e),this._conn.rawInput(a.serialize(e))):this._conn._dataRecv(e,c.data))}},_onOpen:function(){a.info("Websocket open");var c=this._buildStream();this._conn.xmlOutput(c.tree());c=a.serialize(c);this._conn.rawOutput(c);this.socket.send(c)},_reqToData:function(a){return a},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)()}};return a});(function(a){"function"===
typeof define&&define.amd&&define("strophe",["strophe-core","strophe-bosh","strophe-websocket"],function(a){return a})})(this);if(a)if("function"===typeof define&&define.amd)"function"===typeof requirejs?requirejs(["strophe"],function(b){a(b.Strophe,b.$build,b.$msg,b.$iq,b.$pres)}):require(["strophe"],function(b){a(b.Strophe,b.$build,b.$msg,b.$iq,b.$pres)});else return a(Strophe,$build,$msg,$iq,$pres)})(function(a,b,c,d,e){window.Strophe=a;window.$build=b;window.$msg=c;window.$iq=d;window.$pres=e});
var Occupant,RoomConfig,XmppRoom,hasProp={}.hasOwnProperty,bind=function(a,b){return function(){return a.apply(b,arguments)}};
Strophe.addConnectionPlugin("muc",{_connection:null,rooms:{},roomNames:[],init:function(a){this._connection=a;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig");return Strophe.addNamespace("MUC_REGISTER","jabber:iq:register")},join:function(a,b,c,d,e,f,h,l){var g;g=this.test_append_nick(a,b);
g=$pres({from:this._connection.jid,to:g}).c("x",{xmlns:Strophe.NS.MUC});null!=h&&(g=g.c("history",h).up());null!=f&&g.cnode(Strophe.xmlElement("password",[],f));null!=l&&g.up().cnode(l);null==this._muc_handler&&(this._muc_handler=this._connection.addHandler(function(b){return function(c){var d,e,f,g,h,l;d=c.getAttribute("from");if(!d)return!0;d=d.split("/")[0];if(!b.rooms[d])return!0;a=b.rooms[d];d={};if("message"===c.nodeName)d=a._message_handlers;else if("presence"===c.nodeName&&(l=c.getElementsByTagName("x"),
0<l.length)){e=0;for(g=l.length;e<g;e++)if(h=l[e],(h=h.getAttribute("xmlns"))&&h.match(Strophe.NS.MUC)){d=a._presence_handlers;break}}for(f in d)e=d[f],e(c,a)||delete d[f];return!0}}(this)));this.rooms.hasOwnProperty(a)||(this.rooms[a]=new XmppRoom(this,a,b,f),d&&this.rooms[a].addHandler("presence",d),c&&this.rooms[a].addHandler("message",c),e&&this.rooms[a].addHandler("roster",e),this.roomNames.push(a));return this._connection.send(g)},leave:function(a,b,c,d){var e;e=this.roomNames.indexOf(a);delete this.rooms[a];
0<=e&&(this.roomNames.splice(e,1),0===this.roomNames.length&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null));b=this.test_append_nick(a,b);a=this._connection.getUniqueId();b=$pres({type:"unavailable",id:a,from:this._connection.jid,to:b});null!=d&&b.c("status",d);null!=c&&this._connection.addHandler(c,null,"presence",null,a);this._connection.send(b);return a},message:function(a,b,c,d,e,f){a=this.test_append_nick(a,b);e=e||(null!=b?"chat":"groupchat");f=f||this._connection.getUniqueId();
b=$msg({to:a,from:this._connection.jid,type:e,id:f}).c("body").t(c);b.up();null!=d&&(b.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(d),0===b.node.childNodes.length?(d=b.node.parentNode,b.up().up(),b.node.removeChild(d)):b.up().up());b.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(b);return f},groupchat:function(a,b,c,d){return this.message(a,null,b,c,void 0,d)},invite:function(a,b,c){var d;d=this._connection.getUniqueId();a=$msg({from:this._connection.jid,
to:a,id:d}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:b});null!=c&&a.c("reason",c);this._connection.send(a);return d},multipleInvites:function(a,b,c){var d,e,f,h;f=this._connection.getUniqueId();d=$msg({from:this._connection.jid,to:a,id:f}).c("x",{xmlns:Strophe.NS.MUC_USER});a=0;for(e=b.length;a<e;a++)h=b[a],d.c("invite",{to:h}),null!=c&&(d.c("reason",c),d.up()),d.up();this._connection.send(d);return f},directInvite:function(a,b,c,d){var e;e=this._connection.getUniqueId();a={xmlns:"jabber:x:conference",
jid:a};null!=c&&(a.reason=c);null!=d&&(a.password=d);b=$msg({from:this._connection.jid,to:b,id:e}).c("x",a);this._connection.send(b);return e},queryOccupants:function(a,b,c){var d;d={xmlns:Strophe.NS.DISCO_ITEMS};a=$iq({from:this._connection.jid,to:a,type:"get"}).c("query",d);return this._connection.sendIQ(a,b,c)},configure:function(a,b,c){a=$iq({to:a,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).tree();return this._connection.sendIQ(a,b,c)},cancelConfigure:function(a){a=$iq({to:a,type:"set"}).c("query",
{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}).tree();return this._connection.sendIQ(a)},saveConfiguration:function(a,b,c,d){var e,f,h;f=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});if("undefined"!==typeof Strophe.x&&"undefined"!==typeof Strophe.x.Form&&b instanceof Strophe.x.Form)b.type="submit",f.cnode(b.toXML());else{f.c("x",{xmlns:"jabber:x:data",type:"submit"});e=0;for(h=b.length;e<h;e++)a=b[e],f.cnode(a).up()}b=f.tree();return this._connection.sendIQ(b,
c,d)},createInstantRoom:function(a,b,c){a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(a.tree(),b,c)},createConfiguredRoom:function(a,b,c,d){var e,f;a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});a.c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up();for(e in b)hasProp.call(b,e)&&(f=b[e],a.c("field",
{"var":e}).c("value").t(f).up().up());return this._connection.sendIQ(a.tree(),c,d)},setTopic:function(a,b){var c;c=$msg({to:a,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(b);return this._connection.send(c.tree())},_modifyPrivilege:function(a,b,c,d,e){a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(b.node);null!=c&&a.c("reason",c);return this._connection.sendIQ(a.tree(),d,e)},modifyRole:function(a,b,c,d,e,f){b=$build("item",{nick:b,role:c});
return this._modifyPrivilege(a,b,d,e,f)},kick:function(a,b,c,d,e){return this.modifyRole(a,b,"none",c,d,e)},voice:function(a,b,c,d,e){return this.modifyRole(a,b,"participant",c,d,e)},mute:function(a,b,c,d,e){return this.modifyRole(a,b,"visitor",c,d,e)},op:function(a,b,c,d,e){return this.modifyRole(a,b,"moderator",c,d,e)},deop:function(a,b,c,d,e){return this.modifyRole(a,b,"participant",c,d,e)},modifyAffiliation:function(a,b,c,d,e,f){b=$build("item",{jid:b,affiliation:c});return this._modifyPrivilege(a,
b,d,e,f)},ban:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"outcast",c,d,e)},member:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"member",c,d,e)},revoke:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"none",c,d,e)},owner:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"owner",c,d,e)},admin:function(a,b,c,d,e){return this.modifyAffiliation(a,b,"admin",c,d,e)},changeNick:function(a,b){var c;c=this.test_append_nick(a,b);c=$pres({from:this._connection.jid,to:c,id:this._connection.getUniqueId()});
return this._connection.send(c.tree())},setStatus:function(a,b,c,d){a=this.test_append_nick(a,b);a=$pres({from:this._connection.jid,to:a});null!=c&&a.c("show",c).up();null!=d&&a.c("status",d);return this._connection.send(a.tree())},registrationRequest:function(a,b,c){a=$iq({to:a,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER});return this._connection.sendIQ(a,function(a){var c,f,h,l,g;c=a.getElementsByTagName("field");h={required:[],optional:[]};l=0;for(g=c.length;l<
g;l++)a=c[l],f={"var":a.getAttribute("var"),label:a.getAttribute("label"),type:a.getAttribute("type")},0<a.getElementsByTagName("required").length?h.required.push(f):h.optional.push(f);return b(h)},c)},submitRegistrationForm:function(a,b,c,d){var e,f;a=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_REGISTER});a.c("x",{xmlns:"jabber:x:data",type:"submit"});a.c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#register").up().up();for(e in b)f=b[e],a.c("field",{"var":e}).c("value").t(f).up().up();
return this._connection.sendIQ(a,c,d)},listRooms:function(a,b,c){a=$iq({to:a,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(a,b,c)},test_append_nick:function(a,b){var c,d;d=Strophe.escapeNode(Strophe.getNodeFromJid(a));c=Strophe.getDomainFromJid(a);return d+"@"+c+(null!=b?"/"+b:"")}});
XmppRoom=function(){function a(a,c,d,e){this.client=a;this.name=c;this.nick=d;this.password=e;this._roomRosterHandler=bind(this._roomRosterHandler,this);this._addOccupant=bind(this._addOccupant,this);this.roster={};this._message_handlers={};this._presence_handlers={};this._roster_handlers={};this._handler_ids=0;this.client.muc&&(this.client=this.client.muc);this.name=Strophe.getBareJidFromJid(this.name);this.addHandler("presence",this._roomRosterHandler)}a.prototype.join=function(a,c,d){return this.client.join(this.name,
this.nick,a,c,d,this.password)};a.prototype.leave=function(a,c){this.client.leave(this.name,this.nick,a,c);return delete this.client.rooms[this.name]};a.prototype.message=function(a,c,d,e){return this.client.message(this.name,a,c,d,e)};a.prototype.groupchat=function(a,c){return this.client.groupchat(this.name,a,c)};a.prototype.invite=function(a,c){return this.client.invite(this.name,a,c)};a.prototype.multipleInvites=function(a,c){return this.client.invite(this.name,a,c)};a.prototype.directInvite=
function(a,c){return this.client.directInvite(this.name,a,c,this.password)};a.prototype.configure=function(a){return this.client.configure(this.name,a)};a.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};a.prototype.saveConfiguration=function(a){return this.client.saveConfiguration(this.name,a)};a.prototype.queryOccupants=function(a,c){return this.client.queryOccupants(this.name,a,c)};a.prototype.setTopic=function(a){return this.client.setTopic(this.name,a)};a.prototype.modifyRole=
function(a,c,d,e,f){return this.client.modifyRole(this.name,a,c,d,e,f)};a.prototype.kick=function(a,c,d,e){return this.client.kick(this.name,a,c,d,e)};a.prototype.voice=function(a,c,d,e){return this.client.voice(this.name,a,c,d,e)};a.prototype.mute=function(a,c,d,e){return this.client.mute(this.name,a,c,d,e)};a.prototype.op=function(a,c,d,e){return this.client.op(this.name,a,c,d,e)};a.prototype.deop=function(a,c,d,e){return this.client.deop(this.name,a,c,d,e)};a.prototype.modifyAffiliation=function(a,
c,d,e,f){return this.client.modifyAffiliation(this.name,a,c,d,e,f)};a.prototype.ban=function(a,c,d,e){return this.client.ban(this.name,a,c,d,e)};a.prototype.member=function(a,c,d,e){return this.client.member(this.name,a,c,d,e)};a.prototype.revoke=function(a,c,d,e){return this.client.revoke(this.name,a,c,d,e)};a.prototype.owner=function(a,c,d,e){return this.client.owner(this.name,a,c,d,e)};a.prototype.admin=function(a,c,d,e){return this.client.admin(this.name,a,c,d,e)};a.prototype.changeNick=function(a){this.nick=
a;return this.client.changeNick(this.name,nick)};a.prototype.setStatus=function(a,c){return this.client.setStatus(this.name,this.nick,a,c)};a.prototype.addHandler=function(a,c){var d;d=this._handler_ids++;switch(a){case "presence":this._presence_handlers[d]=c;break;case "message":this._message_handlers[d]=c;break;case "roster":this._roster_handlers[d]=c;break;default:return this._handler_ids--,null}return d};a.prototype.removeHandler=function(a){delete this._presence_handlers[a];delete this._message_handlers[a];
return delete this._roster_handlers[a]};a.prototype._addOccupant=function(a){a=new Occupant(a,this);return this.roster[a.nick]=a};a.prototype._roomRosterHandler=function(b){var c,d,e;b=a._parsePresence(b);e=b.nick;d=b.newnick||null;switch(b.type){case "error":return!0;case "unavailable":d&&(b.nick=d,this.roster[e]&&this.roster[d]&&(this.roster[e].update(this.roster[d]),this.roster[d]=this.roster[e]),this.roster[e]&&!this.roster[d]&&(this.roster[d]=this.roster[e].update(b)));delete this.roster[e];
break;default:this.roster[e]?this.roster[e].update(b):this._addOccupant(b)}d=this._roster_handlers;for(c in d)b=d[c],b(this.roster,this)||delete this._roster_handlers[c];return!0};a._parsePresence=function(a){var c,d,e,f,h,l,g;d={};d.nick=Strophe.getResourceFromJid(a.getAttribute("from"));d.type=a.getAttribute("type");d.states=[];l=a.childNodes;a=0;for(f=l.length;a<f;a++)switch(c=l[a],c.nodeName){case "error":d.errorcode=c.getAttribute("code");d.error=null!=(g=c.childNodes[0])?g.nodeName:void 0;break;
case "status":d.status=c.textContent||c.text||null;break;case "show":d.show=c.textContent||c.text||null;break;case "x":if(c.getAttribute("xmlns")===Strophe.NS.MUC_USER){g=c.childNodes;e=0;for(h=g.length;e<h;e++)switch(c=g[e],c.nodeName){case "item":d.affiliation=c.getAttribute("affiliation");d.role=c.getAttribute("role");d.jid=c.getAttribute("jid");d.newnick=c.getAttribute("nick");break;case "status":c.getAttribute("code")&&d.states.push(c.getAttribute("code"))}}}return d};return a}();
RoomConfig=function(){function a(a){this.parse=bind(this.parse,this);null!=a&&this.parse(a)}a.prototype.parse=function(a){var c,d,e,f,h,l,g;g=a.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];a=0;for(h=g.length;a<h;a++)switch(c=g[a],d=c.attributes,c.nodeName){case "identity":e={};f=0;for(l=d.length;f<l;f++)c=d[f],e[c.name]=c.textContent||c.text;this.identities.push(e);break;case "feature":this.features.push(c.getAttribute("var"));break;case "x":if("FORM_TYPE"===
!c.childNodes[0].getAttribute("var")||"hidden"===!c.childNodes[0].getAttribute("type"))break;f=c.childNodes;c=0;for(e=f.length;c<e;c++)d=f[c],d.attributes.type||this.x.push({"var":d.getAttribute("var"),label:d.getAttribute("label")||"",value:d.firstChild.textContent||d.firstChild.text||""})}return{identities:this.identities,features:this.features,x:this.x}};return a}();
Occupant=function(){function a(a,c){this.room=c;this.update=bind(this.update,this);this.admin=bind(this.admin,this);this.owner=bind(this.owner,this);this.revoke=bind(this.revoke,this);this.member=bind(this.member,this);this.ban=bind(this.ban,this);this.modifyAffiliation=bind(this.modifyAffiliation,this);this.deop=bind(this.deop,this);this.op=bind(this.op,this);this.mute=bind(this.mute,this);this.voice=bind(this.voice,this);this.kick=bind(this.kick,this);this.modifyRole=bind(this.modifyRole,this);
this.update(a)}a.prototype.modifyRole=function(a,c,d,e){return this.room.modifyRole(this.nick,a,c,d,e)};a.prototype.kick=function(a,c,d){return this.room.kick(this.nick,a,c,d)};a.prototype.voice=function(a,c,d){return this.room.voice(this.nick,a,c,d)};a.prototype.mute=function(a,c,d){return this.room.mute(this.nick,a,c,d)};a.prototype.op=function(a,c,d){return this.room.op(this.nick,a,c,d)};a.prototype.deop=function(a,c,d){return this.room.deop(this.nick,a,c,d)};a.prototype.modifyAffiliation=function(a,
c,d,e){return this.room.modifyAffiliation(this.jid,a,c,d,e)};a.prototype.ban=function(a,c,d){return this.room.ban(this.jid,a,c,d)};a.prototype.member=function(a,c,d){return this.room.member(this.jid,a,c,d)};a.prototype.revoke=function(a,c,d){return this.room.revoke(this.jid,a,c,d)};a.prototype.owner=function(a,c,d){return this.room.owner(this.jid,a,c,d)};a.prototype.admin=function(a,c,d){return this.room.admin(this.jid,a,c,d)};a.prototype.update=function(a){this.nick=a.nick||null;this.affiliation=
a.affiliation||null;this.role=a.role||null;this.jid=a.jid||null;this.status=a.status||null;this.show=a.show||null;return this};return a}();
Strophe.addConnectionPlugin("ping",{_c:null,init:function(a){this._c=a;Strophe.addNamespace("PING","urn:xmpp:ping")},ping:function(a,b,c,d){var e=this._c.getUniqueId("ping");a=$iq({type:"get",to:a,id:e}).c("ping",{xmlns:Strophe.NS.PING});this._c.sendIQ(a,b,c,d)},pong:function(a){var b=a.getAttribute("from");a=a.getAttribute("id");b=$iq({type:"result",to:b,id:a});this._c.sendIQ(b)},addPingHandler:function(a){return this._c.addHandler(a,Strophe.NS.PING,"iq","get")}});
(function(){var a={VERSION:"1.1.3",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:"long-polling cross-origin-long-polling callback-polling websocket eventsource in-process".split(" "),MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"!==typeof window?window:global,extend:function(a,c,d){if(!c)return a;for(var e in c)c.hasOwnProperty(e)&&(a.hasOwnProperty(e)&&!1===d||a[e]!==c[e]&&(a[e]=c[e]));return a},random:function(a){a=
a||this.ID_LENGTH;var c=Math.ceil(a*Math.log(2)/Math.log(36));for(a=csprng(a,36);a.length<c;)a="0"+a;return a},validateOptions:function(a,c){for(var d in a)if(0>this.indexOf(c,d))throw Error("Unrecognized option: "+d);},clientIdFromMessages:function(a){a=this.filter([].concat(a),function(a){return"/meta/connect"===a.channel});return a[0]&&a[0].clientId},copyObject:function(b){var c,d;if(b instanceof Array){c=[];for(d=b.length;d--;)c[d]=a.copyObject(b[d]);return c}if("object"===typeof b){c=null===
b?null:{};for(d in b)c[d]=a.copyObject(b[d]);return c}return b},commonElement:function(a,c){for(var d=0,e=a.length;d<e;d++)if(-1!==this.indexOf(c,a[d]))return a[d];return null},indexOf:function(a,c){if(a.indexOf)return a.indexOf(c);for(var d=0,e=a.length;d<e;d++)if(a[d]===c)return d;return-1},map:function(a,c,d){if(a.map)return a.map(c,d);var e=[];if(a instanceof Array)for(var f=0,h=a.length;f<h;f++)e.push(c.call(d||null,a[f],f));else for(f in a)a.hasOwnProperty(f)&&e.push(c.call(d||null,f,a[f]));
return e},filter:function(a,c,d){if(a.filter)return a.filter(c,d);for(var e=[],f=0,h=a.length;f<h;f++)c.call(d||null,a[f],f)&&e.push(a[f]);return e},asyncEach:function(a,c,d,e){var f=a.length,h=-1,l=0,g=!1,q=function(){l+=1;if(!g){for(g=!0;0<l;)l-=1,h+=1,h===f?d&&d.call(e):c(a[h],q);g=!1}};q()},toJSON:function(a){return!this.stringify?JSON.stringify(a):this.stringify(a,function(a,b){return this[a]instanceof Array?this[a]:b})}};"undefined"!==typeof module?module.exports=a:"undefined"!==typeof window&&
(window.Faye=a);a.Class=function(b,c){"function"!==typeof b&&(c=b,b=Object);var d=function(){return!this.initialize?this:this.initialize.apply(this,arguments)||this},e=function(){};e.prototype=b.prototype;d.prototype=new e;a.extend(d.prototype,c);return d};(function(){var b=a.EventEmitter=function(){},c="function"===typeof Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.prototype.emit=function(a){if("error"===a&&(!this._events||!this._events.error||
c(this._events.error)&&!this._events.error.length)){if(arguments[1]instanceof Error)throw arguments[1];throw Error("Uncaught, unspecified 'error' event.");}if(!this._events)return!1;var b=this._events[a];if(!b)return!1;if("function"==typeof b){switch(arguments.length){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:var f=Array.prototype.slice.call(arguments,1);b.apply(this,f)}return!0}if(c(b)){for(var f=Array.prototype.slice.call(arguments,
1),b=b.slice(),h=0,l=b.length;h<l;h++)b[h].apply(this,f);return!0}return!1};b.prototype.addListener=function(a,b){if("function"!==typeof b)throw Error("addListener only takes instances of Function");this._events||(this._events={});this.emit("newListener",a,b);this._events[a]?c(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b;return this};b.prototype.on=b.prototype.addListener;b.prototype.once=function(a,b){var c=this;c.on(a,function l(){c.removeListener(a,
l);b.apply(this,arguments)});return this};b.prototype.removeListener=function(a,b){if("function"!==typeof b)throw Error("removeListener only takes instances of Function");if(!this._events||!this._events[a])return this;var f=this._events[a];if(c(f)){var h;a:if(f.indexOf)h=f.indexOf(b);else{for(h=0;h<f.length;h++)if(b===f[h])break a;h=-1}if(0>h)return this;f.splice(h,1);0==f.length&&delete this._events[a]}else this._events[a]===b&&delete this._events[a];return this};b.prototype.removeAllListeners=function(a){if(0===
arguments.length)return this._events={},this;a&&(this._events&&this._events[a])&&(this._events[a]=null);return this};b.prototype.listeners=function(a){this._events||(this._events={});this._events[a]||(this._events[a]=[]);c(this._events[a])||(this._events[a]=[this._events[a]]);return this._events[a]}})();a.Namespace=a.Class({initialize:function(){this._used={}},exists:function(a){return this._used.hasOwnProperty(a)},generate:function(){for(var b=a.random();this._used.hasOwnProperty(b);)b=a.random();
return this._used[b]=b},release:function(a){delete this._used[a]}});(function(){var b=setTimeout,c;c="function"===typeof setImmediate?function(a){setImmediate(a)}:"object"===typeof process&&process.nextTick?function(a){process.nextTick(a)}:function(a){b(a,0)};var d=function(a){return a},e=function(a){throw a;},f=function(a){this._state=0;this._onFulfilled=[];this._onRejected=[];if("function"===typeof a){var b=this;a(function(a){q(b,a)},function(a){s(b,a)})}};f.prototype.then=function(a,b){var c=new f;
h(this,a,c);l(this,b,c);return c};var h=function(a,b,c){"function"!==typeof b&&(b=d);var e=function(a){g(b,a,c)};0===a._state?a._onFulfilled.push(e):1===a._state&&e(a._value)},l=function(a,b,c){"function"!==typeof b&&(b=e);var d=function(a){g(b,a,c)};0===a._state?a._onRejected.push(d):2===a._state&&d(a._reason)},g=function(a,b,d){c(function(){a:{var c;try{c=a(b)}catch(e){s(d,e);break a}c===d?s(d,new TypeError("Recursive promise chain detected")):q(d,c)}})},q=f.fulfill=f.resolve=function(a,b){var c=
!1,d,e;try{d=typeof b;e=null!==b&&("function"===d||"object"===d)&&b.then;if("function"!==typeof e)return u(a,b);e.call(b,function(b){c^(c=!0)&&q(a,b)},function(b){c^(c=!0)&&s(a,b)})}catch(f){c^(c=!0)&&s(a,f)}},u=function(a,b){if(0===a._state){a._state=1;a._value=b;a._onRejected=[];for(var c=a._onFulfilled,d;d=c.shift();)d(b)}},s=f.reject=function(a,b){if(0===a._state){a._state=2;a._reason=b;a._onFulfilled=[];for(var c=a._onRejected,d;d=c.shift();)d(b)}};f.all=function(a){return new f(function(b,c){var d=
[],e=a.length,g;if(0===e)return b(d);for(g=0;g<e;g++)(function(a,g){f.fulfilled(a).then(function(a){d[g]=a;0===--e&&b(d)},c)})(a[g],g)})};f.defer=c;f.deferred=f.pending=function(){var a={};a.promise=new f(function(b,c){a.fulfill=a.resolve=b;a.reject=c});return a};f.fulfilled=f.resolved=function(a){return new f(function(b,c){b(a)})};f.rejected=function(a){return new f(function(b,c){c(a)})};"undefined"===typeof a?module.exports=f:a.Promise=f})();a.Set=a.Class({initialize:function(){this._index={}},
add:function(a){var c=void 0!==a.id?a.id:a;if(this._index.hasOwnProperty(c))return!1;this._index[c]=a;return!0},forEach:function(a,c){for(var d in this._index)this._index.hasOwnProperty(d)&&a.call(c,this._index[d])},isEmpty:function(){for(var a in this._index)if(this._index.hasOwnProperty(a))return!1;return!0},member:function(a){for(var c in this._index)if(this._index[c]===a)return!0;return!1},remove:function(a){a=void 0!==a.id?a.id:a;var c=this._index[a];delete this._index[a];return c},toArray:function(){var a=
[];this.forEach(function(c){a.push(c)});return a}});a.URI={isURI:function(a){return a&&a.protocol&&a.host&&a.path},isSameOrigin:function(b){var c=a.ENV.location;return b.protocol===c.protocol&&b.hostname===c.hostname&&b.port===c.port},parse:function(b){if("string"!==typeof b)return b;var c={},d,e,f,h,l;d=function(a,d){b=b.replace(d,function(b){c[a]=b;return""});c[a]=c[a]||""};d("protocol",/^[a-z]+\:/i);d("host",/^\/\/[^\/\?#]+/);!/^\//.test(b)&&!c.host&&(b=a.ENV.location.pathname.replace(/[^\/]*$/,
"")+b);d("pathname",/^[^\?#]*/);d("search",/^\?[^#]*/);d("hash",/^#.*/);c.protocol=c.protocol||a.ENV.location.protocol;c.host?(c.host=c.host.substr(2),d=c.host.split(":"),c.hostname=d[0],c.port=d[1]||""):(c.host=a.ENV.location.host,c.hostname=a.ENV.location.hostname,c.port=a.ENV.location.port);c.pathname=c.pathname||"/";c.path=c.pathname+c.search;e=(d=c.search.replace(/^\?/,""))?d.split("&"):[];l={};f=0;for(h=e.length;f<h;f++)d=e[f].split("="),l[decodeURIComponent(d[0]||"")]=decodeURIComponent(d[1]||
"");c.query=l;c.href=this.stringify(c);return c},stringify:function(a){var c=a.protocol+"//"+a.hostname;a.port&&(c+=":"+a.port);return c+=a.pathname+this.queryString(a.query)+(a.hash||"")},queryString:function(a){var c=[],d;for(d in a)a.hasOwnProperty(d)&&c.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));return 0===c.length?"":"?"+c.join("&")}};a.Error=a.Class({initialize:function(a,c,d){this.code=a;this.params=Array.prototype.slice.call(c);this.message=d},toString:function(){return this.code+
":"+this.params.join(",")+":"+this.message}});a.Error.parse=function(b){b=b||"";if(!a.Grammar.ERROR.test(b))return new this(null,[],b);b=b.split(":");var c=parseInt(b[0]),d=b[1].split(",");b=b[2];return new this(c,d,b)};a.Error.versionMismatch=function(){return(new this(300,arguments,"Version mismatch")).toString()};a.Error.conntypeMismatch=function(){return(new this(301,arguments,"Connection types not supported")).toString()};a.Error.extMismatch=function(){return(new this(302,arguments,"Extension mismatch")).toString()};
a.Error.badRequest=function(){return(new this(400,arguments,"Bad request")).toString()};a.Error.clientUnknown=function(){return(new this(401,arguments,"Unknown client")).toString()};a.Error.parameterMissing=function(){return(new this(402,arguments,"Missing required parameter")).toString()};a.Error.channelForbidden=function(){return(new this(403,arguments,"Forbidden channel")).toString()};a.Error.channelUnknown=function(){return(new this(404,arguments,"Unknown channel")).toString()};a.Error.channelInvalid=
function(){return(new this(405,arguments,"Invalid channel")).toString()};a.Error.extUnknown=function(){return(new this(406,arguments,"Unknown extension")).toString()};a.Error.publishFailed=function(){return(new this(407,arguments,"Failed to publish")).toString()};a.Error.serverError=function(){return(new this(500,arguments,"Internal server error")).toString()};a.Deferrable={then:function(b,c){var d=this;this._promise||(this._promise=new a.Promise(function(a,b){d._fulfill=a;d._reject=b}));return 0===
arguments.length?this._promise:this._promise.then(b,c)},callback:function(a,c){return this.then(function(d){a.call(c,d)})},errback:function(a,c){return this.then(null,function(d){a.call(c,d)})},timeout:function(b,c){this.then();var d=this;this._timer=a.ENV.setTimeout(function(){d._reject(c)},1E3*b)},setDeferredStatus:function(b,c){this._timer&&a.ENV.clearTimeout(this._timer);this.then();"succeeded"===b?this._fulfill(c):"failed"===b?this._reject(c):delete this._promise}};a.Publisher={countListeners:function(a){return this.listeners(a).length},
bind:function(a,c,d){var e=Array.prototype.slice,f=function(){c.apply(d,e.call(arguments))};this._listeners=this._listeners||[];this._listeners.push([a,c,d,f]);return this.on(a,f)},unbind:function(a,c,d){this._listeners=this._listeners||[];for(var e=this._listeners.length,f;e--;)if(f=this._listeners[e],f[0]===a&&(!c||!(f[1]!==c||f[2]!==d)))this._listeners.splice(e,1),this.removeListener(a,f[3])}};a.extend(a.Publisher,a.EventEmitter.prototype);a.Publisher.trigger=a.Publisher.emit;a.Timeouts={addTimeout:function(b,
c,d,e){this._timeouts=this._timeouts||{};if(!this._timeouts.hasOwnProperty(b)){var f=this;this._timeouts[b]=a.ENV.setTimeout(function(){delete f._timeouts[b];d.call(e)},1E3*c)}},removeTimeout:function(b){this._timeouts=this._timeouts||{};var c=this._timeouts[b];c&&(a.ENV.clearTimeout(c),delete this._timeouts[b])},removeAllTimeouts:function(){this._timeouts=this._timeouts||{};for(var a in this._timeouts)this.removeTimeout(a)}};a.Logging={LOG_LEVELS:{fatal:4,error:3,warn:2,info:1,debug:0},writeLog:function(b,
c){if(a.logger){var d=Array.prototype.slice.apply(b),e="[Faye",f=this.className,h=d.shift().replace(/\?/g,function(){try{return a.toJSON(d.shift())}catch(b){return"[Object]"}}),l;for(l in a)f||"function"===typeof a[l]&&this instanceof a[l]&&(f=l);f&&(e+="."+f);e+="] ";if("function"===typeof a.logger[c])a.logger[c](e+h);else"function"===typeof a.logger&&a.logger(e+h)}}};(function(){for(var b in a.Logging.LOG_LEVELS)(function(b){a.Logging[b]=function(){this.writeLog(arguments,b)}})(b)})();a.Grammar=
{CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/,
VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/};a.Extensible={addExtension:function(a){this._extensions=this._extensions||[];this._extensions.push(a);a.added&&a.added(this)},removeExtension:function(a){if(this._extensions)for(var c=this._extensions.length;c--;)this._extensions[c]===a&&(this._extensions.splice(c,1),a.removed&&a.removed(this))},pipeThroughExtensions:function(a,c,d,e,f){this.debug("Passing through ? extensions: ?",a,c);if(!this._extensions)return e.call(f,
c);var h=this._extensions.slice(),l=function(c){if(!c)return e.call(f,c);var q=h.shift();if(!q)return e.call(f,c);var u=q[a];if(!u)return l(c);if(3<=u.length)q[a](c,d,l);else q[a](c,l)};l(c)}};a.extend(a.Extensible,a.Logging);a.Channel=a.Class({initialize:function(a){this.id=this.name=a},push:function(a){this.trigger("message",a)},isUnused:function(){return 0===this.countListeners("message")}});a.extend(a.Channel.prototype,a.Publisher);a.extend(a.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",
SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(a){var c=this.parse(a);a=["/**",a];var d=c.slice();d[d.length-1]="*";a.push(this.unparse(d));for(var e=1,f=c.length;e<f;e++)d=c.slice(0,e),d.push("**"),a.push(this.unparse(d));return a},isValid:function(b){return a.Grammar.CHANNEL_NAME.test(b)||a.Grammar.CHANNEL_PATTERN.test(b)},parse:function(a){return!this.isValid(a)?null:a.split("/").slice(1)},unparse:function(a){return"/"+
a.join("/")},isMeta:function(a){return(a=this.parse(a))?a[0]===this.META:null},isService:function(a){return(a=this.parse(a))?a[0]===this.SERVICE:null},isSubscribable:function(a){return!this.isValid(a)?null:!this.isMeta(a)&&!this.isService(a)},Set:a.Class({initialize:function(){this._channels={}},getKeys:function(){var a=[],c;for(c in this._channels)a.push(c);return a},remove:function(a){delete this._channels[a]},hasSubscription:function(a){return this._channels.hasOwnProperty(a)},subscribe:function(b,
c,d){for(var e,f=0,h=b.length;f<h;f++)e=b[f],e=this._channels[e]=this._channels[e]||new a.Channel(e),c&&e.bind("message",c,d)},unsubscribe:function(a,c,d){var e=this._channels[a];if(!e)return!1;e.unbind("message",c,d);return e.isUnused()?(this.remove(a),!0):!1},distributeMessage:function(b){for(var c=a.Channel.expand(b.channel),d=0,e=c.length;d<e;d++){var f=this._channels[c[d]];f&&f.trigger("message",b.data)}}})});a.Publication=a.Class(a.Deferrable);a.Subscription=a.Class({initialize:function(a,c,
d,e){this._client=a;this._channels=c;this._callback=d;this._context=e;this._cancelled=!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}});a.extend(a.Subscription.prototype,a.Deferrable);a.Client=a.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(b,
c){this.info("New client created for ?",b);c=c||{};a.validateOptions(c,"interval timeout endpoints proxy retry scheduler websocketExtensions tls ca".split(" "));this._endpoint=b||this.DEFAULT_ENDPOINT;this._channels=new a.Channel.Set;this._dispatcher=new a.Dispatcher(this,this._endpoint,c);this._messageId=0;this._state=this.UNCONNECTED;this._responseCallbacks={};this._advice={reconnect:this.RETRY,interval:1E3*(c.interval||this.INTERVAL),timeout:1E3*(c.timeout||this.CONNECTION_TIMEOUT)};this._dispatcher.timeout=
this._advice.timeout/1E3;this._dispatcher.bind("message",this._receiveMessage,this);if(a.Event&&void 0!==a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",function(){0>a.indexOf(this._dispatcher._disabled,"autodisconnect")&&this.disconnect()},this)},addWebsocketExtension:function(a){return this._dispatcher.addWebsocketExtension(a)},disable:function(a){return this._dispatcher.disable(a)},setHeader:function(a,c){return this._dispatcher.setHeader(a,c)},handshake:function(b,c){if(this._advice.reconnect!==
this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var d=this;this.info("Initiating handshake with ?",a.URI.stringify(this._endpoint));this._dispatcher.selectTransport(a.MANDATORY_CONNECTION_TYPES);this._sendMessage({channel:a.Channel.HANDSHAKE,version:a.BAYEUX_VERSION,supportedConnectionTypes:this._dispatcher.getConnectionTypes()},{},function(e){e.successful?(this._state=this.CONNECTED,this._dispatcher.clientId=e.clientId,this._dispatcher.selectTransport(e.supportedConnectionTypes),
this.info("Handshake successful: ?",this._dispatcher.clientId),this.subscribe(this._channels.getKeys(),!0),b&&a.Promise.defer(function(){b.call(c)})):(this.info("Handshake unsuccessful"),a.ENV.setTimeout(function(){d.handshake(b,c)},1E3*this._dispatcher.retry),this._state=this.UNCONNECTED)},this)}},connect:function(b,c){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(b,c)},this);this.callback(b,
c);this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._dispatcher.clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("unknown"),this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._dispatcher.clientId),this._sendMessage({channel:a.Channel.CONNECT,clientId:this._dispatcher.clientId,connectionType:this._dispatcher.connectionType},{},this._cycleConnection,this)))}},disconnect:function(){if(this._state===this.CONNECTED){this._state=
this.DISCONNECTED;this.info("Disconnecting ?",this._dispatcher.clientId);var b=new a.Publication;this._sendMessage({channel:a.Channel.DISCONNECT,clientId:this._dispatcher.clientId},{},function(c){c.successful?(this._dispatcher.close(),b.setDeferredStatus("succeeded")):b.setDeferredStatus("failed",a.Error.parse(c.error))},this);this.info("Clearing channel listeners for ?",this._dispatcher.clientId);this._channels=new a.Channel.Set;return b}},subscribe:function(b,c,d){if(b instanceof Array)return a.map(b,
function(a){return this.subscribe(a,c,d)},this);var e=new a.Subscription(this,b,c,d),f=!0===c;if(this._channels.hasSubscription(b)&&!f)return this._channels.subscribe([b],c,d),e.setDeferredStatus("succeeded"),e;this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._dispatcher.clientId,b);f||this._channels.subscribe([b],c,d);this._sendMessage({channel:a.Channel.SUBSCRIBE,clientId:this._dispatcher.clientId,subscription:b},{},function(f){if(!f.successful)return e.setDeferredStatus("failed",
a.Error.parse(f.error)),this._channels.unsubscribe(b,c,d);f=[].concat(f.subscription);this.info("Subscription acknowledged for ? to ?",this._dispatcher.clientId,f);e.setDeferredStatus("succeeded")},this)},this);return e},unsubscribe:function(b,c,d){if(b instanceof Array)return a.map(b,function(a){return this.unsubscribe(a,c,d)},this);this._channels.unsubscribe(b,c,d)&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._dispatcher.clientId,b);this._sendMessage({channel:a.Channel.UNSUBSCRIBE,
clientId:this._dispatcher.clientId,subscription:b},{},function(a){a.successful&&(a=[].concat(a.subscription),this.info("Unsubscription acknowledged for ? from ?",this._dispatcher.clientId,a))},this)},this)},publish:function(b,c,d){a.validateOptions(d||{},["attempts","deadline"]);var e=new a.Publication;this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._dispatcher.clientId,b,c);this._sendMessage({channel:b,data:c,clientId:this._dispatcher.clientId},d,function(b){b.successful?
e.setDeferredStatus("succeeded"):e.setDeferredStatus("failed",a.Error.parse(b.error))},this)},this);return e},_sendMessage:function(a,c,d,e){a.id=this._generateMessageId();var f=this._advice.timeout?1.2*this._advice.timeout/1E3:1.2*this._dispatcher.retry;this.pipeThroughExtensions("outgoing",a,null,function(a){a&&(d&&(this._responseCallbacks[a.id]=[d,e]),this._dispatcher.sendMessage(a,f,c||{}))},this)},_generateMessageId:function(){this._messageId+=1;this._messageId>=Math.pow(2,32)&&(this._messageId=
0);return this._messageId.toString(36)},_receiveMessage:function(a){var c=a.id,d;void 0!==a.successful&&(d=this._responseCallbacks[c],delete this._responseCallbacks[c]);this.pipeThroughExtensions("incoming",a,null,function(a){a&&(a.advice&&this._handleAdvice(a.advice),this._deliverMessage(a),d&&d[0].call(d[1],a))},this)},_handleAdvice:function(b){a.extend(this._advice,b);this._dispatcher.timeout=this._advice.timeout/1E3;this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=
this.UNCONNECTED,this._dispatcher.clientId=null,this._cycleConnection())},_deliverMessage:function(a){a.channel&&void 0!==a.data&&(this.info("Client ? calling listeners for ? with ?",this._dispatcher.clientId,a.channel,a.data),this._channels.distributeMessage(a))},_cycleConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._dispatcher.clientId));var b=this;a.ENV.setTimeout(function(){b.connect()},this._advice.interval)}});a.extend(a.Client.prototype,
a.Deferrable);a.extend(a.Client.prototype,a.Publisher);a.extend(a.Client.prototype,a.Logging);a.extend(a.Client.prototype,a.Extensible);a.Dispatcher=a.Class({MAX_REQUEST_SIZE:2048,DEFAULT_RETRY:5,UP:1,DOWN:2,initialize:function(b,c,d){this._client=b;this.endpoint=a.URI.parse(c);this._alternates=d.endpoints||{};this.cookies=a.Cookies&&new a.Cookies.CookieJar;this._disabled=[];this._envelopes={};this.headers={};this.retry=d.retry||this.DEFAULT_RETRY;this._scheduler=d.scheduler||a.Scheduler;this._state=
0;this.transports={};this.wsExtensions=[];this.proxy=d.proxy||{};"string"===typeof this._proxy&&(this._proxy={origin:this._proxy});if(b=d.websocketExtensions){b=[].concat(b);c=0;for(var e=b.length;c<e;c++)this.addWebsocketExtension(b[c])}this.tls=d.tls||{};this.tls.ca=this.tls.ca||d.ca;for(var f in this._alternates)this._alternates[f]=a.URI.parse(this._alternates[f]);this.maxRequestSize=this.MAX_REQUEST_SIZE},endpointFor:function(a){return this._alternates[a]||this.endpoint},addWebsocketExtension:function(a){this.wsExtensions.push(a)},
disable:function(a){this._disabled.push(a)},setHeader:function(a,c){this.headers[a]=c},close:function(){var a=this._transport;delete this._transport;a&&a.close()},getConnectionTypes:function(){return a.Transport.getConnectionTypes()},selectTransport:function(b){a.Transport.get(this,b,this._disabled,function(b){this.debug("Selected ? transport for ?",b.connectionType,a.URI.stringify(b.endpoint));b!==this._transport&&(this._transport&&this._transport.close(),this._transport=b,this.connectionType=b.connectionType)},
this)},sendMessage:function(a,c,d){d=d||{};var e=a.id,f=d.attempts;d=d.deadline&&(new Date).getTime()+1E3*d.deadline;var h=this._envelopes[e];h||(c=new this._scheduler(a,{timeout:c,interval:this.retry,attempts:f,deadline:d}),h=this._envelopes[e]={message:a,scheduler:c});this._sendEnvelope(h)},_sendEnvelope:function(b){if(this._transport&&!b.request&&!b.timer){var c=b.message,d=b.scheduler,e=this;d.isDeliverable()?(b.timer=a.ENV.setTimeout(function(){e.handleError(c)},1E3*d.getTimeout()),d.send(),
b.request=this._transport.sendMessage(c)):(d.abort(),delete this._envelopes[c.id])}},handleResponse:function(b){var c=this._envelopes[b.id];void 0!==b.successful&&c&&(c.scheduler.succeed(),delete this._envelopes[b.id],a.ENV.clearTimeout(c.timer));this.trigger("message",b);this._state!==this.UP&&(this._state=this.UP,this._client.trigger("transport:up"))},handleError:function(b,c){var d=this._envelopes[b.id],e=d&&d.request,f=this;e&&(e.then(function(a){a&&a.abort&&a.abort()}),e=d.scheduler,e.fail(),
a.ENV.clearTimeout(d.timer),d.request=d.timer=null,c?this._sendEnvelope(d):d.timer=a.ENV.setTimeout(function(){d.timer=null;f._sendEnvelope(d)},1E3*e.getInterval()),this._state!==this.DOWN&&(this._state=this.DOWN,this._client.trigger("transport:down")))}});a.extend(a.Dispatcher.prototype,a.Publisher);a.extend(a.Dispatcher.prototype,a.Logging);a.Scheduler=function(a,c){this.message=a;this.options=c;this.attempts=0};a.extend(a.Scheduler.prototype,{getTimeout:function(){return this.options.timeout},
getInterval:function(){return this.options.interval},isDeliverable:function(){var a=this.options.attempts,c=this.attempts,d=this.options.deadline,e=(new Date).getTime();return void 0!==a&&c>=a||void 0!==d&&e>d?!1:!0},send:function(){this.attempts+=1},succeed:function(){},fail:function(){},abort:function(){}});a.Transport=a.extend(a.Class({DEFAULT_PORTS:{"http:":80,"https:":443,"ws:":80,"wss:":443},SECURE_PROTOCOLS:["https:","wss:"],MAX_DELAY:0,batching:!0,initialize:function(b,c){this._dispatcher=
b;this.endpoint=c;this._outbox=[];this._proxy=a.extend({},this._dispatcher.proxy);!this._proxy.origin&&a.NodeAdapter&&(this._proxy.origin=0<=a.indexOf(this.SECURE_PROTOCOLS,this.endpoint.protocol)?process.env.HTTPS_PROXY||process.env.https_proxy:process.env.HTTP_PROXY||process.env.http_proxy)},close:function(){},encode:function(a){return""},sendMessage:function(b){this.debug("Client ? sending message to ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),b);if(!this.batching)return a.Promise.fulfilled(this.request([b]));
this._outbox.push(b);this._flushLargeBatch();if(b.channel===a.Channel.HANDSHAKE)return this._publish(0.01);b.channel===a.Channel.CONNECT&&(this._connectMessage=b);return this._publish(this.MAX_DELAY)},_publish:function(b){this._promise=this._promise||new a.Promise;this.addTimeout("publish",b,function(){this._flush();delete this._promise},this);return this._promise},_flush:function(){this.removeTimeout("publish");1<this._outbox.length&&this._connectMessage&&(this._connectMessage.advice={timeout:0});
a.Promise.fulfill(this._promise,this.request(this._outbox));this._connectMessage=null;this._outbox=[]},_flushLargeBatch:function(){if(!(this.encode(this._outbox).length<this._dispatcher.maxRequestSize)){var b=this._outbox.pop();this._promise=this._promise||new a.Promise;this._flush();b&&this._outbox.push(b)}},_receive:function(b){if(b){b=[].concat(b);this.debug("Client ? received from ? via ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),this.connectionType,b);for(var c=0,d=b.length;c<
d;c++)this._dispatcher.handleResponse(b[c])}},_handleError:function(b,c){b=[].concat(b);this.debug("Client ? failed to send to ? via ?: ?",this._dispatcher.clientId,a.URI.stringify(this.endpoint),this.connectionType,b);for(var d=0,e=b.length;d<e;d++)this._dispatcher.handleError(b[d])},_getCookies:function(){var b=this._dispatcher.cookies,c=a.URI.stringify(this.endpoint);return!b?"":a.map(b.getCookiesSync(c),function(a){return a.cookieString()}).join("; ")},_storeCookies:function(b){var c=this._dispatcher.cookies,
d=a.URI.stringify(this.endpoint),e;if(b&&c){b=[].concat(b);for(var f=0,h=b.length;f<h;f++)e=a.Cookies.Cookie.parse(b[f]),c.setCookieSync(e,d)}}}),{get:function(b,c,d,e,f){var h=b.endpoint;a.asyncEach(this._transports,function(h,g){var q=h[0],u=h[1],s=b.endpointFor(q);if(0<=a.indexOf(d,q))return g();if(0>a.indexOf(c,q))return u.isUsable(b,s,function(){}),g();u.isUsable(b,s,function(a){if(!a)return g();a=u.hasOwnProperty("create")?u.create(b,s):new u(b,s);e.call(f,a)})},function(){throw Error("Could not find a usable connection type for "+
a.URI.stringify(h));})},register:function(a,c){this._transports.push([a,c]);c.prototype.connectionType=a},getConnectionTypes:function(){return a.map(this._transports,function(a){return a[0]})},_transports:[]});a.extend(a.Transport.prototype,a.Logging);a.extend(a.Transport.prototype,a.Timeouts);a.Event={_registry:[],on:function(a,c,d,e){var f=function(){d.call(e)};a.addEventListener?a.addEventListener(c,f,!1):a.attachEvent("on"+c,f);this._registry.push({_element:a,_type:c,_callback:d,_context:e,_handler:f})},
detach:function(a,c,d,e){for(var f=this._registry.length,h;f--;)h=this._registry[f],a&&a!==h._element||(c&&c!==h._type||d&&d!==h._callback||e&&e!==h._context)||(h._element.removeEventListener?h._element.removeEventListener(h._type,h._handler,!1):h._element.detachEvent("on"+h._type,h._handler),this._registry.splice(f,1))}};if(void 0!==a.ENV.onunload)a.Event.on(a.ENV,"unload",a.Event.detach,a.Event);"object"!==typeof JSON&&(JSON={});(function(){function b(a){return 10>a?"0"+a:a}function c(a){f.lastIndex=
0;return f.test(a)?'"'+a.replace(f,function(a){var b=g[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function d(a,b){var e,f,g,A,v=h,z,y=b[a];y&&("object"===typeof y&&"function"===typeof y.toJSON)&&(y=y.toJSON(a));"function"===typeof q&&(y=q.call(b,a,y));switch(typeof y){case "string":return c(y);case "number":return isFinite(y)?String(y):"null";case "boolean":case "null":return String(y);case "object":if(!y)return"null";h+=l;z=[];if("[object Array]"===
Object.prototype.toString.apply(y)){A=y.length;for(e=0;e<A;e+=1)z[e]=d(e,y)||"null";g=0===z.length?"[]":h?"[\n"+h+z.join(",\n"+h)+"\n"+v+"]":"["+z.join(",")+"]";h=v;return g}if(q&&"object"===typeof q){A=q.length;for(e=0;e<A;e+=1)"string"===typeof q[e]&&(f=q[e],(g=d(f,y))&&z.push(c(f)+(h?": ":":")+g))}else for(f in y)Object.prototype.hasOwnProperty.call(y,f)&&(g=d(f,y))&&z.push(c(f)+(h?": ":":")+g);g=0===z.length?"{}":h?"{\n"+h+z.join(",\n"+h)+"\n"+v+"}":"{"+z.join(",")+"}";h=v;return g}}"function"!==
typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+b(this.getUTCMonth()+1)+"-"+b(this.getUTCDate())+"T"+b(this.getUTCHours())+":"+b(this.getUTCMinutes())+":"+b(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var e=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
h,l,g={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},q;a.stringify=function(a,b,c){var e;l=h="";if("number"===typeof c)for(e=0;e<c;e+=1)l+=" ";else"string"===typeof c&&(l=c);if((q=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return d("",{"":a})};"function"!==typeof JSON.stringify&&(JSON.stringify=a.stringify);"function"!==typeof JSON.parse&&(JSON.parse=function(a,b){function c(a,d){var e,f,g=a[d];if(g&&"object"===
typeof g)for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&(f=c(g,e),void 0!==f?g[e]=f:delete g[e]);return b.call(a,d,g)}var d;a=String(a);e.lastIndex=0;e.test(a)&&(a=a.replace(e,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return d=eval("("+a+")"),"function"===typeof b?c({"":d},
""):d;throw new SyntaxError("JSON.parse");})})();a.Transport.WebSocket=a.extend(a.Class(a.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(a,c){this.callback(function(){a.call(c,!0)});this.errback(function(){a.call(c,!1)});this.connect()},request:function(b){this._pending=this._pending||new a.Set;for(var c=0,d=b.length;c<d;c++)this._pending.add(b[c]);var e=new a.Promise;this.callback(function(c){c&&1===c.readyState&&(c.send(a.toJSON(b)),a.Promise.fulfill(e,c))},this);
this.connect();return{abort:function(){e.then(function(a){a.close()})}}},connect:function(){if(!a.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var b=this._createSocket();if(!b)return this.setDeferredStatus("failed");var c=this;b.onopen=function(){b.headers&&c._storeCookies(b.headers["set-cookie"]);c._socket=b;c._state=c.CONNECTED;c._everConnected=!0;c._ping();c.setDeferredStatus("succeeded",b)};var d=!1;b.onclose=
b.onerror=function(){if(!d){d=!0;var a=c._state===c.CONNECTED;b.onopen=b.onclose=b.onerror=b.onmessage=null;delete c._socket;c._state=c.UNCONNECTED;c.removeTimeout("ping");var f=c._pending?c._pending.toArray():[];delete c._pending;a||c._everConnected?(c.setDeferredStatus("unknown"),c._handleError(f,a)):c.setDeferredStatus("failed")}};b.onmessage=function(a){if(a=JSON.parse(a.data)){a=[].concat(a);for(var b=0,d=a.length;b<d;b++)void 0!==a[b].successful&&c._pending.remove(a[b]);c._receive(a)}}}},close:function(){this._socket&&
this._socket.close()},_createSocket:function(){var b=a.Transport.WebSocket.getSocketUrl(this.endpoint),c=this._dispatcher.headers,d=this._dispatcher.wsExtensions,e=this._getCookies(),c={extensions:d,headers:c,proxy:this._proxy,tls:this._dispatcher.tls};""!==e&&(c.headers.Cookie=e);if(a.WebSocket)return new a.WebSocket.Client(b,[],c);if(a.ENV.MozWebSocket)return new MozWebSocket(b);if(a.ENV.WebSocket)return new WebSocket(b)},_ping:function(){this._socket&&1===this._socket.readyState&&(this._socket.send("[]"),
this.addTimeout("ping",this._dispatcher.timeout/2,this._ping,this))}}),{PROTOCOLS:{"http:":"ws:","https:":"wss:"},create:function(a,c){var d=a.transports.websocket=a.transports.websocket||{};d[c.href]=d[c.href]||new this(a,c);return d[c.href]},getSocketUrl:function(b){b=a.copyObject(b);b.protocol=this.PROTOCOLS[b.protocol];return a.URI.stringify(b)},isUsable:function(a,c,d,e){this.create(a,c).isUsable(d,e)}});a.extend(a.Transport.WebSocket.prototype,a.Deferrable);a.Transport.register("websocket",
a.Transport.WebSocket);if(a.Event&&void 0!==a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",function(){a.Transport.WebSocket._unloaded=!0});a.Transport.EventSource=a.extend(a.Class(a.Transport,{initialize:function(b,c){a.Transport.prototype.initialize.call(this,b,c);if(!a.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new a.Transport.XHR(b,c);c=a.copyObject(c);c.pathname+="/"+b.clientId;var d=new EventSource(a.URI.stringify(c)),e=this;d.onopen=function(){e._everConnected=!0;
e.setDeferredStatus("succeeded")};d.onerror=function(){e._everConnected?e._handleError([]):(e.setDeferredStatus("failed"),d.close())};d.onmessage=function(a){e._receive(JSON.parse(a.data))};this._socket=d},close:function(){this._socket&&(this._socket.onopen=this._socket.onerror=this._socket.onmessage=null,this._socket.close(),delete this._socket)},isUsable:function(a,c){this.callback(function(){a.call(c,!0)});this.errback(function(){a.call(c,!1)})},encode:function(a){return this._xhr.encode(a)},request:function(a){return this._xhr.request(a)}}),
{isUsable:function(b,c,d,e){if(!b.clientId)return d.call(e,!1);a.Transport.XHR.isUsable(b,c,function(a){if(!a)return d.call(e,!1);this.create(b,c).isUsable(d,e)},this)},create:function(b,c){var d=b.transports.eventsource=b.transports.eventsource||{},e=b.clientId,f=a.copyObject(c);f.pathname+="/"+(e||"");f=a.URI.stringify(f);d[f]=d[f]||new this(b,c);return d[f]}});a.extend(a.Transport.EventSource.prototype,a.Deferrable);a.Transport.register("eventsource",a.Transport.EventSource);a.Transport.XHR=a.extend(a.Class(a.Transport,
{encode:function(b){return a.toJSON(b)},request:function(b){var c=this.endpoint.href,d,e=this;try{d=new XMLHttpRequest}catch(f){d=a.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest}d.open("POST",c,!0);d.setRequestHeader("Content-Type","application/json");d.setRequestHeader("Pragma","no-cache");d.setRequestHeader("X-Requested-With","XMLHttpRequest");var c=this._dispatcher.headers,h;for(h in c)c.hasOwnProperty(h)&&d.setRequestHeader(h,c[h]);var l=function(){d.abort()};if(void 0!==
a.ENV.onbeforeunload)a.Event.on(a.ENV,"beforeunload",l);d.onreadystatechange=function(){if(d&&4===d.readyState){var c=null,f=d.status,h=d.responseText,f=200<=f&&300>f||304===f||1223===f;void 0!==a.ENV.onbeforeunload&&a.Event.detach(a.ENV,"beforeunload",l);d.onreadystatechange=function(){};d=null;if(!f)return e._handleError(b);try{c=JSON.parse(h)}catch(s){}c?e._receive(c):e._handleError(b)}};d.send(this.encode(b));return d}}),{isUsable:function(b,c,d,e){d.call(e,a.URI.isSameOrigin(c))}});a.Transport.register("long-polling",
a.Transport.XHR);a.Transport.CORS=a.extend(a.Class(a.Transport,{encode:function(b){return"message="+encodeURIComponent(a.toJSON(b))},request:function(b){var c=a.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,d=new c,e=++a.Transport.CORS._id,f=this._dispatcher.headers,h=this,l;d.open("POST",a.URI.stringify(this.endpoint),!0);if(d.setRequestHeader)for(l in d.setRequestHeader("Pragma","no-cache"),f)f.hasOwnProperty(l)&&d.setRequestHeader(l,f[l]);var g=function(){if(!d)return!1;a.Transport.CORS._pending.remove(e);
d=d.onload=d.onerror=d.ontimeout=d.onprogress=null};d.onload=function(){var a=null;try{a=JSON.parse(d.responseText)}catch(c){}g();a?h._receive(a):h._handleError(b)};d.onerror=d.ontimeout=function(){g();h._handleError(b)};d.onprogress=function(){};c===a.ENV.XDomainRequest&&a.Transport.CORS._pending.add({id:e,xhr:d});d.send(this.encode(b));return d}}),{_id:0,_pending:new a.Set,isUsable:function(b,c,d,e){return a.URI.isSameOrigin(c)?d.call(e,!1):a.ENV.XDomainRequest?d.call(e,c.protocol===a.ENV.location.protocol):
a.ENV.XMLHttpRequest?(b=new a.ENV.XMLHttpRequest,d.call(e,void 0!==b.withCredentials)):d.call(e,!1)}});a.Transport.register("cross-origin-long-polling",a.Transport.CORS);a.Transport.JSONP=a.extend(a.Class(a.Transport,{encode:function(b){var c=a.copyObject(this.endpoint);c.query.message=a.toJSON(b);c.query.jsonp="__jsonp"+a.Transport.JSONP._cbCount+"__";return a.URI.stringify(c)},request:function(b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script"),e=a.Transport.JSONP.getCallbackName(),
f=a.copyObject(this.endpoint),h=this;f.query.message=a.toJSON(b);f.query.jsonp=e;var l=function(){if(!a.ENV[e])return!1;a.ENV[e]=void 0;try{delete a.ENV[e]}catch(b){}d.parentNode.removeChild(d)};a.ENV[e]=function(a){l();h._receive(a)};d.type="text/javascript";d.src=a.URI.stringify(f);c.appendChild(d);d.onerror=function(){l();h._handleError(b)};return{abort:l}}}),{_cbCount:0,getCallbackName:function(){this._cbCount+=1;return"__jsonp"+this._cbCount+"__"},isUsable:function(a,c,d,e){d.call(e,!0)}});a.Transport.register("callback-polling",
a.Transport.JSONP)})();var slice=Array.prototype.slice;Evented={on:function(a,b,c){var d;this.__callbacks||(this.__callbacks={});this.__callbacks[a]||(this.__callbacks[a]=[]);c?(d=slice.call(arguments,3),d.unshift(b),d=Function.prototype.bind.apply(b[c],d)):d=b;this.__callbacks[a].push(d)},trigger:function(a){var b=slice.call(arguments,1);this.__callbacks&&this.__callbacks[a]&&$j.each(this.__callbacks[a],function(a,d){d.apply(null,b)})}};
(function(){if("undefined"!==typeof Faye){var a=Faye.Transport.prototype._receive;Faye.Transport.prototype._receive=function(){a.apply(this,arguments);var b=this._dispatcher;b._state!==b.UP&&(b._state=b.UP,b._client.trigger("transport:up"))}}})();FayeBackoffScheduler=function(){Faye.Scheduler.apply(this,arguments)};
(function(){function a(){}a.prototype=Faye.Scheduler.prototype;FayeBackoffScheduler.prototype=new a;FayeBackoffScheduler.prototype.getInterval=function(){delay=Math.pow(this.attempts,2)+Math.random(5);return Math.min(60,delay)}})();
FayeMessageTransformer=function(){return{transform:function(a){a={version:a[0],kuid:a[1],uuid:a[2],text:a[3],timestamp:a[4],user_id:a[5],username:a[6],character_name:a[7],level:a[8],admin:0<=a[10].indexOf("a"),developer:0<=a[10].indexOf("d"),mobile:0<=a[10].indexOf("m"),premium:0<=a[10].indexOf("p"),guid:a[9]};"0"===a.kuid?(a.data=JSON.parse(a.text),a.type=a.data.type):a.type="chat";return a}}}();FayeConnectionMonitor=function(a){this.initialize(a)};
(function(){FayeConnectionMonitor.prototype={initialize:function(a){this._client=a.client;this._transportDown=!1;this._disconnected=!0;this._disconnectTimeout=a.timeout||2E4;this._addListeners()},isConnected:function(){return!this._disconnected},destroy:function(){this._removeListeners();this._clearTimeout();this._client=void 0},_clearTimeout:function(){clearTimeout(this._timeout);this._timeout=void 0},_addListeners:function(){var a=this;this._upListener=function(){var b=a._disconnected;a._clearTimeout();
a._transportDown=!1;a._disconnected=!1;b&&a.trigger("connect")};this._downListener=function(){a._transportDown=!0;a._timeout=setTimeout(function(){a._transportDown&&a._client&&(a._disconnected=!0,a._ping(),a.trigger("disconnect"))},a._disconnectTimeout)};this._client.on("transport:up",this._upListener);this._client.on("transport:down",this._downListener)},_removeListeners:function(){this._client.removeListener("transport:up",this._upListener);this._client.removeListener("transport:down",this._downListener);
this._upListener=this._downListener=void 0},_isWebSocket:function(){return"websocket"===this._client._dispatcher.connectionType},_ping:function(){this._isWebSocket()||this._client.publish("/service/ping",{})}};$j.extend(FayeConnectionMonitor.prototype,Evented)})();
var CropDraggable=Class.create(Draggable,{initialize:function(a,b){this.options=Object.extend({drawMethod:function(){}},b||{});this.handle=this.element=$(a);this.delta=this.currentDelta();this.dragging=!1;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},draw:function(a){var b=Element.cumulativeOffset(this.element),c=this.currentDelta();b[0]-=c[0];b[1]-=c[1];c=[0,1].map(function(c){return a[c]-b[c]-this.offset[c]}.bind(this));
this.options.drawMethod(c)}}),Cropper={};
Cropper.Img=Class.create({initialize:function(a,b){this.options=Object.extend({ratioDim:{x:0,y:0},minWidth:0,minHeight:0,displayOnInit:!1,onEndCrop:Prototype.emptyFunction,captureKeys:!0,onloadCoords:null,maxWidth:0,maxHeight:0,autoIncludeCSS:!1},b||{});this.img=$(a);this.clickCoords={x:0,y:0};this.resizing=this.dragging=!1;this.isWebKit=/Konqueror|Safari|KHTML/.test(navigator.userAgent);this.isIE=/MSIE/.test(navigator.userAgent);this.isOpera8=/Opera\s[1-8]/.test(navigator.userAgent);this.ratioY=
this.ratioX=0;this.attached=!1;this.fixedWidth=0<this.options.maxWidth&&this.options.minWidth>=this.options.maxWidth;this.fixedHeight=0<this.options.maxHeight&&this.options.minHeight>=this.options.maxHeight;if("undefined"!=typeof this.img){this.options.autoIncludeCSS&&$$("script").each(function(a){if(a.src.match(/\/cropper([^\/]*)\.js/)){a=a.src.replace(/\/cropper([^\/]*)\.js.*/,"");var b=document.createElement("link");b.rel="stylesheet";b.type="text/css";b.href=a+"/cropper.css";b.media="screen";
document.getElementsByTagName("head")[0].appendChild(b)}});if(0<this.options.ratioDim.x&&0<this.options.ratioDim.y){var c=this.getGCD(this.options.ratioDim.x,this.options.ratioDim.y);this.ratioX=this.options.ratioDim.x/c;this.ratioY=this.options.ratioDim.y/c}this.subInitialize();if(this.img.complete||this.isWebKit)this.onLoad();else Event.observe(this.img,"load",this.onLoad.bindAsEventListener(this))}},getGCD:function(a,b){return 0===b?a:this.getGCD(b,a%b)},onLoad:function(){var a=this.img.parentNode,
b="";this.isOpera8&&(b=" opera8");this.imgWrap=new Element("div",{"class":"imgCrop_wrap"+b});this.north=(new Element("div",{"class":"imgCrop_overlay imgCrop_north"})).insert(new Element("span"));this.east=(new Element("div",{"class":"imgCrop_overlay imgCrop_east"})).insert(new Element("span"));this.south=(new Element("div",{"class":"imgCrop_overlay imgCrop_south"})).insert(new Element("span"));this.west=(new Element("div",{"class":"imgCrop_overlay imgCrop_west"})).insert(new Element("span"));b=[this.north,
this.east,this.south,this.west];this.dragArea=new Element("div",{"class":"imgCrop_dragArea"});b.each(function(a){this.dragArea.insert(a)},this);this.handleN=new Element("div",{"class":"imgCrop_handle imgCrop_handleN"});this.handleNE=new Element("div",{"class":"imgCrop_handle imgCrop_handleNE"});this.handleE=new Element("div",{"class":"imgCrop_handle imgCrop_handleE"});this.handleSE=new Element("div",{"class":"imgCrop_handle imgCrop_handleSE"});this.handleS=new Element("div",{"class":"imgCrop_handle imgCrop_handleS"});
this.handleSW=new Element("div",{"class":"imgCrop_handle imgCrop_handleSW"});this.handleW=new Element("div",{"class":"imgCrop_handle imgCrop_handleW"});this.handleNW=new Element("div",{"class":"imgCrop_handle imgCrop_handleNW"});this.selArea=new Element("div",{"class":"imgCrop_selArea"});[(new Element("div",{"class":"imgCrop_marqueeHoriz imgCrop_marqueeNorth"})).insert(new Element("span")),(new Element("div",{"class":"imgCrop_marqueeVert imgCrop_marqueeEast"})).insert(new Element("span")),(new Element("div",
{"class":"imgCrop_marqueeHoriz imgCrop_marqueeSouth"})).insert(new Element("span")),(new Element("div",{"class":"imgCrop_marqueeVert imgCrop_marqueeWest"})).insert(new Element("span")),this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW,new Element("div",{"class":"imgCrop_clickArea"})].each(function(a){this.selArea.insert(a)},this);this.imgWrap.appendChild(this.img);this.imgWrap.appendChild(this.dragArea);this.dragArea.appendChild(this.selArea);
this.dragArea.appendChild(new Element("div",{"class":"imgCrop_clickArea"}));a.appendChild(this.imgWrap);this.startDragBind=this.startDrag.bindAsEventListener(this);Event.observe(this.dragArea,"mousedown",this.startDragBind);this.onDragBind=this.onDrag.bindAsEventListener(this);Event.observe(document,"mousemove",this.onDragBind);this.endCropBind=this.endCrop.bindAsEventListener(this);Event.observe(document,"mouseup",this.endCropBind);this.resizeBind=this.startResize.bindAsEventListener(this);this.handles=
[this.handleN,this.handleNE,this.handleE,this.handleSE,this.handleS,this.handleSW,this.handleW,this.handleNW];this.registerHandles(!0);this.options.captureKeys&&(this.keysBind=this.handleKeys.bindAsEventListener(this),Event.observe(document,"keypress",this.keysBind));new CropDraggable(this.selArea,{drawMethod:this.moveArea.bindAsEventListener(this)});this.setParams()},registerHandles:function(a){for(var b=0;b<this.handles.length;b++){var c=$(this.handles[b]);if(a){var d=!1;if(this.fixedWidth&&this.fixedHeight)d=
!0;else if(this.fixedWidth||this.fixedHeight){var e=c.className.match(/([S|N][E|W])$/),f=c.className.match(/(E|W)$/),h=c.className.match(/(N|S)$/);if(e||this.fixedWidth&&f||this.fixedHeight&&h)d=!0}d?c.hide():Event.observe(c,"mousedown",this.resizeBind)}else c.show(),Event.stopObserving(c,"mousedown",this.resizeBind)}},setParams:function(){this.imgW=this.img.width;this.imgH=this.img.height;$(this.north).setStyle({height:0});$(this.east).setStyle({width:0,height:0});$(this.south).setStyle({height:0});
$(this.west).setStyle({width:0,height:0});$(this.imgWrap).setStyle({width:this.imgW+"px",height:this.imgH+"px"});$(this.selArea).hide();var a={x1:0,y1:0,x2:0,y2:0},b=!1;null!==this.options.onloadCoords?(a=this.cloneCoords(this.options.onloadCoords),b=!0):0<this.options.ratioDim.x&&0<this.options.ratioDim.y&&(a.x1=Math.ceil((this.imgW-this.options.ratioDim.x)/2),a.y1=Math.ceil((this.imgH-this.options.ratioDim.y)/2),a.x2=a.x1+this.options.ratioDim.x,a.y2=a.y1+this.options.ratioDim.y,b=!0);this.setAreaCoords(a,
!1,!1,1);this.options.displayOnInit&&b&&(this.selArea.show(),this.drawArea(),this.endCrop());this.attached=!0},remove:function(){this.attached&&(this.attached=!1,this.imgWrap.parentNode.insertBefore(this.img,this.imgWrap),this.imgWrap.parentNode.removeChild(this.imgWrap),Event.stopObserving(this.dragArea,"mousedown",this.startDragBind),Event.stopObserving(document,"mousemove",this.onDragBind),Event.stopObserving(document,"mouseup",this.endCropBind),this.registerHandles(!1),this.options.captureKeys&&
Event.stopObserving(document,"keypress",this.keysBind))},reset:function(){if(this.attached)this.setParams();else this.onLoad();this.endCrop()},handleKeys:function(a){var b=0,c=0;if(!this.dragging){switch(a.keyCode){case 37:b=-1;break;case 38:c=-1;break;case 39:b=1;break;case 40:c=1}if(0!==b||0!==c)a.shiftKey&&(b*=10,c*=10),this.moveArea([this.areaCoords.x1+b,this.areaCoords.y1+c]),this.endCrop(),Event.stop(a)}},calcW:function(){return this.areaCoords.x2-this.areaCoords.x1},calcH:function(){return this.areaCoords.y2-
this.areaCoords.y1},moveArea:function(a){this.setAreaCoords({x1:a[0],y1:a[1],x2:a[0]+this.calcW(),y2:a[1]+this.calcH()},!0,!1);this.drawArea()},cloneCoords:function(a){return{x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2}},setAreaCoords:function(a,b,c,d,e){if(b)c=a.x2-a.x1,d=a.y2-a.y1,0>a.x1&&(a.x1=0,a.x2=c),0>a.y1&&(a.y1=0,a.y2=d),a.x2>this.imgW&&(a.x2=this.imgW,a.x1=this.imgW-c),a.y2>this.imgH&&(a.y2=this.imgH,a.y1=this.imgH-d);else if(0>a.x1&&(a.x1=0),0>a.y1&&(a.y1=0),a.x2>this.imgW&&(a.x2=this.imgW),a.y2>this.imgH&&
(a.y2=this.imgH),null!==d&&(0<this.ratioX?this.applyRatio(a,{x:this.ratioX,y:this.ratioY},d,e):c&&this.applyRatio(a,{x:1,y:1},d,e),b=[this.options.minWidth,this.options.minHeight],e=[this.options.maxWidth,this.options.maxHeight],0<b[0]||0<b[1]||0<e[0]||0<e[1])){var f={a1:a.x1,a2:a.x2};a={a1:a.y1,a2:a.y2};var h={min:0,max:this.imgW},l={min:0,max:this.imgH};if((0!==b[0]||0!==b[1])&&c)0<b[0]?b[1]=b[0]:0<b[1]&&(b[0]=b[1]);if((0!==e[0]||0!==e[0])&&c)0<e[0]&&e[0]<=e[1]?e[1]=e[0]:0<e[1]&&e[1]<=e[0]&&(e[0]=
e[1]);0<b[0]&&this.applyDimRestriction(f,b[0],d.x,h,"min");1<b[1]&&this.applyDimRestriction(a,b[1],d.y,l,"min");0<e[0]&&this.applyDimRestriction(f,e[0],d.x,h,"max");1<e[1]&&this.applyDimRestriction(a,e[1],d.y,l,"max");a={x1:f.a1,y1:a.a1,x2:f.a2,y2:a.a2}}this.areaCoords=a},applyDimRestriction:function(a,b,c,d,e){if("min"==e?a.a2-a.a1<b:a.a2-a.a1>b)1==c?a.a2=a.a1+b:a.a1=a.a2-b,a.a1<d.min?(a.a1=d.min,a.a2=b):a.a2>d.max&&(a.a1=d.max-b,a.a2=d.max)},applyRatio:function(a,b,c,d){"N"==d||"S"==d?(b=this.applyRatioToAxis({a1:a.y1,
b1:a.x1,a2:a.y2,b2:a.x2},{a:b.y,b:b.x},{a:c.y,b:c.x},{min:0,max:this.imgW}),a.x1=b.b1,a.y1=b.a1,a.x2=b.b2,a.y2=b.a2):(b=this.applyRatioToAxis({a1:a.x1,b1:a.y1,a2:a.x2,b2:a.y2},{a:b.x,b:b.y},{a:c.x,b:c.y},{min:0,max:this.imgH}),a.x1=b.a1,a.y1=b.b1,a.x2=b.a2,a.y2=b.b2)},applyRatioToAxis:function(a,b,c,d){a=Object.extend(a,{});var e=Math.floor((a.a2-a.a1)*b.b/b.a),f=null,h=f=null;1==c.b?(f=a.b1+e,f>d.max&&(f=d.max,h=f-a.b1),a.b2=f):(f=a.b2-e,f<d.min&&(f=d.min,h=f+a.b2),a.b1=f);null!==h&&(f=Math.floor(h*
b.a/b.b),1==c.a?a.a2=a.a1+f:a.a1=a.a1=a.a2-f);return a},drawArea:function(){var a=this.calcW(),b=this.calcH(),c=[this.areaCoords.x1+"px",this.areaCoords.y1+"px",a+"px",b+"px",this.areaCoords.x2+"px",this.areaCoords.y2+"px",this.img.width-this.areaCoords.x2+"px",this.img.height-this.areaCoords.y2+"px"],d=this.selArea.style;d.left=c[0];d.top=c[1];d.width=c[2];d.height=c[3];a=Math.ceil((a-6)/2)+"px";b=Math.ceil((b-6)/2)+"px";this.handleN.style.left=a;this.handleE.style.top=b;this.handleS.style.left=
a;this.handleW.style.top=b;this.north.style.height=c[1];b=this.east.style;b.top=c[1];b.height=c[3];b.left=c[4];b.width=c[6];b=this.south.style;b.top=c[5];b.height=c[7];b=this.west.style;b.top=c[1];b.height=c[3];b.width=c[0];this.subDrawArea();this.forceReRender()},forceReRender:function(){if(this.isIE||this.isWebKit){var a=document.createTextNode(" "),b,c,d;if(this.isIE)fixEl=this.selArea;else if(this.isWebKit){fixEl=document.getElementsByClassName("imgCrop_marqueeSouth",this.imgWrap)[0];b=new Element("div");
b.style.visibility="hidden";var e=["SE","S","SW"];for(d=0;d<e.length;d++)c=document.getElementsByClassName("imgCrop_handle"+e[d],this.selArea)[0],c.childNodes.length&&c.removeChild(c.childNodes[0]),c.appendChild(b)}fixEl.appendChild(a);fixEl.removeChild(a)}},startResize:function(a){this.startCoords=this.cloneCoords(this.areaCoords);this.resizing=!0;this.resizeHandle=Event.element(a).classNames().toString().replace(/([^N|NE|E|SE|S|SW|W|NW])+/,"");Event.stop(a)},startDrag:function(a){this.selArea.show();
this.clickCoords=this.getCurPos(a);this.setAreaCoords({x1:this.clickCoords.x,y1:this.clickCoords.y,x2:this.clickCoords.x,y2:this.clickCoords.y},!1,!1,null);this.dragging=!0;this.onDrag(a);Event.stop(a)},getCurPos:function(a){for(var b=this.imgWrap,c=Element.cumulativeOffset(b);"BODY"!=b.nodeName;)c[1]-=b.scrollTop||0,c[0]-=b.scrollLeft||0,b=b.parentNode;return{x:Event.pointerX(a)-c[0],y:Event.pointerY(a)-c[1]}},onDrag:function(a){if(this.dragging||this.resizing){var b=null,c=this.getCurPos(a),d=this.cloneCoords(this.areaCoords),
e={x:1,y:1};this.dragging?(c.x<this.clickCoords.x&&(e.x=-1),c.y<this.clickCoords.y&&(e.y=-1),this.transformCoords(c.x,this.clickCoords.x,d,"x"),this.transformCoords(c.y,this.clickCoords.y,d,"y")):this.resizing&&(b=this.resizeHandle,b.match(/E/)?(this.transformCoords(c.x,this.startCoords.x1,d,"x"),c.x<this.startCoords.x1&&(e.x=-1)):b.match(/W/)&&(this.transformCoords(c.x,this.startCoords.x2,d,"x"),c.x<this.startCoords.x2&&(e.x=-1)),b.match(/N/)?(this.transformCoords(c.y,this.startCoords.y2,d,"y"),
c.y<this.startCoords.y2&&(e.y=-1)):b.match(/S/)&&(this.transformCoords(c.y,this.startCoords.y1,d,"y"),c.y<this.startCoords.y1&&(e.y=-1)));this.setAreaCoords(d,!1,a.shiftKey,e,b);this.drawArea();Event.stop(a)}},transformCoords:function(a,b,c,d){var e=[a,b];a>b&&e.reverse();c[d+"1"]=e[0];c[d+"2"]=e[1]},endCrop:function(){this.resizing=this.dragging=!1;this.options.onEndCrop(this.areaCoords,{width:this.calcW(),height:this.calcH()})},subInitialize:function(){},subDrawArea:function(){}});
Cropper.ImgWithPreview=Class.create(Cropper.Img,{subInitialize:function(){this.hasPreviewImg=!1;"undefined"!=typeof this.options.previewWrap&&(0<this.options.minWidth&&0<this.options.minHeight)&&(this.previewWrap=$(this.options.previewWrap),this.previewImg=this.img.cloneNode(!1),this.previewImg.id="imgCrop_"+this.previewImg.id,this.hasPreviewImg=this.options.displayOnInit=!0,this.previewWrap.addClassName("imgCrop_previewWrap"),this.previewWrap.setStyle({width:this.options.minWidth+"px",height:this.options.minHeight+
"px"}),this.previewWrap.appendChild(this.previewImg))},subDrawArea:function(){if(this.hasPreviewImg){var a=this.calcW(),b=this.calcH(),c=this.imgH/b,d=a/this.options.minWidth,b=b/this.options.minHeight,a=Math.ceil(this.options.minWidth*(this.imgW/a))+"px",c=Math.ceil(this.options.minHeight*c)+"px",d="-"+Math.ceil(this.areaCoords.x1/d)+"px",b="-"+Math.ceil(this.areaCoords.y1/b)+"px",e=this.previewImg.style;e.width=a;e.height=c;e.left=d;e.top=b}}});
if("undefined"==typeof unityObject)var unityObject=function(){function a(a,b,c){if(a==da){if(null==X||X==da)return}else if(null!=X)return;X=a;qa.send(a,b,c)}function b(a,b,c,d){X=a;qa.send(a,b,c,d)}function c(a){a=RegExp(escape(a)+"=([^;]+)");return a.test(t.cookie+";")?(a.exec(t.cookie+";"),RegExp.$1):!1}function d(a){P?a():ea[ea.length]=a}function e(){if(!P){try{var a=t.getElementsByTagName("body")[0],b=a.appendChild(t.createElement("span"));a.removeChild(b)}catch(c){return}P=!0;for(a=0;a<ea.length;++a)ea[a]()}}
function f(a){if(typeof C.addEventListener!=D)C.addEventListener("load",a,!1);else if(typeof t.addEventListener!=D)t.addEventListener("load",a,!1);else if(typeof C.attachEvent!=D)h(C,"onload",a);else if("function"==typeof window.onload){var b=window.onload;C.onload=function(){b();a()}}else C.onload=a}function h(a,b,c){a.attachEvent(b,c);fa[fa.length]={target:a,type:b,event:c}}function l(a){var b=0;if(a){var c=a.toLowerCase().match(/^(\d+)(?:\.(\d+)(?:\.(\d+)([dabfr])?(\d+)?)?)?$/);if(c&&c[1]){a=c[1];
var d=c[2]?c[2]:0,e=c[3]?c[3]:0,f=c[4]?c[4]:"r",c=c[5]?c[5]:0,b=b|a/10%10<<28|a%10<<24,b=b|d%10<<20,b=b|e%10<<16,b=b|{d:8192,a:16384,b:24576,f:32768,r:32768}[f],b=b|c/100%10<<8,b=b|c/10%10<<4,b=b|c%10}}return b}function g(a,b){var c=t.getElementsByTagName("body")[0],d=t.createElement("object");if(c&&d){d.setAttribute("type",Y);d.style.visibility="hidden";c.appendChild(d);var e=0;(function(){if(typeof d.GetPluginVersion==D)10>e++?setTimeout(arguments.callee,10):(c.removeChild(d),a(null));else{var f=
{};if(b)for(var g=0;g<b.length;++g)f[b[g]]=d.GetUnityVersion(b[g]);f.plugin=d.GetPluginVersion();c.removeChild(d);a(f)}})()}else a(null)}function q(b,c){var d=ua,e;G.plugins.refresh();if(typeof G.plugins!=D&&G.plugins[U]&&typeof G.mimeTypes!=D&&G.mimeTypes[Y]&&G.mimeTypes[Y].enabledPlugin){d=da;if(w.sf&&/Mac OS X 10_6/.test(G.appVersion)){g(function(c){if(!c||!c.plugin)d=ga,e="OSX10.6-SFx64";a(d,V,e);b(d,c)},c);return}if(w.mac&&w.ch){g(function(c){if(c&&(l(c.plugin)<=l("2.6.1f3")||l(c.plugin)<l(unityObject.minRequiredVersion)))d=
ga,e="OSX-CH-U<=2.6.1f3";a(d,V,e);b(d,c)},c);return}if(c){g(function(c){l(c.plugin)<l(unityObject.minRequiredVersion)&&(d=ga);a(d,V,e);b(d,c)},c);return}}else if(w.ie)try{var f=new ActiveXObject("UnityWebPlayer.UnityWebPlayer.1"),h=f.GetPluginVersion();if(c){for(var H={},Z=0;Z<c.length;++Z)H[c[Z]]=f.GetUnityVersion(c[Z]);H.plugin=h}d=da;if("2.5.0f5"==h){var q=/Windows NT \d+\.\d+/.exec(G.userAgent);q&&0<q.length&&6<=parseFloat(q[0].split(" ")[2])&&(d=ga,e="WIN-U2.5.0f5")}l(h)<l(unityObject.minRequiredVersion)&&
(d=ga)}catch(ta){e=w.win&&w.ie&&w.x64?"WIN-IEx64":"ActiveXFailed"}a(d,V,e);b(d,H)}function u(a){/^[-+]?[0-9]+$/.test(a)&&(a+="px");return a}function s(a,b,c,d){var e=t.getElementById(a);if(e){if(w.win&&w.ie){var f="",g;for(g in b)b[g]!=Object.prototype[g]&&("styleclass"==g.toLowerCase()?f+=' class="'+b[g]+'"':"classid"!=g.toLowerCase()&&(f+=" "+g+'="'+b[g]+'"'));var h="";for(g in c)c[g]!=Object.prototype[g]&&"classid"!=g.toLowerCase()&&(h+='<param name="'+g+'" value="'+c[g]+'" />');e.outerHTML='<div id="'+
a+'" style="width: '+u(b.width)+"; height: "+u(b.height)+'; visibility: hidden;"><object classid="clsid:444785F1-DE89-4295-863A-D46C3A781394" style="display: block; width: 100%; height: 100%;"'+f+">"+h+"</object></div>";ha[ha.length]=a}else{f=t.createElement("div");f.setAttribute("id",a);f.style.width=u(b.width);f.style.height=u(b.height);f.style.visibility="hidden";h=t.createElement("embed");h.setAttribute("type",Y);h.style.display="block";h.style.width="100%";h.style.height="100%";for(g in b)b[g]!=
Object.prototype[g]&&("styleclass"==g.toLowerCase()?h.setAttribute("class",b[g]):"classid"!=g.toLowerCase()&&h.setAttribute(g,b[g]));for(g in c)c[g]!=Object.prototype[g]&&"classid"!=g.toLowerCase()&&h.setAttribute(g,c[g]);f.appendChild(h);e.parentNode.replaceChild(f,e)}J(a,function(b){b?(b.parentNode.style.visibility="visible",(!w.sf||!w.mac)&&setTimeout(function(){b.focus()},100)):E(a);if(d){var c;b||(c="UnityElementNotFound");d({success:Boolean(b),id:a,ref:b,type:V,error:c})}})}else d&&d({success:!1,
id:a,type:V,error:"UnityElementNotFound"})}function x(a,b){for(var c in a)if(c.toLowerCase()==b){c=a[c];if(/^((?:[\da-f]){2}){3,4}$/i.test(c))return c.substr(0,6);break}return null}function m(a,b,c,d,e){var f=t.getElementById(a);if(f){var g=u(b.width);b=u(b.height);var h=x(c,"backgroundcolor"),H=x(c,"textcolor"),l=x(c,"bordercolor");w.win&&w.ie&&(c="font-family: Verdana; font-size: 12px; text-align: center;",h&&(c+=" background-color: #"+h+";"),H&&(c+=" color: #"+H+";"),l&&(c+=" border: 1px solid #"+
l+";"),h="",Q&&(c+=" width: "+g+"; height: "+b+";",h="width: "+g+"; line-height: "+b+";"),f.outerHTML='<div id="'+a+'" style="'+c+'"><span style="'+h+'">'+e+"</span></div>")}d&&d({success:!1,id:a,error:e})}function n(a,d,e,g,h,l,q){preInstallCallback=va[a];var m=t.getElementById(a);if(m){var n=ya;if(ia&&w.java&&!L&&!c(ja)){H[a]={attributes:d,params:e,callback:g,broken:h};var p="javascript:unityObject.doJavaInstall('"+a+"');",n=ma}else Z&&w.co?(p=F+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(F+
A()),n=ra):w.win?p=F+A():"MacIntel"==G.platform?(p=F+(W?"webplayer-i386.dmg":"webplayer-mini.dmg"),M&&(p+="?referrer="+M)):"MacPPC"==G.platform?(p=F+(W?"webplayer-ppc.dmg":"webplayer-mini.dmg"),M&&(p+="?referrer="+M)):(p='javascript:window.open("http://unity3d.com/webplayer/");',n=wa);b(za,n);if(h){var s="Unity Web Player. Install now! Restart your browser after install.",ba=ka+"/installation/getunityrestart.png";h=190;var r=75}else s="Unity Web Player. Install now!",ba=ka+"installation/getunity.png",
h=193,r=63;var I=d.width||h;d=d.height||r;var v=u(-parseInt(r)),K="unityObject.notifyBeginInstall('"+a+"','"+n+"');unityObject.setInstallStatus('"+sa+"','"+n+"',null",K=n!=ra?K+(",'"+p.replace(/'/g,"\\'")+"');"):K+(");document.location='"+p+"';"),K=K+"return false;",ca=x(e,"backgroundcolor"),E=x(e,"textcolor");e=x(e,"bordercolor");var D=a+"_img";if(w.win&&w.ie){var B='<img id="'+D+'" alt="'+s+'" src="'+ba+'" width="'+h+'" height="'+r+'" style="border-width: 0px;" />',p='<a href="'+p+'" title="'+s+
'" onclick="'+K+'"';Q&&(p+=' style="display: block; height: '+u(r)+"; position: relative; top: "+v+';"');p+=">"+B+"</a>";r="";ca&&(r+=" background-color: #"+ca+";");E&&(r+=" color: #"+E+";");e&&(r+=" border: 1px solid #"+e+";");Q?(h='<div style="width: '+u(h)+'; margin: auto; position: relative;">'+p+"</div>",m.outerHTML='<div id="'+a+'" style="width: '+u(I)+"; height: "+u(d)+"; text-align: center;"+r+'">'+h+"</div>"):m.outerHTML='<div id="'+a+'" style="'+r+'">'+p+"</div>"}else{var C=t.createElement("div");
C.setAttribute("id",a);ca&&(C.style.backgroundColor="#"+ca);E&&(C.style.color="#"+E);e&&(C.style.border="1px solid #"+e);Q&&(C.style.width=u(I),C.style.height=u(d),B=t.createElement("div"),B.style.width=u(h),B.style.margin="auto",B.style.position="relative");I=t.createElement("a");I.setAttribute("href",p);I.setAttribute("title",s);I.setAttribute("onclick",K);Q&&(I.style.display="block",I.style.height=u(r),I.style.position="relative",I.style.top=v);p=t.createElement("img");p.setAttribute("id",D);p.setAttribute("alt",
s);p.setAttribute("src",ba);p.setAttribute("width",h);p.setAttribute("height",r);p.style.borderWidth="0px";I.appendChild(p);Q?(B.appendChild(I),C.appendChild(B)):C.appendChild(I);m.parentNode.replaceChild(C,m)}O(a,!0)}g&&g({success:!1,id:a,type:l,error:q});preInstallCallback&&preInstallCallback({id:a,type:n});V=n;la?n==ma?(b(sa,n),y(a)):n==ra&&!ta&&(ta=!0,f(function(){b(sa,n);t.location=F+"3.0/co/UnityWebPlayer.application?installer="+encodeURIComponent(F+A())})):n==ma&&na&&(R.push(D),z(a+"_java"))}
function A(){var a=W?"UnityWebPlayerFull.exe":"UnityWebPlayer.exe";M&&(a+="?referrer="+M);return a}function v(a,b,c){if(w.win&&w.ie){var d="",e;for(e in a)d+=" "+e+'="'+a[e]+'"';a="";for(e in b)a+='<param name="'+e+'" value="'+b[e]+'" />';c.outerHTML="<object"+d+">"+a+"</object>"}else{d=t.createElement("object");for(e in a)d.setAttribute(e,a[e]);for(e in b)a=t.createElement("param"),a.name=e,a.value=b[e],d.appendChild(a);c.parentNode.replaceChild(d,c)}}function z(a){var b=!1;for(i=0;i<R.length;i++)R[i]&&
(!(typeof t.images[R[i]]==D||!t.images[R[i]].complete||typeof t.images[R[i]].naturalWidth!=D&&0==t.images[R[i]].naturalWidth)?R[i]=null:b=!0);b?setTimeout(arguments.callee,100):setTimeout(function(){var b=t.getElementById(a);b||(b=t.createElement("div"),t.body.insertBefore(b,t.body.lastChild.nextSibling));var c=F+"3.0/jws/";v({id:a,type:"application/x-java-applet",code:"JVMPreloader",width:1,height:1,name:"JVM Preloader"},{context:a,codebase:c,classloader_cache:!1,scriptable:!0,mayscript:!0,codebase:c},
b);O(a,!0)},100)}function y(a){var b=L=!0;document.cookie=escape(ja)+"="+escape(b)+"; path=/";var b=t.getElementById(a),c=H[a],d={id:a,type:"application/x-java-applet",archive:F+"3.0/jws/UnityWebPlayer.jar",code:"UnityWebPlayer",width:c.attributes.width||600,height:c.attributes.height||450,name:"Unity Web Player"};w.win&&w.ff&&(d.style="visibility: hidden;");var e=F+"3.0/jws/UnityWebPlayer.jnlp",f=F,g;w.win?g=A():(g="UnityPlayer.plugin.zip",M&&(g+="?referrer="+M));var e={context:a,jnlp_href:e,classloader_cache:!1,
installer:f+g,image:ka+"installation/unitylogo.png",centerimage:!0,boxborder:!1,scriptable:!0,mayscript:!0},h;for(h in c.params)"src"!=h&&c.params[h]!=Object.prototype[h]&&(e[h]=c.params[h],"logoimage"==h.toLowerCase()?e.image=c.params[h]:"backgroundcolor"==h.toLowerCase()?e.boxbgcolor="#"+c.params[h]:"bordercolor"==h.toLowerCase()?e.boxborder=!0:"textcolor"==h.toLowerCase()&&(e.boxfgcolor="#"+c.params[h]));v(d,e,b);O(a,!0)}function p(a){setTimeout(function(){var b=t.getElementById(a);b&&b.parentNode.removeChild(b)},
0)}function E(a){var b=t.getElementById(a);if(b){if(w.win&&w.ie){var c=b.firstChild;if(c&&"OBJECT"==c.nodeName){b.style.display="none";(function(){if(4==c.readyState){for(var a in c)"function"==typeof c[a]&&(c[a]=null);b.parentNode.removeChild(b)}else setTimeout(arguments.callee,10)})();return}}b.parentNode.removeChild(b)}}function J(a,b){var c=t.getElementById(a);if(!c)return b&&b(null),null;var d;w.win&&w.ie?(c=c.getElementsByTagName("object")[0])&&"OBJECT"==c.nodeName&&(d=c):(c=c.getElementsByTagName("embed")[0])&&
"EMBED"==c.nodeName&&(d=c);return function(){if(d&&typeof d.GetPluginVersion==D)return b&&setTimeout(arguments.callee,10),null;b&&b(d);return d}()}function O(a,b){if(oa){var c=b?"visible":"hidden";if(P&&t.getElementById(a))t.getElementById(a).style.visibility=c;else{var d="#"+a,c="visibility: "+c+";";if(!w.mac||!w.ie){var e=t.getElementsByTagName("head")[0];if(e){if(!S||"screen"!=pa){var g=t.createElement("style");g.setAttribute("type","text/css");g.setAttribute("media","screen");S=e.appendChild(g);
w.win&&(w.ie&&typeof t.styleSheets!=D&&0<t.styleSheets.length)&&(S=t.styleSheets[t.styleSheets.length-1]);pa="screen"}w.win&&w.ie&&"object"==typeof S.addRule?S.addRule(d,c):S&&typeof t.createTextNode!=D&&S.appendChild(t.createTextNode(d+" { "+c+" }"))}}}}}function r(){for(var a in fa)try{var b=fa[a];b.target.detachEvent(b.type,b.event)}catch(c){}for(a in ha)E(ha[a]);for(a in w)w[a]=null;w=null;for(a in unityObject)unityObject[a]=null;unityObject=null}function T(a,b,c){var d={},e=-1;if(a&&"object"==
typeof a)for(var g in a)d[g]=a[g],"tabindex"==g.toLowerCase()&&(e=d[g]);d.width=b;d.height=c;-1==e&&(d.tabIndex=0);return d}function B(a,b){var c="unityObject.firstFrameCallback();",d={};if(a&&"object"==typeof a)for(var e in a)d[e]=a[e],"firstframecallback"==e.toLowerCase()&&(d[e]=c+d[e],c=null);c&&(d.firstFrameCallback=c);d.src=b;return d}var U="Unity Player",Y="application/vnd.unity",C=window,t=document,G=navigator,P=!1,ea=[],ha=[],fa=[],S=null,pa=null,oa=!0,Q=!0,aa="https:"==document.location.protocol,
N=aa?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",ka=aa?"https://ssl-webplayer.unity3d.com/":"http://webplayer.unity3d.com/",F=N+"download_webplayer-3.x/",W=!1,la=!1,ia=!0,na=!1,ja="_unity_triedjava",L=c(ja),H=[],Z=!0,ta=!1,I=!aa&&!1,ba=!0,K=!1,V=null,ca=[],va=[],R=[],M=null,X=null,xa=3E3,D="undefined",da="installed",ua="missing",ga="broken",wa="unsupported",za="ready",sa="start",ya="standard",ma="java",ra="clickonce",w=function(){function a(b,c){for(var d=0;d<Math.max(b.length,
c.length);++d){var e=d<b.length&&b[d]?new Number(b[d]):0,g=d<c.length&&c[d]?new Number(c[d]):0;if(e<g)return-1;if(e>g)return 1}return 0}var b=G.userAgent,c=G.platform,d=!1;/msie/i.test(b)?d=parseFloat(b.replace(/^.*msie ([0-9]+(\.[0-9]+)?).*$/i,"$1")):/Trident/i.test(b)&&(d=parseFloat(b.replace(/^.*rv:([0-9]+(\.[0-9]+)?).*$/i,"$1")));for(var e={w3:typeof t.getElementById!=D&&typeof t.getElementsByTagName!=D&&typeof t.createElement!=D,win:c?/win/i.test(c):/win/i.test(b),mac:c?/mac/i.test(c):/mac/i.test(b),
ie:d,ff:/firefox/i.test(b),ch:/chrome/i.test(b),sf:/safari/i.test(b),wk:/webkit/i.test(b)?parseFloat(b.replace(/^.*webkit\/(\d+(\.\d+)?).*$/i,"$1")):!1,x64:/win64/i.test(b)&&/x64/i.test(b),moz:/mozilla/i.test(b)?parseFloat(b.replace(/^.*mozilla\/([0-9]+(\.[0-9]+)?).*$/i,"$1")):0},c=t.getElementsByTagName("script"),d=0;d<c.length;++d){var g=c[d].src.match(/^(.*)3\.0\/uo\/UnityObject\.js$/i);if(g){F=g[1];break}}e.java=function(){if(G.javaEnabled()){var b=e.win&&e.ff;if(b){if(typeof G.mimeTypes!=D)for(var c=
b?[1,6,0,12]:[1,4,2,0],b=0;b<G.mimeTypes.length;++b)if(G.mimeTypes[b].enabledPlugin){var d=G.mimeTypes[b].type.match(/^application\/x-java-applet;(?:jpi-)?version=(\d+)(?:\.(\d+)(?:\.(\d+)(?:_(\d+))?)?)?$/);if(null!=d&&0>=a(c,d.slice(1)))return!0}}else if(e.win&&e.ie&&typeof ActiveXObject!=D){b=function(a){try{return null!=new ActiveXObject("JavaWebStart.isInstalled."+a+".0")}catch(b){return!1}};if(b("1.7.0"))return!0;if(8<=e.ie){if(b("1.6.0"))for(b=12;50>=b;++b){try{c=null!=new ActiveXObject("JavaPlugin.160_"+
b)}catch(g){c=!1}if(c&&!(9==e.ie&&5==e.moz&&24>b))return!0}}else return b("1.6.0")||b("1.5.0")||b("1.4.2")}}return!1}();e.co=function(){if(e.win&&e.ie){var c=b.match(/(\.NET CLR [0-9.]+)|(\.NET[0-9.]+)/g);if(null!=c)for(var d=[3,5,0],g=0;g<c.length;++g){var f=c[g].match(/[0-9.]{2,}/g)[0].split(".");if(0>=a(d,f))return!0}}return!1}();return e}(),qa=function(){function a(b,e,g,f){if(I){b="http://unityanalyticscapture.appspot.com/event?u="+encodeURIComponent(c)+"&s="+encodeURIComponent(d)+"&e="+encodeURIComponent(b);
M&&(b+="?r="+M);e&&(b+="&t="+encodeURIComponent(e));g&&(b+="&d="+encodeURIComponent(g));var h=new Image;if(f){var H=null;h.onload=h.onerror=function(){clearTimeout(H);h.onload=h.onerror=null;f()};H=setTimeout(h.onload,xa)}h.src=b}else f&&f()}function b(a,c,d,e){if(ba){var g=window._ugaq=window._ugaq||[];K||g.push(["unity._setAccount","UA-16068464-16"]);a="/webplayer/install/"+a;var f="?";c&&(a+=f+"t="+encodeURIComponent(c),f="&");d&&(a+=f+"d="+encodeURIComponent(d),f="&");if(e){var h;c=function(){unityObject.googleAnalyticsCallback=
null;clearTimeout(h);e()};unityObject.googleAnalyticsCallback=c;h=setTimeout(c,xa)}g.push(["unity._trackPageview",a]);if(!K){g=F+"3.0/uo/ga.js";c=t.getElementsByTagName("script");for(d=0;d<c.length;++d)if(c[d].src&&c[d].src.toLowerCase()==g.toLowerCase()){K=!0;break}K||(K=!0,c=t.createElement("script"),c.type="text/javascript",c.async=!0,c.src=g,g=document.getElementsByTagName("script")[0],g.parentNode.insertBefore(c,g))}}else e&&e()}var c=function(){var a=new Date;return Date.UTC(a.getUTCFullYear(),
a.getUTCMonth(),a.getUTCDay(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds()).toString(16)+Math.floor(2147483647*Math.random()).toString(16)}(),d=0;return{send:function(c,e,g,f){function h(){0==--H&&(location.href=f)}++d;var H=2;a(c,e,g,f?h:null);b(c,e,g,f?h:null)}}}();(function(){w.w3&&((typeof t.readyState!=D&&"complete"==t.readyState||typeof t.readyState==D&&(t.getElementsByTagName("body")[0]||t.body))&&e(),P||(typeof t.addEventListener!=D?t.addEventListener("DOMContentLoaded",
e,!1):w.win&&w.ie&&(t.attachEvent("onreadystatechange",function(){"complete"==t.readyState&&(t.detachEvent("onreadystatechange",arguments.callee),e())}),C==top&&function(){if(!P){try{t.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,10);return}e()}}()),w.wk&&function(){P||(/loaded|complete/.test(t.readyState)?e():setTimeout(arguments.callee,10))}(),f(e)))})();(function(){if(w.win&&w.ie)if(typeof C.attachEvent!=D)h(C,"onunload",r);else if("function"==typeof C.onunload){var a=
C.onunload;C.onunload=function(){a();r()}}else C.onunload=r})();return{missingUnityId:null,minRequiredVersion:"3.0.0",embedUnity:function(a,b,c,e,g,f,h){w.w3&&!(w.wk&&312>w.wk)&&a&&b&&c&&e?d(function(){var d=T(f,c,e),H=B(g,b);q(function(b){b==da?s(a,d,H,h):b==wa?m(a,d,H,h,"Unsupported browser."):(n(unityObject.missingUnityId||a,d,H,h,b==ga,null,"NotInstalled"),function(){var b=arguments.callee;q(function(c){c==da?(O(a,!1),s(a,d,H,h)):setTimeout(b,500)})}())})}):h&&h({success:!1,id:a})},addPreInstallCallback:function(a,
b){va[a]=b},addBeginInstallCallback:function(a,b){ca[a]=b},getObjectById:function(a,b){if(w.w3&&a)return J(a,b);b&&b(null);return null},setAutoHideShow:function(a){oa=a},setFullSizeMissing:function(a){Q=a},enableFullInstall:function(a){W=a},enableAutoInstall:function(a){la=a},enableJavaInstall:function(a){ia=a},enableJavaPreloading:function(a,b){na=a;typeof b!=D&&(R=b)},enableClickOnceInstall:function(a){Z=a},enableAnalytics:function(a){I=!aa&&a;ba=a},enableUnityAnalytics:function(a){I=!aa&&a},enableGoogleAnalytics:function(a){ba=
a},setBaseDomain:function(a){var b=N;N=a;"/"!=N[N.length-1]&&(N+="/");F=N+F.substr(b.length)},setBaseDownloadUrl:function(a){F=a;"/"!=F[F.length-1]&&(F+="/");N=a.match(/([^:]*):\/\/([^/]*)/)[0]+"/"},setReferrer:function(a){M=a?encodeURIComponent(a):a},addLoadEvent:f,addDomLoadEvent:d,ua:w,detectUnity:function(a,b){w.w3&&!(w.wk&&312>w.wk)&&a?d(function(){q(a,b)}):a&&a(ua)},createUnity:function(a,b,c,d){w.w3&&!(w.wk&&312>w.wk)&&a&&b&&c&&d?s(a,c,b,d):d&&d({success:!1,id:a})},removeUnity:function(a){w.w3&&
E(a)},notifyBeginInstall:function(a,b){(callback=ca[a])&&callback({id:a,type:b})},setInstallStatus:function(a,c,d,e){b(a,c,d,e)},doJavaInstall:function(a){y(a)},jvmPreloaded:function(a){p(a)},appletStarted:function(a){},javaInstallDone:function(a,b,c){setTimeout('unityObject.javaInstallDoneDirect("'+a+'", '+b+', "'+c+'");',0)},javaInstallDoneDirect:function(a,c,d){c||(c=H[a],b("error",ma,d),n(unityObject.missingUnityId||a,c.attributes,c.params,c.callback,c.broken,ma,d))},firstFrameCallback:function(){var a=
V;null!=X&&(X="first",qa.send("first",a,void 0))}}}();
function addDOMLoadEvent(a){if(!window.__load_events){var b=function(){if(!arguments.callee.done){arguments.callee.done=!0;window.__load_timer&&(clearInterval(window.__load_timer),window.__load_timer=null);for(var a=0;a<window.__load_events.length;a++)window.__load_events[a]();window.__load_events=null}};document.addEventListener&&document.addEventListener("DOMContentLoaded",b,!1);/WebKit/i.test(navigator.userAgent)&&(window.__load_timer=setInterval(function(){/loaded|complete/.test(document.readyState)&&b()},
10));window.onload=b;window.__load_events=[]}window.__load_events.push(a)}
function tabset(){if(!document.getElementById)return!1;var a=document.getElementsByTagName("dl"),b;for(k=0;k<a.length;k++){var c=a[k];if(-1!=c.className.indexOf("tabset")){var d=0,e=c.getElementsByTagName("dd");for(i=0;i<e.length;i++)e[i].parentNode==c&&(0===i?b=e.item(0):e[i].style.display="none",e[i].count=d++);d=[];e=c.getElementsByTagName("dt");for(i=0;i<e.length;i++)e[i].parentNode==c&&(d[d.length]=e[i]);c=[];for(i=0;i<d.length;i++)d[i].transformed_to_tab||(d[i].transformed_to_tab=!0,d[i].count=
i,d[i].onclick=toggleDt,d[i].innerHTML="<a href='#' title='"+d[i].innerHTML+"'>"+d[i].innerHTML+"</a>",d[i].parentNode.removeChild(d[i]),b.parentNode.insertBefore(d[i],b)),0<=d[i].className.indexOf("active")&&(c[c.length]=d[i]);for(i=0;i<c.length;i++)c[i].onclick()}}}
function toggleDt(){var a=this.parentNode.getElementsByTagName("dt");for(i=0;i<a.length;i++)this==a[i]&&0<=this.className.indexOf("dormant")&&-1==this.className.indexOf("active")&&a[i].parentNode==this.parentNode?(this.className+=" active",this.className=this.className.replace(/(?:^\s*|\s*$)/,"")):this!=a[i]&&a[i].parentNode==this.parentNode&&(a[i].className=a[i].className.replace("active","dormant"));a=this.parentNode.getElementsByTagName("dd");for(i=0;i<a.length;i++)a[i].parentNode==this.parentNode&&
(a[i].style.display=this.count==a[i].count?"block":"none");return!1}addDOMLoadEvent(tabset);
var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){a=String(a);for(b=b||2;a.length<b;)a="0"+a;return a};return function(e,f,h){var l=dateFormat;1==arguments.length&&("[object String]"==Object.prototype.toString.call(e)&&!/\d/.test(e))&&(f=e,e=void 0);e=e?new Date(e):new Date;if(isNaN(e))throw SyntaxError("invalid date");
f=String(l.masks[f]||f||l.masks["default"]);"UTC:"==f.slice(0,4)&&(f=f.slice(4),h=!0);var g=h?"getUTC":"get",q=e[g+"Date"](),u=e[g+"Day"](),s=e[g+"Month"](),x=e[g+"FullYear"](),m=e[g+"Hours"](),n=e[g+"Minutes"](),A=e[g+"Seconds"](),g=e[g+"Milliseconds"](),v=h?0:e.getTimezoneOffset(),z={d:q,dd:d(q),ddd:l.i18n.dayNames[u],dddd:l.i18n.dayNames[u+7],m:s+1,mm:d(s+1),mmm:l.i18n.monthNames[s],mmmm:l.i18n.monthNames[s+12],yy:String(x).slice(2),yyyy:x,h:m%12||12,hh:d(m%12||12),H:m,HH:d(m),M:n,MM:d(n),s:A,
ss:d(A),l:d(g,3),L:d(99<g?Math.round(g/10):g),t:12>m?"a":"p",tt:12>m?"am":"pm",T:12>m?"A":"P",TT:12>m?"AM":"PM",Z:h?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(0<v?"-":"+")+d(100*Math.floor(Math.abs(v)/60)+Math.abs(v)%60,4),S:["th","st","nd","rd"][3<q%10?0:(10!=q%100-q%10)*q%10]};return f.replace(a,function(a){return a in z?z[a]:a.slice(1,a.length-1)})}}();
dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:"Sun Mon Tue Wed Thu Fri Sat Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),monthNames:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec January February March April May June July August September October November December".split(" ")};
Date.prototype.format=function(a,b){return dateFormat(this,a,b)};function AccomplishmentGroup(a){this.initialize(a)}
AccomplishmentGroup.prototype={initialize:function(a){this._id=a.id;this._scheduled_end=null;a.scheduled_end&&(this._scheduled_end=new Date(a.scheduled_end));this._progress_content=null;this._dueling_group=a.dueling_group;this._name=a.name},id:function(){return this._id},name:function(){return this._name},scheduledEnd:function(){return this._scheduled_end},setProgressContent:function(a){this._progress_content=a},progressContent:function(){return this.expired()?null:this._progress_content},expired:function(){return this._dueling_group&&
active_user.duelingGroup()&&this._dueling_group!=active_user.duelingGroup()||this._scheduled_end&&new Date>this._scheduled_end?!0:!1}};AccomplishmentTask=function(a){this.initialize(a)};AccomplishmentTask.AND_OPERATOR="AND";AccomplishmentTask.OR_OPERATOR="OR";
AccomplishmentTask.prototype={initialize:function(a){this._id=a.id;this._quota=a.quota;this._operator=a.operator;this._statistic=a.statistic;this._current_progress=a.current_progress;this._statistic.addAccomplishmentTask(this)},quota:function(){return this._quota},isAndTask:function(){return AccomplishmentTask.AND_OPERATOR===this._operator},isOrTask:function(){return AccomplishmentTask.OR_OPERATOR===this._operator},id:function(){return this._id},statistic:function(){return this._statistic},progress:function(){return this._current_progress},
isComplete:function(){return 0<=this._statistic.compare(this._quota,this._current_progress)},isUnprogressed:function(){var a=this.progress();return null===a||void 0===a},updateProgress:function(a,b){if(!this.isComplete()&&a===this._statistic.id()&&!(null===b||void 0===b)&&!(1>this._statistic.compare(this._current_progress,b)))this._current_progress=b,this.trigger("progress",this),this.isComplete()&&this.trigger("complete",this)},displayValue:function(){this.statistic().type();return this.isUnprogressed()?
0:this.progress()},percentValue:function(){var a;a=this.statistic().type();Statistic.ADD_TYPE==a||Statistic.MAX_TYPE==a?this.isUnprogressed()?a=0:(a=this.quota()+0,a=100*((this.progress()+0)/a)):a=this.isComplete()?100:0;100<a&&(a=100);return a},purgeProgress:function(){this._current_progress=void 0}};$j.extend(AccomplishmentTask.prototype,Evented);Accomplishment=function(a){this.initialize(a)};
Accomplishment.prototype={initialize:function(a){var b=this;this._tasks=(a.accomplishment_tasks||[]).map(function(c){c.statistic=a.statisticProvider(c.statistic_id);c=new AccomplishmentTask(c);c.on("complete",function(a){b.trigger("task-complete",a)});c.on("progress",function(a){b.trigger("task-progress",a)});return c});this._id=a.id;this._dom_id=a.dom_id;this._level=a.level;this._badge_id=a.badge_id;this._card_id=a.card_id;this._raffle_id=a.raffle_id;this._item_id=a.item_id;this._reward_points=a.reward_points;
this._badge_of_the_day=a.badge_of_the_day;this._hidden=a.hidden;this._has_completion_tab_been_shown=!1;a.accomplishment_group&&(this._accomplishment_group=new AccomplishmentGroup(a.accomplishment_group));a.scheduled_end&&(this._scheduled_end=new Date(1E3*a.scheduled_end))},id:function(){return this._id},domId:function(){return this._dom_id},tasks:function(){return this._tasks},andTasks:function(){return this.tasks().select(function(a){return a.isAndTask()})},orTasks:function(){return this.tasks().select(function(a){return a.isOrTask()})},
isComplete:function(){if(this._complete)return!0;var a=!0;0<this.andTasks().length&&this.andTasks().any(function(a){return!a.isComplete()})&&(a=!1);a&&(0<this.orTasks().length&&this.orTasks().all(function(a){return!a.isComplete()}))&&(a=!1);a&&(this._complete=!0);return a},isAchievement:function(){return this._level?!0:!1},isBadgeOfTheDay:function(){return this._badge_of_the_day},rank:function(){return[null,"badge_of_the_day","easy","medium","hard","impossible"].indexOf(this._level)},scheduledEnd:function(){return this._scheduled_end},
isActive:function(){return!this.scheduledEnd()?!0:this.scheduledEnd()>=new Date},isHidden:function(){return this._hidden},updateProgress:function(a,b){this.isComplete()||(this._tasks.forEach(function(c){c.updateProgress(a,b)}),this.isComplete()&&this.trigger("complete",this))},purgeProgress:function(){this._complete=!1;this.tasks().invoke("purgeProgress")},prizeName:function(){return this._card_id?"card":this._badge_id?"badge":this._raffle_id?"ticket":this._reward_points?"points":"reward"},hasCompletionTabBeenShown:function(){return this._has_completion_tab_been_shown},
setHasCompletionTabBeenShown:function(){this._has_completion_tab_been_shown=!0},accomplishmentGroup:function(){return this._accomplishment_group},setAccomplishmentGroupProgressContent:function(a){this._accomplishment_group.setProgressContent(a)},accomplishmentGroupProgressContent:function(){var a=this.accomplishmentGroup();if(a)return a.progressContent()},hasCompleteAccomplishmentGroup:function(){return this.accomplishmentGroup()&&!this.accomplishmentGroup().expired()&&!this.accomplishmentGroup().progressContent()},
hasItem:function(){return!!this._item_id}};$j.extend(Accomplishment.prototype,Evented);Statistic=function(a){this.initialize(a)};Statistic.ADD_TYPE="Add";Statistic.MAX_TYPE="Max";Statistic.MIN_TYPE="Min";Statistic.REPLACE_TYPE="Replace";Statistic.LOW="low";Statistic.MEDIUM="medium";Statistic.HIGH="high";Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL=12E4;Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL=3E4;Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL=15E3;
Statistic.betterThanForType=function(a,b,c){return Statistic.ADD_TYPE===c?!1:null===a||void 0===a||isNaN(a)?!0:Statistic.MIN_TYPE===c?b<a:Statistic.MAX_TYPE===c?b>a:b!=a};Statistic.sortOnSentAt=function(a){return a.sort(function(a,c){return a.sentAt()===c.sentAt()?0:a.sentAt()<c.sentAt()?-1:1})};
Statistic.prototype={initialize:function(a){this._stat_type=a.stat_type;this._id=a.id;this._name=a.name;this._display_name=a.display_name;this._display_in_table=a.display_in_table;this._tasks=(a.tasks||[]).slice();this.reset()},reset:function(){this._sent_at=this.getTime();this._pending_value=this._saved_value=this.type()===Statistic.ADD_TYPE?0:null;this._current_value=null},name:function(){return this._name},displayName:function(){return this._display_name||this._name},id:function(){return this._id},
type:function(){return this._stat_type},displayInTable:function(){return this._display_in_table},valueToSend:function(){return this._current_value},value:function(){return Statistic.ADD_TYPE===this.type()?this._saved_value+this._pending_value+this._current_value:this._current_value},pendingValue:function(){return this._pending_value},setPendingValue:function(a){this._pending_value=a},savedValue:function(){return this._saved_value},setSavedValue:function(a){this._saved_value=a},addAccomplishmentTask:function(a){this._tasks.push(a)},
sentAt:function(){return this._sent_at},markAsSent:function(){this._sent_at=this.getTime();Statistic.ADD_TYPE===this.type()?(this._pending_value+=this._current_value,this._current_value=0):this._pending_value=this._current_value},resetPendingValue:function(){Statistic.ADD_TYPE===this.type()?(this._current_value+=this._pending_value,this._pending_value=0):this._pending_value=null},priority:function(){return this.hasIncompleteTasks()?Statistic.HIGH:this._display_in_table?Statistic.MEDIUM:Statistic.LOW},
hasIncompleteTasks:function(){return 0<this.incompleteTasks().length},incompleteTasks:function(){var a=this.value(),b=this.type(),c=this;return null===a||void 0===a?this._tasks.slice():this._tasks.filter(function(d){return d.isComplete()?!1:Statistic.MIN_TYPE===b?a>d.quota():Statistic.ADD_TYPE===b?a-c._saved_value+d.progress()<d.quota():a<d.quota()})},pending:function(){return this.type()===Statistic.ADD_TYPE?null!==this._pending_value&&0!==this._pending_value:null!==this._pending_value},attemptUpdate:function(a){var b=
!1,c=this.incompleteTasks();Statistic.ADD_TYPE===this.type()?(this._current_value+=a,b=0!==a):this.betterThanCurrentValue(a)&&(this._current_value=a,b=!0);b&&c.length!=this.incompleteTasks().length&&(Kongregate.Log.debug("Incomplete tasks list for "+this.name()+" changed"),this._sent_at=0);return b},betterThanCurrentValue:function(a){return Statistic.betterThanForType(this.value(),a,this.type())},betterThanSavedValue:function(a){return Statistic.betterThanForType(this._saved_value,a,this.type())},
betterThanPendingValue:function(a){return Statistic.betterThanForType(this._pending_value,a,this.type())},dirty:function(){var a=this.valueToSend();return isNaN(a)||null===a||void 0===a?!1:Statistic.ADD_TYPE===this.type()?0!==a:this.betterThanSavedValue(a)&&this.betterThanPendingValue(a)},minWaitInterval:function(){switch(this.priority()){case Statistic.LOW:return Statistic.LOW_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.MEDIUM:return Statistic.MEDIUM_PRIORITY_MIN_WAIT_INTERVAL;case Statistic.HIGH:return Statistic.HIGH_PRIORITY_MIN_WAIT_INTERVAL;
default:return 3E5}},readyToSend:function(){if(!this.dirty())return!1;var a=this.sentAt();return 0===a||this.getTime()-a>=this.minWaitInterval()},sendImmediately:function(){return this.dirty()&&0===this.sentAt()},getTime:function(){return(new Date).getTime()},compare:function(a,b){return void 0===a?1:void 0===b?-1:a==b?0:this._stat_type==Statistic.MIN_TYPE?a>b?1:-1:a<b?1:-1}};AccomplishmentTracker=function(a){this.initialize(a)};
AccomplishmentTracker.prototype={initialize:function(a){this._accomplishments=[];this._statistics=[];this._buffered_events=[];this._accomplishments_ever_set=!1;this._earned_as_guest=Cookie.get("guest_accomplishments");this._guest_points=parseInt(Cookie.get("guest_points")||0,10);this._stat_values={};this._watch_stats=!1;this._earned_as_guest=this._earned_as_guest?this._earned_as_guest.split(","):[];a.statistics&&this.setStatistics(a.statistics);a.accomplishments&&this.setAccomplishments(a.accomplishments)},
purgeProgress:function(){this.accomplishments().invoke("purgeProgress")},setAccomplishmentsProgress:function(a){this.purgeProgress();var b=this;try{this._setting_progress=!0,a.pluck("accomplishment_tasks").flatten().each(function(a){b.updateProgress(a.statistic_id,a.current_progress)})}finally{this._setting_progress=!1}},setAccomplishments:function(a){var b=this;this._accomplishments_ever_set=!0;this._accomplishments=[];for(var c=a.length-1;0<=c;c--){var d=a[c];d.statisticProvider=this.getStatisticById.bind(this);
d=new Accomplishment(d);d.on("task-complete",function(a){b.trigger("task-complete",a)});d.on("task-progress",function(a){b.trigger("task-progress",a)});d.on("complete",function(a){return b._setting_progress||b.trigger("accomplishment-complete",a)});this._accomplishments.push(d)}var e=this;this._buffered_events.each(function(a){e.onStatisticUpdated(a)});this._buffered_events=[]},getAccomplishmentById:function(a){return this.accomplishments().detect(function(b){return a==b.id()})},accomplishmentHasInProgressGroup:function(a){(a=
this.getAccomplishmentById(a))&&a.setAccomplishmentGroupInProgress()},accomplishments:function(){return this._accomplishments.select(function(a){return a.isActive()&&!a.isHidden()})},achievements:function(){return this.accomplishments().filter(function(a){return a.isAchievement()})},completeAchievements:function(){return this.achievements().filter(function(a){return a.isComplete()})},statistics:function(){return this._statistics},setStatistics:function(a){this._statistics=[];for(var b=a.length-1;0<=
b;b--)this._statistics.push(new Statistic(a[b]))},onStatisticUpdated:function(a){this._accomplishments_ever_set?this.updateProgress(a.data.id,a.data.value):this._buffered_events.push(a)},completeAccomplishments:function(){return this.accomplishments().select(function(a){return!a.isHidden()&&a.isComplete()}).sortBy(function(a){return a.rank()})},incompleteAccomplishments:function(){return this.accomplishments().select(function(a){return!a.isComplete()}).sortBy(function(a){return a.rank()})},hiddenAccomplishments:function(){return this.accomplishments().select(function(a){return a.isHidden()})},
nextAccomplishment:function(){if(0===this._earned_as_guest.size())return this.incompleteAccomplishments()[0];var a=this;return this.incompleteAccomplishments().find(function(b){return!a._earned_as_guest.include(b.id())})},getStatisticById:function(a){return this._statistics.detect(function(b){return a===b.id()})||new Statistic({id:a})},updateProgress:function(a,b){this._watch_stats&&this.statWatch(a,b);this.accomplishments().forEach(function(c){c.updateProgress(a,b)})},accomplishmentForId:function(a){return this.accomplishments().find(function(b){return b.id()==
a})},getTime:function(){return new Date},startWatchingStats:function(){console.log("Started watching stats");this._watch_stats=!0},statWatch:function(a,b){var c=this.getStatisticById(a);c?(0<c.compare(this._stat_values[a],b)&&console.log("Statistic %o id %o updated to value %o",c.name(),a,b),this._stat_values[a]=b):console.log("no such stat")},threeAMTomorrow:function(){var a=new Date;a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);3<=a.getHours()?a.setTime(a.getTime()+36E5*(24-(a.getHours()-
3))):a.setTime(a.getTime()+36E5*(3-a.getHours()));return a},recordGuestAccomplishment:function(a){this._earned_as_guest.include(a.id())||(this._earned_as_guest.push(a.id()),this._guest_points+=a._reward_points,Cookie.setWithDate("guest_points",this._guest_points,this.threeAMTomorrow()),Cookie.setWithDate("guest_accomplishments",this._earned_as_guest,this.threeAMTomorrow()))}};$j.extend(AccomplishmentTracker.prototype,Evented);AdService=function(a){this.initialize(a)};
AdService.prototype={initialize:function(a){var b=this;this._eventDispatcher=a.event_dispatcher;this._adManagers=[];[window.supersonicAdManager,window.hyprMXAdManager,window.trueXAdManager,a.ad_manager].each(function(a){a&&(a.setReceiver(b),b._adManagers.push(a))});this._adManager=this._adManagers.pop();this._adsReady=this._adShowing=this._campaignCompleted=this._initialized=!1;this._eventDispatcher.register(KonduitEvent.ADS_INITIALIZE,this.onInitializeAds.bind(this));this._eventDispatcher.register(KonduitEvent.ADS_SHOW_INCENTIVIZED,
this.onShowAd.bind(this))},onInitializeAds:function(){this._initialized?this._adsReady?(Kongregate.Log.warn("Ad service already initialized, sending ads available"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)):(Kongregate.Log.warn("Ad service already initialized, sending ads unavailable"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)):(this._initialized=!0,this._adManager?this._adManager.readyForAds():(Kongregate.Log.info("No ad managers available"),this.onCampaignsDone()),
Kongregate.Log.info("AdService initialized!"))},onNoAdAvailable:function(){if(this._adManager=this._adManagers.pop())this._initialized=!1,this.onInitializeAds()},onShowAd:function(){this._adsReady?this._adShowing?Kongregate.Log.warn("Ad already showing, ignoring call"):(this._adManager.showAd(),this._adShowing=!0,this._campaignCompleted=!1,this._eventDispatcher.sendMessage(KonduitEvent.AD_OPENED)):(Kongregate.Log.warn("No ads ready, not attempting to display ad"),this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE),
this._eventDispatcher.sendMessage(KonduitEvent.AD_ABANDONED))},onCampaignsReady:function(){Kongregate.Log.info("Ad campaigns ready!");this._adsReady=!0;this._eventDispatcher.sendMessage(KonduitEvent.ADS_AVAILABLE)},onCampaignsDone:function(){Kongregate.Log.info("Ad campaigns done!");this._adsReady=!1;this._eventDispatcher.sendMessage(KonduitEvent.ADS_UNAVAILABLE)},onCampaignCompleted:function(){Kongregate.Log.info("Ad campaign completed!");this._campaignCompleted=!0},onCampaignClose:function(){Kongregate.Log.info("Ad campaign closed, completed="+
this._campaignCompleted);this._eventDispatcher.sendMessage(this._campaignCompleted?KonduitEvent.AD_COMPLETED:KonduitEvent.AD_ABANDONED);this._campaignCompleted=this._adShowing=!1}};AnalyticsService=function(a){this.initialize(a)};
AnalyticsService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.ANALYTICS_PAYLOAD,this.onAnalyticsPayloadRequest.bind(this))},sendAnalyticsPayload:function(a){if(!this._activeUser.analyticsInfo()||this._lastUserId===this._activeUser.id())return!1;this._lastUserId=this._activeUser.id();var b=this;a=a||0;$j.ajax({url:this._activeUser.gameResourcePath()+"/analytics_payload.json",
success:this.onAnalyticsPayloadResult.bind(this),error:function(c,d,e){Kongregate.Log.error("Analytics payload request failed, errorCount=",a,c,d,e);a<b.maxRetries()&&b.retryAnalyticsPayload(a+1)}})},retryAnalyticsPayload:function(a){a*=1E4;Kongregate.Log.debug("Retrying analytics payload request after "+a);setTimeout(this.sendAnalyticsPayload.bind(this),a)},onAnalyticsPayloadRequest:function(){this.sendAnalyticsPayload()},onAnalyticsPayloadResult:function(a){Kongregate.Log.debug("Analytics payload received");
a.time_skew=(this.getTime()-moment(a.server_time).toDate().getTime())/1E3;this._eventDispatcher.sendMessage("analytics.payload",{data:{info:this._activeUser.analyticsInfo(),payload:a}})},getTime:function(a){var b;a&&(b=moment(a).toDate().getTime());return b||(new Date).getTime()},maxRetries:function(){return 5}};
ApiLogger={log:function(a,b){Kongregate.Utils.isKlient()&&top.postMessage({type:"kongregate:api-message:log",message:{level:a,message:b}},"*")},echoToConsole:function(a,b){Kongregate.Log[a](b);ApiLogger[a](b)},error:function(a){ApiLogger.log(1,a)},warn:function(a){ApiLogger.log(2,a)},info:function(a){ApiLogger.log(3,a)},debug:function(a){ApiLogger.log(4,a)},spam:function(a){ApiLogger.log(5,a)}};
(function(a){function b(a,b){return function(c){return g(a.call(this,c),b)}}function c(a){return function(b){return this.lang().ordinal(a.call(this,b))}}function d(){}function e(a){h(this,a)}function f(a){var b=this._data={},c=a.years||a.year||a.y||0,d=a.months||a.month||a.M||0,e=a.weeks||a.week||a.w||0,g=a.days||a.day||a.d||0,f=a.hours||a.hour||a.h||0,h=a.minutes||a.minute||a.m||0,q=a.seconds||a.second||a.s||0;a=a.milliseconds||a.millisecond||a.ms||0;this._milliseconds=a+1E3*q+6E4*h+36E5*f;this._days=
g+7*e;this._months=d+12*c;b.milliseconds=a%1E3;q+=l(a/1E3);b.seconds=q%60;h+=l(q/60);b.minutes=h%60;f+=l(h/60);b.hours=f%24;g+=l(f/24);g+=7*e;b.days=g%30;d+=l(g/30);b.months=d%12;c+=l(d/12);b.years=c}function h(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function l(a){return 0>a?Math.ceil(a):Math.floor(a)}function g(a,b){for(var c=a+"";c.length<b;)c="0"+c;return c}function q(a,b,c){var d=b._milliseconds,e=b._days;b=b._months;d&&a._d.setTime(+a+d*c);e&&a.date(a.date()+e*c);b&&(d=
a.date(),a.date(1).month(a.month()+b*c).date(Math.min(d,a.daysInMonth())))}function u(a,b){var c=Math.min(a.length,b.length),d=Math.abs(a.length-b.length),e=0,g;for(g=0;g<c;g++)~~a[g]!==~~b[g]&&e++;return e+d}function s(a){if(!a)return r.fn._lang;!U[a]&&Y&&require("./lang/"+a);return U[a]}function x(a){var b=a.match(t),c,d;c=0;for(d=b.length;c<d;c++)b[c]=L[b[c]]?L[b[c]]:b[c].match(/\[.*\]/)?b[c].replace(/^\[|\]$/g,""):b[c].replace(/\\/g,"");return function(e){var g="";for(c=0;c<d;c++)g+="function"===
typeof b[c].call?b[c].call(e,a):b[c];return g}}function m(a,b){function c(b){return a.lang().longDateFormat(b)||b}for(var d=5;d--&&G.test(b);)b=b.replace(G,c);ia[b]||(ia[b]=x(b));return ia[b](a)}function n(a){switch(a){case "DDDD":return ha;case "YYYY":return fa;case "YYYYY":return S;case "S":case "SS":case "SSS":case "DDD":return ea;case "MMM":case "MMMM":case "dd":case "ddd":case "dddd":case "a":case "A":return pa;case "X":return aa;case "Z":case "ZZ":return oa;case "T":return Q;case "MM":case "DD":case "YY":case "HH":case "hh":case "mm":case "ss":case "M":case "D":case "d":case "H":case "h":case "m":case "s":return P;
default:return RegExp(a.replace("\\",""))}}function A(a){var b,c=[];if(!a._d){for(b=0;7>b;b++)a._a[b]=c[b]=null==a._a[b]?2===b?1:0:a._a[b];c[3]+=a._tzh||0;c[4]+=a._tzm||0;b=new Date(0);a._useUTC?(b.setUTCFullYear(c[0],c[1],c[2]),b.setUTCHours(c[3],c[4],c[5],c[6])):(b.setFullYear(c[0],c[1],c[2]),b.setHours(c[3],c[4],c[5],c[6]));a._d=b}}function v(a){var b=a._f.match(t),c=a._i,d,e;a._a=[];for(d=0;d<b.length;d++)if((e=(n(b[d]).exec(c)||[])[0])&&(c=c.slice(c.indexOf(e)+e.length)),L[b[d]]){var g=a,f=void 0,
h=g._a;switch(b[d]){case "M":case "MM":h[1]=null==e?0:~~e-1;break;case "MMM":case "MMMM":f=s(g._l).monthsParse(e);null!=f?h[1]=f:g._isValid=!1;break;case "D":case "DD":case "DDD":case "DDDD":null!=e&&(h[2]=~~e);break;case "YY":h[0]=~~e+(68<~~e?1900:2E3);break;case "YYYY":case "YYYYY":h[0]=~~e;break;case "a":case "A":g._isPm="pm"===(e+"").toLowerCase();break;case "H":case "HH":case "h":case "hh":h[3]=~~e;break;case "m":case "mm":h[4]=~~e;break;case "s":case "ss":h[5]=~~e;break;case "S":case "SS":case "SSS":h[6]=
~~(1E3*("0."+e));break;case "X":g._d=new Date(1E3*parseFloat(e));break;case "Z":case "ZZ":g._useUTC=!0;if((f=(e+"").match(F))&&f[1])g._tzh=~~f[1];f&&f[2]&&(g._tzm=~~f[2]);f&&"+"===f[0]&&(g._tzh=-g._tzh,g._tzm=-g._tzm)}null==e&&(g._isValid=!1)}a._isPm&&12>a._a[3]&&(a._a[3]+=12);!1===a._isPm&&12===a._a[3]&&(a._a[3]=0);A(a)}function z(a,b,c,d,e){return e.relativeTime(b||1,!!c,a,d)}function y(a,b,c){b=c-b;c-=a.day();c>b&&(c-=7);c<b-7&&(c+=7);return Math.ceil(r(a).add("d",c).dayOfYear()/7)}function p(b){var c=
b._i,d=b._f;if(null===c||""===c)return null;"string"===typeof c&&(b._i=c=s().preparse(c));if(r.isMoment(c))b=h({},c),b._d=new Date(+c._d);else if(d)if("[object Array]"===Object.prototype.toString.call(d)){for(var c=b,g,f,l=99;c._f.length;){g=h({},c);g._f=c._f.pop();v(g);d=new e(g);if(d.isValid()){f=d;break}g=u(g._a,d.toArray());g<l&&(l=g,f=d)}h(c,f)}else v(b);else if(f=b,c=f._i,d=C.exec(c),c===a)f._d=new Date;else if(d)f._d=new Date(+d[1]);else if("string"===typeof c)if(d=f._i,N.exec(d)){f._f="YYYY-MM-DDT";
for(c=0;4>c;c++)if(ka[c][1].exec(d)){f._f+=ka[c][0];break}oa.exec(d)&&(f._f+=" Z");v(f)}else f._d=new Date(d);else"[object Array]"===Object.prototype.toString.call(c)?(f._a=c.slice(0),A(f)):f._d=c instanceof Date?new Date(+c):new Date(c);return new e(b)}function E(a,b){r.fn[a]=r.fn[a+"s"]=function(a){var c=this._isUTC?"UTC":"";return null!=a?(this._d["set"+c+b](a),this):this._d["get"+c+b]()}}function J(a){r.duration.fn[a]=function(){return this._data[a]}}function O(a,b){r.duration.fn["as"+a]=function(){return+this/
b}}for(var r,T=Math.round,B,U={},Y="undefined"!==typeof module&&module.exports,C=/^\/?Date\((\-?\d+)/i,t=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|X|zz?|ZZ?|.)/g,G=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,P=/\d\d?/,ea=/\d{1,3}/,ha=/\d{3}/,fa=/\d{1,4}/,S=/[+\-]?\d{1,6}/,pa=/[0-9]*[a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF]+\s*?[\u0600-\u06FF]+/i,oa=/Z|[\+\-]\d\d:?\d\d/i,Q=/T/i,aa=/[\+\-]?\d+(\.\d{1,3})?/,
N=/^\s*\d{4}-\d\d-\d\d((T| )(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,ka=[["HH:mm:ss.S",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],F=/([\+\-]|\d\d)/gi,W="Month Date Hours Minutes Seconds Milliseconds".split(" "),la={Milliseconds:1,Seconds:1E3,Minutes:6E4,Hours:36E5,Days:864E5,Months:2592E6,Years:31536E6},ia={},na="DDD w W M D d".split(" "),ja="MDHhmswW".split(""),L={M:function(){return this.month()+1},MMM:function(a){return this.lang().monthsShort(this,
a)},MMMM:function(a){return this.lang().months(this,a)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(a){return this.lang().weekdaysMin(this,a)},ddd:function(a){return this.lang().weekdaysShort(this,a)},dddd:function(a){return this.lang().weekdays(this,a)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return g(this.year()%100,2)},YYYY:function(){return g(this.year(),4)},YYYYY:function(){return g(this.year(),
5)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return g(~~(this.milliseconds()/10),2)},SSS:function(){return g(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";0>a&&(a=-a,b="-");
return b+g(~~(a/60),2)+":"+g(~~a%60,2)},ZZ:function(){var a=-this.zone(),b="+";0>a&&(a=-a,b="-");return b+g(~~(10*a/6),4)},X:function(){return this.unix()}};na.length;)B=na.pop(),L[B+"o"]=c(L[B]);for(;ja.length;)B=ja.pop(),L[B+B]=b(L[B],2);L.DDDD=b(L.DDD,3);d.prototype={set:function(a){var b,c;for(c in a)b=a[c],"function"===typeof b?this[c]=b:this["_"+c]=b},_months:"January February March April May June July August September October November December".split(" "),months:function(a){return this._months[a.month()]},
_monthsShort:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),monthsShort:function(a){return this._monthsShort[a.month()]},monthsParse:function(a){var b,c;this._monthsParse||(this._monthsParse=[]);for(b=0;12>b;b++)if(this._monthsParse[b]||(c=r([2E3,b]),c="^"+this.months(c,"")+"|^"+this.monthsShort(c,""),this._monthsParse[b]=RegExp(c.replace(".",""),"i")),this._monthsParse[b].test(a))return b},_weekdays:"Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(" "),weekdays:function(a){return this._weekdays[a.day()]},
_weekdaysShort:"Sun Mon Tue Wed Thu Fri Sat".split(" "),weekdaysShort:function(a){return this._weekdaysShort[a.day()]},_weekdaysMin:"Su Mo Tu We Th Fr Sa".split(" "),weekdaysMin:function(a){return this._weekdaysMin[a.day()]},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(a){var b=this._longDateFormat[a];!b&&this._longDateFormat[a.toUpperCase()]&&(b=this._longDateFormat[a.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,
function(a){return a.slice(1)}),this._longDateFormat[a]=b);return b},meridiem:function(a,b,c){return 11<a?c?"pm":"PM":c?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},calendar:function(a,b){var c=this._calendar[a];return"function"===typeof c?c.apply(b):c},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",
dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(a,b,c,d){var e=this._relativeTime[c];return"function"===typeof e?e(a,b,c,d):e.replace(/%d/i,a)},pastFuture:function(a,b){var c=this._relativeTime[0<a?"future":"past"];return"function"===typeof c?c(b):c.replace(/%s/i,b)},ordinal:function(a){return this._ordinal.replace("%d",a)},_ordinal:"%d",preparse:function(a){return a},postformat:function(a){return a},week:function(a){return y(a,this._week.dow,this._week.doy)},
_week:{dow:0,doy:6}};r=function(a,b,c){return p({_i:a,_f:b,_l:c,_isUTC:!1})};r.utc=function(a,b,c){return p({_useUTC:!0,_isUTC:!0,_l:c,_i:a,_f:b})};r.unix=function(a){return r(1E3*a)};r.duration=function(a,b){var c=r.isDuration(a),d="number"===typeof a,e=c?a._data:d?{}:a;d&&(b?e[b]=a:e.milliseconds=a);d=new f(e);c&&a.hasOwnProperty("_lang")&&(d._lang=a._lang);return d};r.version="2.0.0";r.defaultFormat="YYYY-MM-DDTHH:mm:ssZ";r.lang=function(a,b){if(!a)return r.fn._lang._abbr;b?(b.abbr=a,U[a]||(U[a]=
new d),U[a].set(b)):U[a]||s(a);r.duration.fn._lang=r.fn._lang=s(a)};r.langData=function(a){a&&(a._lang&&a._lang._abbr)&&(a=a._lang._abbr);return s(a)};r.isMoment=function(a){return a instanceof e};r.isDuration=function(a){return a instanceof f};r.fn=e.prototype={clone:function(){return r(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1E3)},toString:function(){return this.format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._d},toJSON:function(){return r.utc(this).format("YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},
toArray:function(){return[this.year(),this.month(),this.date(),this.hours(),this.minutes(),this.seconds(),this.milliseconds()]},isValid:function(){null==this._isValid&&(this._isValid=this._a?!u(this._a,(this._isUTC?r.utc(this._a):r(this._a)).toArray()):!isNaN(this._d.getTime()));return!!this._isValid},utc:function(){this._isUTC=!0;return this},local:function(){this._isUTC=!1;return this},format:function(a){a=m(this,a||r.defaultFormat);return this.lang().postformat(a)},add:function(a,b){var c;c="string"===
typeof a?r.duration(+b,a):r.duration(a,b);q(this,c,1);return this},subtract:function(a,b){var c;c="string"===typeof a?r.duration(+b,a):r.duration(a,b);q(this,c,-1);return this},diff:function(a,b,c){a=this._isUTC?r(a).utc():r(a).local();var d=6E4*(this.zone()-a.zone()),e;b&&(b=b.replace(/s$/,""));"year"===b||"month"===b?(d=432E5*(this.daysInMonth()+a.daysInMonth()),e=12*(this.year()-a.year())+(this.month()-a.month()),e+=(this-r(this).startOf("month")-(a-r(a).startOf("month")))/d,"year"===b&&(e/=12)):
(d=this-a-d,e="second"===b?d/1E3:"minute"===b?d/6E4:"hour"===b?d/36E5:"day"===b?d/864E5:"week"===b?d/6048E5:d);return c?e:l(e)},from:function(a,b){return r.duration(this.diff(a)).lang(this.lang()._abbr).humanize(!b)},fromNow:function(a){return this.from(r(),a)},calendar:function(){var a=this.diff(r().startOf("day"),"days",!0);return this.format(this.lang().calendar(-6>a?"sameElse":-1>a?"lastWeek":0>a?"lastDay":1>a?"sameDay":2>a?"nextDay":7>a?"nextWeek":"sameElse",this))},isLeapYear:function(){var a=
this.year();return 0===a%4&&0!==a%100||0===a%400},isDST:function(){return this.zone()<r([this.year()]).zone()||this.zone()<r([this.year(),5]).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return null==a?b:this.add({d:a-b})},startOf:function(a){a=a.replace(/s$/,"");switch(a){case "year":this.month(0);case "month":this.date(1);case "week":case "day":this.hours(0);case "hour":this.minutes(0);case "minute":this.seconds(0);case "second":this.milliseconds(0)}"week"===a&&
this.day(0);return this},endOf:function(a){return this.startOf(a).add(a.replace(/s?$/,"s"),1).subtract("ms",1)},isAfter:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)>+r(a).startOf(b)},isBefore:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)<+r(a).startOf(b)},isSame:function(a,b){b="undefined"!==typeof b?b:"millisecond";return+this.clone().startOf(b)===+r(a).startOf(b)},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},
daysInMonth:function(){return r.utc([this.year(),this.month()+1,0]).date()},dayOfYear:function(a){var b=T((r(this).startOf("day")-r(this).startOf("year"))/864E5)+1;return null==a?b:this.add("d",a-b)},isoWeek:function(a){var b=y(this,1,4);return null==a?b:this.add("d",7*(a-b))},week:function(a){var b=this.lang().week(this);return null==a?b:this.add("d",7*(a-b))},lang:function(b){if(b===a)return this._lang;this._lang=s(b);return this}};for(B=0;B<W.length;B++)E(W[B].toLowerCase().replace(/s$/,""),W[B]);
E("year","FullYear");r.fn.days=r.fn.day;r.fn.weeks=r.fn.week;r.fn.isoWeeks=r.fn.isoWeek;r.duration.fn=f.prototype={weeks:function(){return l(this.days()/7)},valueOf:function(){return this._milliseconds+864E5*this._days+2592E6*this._months},humanize:function(a){var b=+this,c;c=!a;var d=this.lang(),e=T(Math.abs(b)/1E3),g=T(e/60),f=T(g/60),h=T(f/24),l=T(h/365),e=45>e&&["s",e]||1===g&&["m"]||45>g&&["mm",g]||1===f&&["h"]||22>f&&["hh",f]||1===h&&["d"]||25>=h&&["dd",h]||45>=h&&["M"]||345>h&&["MM",T(h/30)]||
1===l&&["y"]||["yy",l];e[2]=c;e[3]=0<b;e[4]=d;c=z.apply({},e);a&&(c=this.lang().pastFuture(b,c));return this.lang().postformat(c)},lang:r.fn.lang};for(B in la)la.hasOwnProperty(B)&&(O(B,la[B]),J(B.toLowerCase()));O("Weeks",6048E5);r.lang("en",{ordinal:function(a){var b=a%10;return a+(1===~~(a%100/10)?"th":1===b?"st":2===b?"nd":3===b?"rd":"th")}});Y&&(module.exports=r);"undefined"===typeof ender&&(this.moment=r);"function"===typeof define&&define.amd&&define("moment",[],function(){return r})}).call(this);
var Kongregate=Kongregate||{};Kongregate.Utils=Kongregate.Utils||{};Kongregate.Utils.isKlient=function(){return/klient|kartridge\//.test(navigator.userAgent.toLowerCase())};Kongregate.Utils.findKongregateWindow=function(){if(!Kongregate.Utils.isKlient())return top;for(var a=window,b=window.parent;b!==top;)a=b,b=a.parent;return a};
Kongregate.Utils.catchErrors=function(a,b,c){return function(){try{return a.apply(b,arguments)}catch(d){return Kongregate.Log.error("catchErrors caught unhandled exception",d),c}}};
(function(){function a(a,c,d){Kongregate.Log[a]=function(){try{"undefined"!==typeof active_user&&void 0===Kongregate.Log.debugLevel&&(Kongregate.Log.debugLevel=active_user.debugLevel()),Kongregate.Log.debugLevel>=c&&(console[d]?Function.prototype.apply.call(console[d],console,arguments):console.log(arguments))}catch(a){}}}Kongregate.Log={};a("spam",5,"log");a("debug",4,"log");a("info",3,"info");a("warn",2,"warn");a("error",1,"error")})();
KonduitEvent={INIT:"init",CONNECT:"connect",CONNECTED:"connected",DISCONNECT:"disconnect",LOGIN:"login",SWITCH_USER:"switch_user",JOIN_ROOM:"join_room",LEAVE_ROOM:"leave_room",USER_JOIN:"user_join",USER_DEPARTURE:"user_departure",USER_CHANGED:"user_changed",ROOM_MESSAGE:"room_message",SYSTEM_MESSAGE:"system_message",PRIVATE_MESSAGE:"private_message",ADMIN_MESSAGE:"admin_message",MESSAGE_ERROR:"message_error",SET_PRESENCE:"set_presence",GUEST_COUNT:"guest_count",ROOM_NOT_FOUND:"room_not_found",ROOM_FULL:"room_full",
REQUEST_CHAT_ROOM:"request_chat_room",CREATE_PRIVATE_ROOM:"create_private_room",DESTROY_PRIVATE_ROOM:"destroy_private_room",PRIVATE_ROOM_INVITATION:"private_room_invitation",PRIVATE_ROOM_KICK:"private_room_kick",PRIVATE_ROOM_INVITATION_SENT:"private_room_invitation_sent",JOIN_GUILD_ROOM:"join_guild_room",SILENCED:"silenced",PARTICIPATE:"participate",AMNESTY:"amnesty",API_INITIALIZED:"api_initialized",ADD_STATISTICS:"add_statistics",STATISTIC_UPDATED:"statistic_updated",STATISTIC_SUBMISSION:"statistic_submission",
STATISTICS_FLUSH:"statistics_flush",STATISTICS_FORCE_FLUSH:"statistics_force_flush",SET_ACCOMPLISHMENT_PROGRESS:"set_accomplishment_progress",NEW_HIGH_SCORE:"new_high_score",DISPLAY_SHOUT_BOX:"display_shout_box",DISPLAY_INVITATION_BOX:"display_invitation_box",SEND_PRIVATE_MESSAGE:"send_private_message",DISPLAY_FEED_POST_BOX:"display_feed_post_box",DISPLAY_SIGN_IN_LIGHTBOX:"display_sign_in_lightbox",DISPLAY_REGISTRATION_LIGHTBOX:"display_registration_lightbox",LIGHTBOX_OPENED:"lightbox_opened",LIGHTBOX_CLOSED:"lightbox_closed",
ACCOMPLISHMENT_TASK_PROGRESS:"accomplishment_task_progress",ACCOMPLISHMENT_COMPLETE:"accomplishment_complete",RESIZE_GAME:"resize_game",HANDLE_ITEM_CHECKOUT_REQUEST:"handle_item_checkout_request",KONDUIT_MESSAGE:"konduit_message",ANALYTICS_PAYLOAD:"analytics_payload",OP_EXTERNAL_MESSAGE:"ext.msg",OP_CONNECTED:"connected",OP_HELLO:"hello",OP_USER_INFO:"user.info",OP_SIGN_IN:"sign_in",PARAM_USER:"user",PARAM_USER_ID:"user_id",PARAM_GAME_AUTH_TOKEN:"auth_token",PURCHASE_RESULT:"purchase_result",PARAM_LOCALCONNECTION_ONLY:"localconnection_only",
CUSTOM_TAB_MESSAGE:"custom_tab_message",CUSTOM_TAB_SHOW:"custom_tab_show",CUSTOM_TAB_CLOSE:"custom_tab_close",CUSTOM_TAB_SHOWN:"custom_tab_shown",CUSTOM_TAB_CLEAR_MESSAGES:"custom_tab_clear_messages",OP_CHAT_TAB:"chat.tab",OP_CHAT_CLEAR_DIALOG:"chat.dlg.clear",OP_CHAT_DISPLAY:"chat.disp",OP_CHAT_MSG:"chat.msg",OP_CHAT_CANVAS_ELEMENT:"chat.elm",OP_CHAT_PRIVATE_MESSAGE:"chat.privateMessage",OP_CHAT_RESIZE_GAME:"chat.resizeGame",OP_CHAT_DISPLAY_INVITATION_BOX:"chat.invite",OP_CHAT_DISPLAY_FEED_POST_BOX:"chat.feedpost",
OP_CHAT_DISPLAY_REGISTRATION:"chat.registration",OP_CHAT_DISPLAY_SHOUT_BOX:"chat.shoutbox",PARAM_SHOUT_MESSAGE:"shout_message",PARAM_CANVAS_SIZE:"chat.canvas.size",PARAM_RESIZE_GAME_WIDTH:"chat.resizeGame.width",PARAM_RESIZE_GAME_HEIGHT:"chat.resizeGame.height",PARAM_INVITATION_MESSAGE:"invitation_message",PARAM_FRIEND_FILTER:"filter",PARAM_IMAGE_URI:"image_uri",PARAM_KV_PARAMS:"kv_params",PARAM_NAME:"name",PARAM_DESCRIPTION:"desc",PARAM_DATA:"data",OP_SHOUT_CALLBACK:"ext.shout_callback",PARAM_MESSAGE_TYPE:"ext.message_type",
PARAM_MESSAGE_RECIPIENTS:"ext.message_recipients",PARAM_ERROR:"error",PARAM_SUCCESS:"success",PARAM_REQUEST_ID:"req.id",OP_STATS_SUBMIT:"stat.submit",PARAM_STATS:"stats",ITEM_LIST:"mtx.item_list",ITEM_CHECKOUT:"mtx.checkout",PURCHASE_KREDS:"mtx.kred_purchase",ITEM_INSTANCES:"mtx.item_instances",USE_ITEM_INSTANCE:"mtx.use_item_instance",PARAM_PURCHASE_METHOD:"purchase_method",PARAM_ITEM_TAGS:"item_tags",PARAM_ITEMS:"items",PARAM_ORDER_INFO:"order_info",PARAM_ID:"id",ADS_INITIALIZE:"ads.initialize",
ADS_AVAILABLE:"ads.available",ADS_UNAVAILABLE:"ads.unavailable",ADS_SHOW_INCENTIVIZED:"ads.show_incentivized",AD_OPENED:"ads.ad_opened",AD_COMPLETED:"ads.ad_completed",AD_ABANDONED:"ads.ad_abandoned",PROCESSING_SAVE_SHARED_CONTENT:"processing_save_shared_content",SAVE_SHARED_CONTENT:"save_shared_content",SAVE_SHARED_CONTENT_COMPLETE:"shared_content_save_complete",LOAD_SHARED_CONTENT:"load_shared_content",BROWSE_SHARED_CONTENT:"browse_shared_content",OP_SAVE_SHARED_CONTENT:"save_shared_content",OP_BROWSE_SHARED_CONTENT:"browse_shared_content",
OP_LOAD_SHARED_CONTENT:"load_shared_content",OP_SHARED_CONTENT_SAVE_COMPLETE:"shared_content_save_complete",PARAM_CONTENT_TYPE:"content_type",PARAM_LABEL:"label",PARAM_IMAGE:"image",PARAM_PERMALINK:"permalink",OP_IMAGE_AVATAR_SUBMIT:"avatar.submit",OP_IMAGE_AVATAR_FINISHED:"avatar.finished",IMAGE_AVATAR_SUBMIT:"image_avatar_submit",IMAGE_AVATAR_COMPLETE:"image_avatar_complete",OP_ANALYTICS_PAYLOAD:"analytics.payload",HOLODECK_DATA:"holodeck_data",PARAM_HOLODECK_TYPE:"holodeck_type",FETCH_HISTORY:"fetch_history",
HISTORY_RECEIVED:"history_received",FAYE_DISCONNECT:"faye_disconnect"};KonduitChatErrorMessage={MESSAGE_TOO_LONG:"error_msg_too_long",RATE_LIMITED:"error_msg_rate_limit"};KonduitPresenceType={CHAT:"chat",AWAY:"away"};KonduitEventDispatcher=function(){this.initialize()};
KonduitEventDispatcher.prototype={initialize:function(){this._callbacks={}},map:function(a,b){var c=this;this.register(a,function(a){c.fire({type:b,data:a.data})})},register:function(a,b){this._callbacks.hasOwnProperty(a)||(this._callbacks[a]=[]);this._callbacks[a].push(b)},fire:function(a){var b=a.type;if(this._callbacks.hasOwnProperty(b))for(var c=0,d=this._callbacks[b].length;c<d;c++)this._callbacks[b][c](a)},sendMessage:function(a,b){this.fire({type:KonduitEvent.KONDUIT_MESSAGE,opcode:a,params:b||
{}})}};ApiService=function(a){this.initialize(a)};
ApiService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._createServices(a);this._mapEvents();this._eventDispatcher.register(KonduitEvent.OP_HELLO,this._onClientConnected.bind(this));this._eventDispatcher.register(KonduitEvent.SWITCH_USER,this._sendUserInfo.bind(this))},_mapEvent:function(a,b){ApiService._mapEvent(this._eventDispatcher,a,b)},_mapEvents:function(){this._mapEvent("chat.sign",KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX);
this._mapEvent("chat.registration",KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX);this._mapEvent("chat.shoutbox",KonduitEvent.DISPLAY_SHOUT_BOX);this._mapEvent("chat.feedpost",KonduitEvent.DISPLAY_FEED_POST_BOX);this._mapEvent("chat.invite",KonduitEvent.DISPLAY_INVITATION_BOX);this._mapEvent("chat.privateMessage",KonduitEvent.SEND_PRIVATE_MESSAGE);this._mapEvent("chat.resizeGame",KonduitEvent.RESIZE_GAME)},_createServices:function(a){(new StatisticService({event_dispatcher:a.event_dispatcher,active_user:a.active_user,
statistics:a.statistics,is_connected:a.is_connected})).start();new AnalyticsService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new MicrotransactionService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new AdService({event_dispatcher:a.event_dispatcher,active_user:a.active_user,ad_manager:a.ad_manager});new SharedContentService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});new ImageService({event_dispatcher:a.event_dispatcher,active_user:a.active_user});
new ChatService({event_dispatcher:a.event_dispatcher,active_user:a.active_user})},_onClientConnected:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_HELLO,{success:!0});this._sendUserInfo();this._eventDispatcher.fire({type:KonduitEvent.API_INITIALIZED})},_sendUserInfo:function(){this._eventDispatcher.sendMessage(KonduitEvent.OP_USER_INFO,{user:this._activeUser.username(),user_id:this._activeUser.id(),auth_token:this._activeUser.gameAuthToken()});this._eventDispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD})}};
ApiService._mapEvent=function(a,b,c){a.register(b,function(b){a.fire({type:c,data:b.data})})};ChatService=function(a){this.initialize(a)};
ChatService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._konduitToCanvas=a.canvas_dispatcher||window.konduitToCanvas;this._queuedMessages=[];this._customTabShowing=!1;this._activeUser.chatApiEnabled()&&(this._eventDispatcher.register(KonduitEvent.OP_CHAT_TAB,this.onChatTabRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CLEAR_DIALOG,this.clearChat.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_DISPLAY,
this.onChatDisplayRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_MSG,this.onCustomTabMessage.bind(this)),this._eventDispatcher.register(KonduitEvent.OP_CHAT_CANVAS_ELEMENT,this.onCanvasElementRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.CUSTOM_TAB_SHOWN,this.onCustomTabShown.bind(this)))},closeTab:function(){Kongregate.Log.info("Closing tab!");this._customTabShowing=!1;this.clearChat();this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLOSE,data:{}})},
clearChat:function(){this._queuedMessages=[];this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,data:{}})},onChatTabRequest:function(a){a=a.data;this._queuedMessages=[];var b=a.name;if(ChatService.DEFAULT_TAB===b)this.closeTab();else{var c=a[KonduitEvent.PARAM_CANVAS_SIZE];if(!isFinite(c)||0>c)c=0.5;this.clearChat();this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_SHOW,data:{name:b,description:a.desc,size:Math.min(c,1)/2}})}},onCustomTabShown:function(a){Kongregate.Log.info("Custom tab visible!");
this._customTabShowing=!0;this.flushMessageQueue();var b={};b[KonduitEvent.PARAM_CANVAS_SIZE]=a.data;this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_TAB,b)},onChatDisplayRequest:function(a){var b=a.data;a=b.user;b=Kongregate.LanguageFilter.filter(b.data);a&&b&&(0===a.indexOf("@")&&(a=a.substr(1,a.length-1)),this._eventDispatcher.fire({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{user:{username:a},message:b}}))},onCustomTabMessage:function(a){a=a.data;this._eventDispatcher.sendMessage(KonduitEvent.OP_CHAT_MSG,
{user:a.user.username,data:a.message})},onCanvasElementRequest:function(a){this._queuedMessages.push({type:a.type,data:a.data.data});this._customTabShowing&&this.flushMessageQueue()},flushMessageQueue:function(){var a=this;this._queuedMessages.forEach(function(b){a._konduitToCanvas(b)});this._queuedMessages=[]}};ChatService.DEFAULT_TAB="Default";ChatService.CUSTOM_TAB="custom";ImageService=function(a){this.initialize(a)};
ImageService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.OP_IMAGE_AVATAR_SUBMIT,this.onAvatarSubmit.bind(this));this._eventDispatcher.register(KonduitEvent.IMAGE_AVATAR_COMPLETE,this.onAvatarSubmissionResult.bind(this))},onAvatarSubmit:function(a){if(this._activeUser.isAuthenticated()){var b=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:a.data.image||Kongregate.DEFAULT_ICON_BASE64},
success:function(a){b._eventDispatcher.fire({type:KonduitEvent.IMAGE_AVATAR_SUBMIT,data:{filename:a}})},error:this.onFailure.bind(this)})}else this.onFailure()},onAvatarSubmissionResult:function(a){this._eventDispatcher.sendMessage(KonduitEvent.OP_IMAGE_AVATAR_FINISHED,{success:a.data.success})},onFailure:function(){this.onAvatarSubmissionResult({data:{success:!1}})}};KonduitJavascriptAdapter=function(a){this.initialize(a)};KonduitJavascriptAdapter.IGNORED_EVENTS=[KonduitEvent.ADD_STATISTICS];
KonduitJavascriptAdapter.prototype={initialize:function(a){this._activeUser=a.activeUser;this._eventDispatcher=a.eventDispatcher;this._klient=Kongregate.Utils.isKlient();this.initializeEventMap();this.initializeMessageConnection()},initializeMessageConnection:function(){this.messageConnection=new Kongregate.MessageConnection({channel_id:window.channel_id});this.messageConnection.addMessageListener(this._onClientMessage.bind(this));this.messageConnection.listen()},initializeEventMap:function(){this._eventMap=
{};this._eventMap[KonduitEvent.CUSTOM_TAB_SHOW]=KonduitEvent.CUSTOM_TAB_SHOWN;this._eventMap[KonduitEvent.CUSTOM_TAB_MESSAGE]=KonduitEvent.OP_CHAT_MSG;this._eventMap[KonduitEvent.SWITCH_USER]=KonduitEvent.SWITCH_USER;this._eventMap[KonduitEvent.IMAGE_AVATAR_COMPLETE]=KonduitEvent.IMAGE_AVATAR_COMPLETE;this._eventMap[KonduitEvent.OP_LOAD_SHARED_CONTENT]=KonduitEvent.OP_LOAD_SHARED_CONTENT;this._eventMap[KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE]=KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE},_onClientMessage:function(a,
b){this._eventDispatcher.fire({type:KonduitEvent.KONDUIT_MESSAGE,data:{outgoing:!0,opcode:a,params:b}})},_setLocalConnectionOnly:function(a,b){a[b]=$j.extend({},a[b]);a[b][KonduitEvent.PARAM_LOCALCONNECTION_ONLY]=!0},_forwardToKlient:function(a){this._klient&&top.postMessage({type:"kongregate:api-message:in",message:{opcode:a.opcode,params:a.params}},"*")},dispatchEvent:function(a){var b=this._eventMap[a.type];if(b)return this._eventDispatcher.fire({type:b,data:a.data}),!0;if(0<=KonduitJavascriptAdapter.IGNORED_EVENTS.indexOf(a.type))return!0;
this._forwardToKlient(a);if(!this.messageConnection.connected())return!1;switch(a.type){case KonduitEvent.KONDUIT_MESSAGE:this.messageConnection.sendMessage(a.opcode,a.params||{});break;default:this.messageConnection.sendMessage(KonduitEvent.OP_EXTERNAL_MESSAGE,{opcode:a.type,data:a.data})}this._setLocalConnectionOnly(a,a.data?"data":"params");return!1}};MicrotransactionService=function(a){this.initialize(a)};
MicrotransactionService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._activeUser.mtxApiEnabled()&&(this._eventDispatcher=a.event_dispatcher,this._eventDispatcher.register(KonduitEvent.ITEM_LIST,this.onItemListRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_CHECKOUT,this.onItemCheckoutRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.PURCHASE_KREDS,this.onKredPurchaseRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.ITEM_INSTANCES,
this.onItemInstanceRequest.bind(this)),this._eventDispatcher.register(KonduitEvent.USE_ITEM_INSTANCE,this.onUseItemInstanceRequest.bind(this)))},onItemListRequest:function(a){var b=this._eventDispatcher,c=(a.data.item_tags||[]).filter(function(a){return"string"===typeof a&&0<a.length}),d=function(c){var d=c.success,e={success:d};e[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];d&&(e.data=c.items);b.sendMessage(KonduitEvent.ITEM_LIST,e)},e={api_key:this._activeUser.gameId()};
c.length&&(e.tags=c.join(","));Kongregate.Log.info("Requesting item list from server");$j.ajax({url:"/api/items.json",cache:!1,data:e,success:d,error:function(){d({success:!1})}})},onItemCheckoutRequest:function(a){var b=a.data.items,c=a.data.order_info,d;b?(b=MicrotransactionService.buildCartJSON(b),d="/checkouts/new?cart="+encodeURIComponent(b)):c&&(d="/checkouts/new?order_info="+encodeURIComponent(c));d?(Kongregate.Log.info("Path:",d),this._eventDispatcher.fire({type:KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,
data:{url:"https://"+location.host+this._activeUser.gameResourcePath()+d}})):Kongregate.Log.warn("Couldn't build a URL from item message:",a.data)},onItemInstanceRequest:function(a){var b=this._eventDispatcher,c=a.data.user,d=function(d){Kongregate.Log.info("Item instance list received for "+c);var f=d.success,h={success:f};h[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];f&&(h.data=d.items);b.sendMessage(KonduitEvent.ITEM_INSTANCES,h)};Kongregate.Log.info("Requesting item list from server");
$j.ajax({url:"/api/user_items.json",cache:!1,data:{api_key:this._activeUser.gameId(),username:c},success:d,error:function(){d({success:!1})}})},onUseItemInstanceRequest:function(a){var b=a.data.id,c=this._eventDispatcher,d=function(d){d=d.success;var f={success:d,id:b};Kongregate.Log.info("Item instance use result for item instance id:"+b+", success: "+d);f[KonduitEvent.PARAM_REQUEST_ID]=a.data[KonduitEvent.PARAM_REQUEST_ID];c.sendMessage(KonduitEvent.USE_ITEM_INSTANCE,f)};Kongregate.Log.info("Requesting item instance use for item ID: "+
b);$j.ajax({url:"/api/use_item.json",method:"POST",data:{api_key:this._activeUser.gameId(),user_id:this._activeUser.id(),game_auth_token:this._activeUser.gameAuthToken(),id:b},success:d,error:function(){d({success:!1})}})},onKredPurchaseRequest:function(a){this._activeUser.activateKredPurchase(a.data.purchase_method)}};
MicrotransactionService.buildCartJSON=function(a){if(!a||0===a.length)return"[]";a=a.map(function(a){return a?"string"===typeof a||$j.isNumeric(a)?{identifier:a}:Array.isArray(a)?1<=a.length?{identifier:a[0],data:a[1]}:null:"string"===typeof a.identifier&&0<a.identifier.length?a:null!==a&&void 0!==a&&$j.isNumeric(a.identifier)?a:null:null}).filter(function(a){return null!==a});return JSON.stringify(a)};SharedContentService=function(a){this.initialize(a)};
SharedContentService.prototype={initialize:function(a){this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._eventDispatcher.register(KonduitEvent.SAVE_SHARED_CONTENT,this.onSaveSharedContentRequest.bind(this));this._eventDispatcher.register(KonduitEvent.OP_LOAD_SHARED_CONTENT,this.onSharedContentLoaded.bind(this));this._eventDispatcher.register(KonduitEvent.OP_SHARED_CONTENT_SAVE_COMPLETE,this.onSharedContentSaved.bind(this))},onSharedContentLoaded:function(a){var b=
a.data,c={};c[KonduitEvent.PARAM_DATA]=b.content;c[KonduitEvent.PARAM_CONTENT_TYPE]=b.contentType;c[KonduitEvent.PARAM_NAME]=b.name;c[KonduitEvent.PARAM_PERMALINK]=b.permalink;c[KonduitEvent.PARAM_ID]=b.id;c[KonduitEvent.PARAM_LABEL]=b.label;this._eventDispatcher.sendMessage(a.type,c)},onSharedContentSaved:function(a){var b=a.data,c={};c[KonduitEvent.PARAM_DATA]=b.content;c[KonduitEvent.PARAM_SUCCESS]=b.success;c[KonduitEvent.PARAM_NAME]=b.name;c[KonduitEvent.PARAM_PERMALINK]=b.permalink;c[KonduitEvent.PARAM_ID]=
b.id;c[KonduitEvent.PARAM_LABEL]=b.label;this._eventDispatcher.sendMessage(a.type,c)},onSaveSharedContentRequest:function(a){var b=a.data;if(!b.filename)if(this._activeUser.sharedContentApiEnabled()){var c=this;$j.ajax({method:"POST",url:"/image_importer",data:{base64:b.image||Kongregate.DEFAULT_ICON_BASE64},success:function(a){c._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{contentType:b.content_type,content:b.data,label:b.label,filename:a}})},error:this.saveFailed.bind(this)});
this._eventDispatcher.fire({type:KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT})}else this._eventDispatcher.fire({type:KonduitEvent.SAVE_SHARED_CONTENT,data:{}}),this.saveFailed()},saveFailed:function(){this._eventDispatcher.sendMessage(KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,{name:null,data:null,label:null,id:null,permalink:null,success:!1})}};StatisticService=function(a){this.initialize(a)};StatisticService.MAX_STATS_FOR_PRIORITY={low:10,medium:10,high:5};
StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL=6E4;StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL=1E4;StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL=1E4;
StatisticService.prototype={initialize:function(a){this._statistics=a.statistics;this._isConnected=a.is_connected||function(){return!1};this._activeUser=a.active_user||window.active_user;this._eventDispatcher=a.event_dispatcher;this._started=!1;var b=this;this._activeUser.addOnAuthenticatedObserver(this.start.bind(this));this._eventDispatcher.register(KonduitEvent.OP_STATS_SUBMIT,function(a){b.submitStats(a.data.stats)})},start:function(){if(this._activeUser.isAuthenticated()&&!this._started){this._started=
!0;var a=this.lowPriorityStats(),b=this.mediumPriorityStats(),c=this.highPriorityStats();Kongregate.Log.debug("Initializing statistic service!");Kongregate.Log.debug("Stats count. Low:"+a.length+", Med:"+b.length+", High: "+c.length);Kongregate.Log.debug({lowStats:a});Kongregate.Log.debug({mediumStats:b});Kongregate.Log.debug({highStats:c});this.flushStatsWithIncompleteTasks();this.startTimers();this._eventDispatcher.register(KonduitEvent.STATISTICS_FLUSH,this.onStatisticsFlush.bind(this));this._eventDispatcher.register(KonduitEvent.STATISTICS_FORCE_FLUSH,
this.onForceFlush.bind(this));this._eventDispatcher.register(KonduitEvent.DISCONNECT,this.onDisconnect.bind(this))}},startTimers:function(){var a=this;this._lowPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.LOW)},StatisticService.LOW_PRIORITY_FLUSHER_INTERVAL);this._mediumPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.MEDIUM)},StatisticService.MEDIUM_PRIORITY_FLUSHER_INTERVAL);this._highPriorityFlusher=setInterval(function(){a.flushPriorityStats(Statistic.HIGH)},
StatisticService.HIGH_PRIORITY_FLUSHER_INTERVAL)},stop:function(){clearInterval(this._lowPriorityFlusher);clearInterval(this._mediumPriorityFlusher);clearInterval(this._highPriorityFlusher)},reset:function(){Kongregate.Log.info("Resetting statistic service");this._statistics.forEach(function(a){a.reset()})},submitStats:function(a){if(a&&a.length)for(var b=0;b<a.length;b++)this.submit(a[b].name,a[b].value)},submit:function(a,b){var c=this._statistics.find(function(b){return b.name()===a});c?(b=Math.floor(b),
c.attemptUpdate(b)&&(this._activeUser.isAuthenticated()||this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:c.id(),value:c.value()})),this._activeUser.isAuthenticated()&&c.sendImmediately()&&(Kongregate.Log.debug("Instantly flushing",c),this.flushStats([c]))):Kongregate.Log.warn("No statistic named "+a+" found, ignoring")},flushStats:function(a){if(this._activeUser.isAuthenticated())if(this._isConnected&&!this._isConnected())Kongregate.Log.warn("Holding off on statistic flush since we're not connected");
else{var b={};a.filter(function(a){return a.id&&void 0!==a.id()&&null!==a.id()}).forEach(function(a){b[a.id()]=a.valueToSend();a.markAsSent()});0!==Object.keys(b).length&&this.dispatchEvent(KonduitEvent.STATISTICS_FLUSH,{user:this._activeUser.username(),stats:JSON.stringify(b)})}},flushPriorityStats:function(a){if(this._activeUser.isAuthenticated()){var b=Statistic.sortOnSentAt(this.statsForPriority(a)).filter(function(a){return a.readyToSend()}).slice(0,this.maxStatsToSendForPriority(a));if(0!==
b.length){var c={};c["flush"+a]=b;Kongregate.Log.debug(c);this.flushStats(b)}}},flushStatsWithIncompleteTasks:function(){var a=this._statistics.filter(function(a){return a.readyToSend()&&a.hasIncompleteTasks()});0<a.length&&(Kongregate.Log.info("Flushing all stats with tasks, length="+a.length),this.flushStats(a))},processServerResponse:function(a){if(this._activeUser.isAuthenticated())if(a.user_id&&a.user_id!==this._activeUser.id())Kongregate.Log.warn("Not processing stats response since it was for a different user");
else{if(!a.success&&a.retry)return this.resetPendingValues();this.parseAddStats(a["stats.add"]);this.parseServerStats(a.stats);this.parseTaskStatsProgressed(a["stats.prgs"]);this.parseCurrentHighScores(a["stats.current_high"])}else this.reset()},parseAddStats:function(a){this.forEachStatId(a,function(a,c){a.setSavedValue(c)})},parseServerStats:function(a){this.forEachStatId(a,function(a,c){Statistic.ADD_TYPE===a.type()?a.setPendingValue(a.pendingValue()-c):(a.betterThanSavedValue(c)&&a.setSavedValue(c),
(a.betterThanPendingValue(c)||c==a.pendingValue())&&a.setPendingValue(null));ApiLogger.echoToConsole("debug","["+a.name()+"-ServerUpdate]: submitted="+c+", saved="+a.savedValue()+", pending="+a.pendingValue()+", value="+a.value())})},parseTaskStatsProgressed:function(a){if(a)for(var b in a)a.hasOwnProperty(b)&&this.dispatchEvent(KonduitEvent.STATISTIC_UPDATED,{id:parseInt(b,10),value:a[b]})},parseCurrentHighScores:function(a){if(a&&a.length){var b=this;this.forEachStatId(a,function(a){b.dispatchEvent(KonduitEvent.NEW_HIGH_SCORE,
{id:a.id(),value:a.savedValue()})})}},onForceFlush:function(){Kongregate.Log.info("Forcing flush of all statistics");this.flushStats(this._statistics)},onStatisticsFlush:function(a){a.data.result&&this.processServerResponse(a.data)},onDisconnect:function(a){Kongregate.Log.debug("Disconnect detected, resetting statistic pending values");this.resetPendingValues()},resetPendingValues:function(){this._statistics.forEach(function(a){a.resetPendingValue()})},dispatchEvent:function(a,b){this._eventDispatcher.fire({type:a,
data:b})},lowPriorityStats:function(){return this.statsForPriority(Statistic.LOW)},mediumPriorityStats:function(){return this.statsForPriority(Statistic.MEDIUM)},highPriorityStats:function(){return this.statsForPriority(Statistic.HIGH)},statsForPriority:function(a){return this._statistics.filter(function(b){return a===b.priority()})},forEachStatId:function(a,b){if(a){var c=Object.isArray(a),d;for(d in a)if(a.hasOwnProperty(d)){var e=c?this.statForId(a[d]):this.statForId(d);e?b(e,c?null:a[d]):ApiLogger.echoToConsole("warn",
"Statistic ID "+d+" not found")}}},statForId:function(a){return this._statistics.find(function(b){return b.id()==a})},maxStatsToSendForPriority:function(a){return StatisticService.MAX_STATS_FOR_PRIORITY[a]||5}};ChatApiTab=function(a){this.initialize(a)};
ChatApiTab.prototype={initialize:function(a){this._holodeck=a.holodeck;if(this._node=$("chat_api_pane")){this._canvas_node=this._node.down("#chat_api_canvas");this._title_node=this._node.down(".chat_api_pane_title");var b=this,c=this._holodeck;this._chat_dialogue=new ChatDialogue(this._node,function(a){b.sentMessage(a);c.konduit().dispatchEvent({type:KonduitEvent.CUSTOM_TAB_MESSAGE,data:{message:a,user:{username:c.username()}}})},this._holodeck,this._holodeck.chatWindow())}},sentMessage:function(a){this._chat_dialogue.displayMessage(this._holodeck.username(),
a,{},{non_user:!0})},receivedMessage:function(a){this._chat_dialogue.displayMessage(a.data.user.username,a.data.message,{},{non_user:!0})},clearMessages:function(a){this._chat_dialogue.clear()},setTabInfo:function(a){var b=this._holodeck.height(),c=parseInt(a.data.size*b,10),b=Math.min(b-94,b-c-80);$("chat_api_canvas").setStyle({height:c+"px"});this._chat_dialogue.setMessageWindowHeight(b);this._title_node.update(a.data.description);a="string"==typeof a.data.name?a.data.name.substr(0,10):"Match";
$("chat_api_title").update(a)}};ChatDialogue=function(a,b,c,d){this.initialize(a,b,c,d)};ChatDialogue.MAX_CHARS_PER_MESSAGE=250;ChatDialogue.SCROLL_FUDGE=35;ChatDialogue.VERY_LARGE_SCROLL=131072;ChatDialogue.COLLECTION_PERIOD=8;ChatDialogue.MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');
ChatDialogue.GUILD_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>\n</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');ChatDialogue.GUEST_MESSAGE_TEMPLATE=new Template('<p class="#{classNames}">\n<span class="timestamp">#{timestamp}</span>\n<span class="guildname">\n<span class="truncate">#{characterName}</span>:\n</span>\n<span class="message hyphenate">#{message}</span></p>');
ChatDialogue.MOTD_MESSAGE_TEMPLATE=new Template('<p class="whisper received_whisper">\n<span class="timestamp">#{timestamp}</span>\n<span username="#{username}" class="username #{userClassNames}">\n<span username="#{username}" class="truncate">#{prefix}#{username}</span>:\n</span>\n<span class="message hyphenate">#{message}</span>\n</p>');ChatDialogue.GUILD_JOIN_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> joined the guild\n</span>\n</p>');
ChatDialogue.GUILD_LEAVE_TEMPLATE=new Template('<p class="room-activity joined-guild">\n<span class="msg">\n<strong title="#{characterName}" class="truncate">#{characterName}</strong> left the guild\n</span>\n</p>');
ChatDialogue.prototype={initialize:function(a,b,c,d){this._messages_until_next_collection=0;this._holodeck=c;this._user_manager=d;this._parent_node=a;this._messages_count=0;this._onInputFunction=b;this._message_window_node=a.down(".chat_message_window");this._input_node=a.down(".chat_input");this._charsRemainingNode=$j(a.down(".chat_chars_remaining"));this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200;var e=this;this._input_node.observe("keypress",function(a){e.onKeyPress(a)});
this._input_node.observe("focus",function(a){e.clearPrompt()});$j(this._input_node).on("textchange",function(){e.updateCharsRemaining(e._input_node)});this._message_window_node.observe("click",function(a){if(a.target){var b=a.target.getAttribute("username");b&&(a.stop(),d.showProfile(b))}})},focus:function(){this._input_node.focus()},onKeyPress:function(a){a.keyCode==Event.KEY_RETURN&&(this.sendInput(),this.updateCharsRemaining(a.target),a.stop())},updateCharsRemaining:function(a){a=a.value.length;
if(a>ChatDialogue.MAX_CHARS_PER_MESSAGE)return this._charsRemainingNode.addClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-a),!1;this._charsRemainingNode.removeClass("full").text(ChatDialogue.MAX_CHARS_PER_MESSAGE-a)},clearPrompt:function(){this._input_node.hasClassName("prompt_text")&&(this._input_node.removeClassName("prompt_text"),this._input_node.value="",this._input_node.stopObserving("focus"))},sendInput:function(){var a=this._input_node.value;this._holodeck.processChatCommand(a)&&this._holodeck.filterOutgoingMessage(a,
this._onInputFunction);this._input_node.value=""},disable:function(){this._parent_node.down(".chat_controls").hide()},enable:function(){this._parent_node.down(".chat_controls").show()},displayUnsanitizedMessage:function(a,b,c,d){c||(c={});d||(d={});allow_mutes=(active_room=this._holodeck.chatWindow().activeRoom())&&!active_room.canUserModerate(active_room.self())||d.whisper;if(!allow_mutes||!this._user_manager.isMuted(a)){var e=!d.non_user?"chat_message_window_username":"chat_message_window_undecorated_username",
f=a==this._user_manager.username(),h=[],e=[e],l=d["private"]?"To ":"";this._messages_count%2&&h.push("even");c["class"]&&h.push(c["class"]);f&&e.push("is_self");d.timestamp=d.timestamp?new Date(d.timestamp):new Date;d.formatted_timestamp=d.timestamp.format("mmm d - h:MMTT");a=this.messageContent({prefix:l,username:a,message:b,classNames:h.join(" "),userClassNames:e.join(" "),characterName:d.characterName,timestamp:d.formatted_timestamp,template:d.template});this.insert(a,null,{timestamp:d.timestamp});
this._messages_count++}},messageContent:function(a){var b=!a.username.match(/^_/);return(a.template?a.template:a.characterName&&b?ChatDialogue.GUILD_MESSAGE_TEMPLATE:b?ChatDialogue.MESSAGE_TEMPLATE:ChatDialogue.GUEST_MESSAGE_TEMPLATE).evaluate(a)},displayMessage:function(a,b,c,d){var e=this;this._holodeck.filterIncomingMessage(b,function(b){e.displayUnsanitizedMessage(a,b,c,d)})},kongBotMessage:function(a){this.displayMessage("Kong Bot",a,{"class":"whisper received_whisper"},{non_user:!0})},displaySystemMessage:function(a,
b){switch(a.type){case "guild_join":this.displayUnsanitizedMessage("Kong Bot",null,{},{non_user:!0,timestamp:b,characterName:a.character_name,template:ChatDialogue.GUILD_JOIN_TEMPLATE});break;case "guild_leave":this.displayUnsanitizedMessage("Kong Bot",null,{},{non_user:!0,timestamp:b,characterName:a.character_name,template:ChatDialogue.GUILD_LEAVE_TEMPLATE})}},insert:function(a,b,c){var d=this,e=this._message_window_node,f=this._holodeck;f.scheduleRender(function(){var h=e.getHeight(),l=h+e.scrollTop+
ChatDialogue.SCROLL_FUDGE>=e.scrollHeight,g=0!==h&&l;f.scheduleRender(function(){if("string"==typeof a||a instanceof String)a=$j("<div/>",{html:a,"class":"chat-message"});c=c||{};var f=$j(a).data(c),h=!1,l;$j(e).children(".chat-message").each(function(){var a=$j(this).data("timestamp");if(a>c.timestamp)return l=this,d.sameTimestamps(c.timestamp,a)&&$j(this).find(".timestamp").hide(),!1;!h&&(c.timestamp&&d.sameTimestamps(c.timestamp,a))&&(h=!0)});h&&f.find(".timestamp").hide();l?(f.insertBefore(l),
g=!1):f.appendTo(e);g&&d.scrollToBottom();b&&b()})})},scrollToBottom:function(){this._message_window_node.scrollTop=ChatDialogue.VERY_LARGE_SCROLL},setInput:function(a){this.clearPrompt();var b=this._input_node;setTimeout(function(){b.setValue(a);b.positionCaretAtEnd()},0)},sendPrivateMessage:function(a,b){this._user_manager.sendPrivateMessage(a,b);this.displayMessage(a,b,{"class":"whisper sent_whisper"},{"private":!0})},receivedPrivateMessage:function(a){if(a.data.success){var b=this;this._holodeck.filterIncomingMessage(a.data.message,
function(c){b.displayUnsanitizedMessage(a.data.from,c+'&nbsp; (<a class="reply_link" onclick="holodeck.insertPrivateMessagePrefixFor(\''+a.data.from+'\');return false;" href="#">reply</a>)',{"class":"whisper received_whisper"},{whisper:!0})})}else this.kongBotMessage(a.data.to+" cannot be reached. Please try again later.")},setMessageWindowHeight:function(a){this._message_window_node.setStyle({height:a+"px"})},clear:function(){this._message_window_node.update("")},earliestTimestamp:function(){var a=
$j(this._message_window_node).children(".chat-message").first();return a&&a.data("timestamp")?a.data("timestamp")/1E3:0},sameTimestamps:function(a,b){return"undefined"!==typeof a&&"undefined"!==typeof b&&a.getYear()===b.getYear()&&a.getMonth()===b.getMonth()&&a.getDay()===b.getDay()&&a.getHours()===b.getHours()&&a.getMinutes()===b.getMinutes()}};ChatNag=function(a,b){this.initialize(a,b)};
ChatNag.prototype={initialize:function(a,b){this._chat_window=a;this._chat_nags=b;this._current_increment=0;b.each(function(a){active_user.isPremium()&&a.advertising&&b.splice(b.indexOf(a),1)});if(b&&0<b.length){var c=this;this._executer=new PeriodicalExecuter(function(){c.showNag()},60)}},showNag:function(){var a,b,c,d,e,f;this._current_increment+=1;if(this._chat_nags&&(0<this._chat_nags.length&&this._current_increment===this._chat_nags.first().spawn_delay)&&(a=this._chat_nags.shift(),!this.targetedToDifferentRoom(a))){if(e=
null!==a.cnid){f="kong_cns_"+a.cnid;if(a.suppressible&&Cookie.get(f))return;if(a.per_user_limit){b="kong_cnul_"+a.cnid;c=parseInt(Cookie.get(b)||0,10);if(c>=a.per_user_limit)return;Cookie.set(b,c+1,a.days_to_expire,"/")}b=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||1,10);c="kong_cn_"+a.cnid;d=parseInt(Cookie.get(c)||0,10);d+=a.frequency}if(!e||d<=b)this._chat_window.showChatNag(this.prepareNagContent(a),function(){var b=$("nag_supress_control_"+a.cnid);b&&b.observe("click",function(b){$("nag_wrapper_"+
a.cnid).hide();Cookie.set(f,"true",a.days_to_expire,"/");Event.stop(b);return!1})}),this._chat_window.recordAnalyticsEvent("ChatNag",a.name),e&&(Cookie.set(c,b,a.days_to_expire,"/"),a.has_campaign_cap&&new Ajax.Request("/chat_nags/"+a.cnid+"/increment",{method:"post"}))}},prepareNagContent:function(a){var b=(new Date).getTime(),b=a.nag_content.gsub("TIMESTAMP",b),c=new Template('<div id="nag_wrapper_#{cnid}" class="chat_nag"><a title="Do not show this again" id="nag_supress_control_#{cnid}" class="nag_supress_control">X</a>#{content}</div>');
a.suppressible&&(b=c.evaluate({cnid:a.cnid,content:b}));return b},updateDefaultNag:function(a){if(this._chat_nags&&!(0===this._chat_nags.length||null!==this._chat_nags[0].cnid))this._chat_nags[0]=a},targetedToDifferentRoom:function(a){return a.targeted_room_id.blank()?!1:a.targeted_room_id!==this._chat_window.activeRoom().id()?!0:!1}};ChatRoom=function(a,b){this.initialize(a,b)};ChatRoom._generateTemplate=function(){this._template||(this._template=$$(".chat_room_template")[0])};
ChatRoom.template=function(){this._generateTemplate();return this._template.cloneNode(!0)};ChatRoom.updateTemplateSilenceScheduledEnd=function(a){this._generateTemplate();this._template.down(".silence_duration").update(tr("You have been silenced for "+a))};ChatRoom.initializeTemplates=function(){ChatRoom.USER_ROW_TEMPLATE||(ChatRoom.USER_ROW_TEMPLATE=new Template($("user_row_template").innerHTML),ChatRoom.ADMIN_MESSAGE_TEMPLATE=new Template($("admin_message_template").innerHTML))};
ChatRoom.prototype={initialize:function(a,b){this._chat_window=a;this._room=b;this._users={};this._users_list=[];this._guests_in_room_count=this._users_in_room_count=0;this._favorite_room=a.isFavoriteRoom(b.id);this._node=ChatRoom.template();ChatRoom.initializeTemplates();this._users_in_room_node=this._node.down(".users_in_room");this._guests_in_room_node=this._node.down(".guest_count_in_room");this._number_in_room_node=a._chat_window_node.down(".number_in_room");this._guest_count_holder=this._node.down(".guest_count_holder");
this._silence_duration_node=this._node.down(".silence_duration");this._chat_actions_node=(new Element("div")).setStyle({display:"none"}).update($("chat_actions_dropdown_template").innerHTML);this._chat_actions_options=this._chat_actions_node.down("ul.chat_actions_list");this._chat_actions_control=this._chat_actions_node.down("span.btn");var c=this;this._chat_actions_control.observe("click",function(){$j(c._chat_actions_options).toggle()});document.observe("click",function(a){a.target.hasClassName("btn_target")||
$j(c._chat_actions_options).hide()});$("chat_actions_container").insert(this._chat_actions_node);this._chat_actions_options.select(".exclude_"+this.type()).invoke("remove");this._favorite_room_option_node=this._chat_actions_options.down(".favorite_room");this._tab_for_room=this._chat_window.tabForRoom(this);this._unread_message_node=this._tab_for_room.down(".unread_chat_messages");this._favorite_room_option_node&&this._favorite_room&&this._favorite_room_option_node.writeAttribute("data-chat-action",
"unfavorite_room").update(tr8nProxy.trl("Unfavorite room"));var d=function(a){c.addToFavorites();a.stop()},e=function(b){a.showOnlineFriends();b.stop()};this._chat_actions_options.observe("click",function(b){var h;h=$j(b.target);var l=null;h.is("li")||(h=h.parent("li"));l=h.attr("data-chat-action");switch(l){case "room_chooser":a.activateRoomChooser();break;case "leave_private":c.isMyPrivateRoom()?holodeck.destroyPrivateRoom():holodeck.leavePrivateRoom();break;case "leave_guild":holodeck.leaveGuildRoom();
break;case "friends_online":h=CapturesToInlineRegistration.decorate(e);h(b);break;case "room_details":a.activateRoomInfo(c);b.stop();break;case "favorite_room":b.stop();h=CapturesToInlineRegistration.decorate(d);h(b);break;case "unfavorite_room":c.removeFromFavorites();b.stop();break;case "set_status":KonduitPresenceType.AWAY==c._presence?a.holodeck().setPresenceChat():a.holodeck().setPresenceAway()}c._chat_actions_options.hide()});this._users_in_room_node.on("mouseover",".js-user-chat-hover",function(b){var d=
b.target.getAttribute("username");d&&d.toLowerCase()!=c.username().toLowerCase()&&(d=c.user(d),a.showUserRollover(d,b.target),Event.stop(b))});this._users_in_room_node.observe("mouseout",function(b){a.hideUserRollover();Event.stop(b)});this._users_in_room_node.on("click",".username",function(b){var c=b.target.getAttribute("username");c&&(a.showProfile(c),Event.stop(b))});this._messages_to_retain=parseInt(document.location.href.parseQuery().messages_to_retain,10)||200;this._chat_dialogue=new ChatDialogue(this._node,
function(a){c.sendRoomMessage(a)},this.holodeck(),this._chat_window);a._chat_rooms_container_node.insert({bottom:this._node});this._history_button=$j(this._node).find(".chat_message_window .history-button");this._history_spinner=$j(this._node).find(".chat_message_window .history-spinner");this.isGuildRoom()&&(this.showHistoryButton(),this._history_button.on("click",function(){c._history_button.hide();c._history_spinner.show();c.fetchHistory()}))},showHistoryButton:function(){this._history_button.show();
this._history_spinner.hide()},hideHistoryButton:function(){this._history_button.hide();this._history_spinner.hide()},destroy:function(){this._node.remove();this._chat_actions_node.remove()},chatEnabled:function(){return this._chat_enabled},disable:function(){this._chat_dialogue.disable();this._chat_enabled=!1},disableDueToGuest:function(){this._node.down(".guest_chat_controls").show();this.disable()},disableDueToSilence:function(){this.isPrivate()||(this._node.down(".silenced_chat_controls").show(),
this.disable())},disableDueToFayeDisconnect:function(){this.disconnectedFromFaye=!0;this._node.down(".faye_disconnect_controls").show();this.disable()},enableDueToFayeConnect:function(){this.disconnectedFromFaye=!1;this.enable()},enable:function(){this._node.down(".guest_chat_controls").hide();this._node.down(".silenced_chat_controls").hide();this._node.down(".faye_disconnect_controls").hide();this._chat_dialogue.enable();this._chat_enabled=!0},username:function(){return this._chat_window.username()},
id:function(){return this._room.id},name:function(){return this._room.name},xmppName:function(){return this._room.xmpp_name},shortName:function(){this._short_room_name||(this._short_room_name="room_"+this._room.xmpp_name);return this._short_room_name},type:function(){return this._room.type},isGuildRoom:function(){return"guild"===this._room.type},guildId:function(){if("guild"!=this.type())console.error("Attempted to check guildId for non guild room");else return Holodeck.guildIdFromXmppName(this.xmppName())},
konduit:function(){return this._chat_window.konduit()},isPrivate:function(){return"private"==this.type()},isMyPrivateRoom:function(){return this.isPrivateRoomOwner(this.username())},isPrivateRoomOwner:function(a){if(this.isPrivate()&&a)try{var b=this.xmppName(),c=b.substr(b.indexOf("-")+1);return c&&c.toLowerCase()==a.toLowerCase()}catch(d){}return!1},privateRoomOwnerUsername:function(){if(this.isPrivate())try{return this.name().split("'")[0]}catch(a){}return null},dispatchEvent:function(a){this.konduit().dispatchEvent(a)},
insert:function(a,b){this._chat_dialogue.insert(a,b)},receivedAdminMessage:function(a){this._chat_dialogue.insert(ChatRoom.ADMIN_MESSAGE_TEMPLATE.evaluate({content:a.data.admin_message}))},fetchHistory:function(){holodeck.konduit().dispatchEvent({type:KonduitEvent.FETCH_HISTORY,data:{room:this._room,maxTime:this._chat_dialogue.earliestTimestamp()}})},sendRoomMessage:function(a){a&&this.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:{message:this._chat_window.escapeOutgoingMessage(a),room:this._room}})},
receivedMessage:function(a){this.isActive()||this._unread_message_node.show();this.checkUserForModeration(a.data.user.username);this._chat_dialogue.displayMessage(a.data.user.username,a.data.message,{},{characterName:a.data.user.variables.game_character_name,timestamp:a.data.timestamp})},receivedSystemMessage:function(a){this.isActive()||this._unread_message_node.show();this._chat_dialogue.displaySystemMessage(a.data.data,a.data.timestamp)},checkUserForModeration:function(a){this.self()?this.canUserModerate(this.self())&&
this._chat_window.noticedModeratableUser(a):this.checkUserForModeration.bind(this).delay(500,a)},messageError:function(a){this.insert(this._chat_window.errorMessageTemplate(a.data.errorType))},_avatarSrc:function(a){return a.chatAvatarUrl()},_avatarStyle:function(a){return""},_generateUserNode:function(a){var b=this._chat_window,c=a.username,c={rowClasses:[],avatarSrc:this._avatarSrc(a),avatarStyle:this._avatarStyle(a),userNodeId:this.userNodeId(c),usernameNodeId:this.usernameNodeId(c),username:c,
level:a.level()};a.gameCharacterName()&&(c.game_character_name="("+a.gameCharacterName()+")");a.isSilenced()&&c.rowClasses.push("silenced");KonduitPresenceType.AWAY==a.presence()&&c.rowClasses.push("away");b.isMuted(a)&&c.rowClasses.push("muted");var d={};a.isAdmin()?d={extraIconClass:"spritesite admin_icon",extraIconType:"Administrator",extraIconTitle:"Administrator"}:this.owner()==a.username?d={extraIconClass:"spritesite room_owner_icon",extraIconType:"Room Owner",extraIconTitle:"Room Owner"}:this.canUserModerate(a)?
d={extraIconClass:"spritesite moderator_icon",extraIconType:"Moderator",extraIconTitle:"Moderator"}:a.isDeveloper()&&(d={extraIconClass:"spritesite developer_icon",extraIconType:"Developer",extraIconTitle:"Developer"});var c=Object.extend(c,d),d=ChatRoom.USER_ROW_TEMPLATE,e=a.specialChatVars();if(e){var f=(active_user.username()==a.username?"You've":a.username)+" completed",h=[];e.chat_icons&&(e.chat_icons.each(function(a){a.message=f;var b='<img src="#{image_url}" alt="#{message} #{subject_name}" title="#{message} #{subject_name}" class="#{slug} rank_icon" />'.interpolate(a);
"kartridge-charter"==a.slug&&(b='<a href="https://www.kartridge.com" target="_blank">'+b+"</a>");h.push(b)}),c.extraIconTags=h.join(""))}d=(new Element("div",{id:c.userNodeId,"class":"user_row "+c.rowClasses.join(" ")})).update(d.evaluate(c));b.isFriend(a)||d.down(".friend_icon").remove();c.extraIconType||d.down(".rank_icon").remove();a.isPremium()?active_user.premiumizeUpsellNode(d.down(".premium_icon"),"username_icon","icon_tab"):d.down(".premium_icon").remove();a.isMobile()||d.down(".mobile_icon").remove();
a.isGuest()&&d.down(".username").remove();return d},self:function(){return this._users[this.username().toLowerCase()]},removeUser:function(a){if(a=a.userRowNode?a:this.user(a.username))this.removeUserNode(a),delete this._users[a.username.toLowerCase()],this._users_list.orderedDelete(a,this.userSorter())},removeUserNode:function(a){(a=this.user(a.username))&&a.userRowNode()&&a.userRowNode().remove()},isGuest:function(a){return this._chat_window.isGuest(a)},userSorter:function(){var a=this._chat_window,
b=this,c=function(b){return a.username()==b.username},d=function(a){return!a.isSilenced()},e=function(a){return a.isAdmin()},f=function(a){return!a.isAdmin()&&b.canUserModerate(a)},h=function(b){return a.isFriend(b)},l=function(b){return!a.isMuted(b)},g=function(a){return a.isAway()},q=function(a,b,c){b=a(b);a=a(c);return b&&!a?-1:!b&&a?1:0};return function(a,b){return q(c,a,b)||q(d,a,b)||q(e,a,b)||q(f,a,b)||q(h,a,b)||q(l,a,b)||a.username.toLowerCase().localeCompare(b.username.toLowerCase())||q(g,
a,b)}},updateUser:function(a,b){if(!this.isGuest(a)){var c=this.userSorter(),d=this._users[a.username.toLowerCase()],e=a.variables?new ChatUser(a.variables):a;if(b||!(d&&0===c(d,e))){d&&(this.removeUserNode(e),this._users_list.orderedDelete(d,c));this._users[e.username.toLowerCase()]=e;e.setUserRowNode(this._generateUserNode(e));var f,h,l;try{f=this._users_list.orderedInsert(e,c),0<f&&(l=(h=this._users_list[f-1])?h.userRowNode():null)&&$j(l).after(e.userRowNode()),l||$j(e.userRowNode()).prependTo(this._users_in_room_node)}catch(g){Kongregate.Log.error("Error adding user to list",
g,f,h,l)}if(e.username==this._chat_window.username()){if(this._presence!=e.presence())switch(e.presence()){case KonduitPresenceType.CHAT:this._chat_dialogue.kongBotMessage("Set status to active");$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Away"));break;case KonduitPresenceType.AWAY:this._chat_dialogue.kongBotMessage("Set status to away"),$j("[data-chat-action=set_status]").html(tr8nProxy.trl("Set status")+":"+tr8nProxy.trl("Active"))}this._presence=e.presence()}}}},
updateRoomHeader:function(){this._chat_window._chat_window_node.down(".room_name").innerHTML=this.name();this.updateUsersCount()},updateUsersCount:function(){this.isActive()&&this._number_in_room_node.update(this._users_list.length+this._guests_in_room_count)},updateGuestCount:function(a){a&&this.setGuestCount(this._guests_in_room_count+a)},guestCountUpdated:function(a){this.setGuestCount(a.data.guests)},setGuestCount:function(a){0<=a&&(this._guests_in_room_count=a);a=" guests in room";1==this._guests_in_room_count&&
(a=" guest in room");0<this._guests_in_room_count?(this._guest_count_holder.show(),this._guests_in_room_node.update(this._guests_in_room_count+a)):this._guest_count_holder.hide()},updateSilenceScheduledEnd:function(a){this._silence_duration_node.update(tr("You have been silenced for "+a))},isSilenced:function(){return this._chat_window.isSilenced()},userJoined:function(a){a=a.data.user;this.user(a.username)||this.updateUser(a);this.isGuest(a)&&this.updateGuestCount(1);this.updateUsersCount()},userChanged:function(a){this.updateUser(a.data.user,
a.data.force||a.data.user.variables.force)},userLeft:function(a){a=a.data.user;this.isGuest(a)||(this.removeUser(a),this.isMyPrivateRoom()&&delete holodeck._users_invited[a.username]);this.isGuest(a)&&this.updateGuestCount(-1);this.updateUsersCount()},updateChatControlsForUser:function(a){a.username==this.username()&&(a.isSilenced()||this.enable(),this.isGuest(a)&&this.disableDueToGuest())},userListScrollTop:function(){return this._users_in_room_node.scrollTop},user:function(a){return this._users[a.toLowerCase()]},
users:function(){return this._users_list},addFriends:function(a){this.refreshUsers(a)},removeFriends:function(a){this.refreshUsers(a)},addMutings:function(a){this.refreshUsers(a)},refreshUsers:function(a){for(var b,c=[],d=0,e=a.length;d<e;d++)if(b=this.user(a[d]))this.removeUser(b),c.push(b);d=0;for(e=c.length;d<e;d++)this.userChanged({data:{user:c[d],force:!0}})},hide:function(){this._node.hide();this._chat_actions_node.hide();this._tab_for_room.removeClassName("active")},show:function(){this._node.show();
this.updateRoomHeader();this._chat_actions_node.show();this._tab_for_room.addClassName("active");this._unread_message_node.hide();this.scrollToBottom()},showChatNag:function(a,b){this.insert(a,b)},owner:function(){return this._chat_window.roomOwner(this._room.id)},holodeck:function(){return this._chat_window.holodeck()},insertInChatInput:function(a){this._chat_dialogue.setInput(a)},addToFavorites:function(){this._chat_window.recordAnalyticsEvent("ChatAction","FavoriteRoom");new Ajax.Request("/rooms/"+
this._room.id+"/favorite_rooms",{asynchronous:!0,evalScripts:!0,method:"post"});this._favorite_room_option_node.writeAttribute("data-chat-action","unfavorite_room").update(tr8nProxy.trl("Unfavorite room"));this._chat_window.addFavoriteRooms([this._room.id])},removeFromFavorites:function(){new Ajax.Request("/rooms/"+this._room.id+"/unfavorite_rooms",{asynchronous:!0,method:"post"});this._favorite_room_option_node.writeAttribute("data-chat-action","favorite_room").update(tr8nProxy.trl("Favorite this room"));
this._chat_window.removeFavoriteRoom(this._room.id)},userNodeId:function(a){return"user_"+a+"_"+this.shortName()},usernameNodeId:function(a){return"username_"+this.userNodeId(a)},getId:function(){return this._room.id},scrollToBottom:function(){this._chat_dialogue.scrollToBottom()},isActive:function(){return this==this._chat_window.activeRoom()},roomId:function(){return parseInt(this._room.id)},isGameRoom:function(){return"game"==this._room.type},gameId:function(){return!this.isGameRoom()?null:this._room.game_id||
parseInt(this._room.id.match(/^\d+/)[0],10)},canUserModerate:function(a){if(!a)return!1;var b=a.moderatorRoomIds();a=a.moderatorGameIds();return"all"==b||"all"==a?!0:this.isGameRoom()?a.include(this.gameId()):b.include(this.roomId())}};ChatRoomChooser=function(a){this.initialize(a)};ChatRoomChooser.DESCRIPTION_TOP_FUDGE=9;
ChatRoomChooser.prototype={initialize:function(a){this._chat_window=a.chat_window;this._node=$("chat_room_chooser");this._holodeck=a.holodeck;if(this._node){this._rooms_list_node=this._node.down(".rooms_list");if(this._room_description_rollover_node=this._rooms_list_node.down(".room_description_rollover_container"))this._room_description_rollover_content=this._room_description_rollover_node.down(".room_description_rollover_content");var b=this,c=this._holodeck;this._node.down(".return_to_room").observe("click",
function(a){b.deactivate();a.stop()});this._rooms_list_node.observe("click",function(a){var e=a.target;e.hasClassName("room")||(e=e.up(".room"));if(e&&(!e.hasClassName("full")||c.isChatModerator()))b._chat_window.recordAnalyticsEvent("ChatAction","ChangeRoom"),b.joinRoom(e);a.stop()});this._room_groups=$H()}},isActive:function(){return this._node.visible()},activate:function(a){a&&this._node.down(".room_name").update(a.name());this._chat_window.hideChatWindow();this.requestJoinableRooms();this.clearGroups();
this._chat_window.setActiveTempPane(this);this.show()},deactivate:function(){this.hide();this._chat_window.clearActiveTempPane();this._chat_window.showChatWindow()},show:function(){this._node.ieHappyShow()},hide:function(){this._node&&this._node.ieHappyHide()},clearGroups:function(){$H(this._room_groups).each(function(a){a=a[1];a.clearRooms();a._node.hide()})},roomGroups:function(a){this.clearGroups();for(var b=0,c=a.length;b<c;b++)this.addRoomGroup(a[b])},redoRoomList:function(){this.clearGroups();
this.isActive()&&this.requestJoinableRooms()},addRoomGroup:function(a){var b=this._rooms_list_node,c=this,d=this._room_groups.getWithDefault(a.name,function(){return new ChatRoomGroup(c,b,a)});d.setRooms(a.rooms);d.show();a.expand&&d.open()},requestJoinableRooms:function(){this._chat_window.showSpinner();var a=this._chat_window;new Ajax.Request("/rooms.js?game_id="+this.holodeck().gameId(),{method:"get",onComplete:a.hideSpinner})},roomGroup:function(a){return this._room_groups.get(a)},joinRoom:function(a){var b=
a.room;(a=$j(a).data("guild-room"))?this.holodeck().joinRoom(a):b.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom","chat_features_tab"):this.holodeck().joinRoom(b)},holodeck:function(){return this._holodeck},showDescriptionRollover:function(a,b){this._room_description_rollover_content.update(a);this.setDescriptionRolloverPosition(b);this._room_description_rollover_node.show()},hideDescriptionRollover:function(){this._room_description_rollover_content.update("");
this._room_description_rollover_node.hide()},beginDescriptionRolloverHide:function(){var a=this;this._room_rollover_hide_timer&&clearTimeout(this._room_rollover_hide_timer);this._room_rollover_hide_timer=setTimeout(function(){a.hideDescriptionRollover()},5E3)},stopDescriptionRolloverHide:function(){clearTimeout(this._room_rollover_hide_timer)},setDescriptionRolloverPosition:function(a){var b=this._rooms_list_node.scrollTop;a=a.positionedOffset()[1];var c=a-=ChatRoomChooser.DESCRIPTION_TOP_FUDGE;b<
a&&(c=a-b);this._room_description_rollover_node.setStyle({top:c+"px"})}};ChatRoomGroup=function(a,b,c){this.initialize(a,b,c)};ChatRoomGroup.template=function(){this._template||(this._template=$$(".joinable_rooms_group")[0]);return this._template.cloneNode(!0)};
ChatRoomGroup.prototype={initialize:function(a,b,c){this._name=c.name;this._chooser=a;a=ChatRoomGroup.template();b.insert(a);c.move_to_top?b.insert({top:a}):b.insert({bottom:a});this._node=a;this._list_node=a.down(".rooms");this._panel=new CollapsiblePanel(a);a.down(".group_name").update(this._name)},setRooms:function(a){var b=this._list_node,c=this._chooser;c.holodeck();var d=this;a.each(function(a,f){var h=d.buildRoomNode(a);b.insert(h);a.description&&(h.observe("mouseover",function(b){c.showDescriptionRollover(a.description,
h);Event.stop(b)}),h.observe("mouseout",function(a){c.beginDescriptionRolloverHide();Event.stop(a)}))})},buildRoomNode:function(a){return"guild"===a.type?this.buildGuildRoomNode(a):this.buildRegularRoomNode(a)},buildGuildRoomNode:function(a){var b=$j("#js-guild-room-template li").clone();b.find(".js-name").html(a.game_title+": "+a.guild_name);b.data("guild-room",a);return b[0]},buildRegularRoomNode:function(a){var b=new Element("li",{"class":0===i%2?"even room":"odd room"});b.room=a;var c=(new Element("p",
{"class":"name"})).update(a.name);a.premium_only&&(active_user.isPremium()||c.addClassName("upsell"),c.addClassName("premium_room_icon spritesite"));"game"===a.type&&("en"!==a.language&&"any"!=a.language)&&(c.insert("&nbsp;"),c.insert((new Element("em")).update("<strong>("+a.language+")</strong>")));b.insert(c);a.joinable?b.insert((new Element("p",{"class":"user_count"})).update(a.total_user_count)):(b.insert((new Element("p",{"class":"user_count"})).update("full")),holodeck.isChatModerator()?b.addClassName("mod_full"):
b.addClassName("full"));b.insert(new Element("div",{style:"clear:both;"}));return b},node:function(){return this._node},clearRooms:function(){this._list_node.select(".room").each(function(a){a.remove()})},show:function(){this._node.show()},hide:function(){this._node.hide()},open:function(){this._panel.open()}};ChatUser=function(a){this.initialize(a)};
ChatUser.prototype={initialize:function(a){this.username=a.username;this._game_url=a.game_url;this._game_title=a.game_title;this._chat_avatar_url=a.chat_avatar_url;this._admin=a.admin;this._developer=a.developer;this._premium=a.premium;this._role=a.role;this._presence=a.presence;this._level=a.level;this._game_character_name=a.game_character_name;this._mobile=a.mobile;this._special_chat_vars=null;try{this._special_chat_vars="object"==typeof a.special_chat_vars?a.special_chat_chars:a.special_chat_vars.evalJSON()}catch(b){if("undefined"!=
typeof console)try{console.log("Could not parse variables object %o",a.special_chat_vars)}catch(c){}}this._moderator_room_ids=a.moderator_room_ids||[];this._moderator_game_ids=a.moderator_game_ids||[]},gameCharacterName:function(){return this._game_character_name},gameUrl:function(){return this._game_url},gameTitle:function(){return this._game_title},chatAvatarUrl:function(){return this._chat_avatar_url},isAdmin:function(){return this._admin},isDeveloper:function(){return this._developer},isPremium:function(){return this._premium},
isMobile:function(){return this._mobile},isGuest:function(){return this.username.match(/^_/)},role:function(){return this._role},level:function(){return this._level},presence:function(){return this._presence},specialChatVars:function(){return this._special_chat_vars},moderatorRoomIds:function(){return this._moderator_room_ids},moderatorGameIds:function(){return this._moderator_game_ids},isSilenced:function(){return"participant"!=this.role()&&"moderator"!=this.role()},isAway:function(){return KonduitPresenceType.AWAY==
this.presence()},changeRole:function(a){this._role=a},setUserRowNode:function(a){this._user_row_node=a},userRowNode:function(){return this._user_row_node}};ChatWindow=function(a){this.initialize(a)};ChatWindow.MODERATABLE_TIME_LIMIT=18E5;
ChatWindow.prototype={initialize:function(a){a.chat_window=this;this._holodeck=a.holodeck;this._friends={};this._mutings={};this._rooms=new Hash;this._room_owners={};this._node=$("chat_tab_pane");this._chat_window_node=$("chat_window");this._chat_rooms_container_node=$("chat_rooms_container");this._rooms_to_join=[];this._favorite_rooms=[];this._rooms_by_type={};this._chat_tab_clicked=this._logged_in_to_chat=!1;this._room_chooser=new ChatRoomChooser(a);this._user_rollover_manager=new UserRollover(this);
this._mini_profile=new MiniProfile(a);this._online_friends=new OnlineFriends(this);this._room_info=new RoomInfo(a);this._moderatableUsers={};this._moderatableUsersSweeper=null;this._chat_bootstrap_url=a.chat_bootstrap_url;this._seen=!1;this._deferred_room_params={};this._deferred_room_callbacks={};this.LAST_VIEWED_TAB_COOKIE="kong_chat_tab";this.GENERAL_CHAT_ROOM="chat";this.GAME_CHAT_ROOM="game";this.GUILD_CHAT_ROOM="guild";this.PRIVATE_CHAT_ROOM="private";this.SINGLE_PLAYER_GAME="spg";this.MULTIPLAYER_GAME=
"mpg";this.GUILD_GAME="guilds";this._activeTabMatrix={};this._activeTabMatrix[this.SINGLE_PLAYER_GAME]={};this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GENERAL_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GAME_CHAT_ROOM]=this.GENERAL_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.SINGLE_PLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME]=
{};this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GENERAL_CHAT_ROOM]=this.GAME_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GAME_CHAT_ROOM]=this.GAME_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.MULTIPLAYER_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME]={};this._activeTabMatrix[this.GUILD_GAME][this.GENERAL_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.GAME_CHAT_ROOM]=
this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.GUILD_CHAT_ROOM]=this.GUILD_CHAT_ROOM;this._activeTabMatrix[this.GUILD_GAME][this.PRIVATE_CHAT_ROOM]=this.PRIVATE_CHAT_ROOM;var b=this;this._chat_bootstrap_url&&this.bootstrapChat.bind(this).runWhenDomLoaded(!0);$$("#chat_room_tabs .chat_room_tab").each(function(a){a.down("a").observe("click",function(d){var e=a.id.split("_")[0],f=b.roomByType(e),h=["guild","chat","game"],l=function(a){return a===e};0<=h.indexOf(e)&&active_user.isChatModerator()&&
(h.reject(l).each(function(a){(f=b.roomByType(a))&&holodeck.setPresenceAway(f.xmppName())}),h.filter(l).each(function(a){(f=b.roomByType(a))&&holodeck.setPresenceChat(f.xmppName())}));f?(b.setActiveRoom(f),b.activeChatDialogue().focus()):(b.joinDeferredRoom(e),function(){b.activeChatDialogue().focus()}.delay(0.2));Event.stop(d);return!1})})},roomByType:function(a){return this._rooms_by_type[a]},hasJoinedAnyRooms:function(){return 0<this._rooms.size()},requestRoomToJoin:function(){new Ajax.Request(this._chat_bootstrap_url,
{method:"post",parameters:{choose_room:!0}})},bootstrapChat:function(a){var b=this._chat_bootstrap_url,c=Cookie.get("kong_room_id"),d={};c&&(d.room_id=c);a&&(d.gameplay_id=this._holodeck.gameplay(),d.reload=!0,this._mini_profile.deactivate(),this._room_info.deactivate(),this._room_chooser.deactivate());new Ajax.Request(b,{method:"post",parameters:d})},findOrCreateRoom:function(a){if(!a.id)return null;a.owner=this.roomOwner(a.id);var b=this._rooms.get(a.id);b||(b=new ChatRoom(this,a),this._rooms.set(a.id,
b),$("chat_window_header").show());return b},joinedRoom:function(a){var b=this.roomByType(a.type),c=this.findOrCreateRoom(a);if(c&&c!=b)if(this._rooms_by_type[a.type]=c,this.setActiveRoom(c),this.authenticated()&&("private"!=c.type()&&b&&this.updateLastActionTaken(),this.startBeacon()),this.GAME_CHAT_ROOM==a.type&&this._hide_first_game_room_join)this._hide_first_game_room_join=!1;else return this.tabForRoom(c).show(),c},holodeck:function(){return this._holodeck},authenticated:function(){return this._holodeck.authenticated()},
isAdmin:function(a){return this._active_room.user(a).isAdmin()},setLastViewedTabCookie:function(a){Cookie.set(this.LAST_VIEWED_TAB_COOKIE,a,void 0,"/games")},getLastViewedTabCookie:function(){return Cookie.get(this.LAST_VIEWED_TAB_COOKIE)},setActiveRoom:function(a){var b=a.type();this._active_room=a;this.setLastViewedTabCookie(b);this._holodeck._active_dialogue=a._chat_dialogue;this.showActiveRoom()},showActiveRoom:function(){var a=this,b=this._active_room;this.activeTempPane();var c=this._holodeck;
this._rooms.values().each(function(d){d==b?d.show():d.hide();d.disconnectedFromFaye?d.disableDueToFayeDisconnect():a.isSilenced()&&!d.isPrivate()?d.disableDueToSilence():c.authenticated()?d.enable():d.disableDueToGuest()})},fayeDisconnect:function(a){(a=this.roomByType("guild"))&&a.disableDueToFayeDisconnect()},fayeConnect:function(a){(a=this.roomByType("guild"))&&a.enableDueToFayeConnect()},activatePrivateRoom:function(){this.canActivatePrivateRoom()&&this.roomByType("private")&&this.setActiveRoom(this.roomByType("private"))},
canActivatePrivateRoom:function(){return this.roomByType("private")&&this._active_room!=this.roomByType("private")},leftRoom:function(a){var b=a.room,c=this._rooms.get(b.id),d=c?c.type():void 0;if("private"==d||"guild"==d){var e=this.roomByType(d);e&&e.xmppName()==b.xmpp_name&&(this.tabForRoom(e).hide(),this.setFirstAvailableRoomAsActive(["game","chat"]),delete this._rooms_by_type[d])}if(a.kicked)(function(a){a.activeChatDialogue().displayMessage("Kong Bot","You have been removed from "+b.name+".",
{"class":"whisper received_whisper"},{non_user:!0})}).defer(this);else if(c&&c.isPrivate()&&!c.isMyPrivateRoom()&&(a.owner_destroyed||a.owner_left)){var f=c;(function(a){var b=f.privateRoomOwnerUsername()||"The room owner";f=void 0;a.activeChatDialogue().displayMessage("Kong Bot",b+" has left the room and the private session has ended.",{"class":"whisper received_whisper"},{non_user:!0})}).defer(this)}this._rooms.unset(b.id);c&&(c.destroy(),c=void 0);0===this._rooms.keys().length&&$("chat_window_header").hide()},
setFirstAvailableRoomAsActive:function(a){var b=this,c,d;a.find(function(a){c=b.roomByType(a);return!!c})?this.setActiveRoom(c):a.find(function(a){(c=b.hasDeferredRoom(a))&&(d=a);return!!c})&&this.joinDeferredRoom(d)},errorMessageTemplate:function(a){this._error_message_templates_node||(this._error_message_templates_node=this._node.down(".chat_error_message_templates"));if(a=this._error_message_templates_node.down("."+a))return a.cloneNode(!0)},konduit:function(){return this._holodeck.konduit()},
userJoinedRoom:function(a){this.withRoom(a,"userJoined")},userLeftRoom:function(a){this.withRoom(a,"userLeft")},userChangedInRoom:function(a){this.withRoom(a,"userChanged")},updateGuestCount:function(a){this.withRoom(a,"guestCountUpdated")},receivedRoomMessage:function(a){this.withRoom(a,"receivedMessage")},receivedSystemMessage:function(a){this.withRoom(a,"receivedSystemMessage")},receivedAdminMessage:function(a){this._active_room&&this._active_room.receivedAdminMessage(a)},receivedPrivateRoomInvitation:function(a){var b=
this.roomByType("private");if(!b||!b.isPrivateRoomOwner(a.username)){var c=(new Element("div")).update((new Template($("chat_notification_received_private_message").innerHTML)).evaluate({username:a.username})),d=c.down(".yes"),e=c.down(".no"),f=function(a){c.hide();d.stopObserving("click");e.stopObserving("click");Event.stop(a);return!1};b&&d.update("Leave "+b.name()+" and join");d.observe("click",function(b){holodeck.joinRoom(a);return f(b)});e.observe("click",function(b){holodeck.invitationIgnoredBy(a.username);
return f(b)});this.activeChatDialogue().insert(c)}},roomNotFound:function(a){(function(b){var c;c="guild"===a.type?"Could not connect to guild chat. If this problem persists, refresh the page and try again.":a.name+" is no longer available.";var d=b.activeChatDialogue();d&&d.displayMessage("Kong Bot",c,{"class":"whisper received_whisper"},{non_user:!0});b.roomJoinFail(a.type)}).defer(this)},roomJoinFail:function(a){if(this.GUILD_CHAT_ROOM==a||this.PRIVATE_CHAT_ROOM==a)this.tabForType(a).hide(),this.activeChatDialogue()||
this.joinDeferredRoom(this.GENERAL_CHAT_ROOM)},roomFull:function(a){(function(b){var c=a.name+" is full. Please try again later.";b.activeChatDialogue().displayMessage("Kong Bot",c,{"class":"whisper received_whisper"},{non_user:!0})}).defer(this)},onPrivateRoomInvitationSent:function(a){var b=a.error;a=a.success?a.username+" was invited to join your private chat room.":"user_in_room"==b?a.username+" is already in your private chat room.":a.username+" cannot be reached. Please try again later";this.activeChatDialogue().displayMessage("Kong Bot",
a,{"class":"whisper received_whisper"},{non_user:!0})},activeChatDialogue:function(){if(this._active_room)return this._active_room._chat_dialogue},room:function(a){return this._rooms.get(a)},withRoom:function(a,b){var c=this.room(a.data.room.id);c||(c=this.findOrCreateRoom(a.data.room));if(c)c[b](a)},addFriends:function(a){var b=this._friends;a.each(function(a){b[a.toLowerCase()]=!0});this._rooms.values().each(function(b){b.addFriends(a)})},removeFriends:function(a){var b=this._friends;a.each(function(a){b[a.toLowerCase()]=
!1});this._rooms.values().each(function(b){b.removeFriends(a)})},addMutings:function(a){var b=this._mutings;a.each(function(a){b[a.toLowerCase()]=!0});this._rooms.values().each(function(b){b.addMutings(a)})},addFavoriteRooms:function(a){this._favorite_rooms=this._favorite_rooms.concat(a);var b=this._rooms;a.each(function(a){if(a=b.get(a))a._favorite_room=!0})},removeFavoriteRoom:function(a){this._rooms.get(a)._favorite_room=!1;this._favorite_rooms=this._favorite_rooms.reject(function(b){return b==
a})},removeMutings:function(a){var b=this._mutings;a.each(function(a){delete b[a.toLowerCase()]});this._rooms.values().each(function(b){b.addMutings(a)})},isFavoriteRoom:function(a){return void 0!==this._favorite_rooms.find(function(b){return b==a})},isFriend:function(a){return!0===this._friends[(a.username?a.username:a).toLowerCase()]},isMuted:function(a){return!a?!1:!0===this._mutings[(a.username?a.username:a).toLowerCase()]},isGuest:function(a){return this._holodeck.isGuestUsername(a.username)},
onSilenced:function(a){this._silenced=!0;this.updateSilenceScheduledEnd(a.data.scheduled_end);this._rooms.values().each(function(a){a.isPrivate()||a.disableDueToSilence()})},onParticipate:function(a){this._silenced=!1;this._rooms.values().each(function(a){a.enable()})},isSilenced:function(){return this._silenced},updateSilenceScheduledEnd:function(a){var b=TimeInWordsHelper.distanceInWordsFromNow(new Date(a));this._rooms.values().each(function(a){a.updateSilenceScheduledEnd(b)});ChatRoom.updateTemplateSilenceScheduledEnd(b)},
username:function(){if(this._holodeck)return this._holodeck.username()},processRoomEvent:function(a){this._room_chooser.deactivate();this._seen&&this._logged_in_to_chat?this.konduit().dispatchEvent(a):this._rooms_to_join.push(a)},setRooms:function(a){var b=a.defaultRooms;this.clearRoomsToJoin();this.roomByType(this.GENERAL_CHAT_ROOM)||this.setDeferredRoomParams(this.GENERAL_CHAT_ROOM,b.generalChatRoom);a.currentGameType=this.SINGLE_PLAYER_GAME;a.gameRoomEnabled&&(this.roomByType(this.GAME_CHAT_ROOM)||
this.determineGameChatRoom(a),a.currentGameType=this.MULTIPLAYER_GAME);this.roomByType(this.GUILD_CHAT_ROOM)||this.determineGuildChatRoom(a);b.guildChatRoom&&(a.currentGameType=this.GUILD_GAME);!this.roomByType(this.PRIVATE_CHAT_ROOM)&&a.previousPrivateRoom&&this.setDeferredRoomParams(this.PRIVATE_CHAT_ROOM,a.previousPrivateRoom,a.previousPrivateRoomCallback);a.mostRecentChatTab=this.getLastViewedTabCookie()||this.GENERAL_CHAT_ROOM;this.hasJoinedAnyRooms()||this.joinActiveRoomType(a)},joinActiveRoomType:function(a){var b=
this._activeTabMatrix[a.currentGameType][a.mostRecentChatTab];a=this.hasDeferredRoom(b)?b:this._activeTabMatrix[a.currentGameType][this.GENERAL_CHAT_ROOM];this.GUILD_CHAT_ROOM==a&&this._deferred_room_params[this.GAME_CHAT_ROOM]&&(this._hide_first_game_room_join=!0,this.joinDeferredRoom(this.GAME_CHAT_ROOM));this.joinDeferredRoom(a)},determineGameChatRoom:function(a){this.setDeferredRoomParams(this.GAME_CHAT_ROOM,a.previousGameRoom?a.previousGameRoom:a.defaultRooms.gameChatRoom?a.defaultRooms.gameChatRoom:
a.gameRoomJoin)},determineGuildChatRoom:function(a){var b,c;a.previousGuildChatRoomForCurrentGame?(b=a.previousGuildChatRoomForCurrentGame,c=a.previousGuildChatRoomForCurrentGameCallback):a.defaultRooms.guildChatRoom?b=a.defaultRooms.guildChatRoom:a.previousSitewideGuildChatRoom&&(b=a.previousSitewideGuildChatRoom,c=a.previousSitewideGuildChatRoomCallback);b&&this.setDeferredRoomParams(this.GUILD_CHAT_ROOM,b,c)},hasDeferredRoom:function(a){return!!this._deferred_room_params[a]},joinDeferredRoom:function(a){var b=
this._deferred_room_params[a];this._deferred_room_params[a]=void 0;var c=this._deferred_room_callbacks[a];c&&c();this._deferred_room_callbacks[a]=void 0;this.joinRoom(b)},joinRoom:function(a){"guild"===a.type?this.processRoomEvent({type:KonduitEvent.JOIN_GUILD_ROOM,data:{guildId:a.guild_id}}):(this.addRoomOwner(a),this.room(a.id)||this.processRoomEvent({type:KonduitEvent.JOIN_ROOM,data:{room:a}}))},setDeferredRoomParams:function(a,b,c){a!=this.PRIVATE_CHAT_ROOM&&this.tabForType(a).show();this._deferred_room_params[a]=
b;this._deferred_room_callbacks[a]=c},sendPrivateMessage:function(a,b){a&&b&&this.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_MESSAGE,data:{message:this.escapeOutgoingMessage(b),username:a}})},escapeOutgoingMessage:function(a){return a.replace(/\\(?!u[0-9a-fA-f]{4}|x[0-9a-fA-f]{2})/g,"\\\\")},onLogin:function(){this._logged_in_to_chat=!0;this.joinRequestedRooms()},onLogout:function(){this._logged_in_to_chat=!1},joinRequestedRooms:function(){if(this._seen&&this._logged_in_to_chat){for(var a=
this._rooms_to_join.length-1;0<=a;a--)this.processRoomEvent(this._rooms_to_join[a]);this.clearRoomsToJoin()}},clearRoomsToJoin:function(){this._rooms_to_join=[]},activateRoomChooser:function(){this.recordAnalyticsEvent("ChatAction","RoomList");this._room_chooser.activate(this._active_room)},hideChatWindow:function(){this._chat_window_node.hide()},showChatWindow:function(){this._chat_window_node.show();this.scrollToBottom()},tabForRoom:function(a){return this.tabForType(a.type())},tabForType:function(a){return $(a+
"_room_tab")},messageError:function(a){this._active_room&&this._active_room.messageError(a)},roomGroups:function(a){this._room_chooser.roomGroups(a)},redoRoomList:function(){this._room_chooser.redoRoomList()},showChatNag:function(a,b){this._active_room&&this._active_room.showChatNag(a,b)},showUserRollover:function(a,b){this._user_rollover_manager.show(a,b)},hideUserRollover:function(){this._user_rollover_manager.beginHide()},addRoomOwner:function(a){this._room_owners[a.id]=a.owner},roomOwner:function(a){return this._room_owners[a]},
insertPrivateMessagePrefixFor:function(a){this.insertInActiveChatInput("/w "+a+" ")},insertInActiveChatInput:function(a){this._active_room&&this._active_room.insertInChatInput(a)},insert:function(a){this._active_room&&this._active_room.insert(a)},updateRolloverMutingLink:function(a){this._user_rollover_manager.updateMutingLink(a)},activeRoomUserListScrollTop:function(){return this._active_room.userListScrollTop()},showProfile:function(a){this.recordAnalyticsEvent("ChatAction","Profile");this._mini_profile.activate(a,
this._active_room)},showSpinner:function(){$("chat_window_spinner").show()},hideSpinner:function(){$("chat_window_spinner").hide()},showOnlineFriends:function(){this.recordAnalyticsEvent("ChatAction","FriendsList");this._online_friends.activate(this._active_room.name())},loadFriendsPage:function(a){this._online_friends.getOnlineFriends(a)},updateLastActionTaken:function(){var a={method:"post",parameters:{game_id:this.gameId()}},b=this.activeRoom();update=!1;b&&("chat"==b.type()&&(a.parameters.room=
b._room.id,update=!0),"game"==b.type()&&(a.parameters.game_room=b._room.id,update=!0),update&&new Ajax.Request("/last_action_taken/update",a))},activeRoomUsernameNode:function(a){return $(this._active_room.usernameNodeId(a))},activeRoom:function(){return this._active_room},startBeacon:function(){this._last_action_beacon&&this._last_action_beacon.stop();var a=this;this._last_action_beacon=new PeriodicalExecuter(function(){a.updateLastActionTaken()},600)},setupBanAndSilencingControls:function(){this._mini_profile.setupBanAndSilencingControls()},
gameId:function(){return this._holodeck.gameId()},deactivateMiniProfile:function(){this._mini_profile.deactivate()},activateRoomInfo:function(a){this.recordAnalyticsEvent("ChatAction","RoomDetails");this._room_info.activate(a)},scrollToBottom:function(){this._rooms.each(function(a){a.value.scrollToBottom()})},deactivateRoomChooser:function(){this._room_chooser.deactivate()},recordAnalyticsEvent:function(a,b){this._holodeck.recordAnalyticsEvent(a,b)},restoreDefaultView:function(){this.clearActiveTempPane();
this.hideSpinner();this._chat_tab_clicked=!0;this._mini_profile._container.hide();this._room_chooser.hide();this._room_info._container.hide();this._online_friends._container.hide();this.showChatWindow()},setActiveTempPane:function(a){this._active_temp_pane=a},clearActiveTempPane:function(){this._active_temp_pane=null},activeTempPane:function(){return this._active_temp_pane},noticedModeratableUser:function(a){active_user.isSuperChatModerator()||(this._moderatableUsers[a]=new Date,this.conditionallyStartModeratableSweeper())},
isModeratableUser:function(a){return active_user.isSuperChatModerator()?!0:!!this._moderatableUsers[a]},conditionallyStartModeratableSweeper:function(){this._moderatableUsersSweeper||(this._moderatableUsersSweeper=new PeriodicalExecuter(function(a){a=new Date;for(var b in this._moderatableUsers)a-this._moderatableUsers[b]>ChatWindow.MODERATABLE_TIME_LIMIT&&delete this._moderatableUsers[b]}.bind(this),60))}};this.Kongregate=this.Kongregate||{};
this.Kongregate.CloudSavesController={modeDetermined:function(a,b,c){active_user.areCloudSavesEnabled()&&(!holodeck||!holodeck.ready?document.observe("holodeck:ready",this.modeDetermined.bind(this,a,b,c)):("localOnly"==a?(c?holodeck.showCloudSavesTab("promptForLogin",{lastUsername:c}):holodeck.showCloudSavesTab(b?"loadConflict":a),holodeck.showCloudSavesIndicator("localOnly")):"debug"!=a&&holodeck.showCloudSavesIndicator(a),("remoteOnly"==a||"sync"==a||"debug"==a)&&KONGREGATE.cloudSavesHandler.beginPolling()))},
setMode:function(a){gameLoader.setSyncMode(a);"remoteOnly"==a?holodeck.showCloudSavesTab(a):holodeck.closeCloudSavesTab();holodeck.showCloudSavesIndicator(a)},syncStarted:function(){holodeck.showCloudSavesIndicator("syncing")},syncEnded:function(a){holodeck.showCloudSavesIndicator(a?gameLoader.getSyncMode():"error")},handleConflict:function(){isDebug||(holodeck.showCloudSavesIndicator("error"),holodeck.showCloudSavesTab("saveConflict"))},forceUpdates:function(){KONGREGATE.cloudSavesHandler.forceUpdates();
"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},reloadCloudSaves:function(){gameLoader.reloadCloudSaves();"remoteOnly"==KONGREGATE.cloudSavesHandler.getSyncMode()?holodeck.showCloudSavesTab("remoteOnly"):holodeck.closeCloudSavesTab()},upgradeToSync:function(a){gameLoader.upgradeToSync(a)},remoteWatermark:function(){return cloudSaves.syncWatermark?moment(cloudSaves.syncWatermark).format("MMMM Do, YYYY"):"unknown"},localWatermark:function(){var a=
KONGREGATE.cloudSavesHandler.localWatermark();return a&&!isNaN(a)?moment(a).format("MMMM Do, YYYY"):"unknown"},userAuthenticated:function(){active_user.areCloudSavesEnabled()&&gameLoader.refreshCloudData(function(){0===cloudSaves.syncWatermark?holodeck.showCloudSavesTab("noCloudSave"):(holodeck.showCloudSavesTab("authenticated",{username:active_user.username()}),jQuery(".js-last-cloud-save-date").html(Kongregate.CloudSavesController.remoteWatermark()),jQuery(".js-last-local-save-date").html(Kongregate.CloudSavesController.localWatermark()))})},
reloadGame:function(){gameLoader.reloadGame()}};CollapsiblePanel=function(a,b){this.initialize(a,b)};
CollapsiblePanel.prototype={initialize:function(a,b){this.element=$(a);this.toggle_callback=b;this.element.panel=this;this.handle=this.element.down(".panel_handle");this.body=this.element.down(".panel_body");var c=this;this.handle.observe("click",function(a){c.toggle();a.stop()});this.collapsed()?this.collapse():this.open()},collapsed:function(){return this.handle.hasClassName("closed_link")},collapse:function(){this.body.hide();this.handle.removeClassName("opened_link");this.handle.addClassName("closed_link")},
open:function(){this.body.show();this.handle.removeClassName("closed_link");this.handle.addClassName("opened_link")},toggle:function(){this.toggle_callback&&this.toggle_callback();this.collapsed()?this.open():this.collapse()},scrollTab:function(a){a.scrollTop=this.handle.positionedOffset()[1]-parseInt(this.handle.getStyle("margin-top"),10)}};Kongregate.DEFAULT_ICON_BASE64="iVBORw0KGgoAAAANSUhEUgAAAE4AAABOCAMAAAC5dNAvAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAwBQTFRF7u7udGNjVScnv7+/49zclQAA3d3daQAAysrKjQAAVgAAdTs7SQAAilZW07e30ri4aSQk1cvL29XVWAAAhzw8YQAAtJqayqOjnAAAaQUF49PTVxcXko2NYxcXqYeHioODrKysqwMDzLy8yMjIubm5cgUFeAUF6dnZv5KSoqKisgYGmQAAt4iIXAAAekVFhAAAi0VFl2trUAAAqQQEdQQEdAAAsbGxpQICmAAAuaGhq3l5ggAAxbCweAAAzba2rQUFwq6ueiUlfAAA6ubmiAAAbQQEciUlfwAAoAEBhgAAWgAAfwQEZAIC39nZxJ6epgUFdhkZbAAAcQAAbwAAdgAAngAAbgAA7OrqvqamXgAAkQAAkwAA2s7OgAAA/Pr6ZgAAegAAZQMDigAA8OjoYwAA+fb29vLytAcHVAsLgQYGnQYG5uTkogYGfAYGf3NzlQYGjQYGiQYGhQYGZwMD08DAgXZ2dy0tkQYGZA8PsQgIwZKSXAwMoAMDngMDnAMDowMDmgMDYwUFlwMDkwMDjwICigMDhAMDgQMDfAICdgICcgIC7+fncAMDmQYGgQgI28fHbA0NiAMDdAMDhgMDfgICegMDeAMDbgICggICWjMzawICfAUFogEBfwYGXwICUwYGXgQEhn5+w8PDzMzM/v7+zs7O1tbW+/v7/Pz8/f39z8/P0cfH+vr60NDQ+fn55OTk4eHh5eXl+Pj44uLi8PDw3t7e9fX19PT06Ojo6enp29vb0dHR5ubm0tLS2tra9/f339/f2NjY9vb21NTU2dnZ09PT1dXV7e3t8vLy8fHx7Ozs6urq5+fnxsbG6+vr4ODg8/Pz4+PjxMTEwsLClpKSwMDAfwgIqgcHvb29iH9/19fXXQEBtwcH+/r6eWpqb1xct6Ghp6enWgYGr5OTcA8P59fXVQUF59/f+/n5s5GR5+bmxKSk2dLSkk5O5uPjypycuXx88/DwwIuLn3Bw6ejoy66u6unp7ezs8u/vpWtru6envKOjnF9f6uHh8/Lyy7KyaPf3UwAACWlJREFUeNqsmHlc0+cdxzOuX/IDBIw/NSKCclSYMV0gaI0hJUsIiVjNIWtAGo50oGu0FbUwFRWCCqW0KmBBm3q0eBS5bzlF5QqnIKK2Xbt1bl1337ObfX5nQhK7vcLef/H7fl7PO9/neD0vXg/tEgE9cGRy8qIDTE6OBNJJCw130acjQ5f7X3AI/+WhkdN0ullHvxuwrzwrYpODRGSV7wu4Syd19PtT5frsR+npYQ6Rnv4oW18+dZ+O6+j3/X1nHoUJhSsdRCgMezTj64/6aGCmU77Z6cKV4escJnylMD3bdwrMF+gCymfSheHrzp2LdZBz59aFC9NnygNQ3fQ+PbAdjo3d5jCxsYeBT79v+hKNHlmeHRa+Lnbb0nmwLXZdeFh2eSSdFhialS6cpw3zCdOzQgNpI8sjwsBUl84TMN2wiOUjtMnZs2Hh87YBX3jY2dlJ2sULZ4VbYpd+H2e9Pb4rI8OlsVuEZy9ctNStd3VNTLBDoisYZj/CMmvd4UPYT7smMMQyjg3iVEaiayIjVcx5RoY1eegwoSudwXXAxhEJeDYIpGJGAkMmtRPxBCIZ7gO6mVJSlwPm6erKkCV/+Zwd/iBNZYilf7IXPfd7kTgBHbs+x6w7iOkSGXzeKx/a4afJslSOYIm96MMFAg4D1x0kdVsOHkErCalSpV3dagFHzFE/Q8fjgNkCjhzcgutCUF1iYiLQqV65aofVao6Yz1tiL7q6gMdnJIDBqC6E0B3KdQV7DtZH9ckVW66u5vFlqM5eBnSp6IFxzT1koUskdL+6ctmGK4TOTnT5ygJlUioDPX8WupxcIGMwxEm8V8GYKktIHUfw0lXrrArV8YCOAYS5OaTutZw81MYA27d1w5dgTDVJVfVbaWlpa9CtEJ1atGbZJ+YIhJd/nJa2RM0Xo2MT8nJeI3VH8gyYTpYkUEoW/bWqnqR6r0YLqXgijljMT1ZqjfvfqjZnl1e/C8WDDO2OYcg7QugigA6zpYplfBEPiq6q7yao9tKCAVJgA+0ptVlR1WRSX/3qPxVKdbKUL07FfEAXQehyDcCFgo2Kruq+SVDvBYGfR20yviB+6zvVZNJdn/a8Qi3ioxk2kmHItdSJCWRSXnT1zWaCbi+FgI+WOUkCVfSyejK4Wb8sWiWQcmTkMLGFbmeuIZUsc1BdcwvBTVQnA9eMVKDY/7ibrDfXP/3FXJs41ZC7k9TlGajm0MnWtwzgjDd7QQIwIbCiikVpzeNktXsNSwlsljqxIc9SR91zqG5gkKDFC1JL+Ulgf377jxaiOtDyx28gzGaBzKwL3pmXT12NfJEqunuwkWAc3QqpQAl9Mz5OlAZb/r0ItfGt7tH8vJ3BuO7tvHyqnCSIj77ZSCMY8NIqBWqVdkPzIFFpbHlnK2az0nHy894mdYZ8Dp9ACnTNtH6CwSidQqWIW9PSiJeA7TfvKsD9nMS3gpNvMOtOcpIIwBYC3RBBY5RGqz360jhR6Kf9Z0McsImkSdZwTlK63YbTfCmBSK2IbukfxhmlRTHZWU8H+kfxz/4femrATEVSW/inDbtxXdHu/GNJUhEBD4oZH20joEVx/fY2Up9DG2FEwUsW2SJNOpa/u4jSUbZkVDfcSjD01G87jfpqHW78swYCc7Xns9S9V0KWwaGIGWjrwDG1+SwcajV1kJiGaYt0YO3s9FfynqVOlCwgUGpjBk11BB2m1o46CzpGXfzAHSOwIVlE6SRvnjwuIutqoGvsqJlLXR3111DUebs+0fGTb0oI3ekSqsyL18U01jVYUmMyuZgmiI+6/hVsrYqntvGVnCZ1rx87IVCT/yYodDG0mloLJlq/Wuv5d6pU1/+8BlzQVqgFJ469bqEj60oFEkOb6KEYa2h1cYfhJ20NY3ihtuOxNwKplNb/rMzRqefoGppIempbt3vL2XI/l7oeojRm2nsAgeKtfGoL3fFSnpJABSHe/WNuJGOtq/zYOi3C9hytpWptv2aivjnwSo+bdWWULh7SeA/1tOO4NXW8fICtgxQQAj/paHIjqmOjnnKdlY9XRupYb2wqKFQRKLRs79GmLpz2sVUfgEYUClD1c6ltJ8u1v9uP/ki8ykxhwaY3WISupEAZryBAdW63CGo3wmwtWoUQpmcbVW5v8MGaNhOvLCihdCcKVGQd0rG9h916CcY2whpcp2XDL090kfX2mhfguT5VwQmzrpBoDoK0CNO7rasS50EP2h2E6RCmn0tTLxm0m34AfFqIMsYXUro9pYVAhKIFewh7t926g1PZ9CJXjmixBJFzPU1dlWTi9hN3mI3otFp8IKQoLN1j1lUQMg0b5nqbevtw7ri96AHLNYgWgDC5Hv/qqSSSvsqmr325TLYG0eHCCkqXuaesCHVhrXE9PLwbKm8T9Pqs/YCLdQEiDw/fXiq5Xdmzyh1kco0OHQlBRWV7MjFdyo6yM6RtscvmhQu7+joJ+romNv987S+ZGkTDdH+8+Wtz0tl5x61m82LPAzDePHSmbEcKoSvAdDqwPE8aboEOblB03ultGl4Ms8EiuLe1V/bduDEnc+v4EVhcHaYroHSnKrQ6gIbJfaH9xvW53LjdtBgsEtDV9F23pvPWX7igPTBWW3Fqjg5BEA0MdNevWXG9HdXJue4Tt6/ZUPmVB1haBLHUvX+qIg6U0I34Wde1j6y4BnQwmwl0nR/ZcKcO1yFxFafeJ3WFFVhzYPPs6boWg9PyHTpwkkB7FYWkTl+UiWgAQPek9kGlFQ9qQXdMmOveeqvSBre/oToAklmkx3VHCR1Ybu4Kn49t8FkBdKC77R/byXw8YHCYcd1RUpeCsFFgLjjFtnDBaWXCdiMQwnJ0KJJi1p2JM2I6JgyEtsAwUy63H2EZOtQYd4bSSeIeoiU56MEuwCZnPivDdQ/jJJY6OQbzGfy3TC4ndZOzuI45L3Dd7CRtZPl5fdH/Q1ekP798hBYYmrEjOMX4rGX732DKjSnBOzJCA2n0SKfiEJaRPT8d28gKKXaKpNMuOX/K0s+zPaw5PetT50u0S4GfO90LkaQYHV8++UNjiiTkntPngejrorN/RnGIJDPOaHzoEEZjXKYkpDjD35mOPaUG7cq4pw+WsFgpDsFiSYL19zJ2BdGJh96gWV9JsT4k2EFC9MUS39kgOvUM7Rz6mdMXLIf5wumzUGe6xSP5SFDA1K7vOciuqYCgEYtHcuzVfeTutLNDTN8doZNv+N8KMAAJHpuKk0HEGAAAAABJRU5ErkJggg==";
window.lightboxController={closeLightboxWithResult:function(a,b){parent.parent.lightbox.prototype.shutdown()}};(function(){"undefined"===typeof window.DOMParser&&window.ActiveXObject&&(DOMParser=function(){},DOMParser.prototype.parseFromString=function(a,b){var c=new ActiveXObject("Microsoft.XMLDOM");c.async="false";c.loadXML(a);return c})})();FayeConnection=function(a){this.initialize(a)};FayeConnection.DISCONNECT_TIMEOUT=2E4;
FayeConnection.prototype={initialize:function(a){this._authenticator=a.authenticator;this._resetReauthenticateBackOffPeriod();this._pendingMessages={}},subscribe:function(a){var b=this;return this._authenticator.authenticate(a.guildId).then(function(c){return b._subscribe(new GuildRoom(a.guildId,c.guild_name))})},disconnect:function(){this._client&&(this._connectionMonitor.destroy(),this._connectionMonitor=null,this._client._state=this._client.DISCONNECTED,this._client._dispatcher.close(),this._pendingMessages=
{},this._activeRoom=this._client=null)},sendMessage:function(a,b){return this._client.publish(b.id,{text:a},{deadline:FayeConnection.DISCONNECT_TIMEOUT/1E3}).then(null,function(a){throw{rateLimited:429===a.code};})},setPresence:function(a,b){b?this.activeRoom=a:a===this.activeRoom&&(this.activeRoom=null)},_connect:function(a){var b=this;this._room=a;this._client=new Faye.Client(window.FAYE_CONFIG.KWAK_SERVICE_URL+"/faye",{scheduler:FayeBackoffScheduler});this._connectionMonitor=new FayeConnectionMonitor({client:this._client,
timeout:FayeConnection.DISCONNECT_TIMEOUT});this._client.addExtension({incoming:this._errorDetectionExtension.bind(this),outgoing:this._outgoingExtension.bind(this)});this._client.addExtension({incoming:this._roomHistoryExtension.bind(this)});this._connectionMonitor.on("disconnect",function(){b.trigger("disconnect")});this._connectionMonitor.on("connect",function(){b.trigger("connect")})},_subscribe:function(a){var b=$j.Deferred(),c=this,d=!1,e=setTimeout(function(){b.reject()},3E4);this._connect(a);
this._pendingMessages[a.id]=[];this._client.subscribe(a.id,function(b){b=FayeMessageTransformer.transform(b);d?c.trigger("message",a,b):c._pendingMessages[a.id].push(b)}).then(function(){var f=c._pendingMessages[a.id];b.resolve(a);for(var h=0;h<f.length;h++)c.trigger("message",a,f[h]);d=!0;clearTimeout(e);delete c._pendingMessages[a.id]});return b.then(null,function(){c.disconnect()})},_reconnect:function(a){var b=this;this.disconnect();this._reauthenticationTimeout||(this._reauthenticationTimeout=
setTimeout(function(){b._authenticator.reauthenticate().then(function(){b._subscribe(a)});b._reauthenticationTimeout=null},Math.min(this._reauthenticateBackOffPeriod,3E5)),this._reauthenticateBackOffPeriod*=2)},_resetReauthenticateBackOffPeriod:function(){this._reauthenticateBackOffPeriod=500},_errorDetectionExtension:function(a,b){void 0!==a.error&&null!==a.error&&(error=Faye.Error.parse(a.error),403===error.code?(a.advice={reconnect:"none"},this._reconnect(this._room)):this._resetReauthenticateBackOffPeriod());
b(a)},_roomHistoryExtension:function(a,b){if("/meta/subscribe"===a.channel&&a.successful){var c=a.ext,d=a.subscription;c&&c.history&&(c=$j.map(c.history,function(a,b){var c=FayeMessageTransformer.transform(a);c.history=!0;return c}),this._pendingMessages[d]=c.concat(this._pendingMessages[d]))}b(a)},_outgoingExtension:function(a,b){void 0===a.ext&&(a.ext={});a.ext.auth_token=this._authenticator.token();"/meta/connect"===a.channel&&this.activeRoom&&(a.ext.active_room=this.activeRoom);b(a)}};
$j.extend(FayeConnection.prototype,Evented);FayeEventDispatcher=function(a){this.initialize(a)};FayeEventDispatcher.MAX_UUIDS=50;
FayeEventDispatcher.prototype={initialize:function(a){this._holodeckEventDispatcher=a.holodeckEventDispatcher;this._uuids=[]},message:function(a,b){this.checkDuplicateMessage(b)||("0"===b.kuid?this._holodeckEventDispatcher.fire({type:KonduitEvent.SYSTEM_MESSAGE,data:{data:b.data,timestamp:1E3*b.timestamp,room:a}}):this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_MESSAGE,data:{history:!1,message:b.text,timestamp:1E3*b.timestamp,room:a,user:FayeUserTransformer.transformUser(b)}}))},history:function(a,
b){this._holodeckEventDispatcher.fire({type:KonduitEvent.HISTORY_RECEIVED,data:{room:a,count:b}})},checkDuplicateMessage:function(a){for(var b=0;b<this._uuids.length;b++)if(this._uuids[b]==a.uuid)return!0;this._uuids.push(a.uuid);this._uuids.length>FayeEventDispatcher.MAX_UUIDS&&this._uuids.shift();return!1},disconnect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_DISCONNECT,data:{}})},connect:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.FAYE_CONNECT,data:{}})},
userJoin:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_JOIN,data:{room:a,user:FayeUserTransformer.transformUser(b)}})},userDeparture:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_DEPARTURE,data:{room:a,user:FayeUserTransformer.transformUser(b)}})},userChanged:function(a,b){this._holodeckEventDispatcher.fire({type:KonduitEvent.USER_CHANGED,data:{room:a,force:!0,user:FayeUserTransformer.transformUser(b)}})},messageTooLong:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,
data:{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG}})},messageRateLimited:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.MESSAGE_ERROR,data:{errorType:KonduitChatErrorMessage.RATE_LIMITED}})},joinRoom:function(a){this._holodeckEventDispatcher.fire({type:KonduitEvent.JOIN_ROOM,data:{room:a}})},roomNotFound:function(){this._holodeckEventDispatcher.fire({type:KonduitEvent.ROOM_NOT_FOUND,data:{room:{name:"That guild chat room",type:"guild"}}})},leaveRoom:function(a,b){data={owner_left:!1,
kicked:Boolean(b),owner_destroyed:!1,room:a};this._holodeckEventDispatcher.fire({type:KonduitEvent.LEAVE_ROOM,data:data})}};FayeHistoryService=function(a){this.initialize(a)};FayeHistoryService.MAX_MESSAGES=20;
FayeHistoryService.prototype={initialize:function(a){this._authenticator=a.authenticator},_makeAjaxRequest:function(a,b,c){return $j.ajax(this._url(a),{method:"GET",dataType:"jsonp",data:{max_time:b,min_time:c}})},fetchHistory:function(a,b,c){var d=this;this._makeAjaxRequest(a,b,c).then(function(b){$j.each(b.history,function(b,c){d.trigger("message",a,FayeMessageTransformer.transform(c))});d.trigger("history",a,b.history.length)})},_url:function(a){return window.FAYE_CONFIG.KWAK_RAILS_URL+"/rooms"+
a.id+"/history.jsonp?t="+this._authenticator.token()}};$j.extend(FayeHistoryService.prototype,Evented);FayeRoomList=function(a){this.initialize(a)};FayeRoomList.CHANGED="changed";FayeRoomList.ADDED="added";FayeRoomList.EXISTS="exists";FayeRoomList.REMOVED="removed";FayeRoomList.USERNAME_CHANGED="username_changed";
FayeRoomList.prototype={initialize:function(a){this._users={}},addUser:function(a){if(this._users[a.kuid]){if(this._users[a.kuid].username!=a.username){var b={status:FayeRoomList.USERNAME_CHANGED,existingUser:this._users[a.kuid]};this._users[a.kuid]=a;return b}return this._diffUser(a)?(this._users[a.kuid]=a,{status:FayeRoomList.CHANGED}):{status:FayeRoomList.EXISTS}}this._users[a.kuid]=a;return{status:FayeRoomList.ADDED}},addUsers:function(a){var b=this,c={},d=[],e=[],f=[],h=$j.extend({},this._users);
$j.each(a,function(a,c){delete h[c.kuid];var q=b.addUser(c);switch(q.status){case FayeRoomList.ADDED:d.push(c);break;case FayeRoomList.CHANGED:e.push(c);break;case FayeRoomList.USERNAME_CHANGED:d.push(c),f.push(q.existingUser)}});$j.each(Object.keys(h),function(a,c){f.push(h[c]);delete b._users[c]});c[FayeRoomList.ADDED]=d;c[FayeRoomList.CHANGED]=e;c[FayeRoomList.REMOVED]=f;return c},_diffUser:function(a){var b=!1,c=this._users[a.kuid];$j.each(Object.keys(a),function(d,e){if(a[e]!==c[e])return b=
!0,!1});return b}};FayeRoomListService=function(a){this.initialize(a)};FayeRoomListService.MESSAGE_FIELDS="kuid level username character_name user_id admin developer premium mobile".split(" ");
FayeRoomListService.prototype={initialize:function(a){this._authenticator=a.authenticator;this._intervalManager=new IntervalManager(this._fetchUserList.bind(this),3E5)},connect:function(a){this._currentRoom&&this._fetchUserList()},subscribe:function(a){this._currentRoom=a;this._roomList=new FayeRoomList;this._intervalManager.start(!1);this._fetchUserList()},unsubscribe:function(a){this._currentRoom&&this._currentRoom.id===a.id&&(this._intervalManager.stop(),this._currentRoom=this._roomList=null)},
message:function(a,b){if(!(b.history||"0"===b.kuid)){var c={active:!0};$j.each(FayeRoomListService.MESSAGE_FIELDS,function(a,d){c[d]=b[d]});var d=this._roomList.addUser(c);switch(d.status){case FayeRoomList.ADDED:this.trigger("userJoin",this._currentRoom,c);break;case FayeRoomList.CHANGED:this.trigger("userChanged",this._currentRoom,c);break;case FayeRoomList.USERNAME_CHANGED:this.trigger("userDeparture",this._currentRoom,d.existingUser),this.trigger("userJoin",this._currentRoom,c)}}},_makeAjaxRequest:function(){return $j.ajax(this._url(this._currentRoom),
{method:"GET",dataType:"jsonp"})},_fetchUserList:function(){var a=this,b=this._currentRoom.id;this._makeAjaxRequest().then(function(c){a._currentRoom&&a._currentRoom.id==b&&(c=a._roomList.addUsers(c.characters),a._triggerEvents(c[FayeRoomList.ADDED],"userJoin"),a._triggerEvents(c[FayeRoomList.CHANGED],"userChanged"),a._triggerEvents(c[FayeRoomList.REMOVED],"userDeparture"))})},_triggerEvents:function(a,b){var c=this;$j.each(a,function(a,e){c.trigger(b,c._currentRoom,e)})},_url:function(a){return window.FAYE_CONFIG.KWAK_RAILS_URL+
"/rooms"+a.id+"/characters.jsonp?t="+this._authenticator.token()}};$j.extend(FayeRoomListService.prototype,Evented);FayeService=function(a){this.initialize(a)};
FayeService.prototype={initialize:function(a){this._authenticator=a.authenticator;this._fayeConnection=a.fayeConnection||new FayeConnection({authenticator:this._authenticator});this._fayeConnection.on("message",this,"trigger","message");this._fayeConnection.on("disconnect",this,"trigger","disconnect");this._fayeConnection.on("connect",this,"trigger","connect")},setPresence:function(a,b){this._fayeConnection.setPresence(a,b)},subscribe:function(a){var b=this;this._currentGuildRoom&&this.leaveCurrentGuildRoom(!1);
this._fayeConnection.subscribe(a).then(function(a){b._currentGuildRoom=a;b._fayeConnection.setPresence(a.id,!0);b.trigger("joinRoom",a)},function(){b.trigger("roomNotFound")})},leaveCurrentGuildRoom:function(a){this._fayeConnection.disconnect();this._currentGuildRoom&&(this._fayeConnection.setPresence(this._currentGuildRoom.id,!1),this.trigger("leaveRoom",this._currentGuildRoom,a),this._currentGuildRoom=null)},sendMessage:function(a,b){var c=this,d=!1;250<a.length&&(d=!0,a=a.substr(0,249)+"\u2026");
return this._fayeConnection.sendMessage(a,b).then(function(){d&&c.trigger("messageTooLong")},function(a){a.rateLimited&&c.trigger("messageRateLimited")})},isCurrentRoomId:function(a){return this._currentGuildRoom&&a===this._currentGuildRoom.id},isCurrentRoomName:function(a){return this._currentGuildRoom&&a===this._currentGuildRoom.xmpp_name}};$j.extend(FayeService.prototype,Evented);
FayeUserTransformer=function(){var a=[];$j.each(["blue","green","purple","red"],function(b,c){for(var d=1;6>=d;d++)a.push("guestavatar-"+c+d+".png")});return{transformUser:function(b){var c=b.username||"_"+b.kuid,d=null;active_user.username()!==b.username&&(d=b.active?"chat":"away");var e=b.level,f=b.character_name,h=b.admin,l=b.developer,g=b.premium,q=b.mobile,u=window.location.host.split(".")[1];if(b.username)b="assets/dynamic/accounts/"+b.username+"/avatar";else{b=b.kuid;for(var s=0,x=b.length,
m=0;m<x;m++)s=(s<<5)-s+b.charCodeAt(m),s&=s;b=Math.abs(s);b="assets/mobile_guest_avatars/"+a[b%a.length]}return{username:c,variables:{level:e,username:c,game_character_name:f,presence:d,admin:h,curator:!1,developer:l,moderator:!1,premium:g,mobile:q,chat_avatar_url:"https://assets."+u+".com/"+b+"?i10c=img.resize(width:16,height:16)",game_title:null,game_url:null,role:"participant",special_chat_vars:"{}",type:""}}}}}();function evalJS(a){eval(a)}
function updateTaskProgress(a,b){try{$(a+"-progress-amount").update(b)}catch(c){console.warn("error during updateTaskProgress on %s to %s",a,b)}}function markTaskComplete(a){try{Element.addClassName(a,"complete"),Element.removeClassName(a,"incomplete"),$(a+"-progress")&&Element.hide(a+"-progress"),new Effect.Highlight(a,{})}catch(b){console.warn("error during markTaskComplete on %s",a)}}
function markAccomplishmentComplete(a){try{Element.addClassName(a,"complete"),Element.removeClassName(a,"incomplete"),new Effect.Highlight(a,{})}catch(b){console.warn("error during markAccomplishmentComplete on %s",a)}}function GuildChatAuthenticator(){this.initialize()}
GuildChatAuthenticator.prototype={initialize:function(){},authenticate:function(a){this._guildId=a;return this._fetchToken()},reauthenticate:function(){var a=this;return this._fetchToken().then(null,function(){a.trigger("kick")})},_fetchToken:function(){var a=this;return $j.getJSON("/api/internal/v1/guilds/"+this._guildId+"/token.json").then(function(b){a._token=b.token;a._expires=Date.now()+1E3*b.ttl;return b})},token:function(){var a=this;!this._pendingTokenRequest&&Date.now()>=this._expires-3E5&&
(this._pendingTokenRequest=this.reauthenticate().always(function(){a._pendingTokenRequest=null}));return this._token}};$j.extend(GuildChatAuthenticator.prototype,Evented);function GuildRoom(a,b){this.type="guild";this.id="/guilds/"+a+"/rooms/1";this.name=b;this.xmpp_name=this.id}HighScores=function(a){this.initialize(a)};
HighScores.prototype={initialize:function(a){this._active=!1;this._holodeck=a;this._container=$("high_scores_container");this._high_scores_node=$("high_scores");this._high_scores_spinner=$("high_scores_spinner")},activate:function(a){this._holodeck.recordAnalyticsEvent("Achievements","Scores");this.hideAccomplishmentsSection();this.getHighScores(a)},getHighScores:function(a,b,c){var d=this._container,e=this._holodeck,f=this._high_scores_node;e.chatWindow();var h=this,l="/high_scores.chat?game_id="+
e.gameId();this._active=!0;f.hide();this._high_scores_spinner.show();a&&(l+="&statistic_id="+a);c&&(l+="&"+c+"="+b,e.recordAnalyticsEvent("Achievements","ScoresChangePage"));this._tabs&&(this._last_tab=this._tabs.activeLink.key);new Ajax.Updater({success:"high_scores"},l,{method:"get",onComplete:function(){h._active&&(h.hideAccomplishmentsSection(),h._high_scores_spinner.hide(),h.hookUpTabsAndSelect(),f.show(),d.ieHappyShow())}})},deactivate:function(){this._active=!1;this._high_scores_spinner&&this._high_scores_spinner.hide();
this._container&&this._container.ieHappyHide();this.showAccomplishmentsSection()},hideAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyHide()},showAccomplishmentsSection:function(){this.accomplishmentsTabNode().ieHappyShow()},hookUpTabsAndSelect:function(a){var b=this,c=$("statistic_id");a="weekly_high_score_tab_pane";this._last_tab&&(a=this._last_tab);this._tabs=new HolodeckTabs("high_score_tab_set",{defaultTab:a});$$(".high_score_panel_tab").each(function(a){a.observe("click",
function(a){holodeck.recordMappedEventAnalytic(a.target.up("li").id)})});c&&c.observe("change",function(){b._holodeck.recordAnalyticsEvent("Achievements","ScoresChangeStat");var a=c.getValue();b.getHighScores(a)})},accomplishmentsTabNode:function(){this._accomplishments_tab_content_node||(this._accomplishments_tab_content_node=$("accomplishments_tab_content"));return this._accomplishments_tab_content_node}};Holodeck=function(a){this.initialize(a)};Holodeck.KONG_GAMEPLAYS_COOKIE_NAME="kong_gameplays";
Holodeck.KONG_HS_ALERT_COOKIE_NAME="kong_hs_alert";Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME="kong_hs_alert_time";Holodeck.HOLODECK_TAB_COOKIE_NAME="holodeck_tab";Holodeck.SIGNUP_TAB_NAME="signup_tab_pane";Holodeck.SIGNIN_TAB_NAME="signin_tab_pane";Holodeck.CHAT_TAB_NAME="chat_tab_pane";Holodeck.LAST_PRIVATE_ROOM_KEY="last_private_room";Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX="last_game_room_";Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX="last_kgr_";
Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE="last_kgr";Holodeck.GAME_ROOM_JOIN={type:"game"};Holodeck.GOOGLE_A_DAY_START_DATE=new Date("Aug 16 2012");Holodeck.GOOGLE_A_DAY_END_DATE=new Date("Sep 30 2012");Holodeck.HS_ALERT_WAIT_MILLISECONDS=36E5;Holodeck.guildIdFromXmppName=function(a){if(a=/guilds\/(\d+)/.exec(a))return a[1]};
Holodeck.prototype={initialize:function(a){var b=window.location.search.parseQuery().guest_access_key,c={};b&&(c.guest_access_key=b);this.ready=!1;this._konduit=new Konduit;this._game_discussions=new GameDiscussions({gameUrl:active_user.gameResourcePath(),inGuilds:page_data.in_guilds,hasGameSpecificForum:a.has_game_specific_forum});new Ajax.Updater({success:"chat_container"},a.holodeck_url,{method:"get",parameters:c,evalScripts:!0,onComplete:function(){holodeck.uiLoaded(a)},onException:function(a,
b){console.error(b.message)}})},uiLoaded:function(a){window.onunload||(window.onunload=Prototype.emptyFunction);if(a){a.holodeck=this;var b=document.location.href.parseQuery();this._interval_between_renders=parseInt(b.interval_between_renders,10)||20;this._has_shown_cannot_connect_alert=!1;this._event_dispatcher=new KonduitEventDispatcher;this.initializeAccomplishmentTracker(a);this._html_dimensions=a.html_dimensions;this._chat_window=new ChatWindow(a);this._users_invited={};this._ignored_invitations=
{};this._holodeck_event_analytics=new HolodeckEventAnalytics;this._incoming_message_filters=[];this._outgoing_message_filters=[];this._game_id=a.game_id;(this._active_user=a.active_user)&&this._active_user.setHolodeck(this);this._chat_disconnected_indicator_node=$("chat_disconnected_indicator");this._chat_connected_indicator_node=$("chat_connected_indicator");this._chat_limited_connection_indicator_node=$("chat_limited_connection_indicator");this._accomplishment_group_award_tab_node=$("accomplishment_group_awarded_tab_pane_content");
this._just_earned_badge=this._suppress_disconnect=this._has_logged_in=!1;this._accomplishments_bootstrap_url=a.accomplishments_bootstrap_url;this._on_loaded_accomplishments_callbacks=[];this._game_path=a.game_path;this._shared_content_type_permalinks=a.shared_content_type_permalinks;this._shared_content_type_names=a.shared_content_type_names;this._permissions=a.permissions;this._authenticated_only_shared_content_sorts=a.authenticated_only_shared_content_sorts;this._has_game_specific_forum=a.has_game_specific_forum;
this._multiplayer_game=a.multiplayer_game;this._suppress_setting_preference_cookie=!1;this._in_beta=a.in_beta;this._in_preview=a.in_preview;this._active_dialogue=void 0;this._chat_commands={};this._chat_api_tab=new ChatApiTab(a);this._chat_host=a.chat_host;this._chat_proxy_websocket=a.chat_proxy_websocket;this._chat_proxy_bosh=a.chat_proxy_bosh;this._saved_shared_content_event=null;this._login_url=a.login_url;this._custom_game_avatar=null;this._avatar_crop_boundaries={};this._avatar_cropper=null;
this._extra_interpolation=a.extra_interpolation;this._gameplay_id=null;this._coupon_templates={};this.addChatCommand("w",this.sendWhisper);this.addChatCommand("msg",this.sendWhisper);this.addChatCommand("bug",function(a,b){var c=(b.match(/^\/\S+\s+(.+)$/)||[])[1],d=a.activeDialogue();c?a.submitGameBug(c,{onSuccess:function(a){d.insert('<p class="bug">Your bug report has been successfully submitted. Thank you!</p>')},onFailure:function(a){d.insert('<p class="bug">Uh oh! Your bug report could not be completed at this time. Please visit the <a href="/feedbacks/new">feedback form</a> and try again.</p>')}}):
d.insert('<p>Use the <code>/bug</code> command to submit a bug report for the game you are playing. Just type <code>/bug</code> followed by a brief report, or visit the <a href="/feedbacks/new">feedback form</a> to submit a more detailed bug report.</p>');return!1});this.addChatCommand("afk",this.setPresenceAway.bind(this));this.addChatCommand("back",this.setPresenceChat.bind(this));this.addChatCommand("invite",function(a,b){var c=(b.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2];c&&0<c.length&&a.sendPrivateRoomInvitation(c);
return!1});this.addChatCommand("kick",function(a,b){var c=(b.match(/^\/([^\s]+)\s+([^\s]+)/)||[])[2];c&&0<c.length&&a.privateRoomKick(c);return!1});this.addChatCommand("history",function(){holodeck.chatWindow().activeRoom()&&holodeck.chatWindow().activeRoom().fetchHistory();return!1});this.addMessageFilters();var c=this._event_dispatcher,d=this._chat_window,e=this._accomplishment_tracker,f=a.achievements&&0<a.achievements.length;c.register(KonduitEvent.INIT,function(a){holodeck.updateDefaultChatTabMessage("Connecting to chat")});
c.register(KonduitEvent.DISCONNECT,function(a){holodeck.showDisconnectedIndicator();CinematicMode.addCinematicMessage("You have been disconnected from Kongregate and scores will not be submitted.");a.data.banned?window.location.href="/":a.data.conflict?holodeck.showSessionAlert():a.data.login_failed?holodeck.showSessionExpiredAlert():holodeck._suppress_disconnect?holodeck._suppress_disconnect=!1:holodeck.showDisconnectedAlert()});c.register(KonduitEvent.FAYE_DISCONNECT,function(a){d.fayeDisconnect()});
c.register(KonduitEvent.FAYE_CONNECT,function(a){d.fayeConnect()});c.register(KonduitEvent.API_INITIALIZED,function(a){(function(){holodeck.loadSharedContentFromUrl();holodeck.saveSharedContentFromUrl();holodeck.konduit().dispatchEvent({type:KonduitEvent.ADD_STATISTICS,data:holodeck._statistics})}).defer()});c.register(KonduitEvent.STATISTIC_UPDATED,function(a){holodeck._has_submitted_stats=!0;e.onStatisticUpdated(a)});c.register(KonduitEvent.STATISTICS_FLUSH,function(a){holodeck.konduit().dispatchEvent(a)});
c.register(KonduitEvent.KONDUIT_MESSAGE,function(a){a.data&&a.data.outgoing?c.fire({type:a.data.opcode,data:a.data.params}):holodeck.konduit().dispatchEvent(a)});c.register(KonduitEvent.LOGIN,function(a){!0===a.data.success?(holodeck.updateDefaultChatTabMessage("Joining room"),holodeck.setUsername(a.data.username),holodeck._has_logged_in=!0,!0===a.data.bosh?holodeck.showLimitedConnectionIndicator():holodeck.showConnectedIndicator(),d.onLogin(),holodeck.closeAlertTab()):holodeck.updateDefaultChatTabMessage("Chat signin failed!")});
c.register(KonduitEvent.CONNECT,function(a){!1===a.data.success?!1===holodeck._has_logged_in&&(holodeck.updateDefaultChatTabMessage("Chat connection failed!"),holodeck.showCannotConnectAlert()):holodeck.updateDefaultChatTabMessage("Signing in")});c.register(KonduitEvent.SILENCED,function(a){d.onSilenced(a)});c.register(KonduitEvent.PARTICIPATE,function(a){d.onParticipate(a)});c.register(KonduitEvent.JOIN_ROOM,function(a){switch(a.data.room.type){case "game":holodeck.setGameRoomCookie(a.data.room);
break;case "guild":var b=Holodeck.guildIdFromXmppName(a.data.room.xmpp_name);a.data.room.guildId=b;b={type:a.data.room.type,guild_id:b};holodeck.setGuildRoomForCurrentGameCookie(b);holodeck.setSitewideGuildRoomCookie(b);break;case "private":$.jStorage.set(Holodeck.LAST_PRIVATE_ROOM_KEY,a.data.room)}holodeck.displayRoom(a.data.room)});c.register(KonduitEvent.ROOM_NOT_FOUND,function(a){"game"==a.data.room.type&&holodeck.getGameRoomCookie()?(holodeck.setGameRoomCookie(),holodeck.joinRoom({type:"game"})):
d.roomNotFound(a.data.room)});c.register(KonduitEvent.JOIN_GUILD_ROOM,function(a){d.roomNotFound({type:"guild",name:"Guild Room"})});c.register(KonduitEvent.ROOM_FULL,function(a){d.roomFull(a.data.room)});c.register(KonduitEvent.REQUEST_CHAT_ROOM,function(a){d.requestRoomToJoin()});c.register(KonduitEvent.LEAVE_ROOM,function(a){d.leftRoom(a.data);"guild"===a.data.room.type&&(holodeck.setGuildRoomForCurrentGameCookie(),holodeck.setSitewideGuildRoomCookie())});c.register(KonduitEvent.ROOM_MESSAGE,function(a){d.receivedRoomMessage(a)});
c.register(KonduitEvent.SYSTEM_MESSAGE,function(a){d.receivedSystemMessage(a)});c.register(KonduitEvent.MESSAGE_ERROR,function(a){d.messageError(a);if(KonduitChatErrorMessage.RATE_LIMITED===a.data.errorType){var b=d.activeRoom(),b=b?b.getId():null,c=(Cookie.get("rate_limit_log")||"[]").evalJSON();c.push([(new Date).getTime(),b,a.data.ruleViolated]);Cookie.set("rate_limit_log",Object.toJSON(c),void 0,"/")}});c.register(KonduitEvent.PRIVATE_MESSAGE,function(a){holodeck.receivedPrivateMessage(a)});c.register(KonduitEvent.ADMIN_MESSAGE,
function(a){d.receivedAdminMessage(a)});c.register(KonduitEvent.USER_JOIN,function(a){holodeck.displayRoomOnFirstJoin(a.data.room);d.userJoinedRoom(a)});c.register(KonduitEvent.USER_CHANGED,function(a){d.userChangedInRoom(a)});c.register(KonduitEvent.USER_DEPARTURE,function(a){d.userLeftRoom(a)});c.register(KonduitEvent.GUEST_COUNT,function(a){d.updateGuestCount(a)});c.register(KonduitEvent.DISPLAY_SHOUT_BOX,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayShoutBox(a)})});c.register(KonduitEvent.DISPLAY_INVITATION_BOX,
function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayInvitationBox(a)})});c.register(KonduitEvent.SEND_PRIVATE_MESSAGE,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.sendPrivateMessage(a)})});c.register(KonduitEvent.DISPLAY_FEED_POST_BOX,function(a){h.capturedSelectorWrapper(a,function(a){holodeck.displayFeedPostBox(a)})});c.register(KonduitEvent.HANDLE_ITEM_CHECKOUT_REQUEST,function(a){holodeck.recordAnalyticsEvent("Lightbox","Kred");var b=a.data.url;setTimeout(function(){h.isAuthenticated()?
top.lightbox.prototype.initializeKredItemPurchaseFrame(b):(h.activateInlineLogin({},!0),lightbox.prototype.addOnCloseCallback(function(){if(h.isAuthenticated())top.lightbox.prototype.initializeKredItemPurchaseFrame(b);else try{holodeck.konduit().dispatchEvent({type:"purchase_result",data:{success:!1}})}catch(a){}}))},0)});c.register(KonduitEvent.DISPLAY_REGISTRATION_LIGHTBOX,function(a){setTimeout(function(){lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+
h.gameId(),{afterStaticContentLoad:lightbox.prototype.toggleRegistration})},0)});c.register(KonduitEvent.DISPLAY_SIGN_IN_LIGHTBOX,function(a){setTimeout(function(){h.activateInlineLogin()},0)});c.register(KonduitEvent.RESIZE_GAME,function(a){var b=a.data["chat.resizeGame.width"],c=a.data["chat.resizeGame.height"];setTimeout(function(){holodeck.resizeGame(b,c)},0)});c.register(KonduitEvent.NEW_HIGH_SCORE,function(a){holodeck.showHighScoreAlert(a)});c.register(KonduitEvent.CUSTOM_TAB_SHOW,function(a){holodeck._chat_api_tab.setTabInfo(a);
holodeck.showChatApiTab()});c.register(KonduitEvent.CUSTOM_TAB_CLOSE,function(a){holodeck.closeChatApiTab()});c.register(KonduitEvent.CUSTOM_TAB_MESSAGE,function(a){holodeck._chat_api_tab.receivedMessage(a)});c.register(KonduitEvent.CUSTOM_TAB_CLEAR_MESSAGES,function(a){holodeck._chat_api_tab.clearMessages(a)});c.register(KonduitEvent.PROCESSING_SAVE_SHARED_CONTENT,function(a){holodeck.promptProcessingSaveSharedContent(a)});c.register(KonduitEvent.SAVE_SHARED_CONTENT,function(a){a.data.filename&&
holodeck.promptSaveSharedContent(a.data)});c.register(KonduitEvent.IMAGE_AVATAR_SUBMIT,function(a){holodeck.showAvatarTab(a.data.filename)});c.register(KonduitEvent.BROWSE_SHARED_CONTENT,function(a){holodeck.showSharedContentsIndex(a.data.content_type,a.data.sort_order,a.data.label)});c.register(KonduitEvent.PRIVATE_ROOM_INVITATION,function(a){holodeck.receivedPrivateRoomInvitation(a.data)});c.register(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,function(a){d.onPrivateRoomInvitationSent(a.data)});c.register(KonduitEvent.HOLODECK_DATA,
function(a){holodeck.handleHolodeckPacket(a.data)});c.register(KonduitEvent.HISTORY_RECEIVED,function(a){var b=holodeck.chatWindow().roomByType("guild");b&&(a.data.count<FayeHistoryService.MAX_MESSAGES?b.hideHistoryButton():b.showHistoryButton())});this._accomplishments=(a.achievements||[]).concat(a.challenges||[]);this._has_submitted_stats=this._authenticated_and_loaded_accomplishments=!1;this._statistics=a.statistics||[];this.setStatisticsAndAccomplishments(this._statistics,this._accomplishments);
this.initializeJavascriptApi()}var h=holodeck._active_user;h.occasionallyShowRegistrationLightbox.bind(h).runWhenReady();holodeck._tabs=new HolodeckTabs("main_tab_set",{afterChange:function(){if(holodeck._tabs){var a=holodeck._tabs.activeContainer;holodeck.checkChatScroll();holodeck.updateTabCookie(a);"chat_tab_pane"===a.id?holodeck.chatWindow().restoreDefaultView():"accomplishments_tab_pane"===a.id&&f&&holodeck.hideHighScores()}},beforeChange:function(a,b){if(!holodeck._tabs)return!1;var c=b.id;
if(0===b.children.length){var d=new Template($(c+"_template").innerHTML);b.insert(d.evaluate());document.fire(c+":loaded")}},defaultTab:void 0,holodeck:holodeck});var l=holodeck._chat_window;holodeck.addOnTabSelectCallback("chat_tab_pane",function(){l._seen||(l._seen=!0,l.joinRequestedRooms())});holodeck.addOnTabSelectCallback("more_games_tab_pane",function(){holodeck._seen_more_games_tab||holodeck.loadMoreGamesTab();holodeck._seen_more_games_tab=!0});holodeck._tabs.addOnCloseCallback("avatar_tab_pane",
function(){holodeck.cancelAvatar()});holodeck.authenticated()?$j("#shared_links_tab").show():h.addRunWhenAuthenticatedObserver(function(){$j("#shared_links_tab").show()});holodeck.authenticated()?(b=holodeck.getTabFromCookie(),holodeck._tab_from_cookie=b.gsub("_pane",""),holodeck._tabs.show(b)):page_data.autofill_username?($$("#new_session_form input[name='username']").first().value=page_data.autofill_username,holodeck._tabs.show(Holodeck.SIGNIN_TAB_NAME)):holodeck._tabs.show(Holodeck.SIGNUP_TAB_NAME);
holodeck.addOnTabLoadCallback("accomplishments_tab_pane",function(){$("accomplishment_vtab_set")?(holodeck.buildAccomplishmentVtabSet(),holodeck.authenticated()||$$(".accomplishment_signin").each(Element.show)):holodeck.loadHighScores();var a=$("accomplishment_awarded_tab");a&&a.down(".close_tab_link").observe("click",function(a){holodeck.recordAnalyticsEvent("Award","Close")})});this._active_user.addRunWhenAuthenticatedObserver(function(){h.hideRateThisGameTab()||(new UserActionCounter({username:h.username(),
counterName:"rate_this_game_closure_user_action_counter"})).count(function(a){setTimeout(!holodeck._in_beta&&!holodeck._in_preview?function(){holodeck.loadRateThisGameTab(a.count)}:function(){holodeck.showMoreGamesTab()},12E5)})});holodeck._shared_content_welcome_tab=new SharedContentWelcomeTab(a);holodeck._lightbox=lightbox.prototype;document.fire("chat_tabs:ready");a=parseInt(Cookie.get(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME)||0,10);Cookie.set(Holodeck.KONG_GAMEPLAYS_COOKIE_NAME,a+1,1E4,"/");this._konduit.setup({eventDispatcher:this._event_dispatcher,
chatHost:this._chat_host,chatProxyWebsocket:this._chat_proxy_websocket,chatProxyBosh:this._chat_proxy_bosh});this.ready=!0;document.fire("holodeck:ready")},initializeAccomplishmentTracker:function(a){this._accomplishment_tracker=new AccomplishmentTracker(Object.clone(a));this._accomplishment_notifications_node=$$(".accomplishment_notifications")[0];this._accomplishment_tracker.on("task-progress",function(a){var c=a.percentValue(),d=a.displayValue();a.isComplete();$$(".accomplishmenttasks-"+a.id()).each(function(e){if(a.isComplete()){e.addClassName("complete");
var f=e.down(".accomplishment_task_progress");f&&f.remove()}else(f=e.down(".progress_amount"))&&f.update(d);50<c&&(f=e.down(".marker"))&&f.addClassName("right");(f=e.down(".current"))&&f.update(d);(e=e.down(".bar"))&&e.setStyle({width:c+"%"})})});this._accomplishment_tracker.on("task-complete",function(a){(a=holodeck.accomplishmentTaskCompletionTemplate(a.id()))&&holodeck.showAccomplishmentCompletedTab(a.cloneNode(!0))});this._accomplishment_tracker.on("accomplishment-complete",function(a){holodeck.recordGuestCompletion(a);
var c=holodeck._tabs.activeContainer;holodeck.showAccomplishmentsTab();holodeck.setTab(c.id);a.hasCompletionTabBeenShown()||(holodeck.showAccomplishmentCompletionTab(a.id()),c=holodeck.accomplishmentCompletionTemplate(a.id()),c=a.isBadgeOfTheDay()?$("botd_award_title"):c.down(".reward_tasks h4"),CinematicMode.addCinematicMessage(c.innerHTML));holodeck.authenticated()&&a.hasCompleteAccomplishmentGroup()&&(holodeck.showAccomplishmentGroupCompletionTab(a.accomplishmentGroup().id()),c="Congratulations! You completed the '"+
a.accomplishmentGroup().name()+"' quest.",CinematicMode.addCinematicMessage(c));holodeck.updateAccomplishmentTab(a.id())})},initializeJavascriptApi:function(){this._api_service=new ApiService({event_dispatcher:this._event_dispatcher,statistics:this._accomplishment_tracker.statistics(),is_connected:function(){return holodeck.konduit().jabberConnected()}})},requestAnalyticsInfo:function(){this._event_dispatcher.fire({type:KonduitEvent.ANALYTICS_PAYLOAD,data:{}})},displayRoomOnFirstJoin:function(a){this._chat_window.roomByType(a.type)||
this.displayRoom(a)},handleHolodeckPacket:function(a){switch(a.holodeck_type){case "levelup":holodeck.showLevelUpTab(a);break;case "coupon_awarded":holodeck.showCouponAwardsTab(a);break;default:console.log("I do not understand this packet type captain.")}},showLevelUpTab:function(a){var b=new Template($("levelup_content_template").innerHTML);holodeck.showProgressTab(b.evaluate($H(a).merge({username:active_user.username()})));75==a.level&&($("hololevel_next_level_message").hide(),$("hololevel_max_level_message").show())},
addCouponTemplate:function(a,b){this._coupon_templates[a]=new Template(b)},showCouponAwardsTab:function(a){var b=a.coupon_promotion_id;if(void 0!==this._coupon_templates[b]){var c=$j("#coupon_promotion_"+b+"_award_content");$j(".js-coupon-promotion-award-content").hide();c.html(this._coupon_templates[b].evaluate(a));c.show();this._tabs.showOnTop("coupon_awards_tab_pane")}},displayRoom:function(a){this._chat_window._active_room||this._chat_window.showChatWindow();this.hideDefaultChatTabContent();this.hideSessionAlertContentInChatTab();
this.updateDefaultChatTabMessage("Connecting to chat");this._chat_window.joinedRoom(a)},rebootstrapChat:function(){this._chat_window.bootstrapChat(!0)},showAccomplishmentCompletionTab:function(a){var b=this._accomplishment_tracker.getAccomplishmentById(a);b&&!b.isHidden()&&(this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(a).cloneNode(!0)),this._currently_shown_award_tab="award",this._holodeck_event_analytics.recordEvent("TabView","Award"),b.setHasCompletionTabBeenShown(),
this.authenticated()&&!b.isBadgeOfTheDay()&&b.accomplishmentGroupProgressContent()?this.insertProgressContentInSuggestionNodes(b.accomplishmentGroupProgressContent()):(!b.isBadgeOfTheDay()||b.isBadgeOfTheDay()&&!this.authenticated())&&this.insertTemplateForNextActionSuggestion({".prize_name":b.prizeName()},this.suggestNextAction.bind(this)),this.getsGoogleADayUpsell(b)&&(a=$("google_a_day_award_tab_upsell_"+b.id()))&&a.show())},insertProgressContentInSuggestionNodes:function(a){this.suggestionLocationNodes().each(function(b){$j(b).html(a)})},
getsGoogleADayUpsell:function(a){var b=new Date;return Holodeck.GOOGLE_A_DAY_START_DATE<b&&Holodeck.GOOGLE_A_DAY_END_DATE>b&&!active_user.hasGoogleADayForToday()&&a.isAchievement()},showBadgeOfTheDayAwardTab:function(a){this.showAccomplishmentCompletedTab(this.accomplishmentCompletionTemplate(a).cloneNode(!0));$("won_both_badge_and_botd_content").hide();$("won_just_botd_content").show()},updateAccomplishmentTab:function(a){var b=this._accomplishment_tracker.accomplishmentForId(a);b&&b.isComplete()&&
($$(".achieved_image_"+a+"_for_award").each(function(a){a&&!a.visible()&&(a.previous().hide(),a.show())}),this.updateAccomplishmentPaneTitle())},updateAccomplishmentPaneTitle:function(){var a=$("accomplishments_pane_title"),b=a.down(".no_accomplishments_completed"),c=a.down(".some_accomplishments_completed"),a=a.down(".all_accomplishments_completed"),d=this._accomplishment_tracker,e=d.completeAccomplishments().length,d=d.accomplishments().length-d.hiddenAccomplishments().length;0===e?(a.hide(),c.hide(),
b.show()):d==e?(c.hide(),b.hide(),a.show()):(a.hide(),b.hide(),c.down(".earned_accomplishments_count").update(e),c.show())},insertTaskCompletedIntoChat:function(a){this.chatWindow().insert(holodeck.accomplishmentTaskCompletionTemplate(a).cloneNode(!0))},currentAwardTab:function(){var a=this._currently_shown_award_tab;this._currently_shown_award_tab=null;return a},showHighScoreAlert:function(a){if(this.shouldShowHighScoreAlert(a.data.value)){this._currently_shown_award_tab="high score";this._holodeck_event_analytics.recordEvent("TabView",
"HighScoreAlert");$("high_score_alert_username").update(active_user.username());var b=a.data.id,c=this._accomplishment_tracker.getStatisticById(b);a='<p class="high_score_number holodeck_kongbot_happy"><strong>'+a.data.value.toLocaleString()+"</strong> "+c.displayName()+"</p>";c=(new Element("a",{href:"#"})).update("view leaderboard &raquo;");c.observe("click",function(a){holodeck.showHighScores(b)});this._tabs.show("high_score_alert_tab_pane");this._tabs.container("high_score_alert_tab_pane").down(".high_score_summary").update(a).insert(c);
this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this))}},shouldShowHighScoreAlert:function(a){if(!a||this.isShowingAccomplishmentCompletedTab())return!1;a=Cookie.get(Holodeck.KONG_HS_ALERT_COOKIE_NAME);return this.hasNotSeenHighScoreRecently()&&!a?(Cookie.set(Holodeck.KONG_HS_ALERT_COOKIE_NAME,"hs_alert",void 0,this._game_path),!0):!1},hasNotSeenHighScoreRecently:function(){var a=Cookie.get(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME);if(a){if(a=new Date(a),(new Date).getTime()-
a.getTime()>Holodeck.HS_ALERT_WAIT_MILLISECONDS)return Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0}else return Cookie.set(Holodeck.KONG_HS_ALERT_TIME_COOKIE_NAME,new Date,void 0,"/"),!0;return!1},chatWindow:function(){return this._chat_window},setTab:function(a){this._suppress_setting_preference_cookie=!0;this._tabs.setActiveTab(a)},closeAlertTab:function(){this._tabs.close("alert_tab_pane")},showCloudSavesTab:function(a,b){var c;this.ready?(this._tabs.show("cloud_saves_tab_pane",
HolodeckTabs.Priority.CLOUD_SAVES),$$("#cloud_saves_tab_pane .js-cloud-save-mode").invoke("hide"),c=$$("#cloud_saves_tab_pane .js-cloud-saves-"+a).first(),b&&c.select(".js-cloud-saves-replace").each(function(a){var c=a.readAttribute("data-option-name");a.update(b[c])}),c.show()):document.observe("holodeck:ready",this.showCloudSavesTab.bind(this,a,b))},closeCloudSavesTab:function(){this._tabs.close("cloud_saves_tab_pane")},showAlertTab:function(){this._tabs.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},
showAccomplishmentsTab:function(){this.setTab("accomplishments_tab_pane")},showAvatarTab:function(a){if(a){this._custom_game_avatar=a;a=this.avatarUrlForFile(this._custom_game_avatar);var b=$("game_supplied_avatar_image_tag");this.setAvatarCropBoundaries({});this._custom_game_avatar&&b&&(startCropper=function(){var a=b.width,d=b.height,e,f,h,l;a==d?(e=0,f=a,h=0,l=d):a>d?(h=0,l=d,e=a/2-d/2,f=e+d):(e=0,f=a,h=d/2-a/2,l=h+a);e={x1:e,x2:f,y1:h,y2:l};40<a&&40<d&&(this.setAvatarCropBoundaries(e),this._avatar_cropper=
new Cropper.Img("game_supplied_avatar_image_tag",{displayOnInit:a==d?!1:!0,ratioDim:{x:1,y:1},minWidth:40,minHeight:40,onloadCoords:e,onEndCrop:function(a,b){holodeck.setAvatarCropBoundaries({x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2})}}))}.bind(this),b.onload=startCropper,b.src=a,this.prepareAvatarTab(),this._tabs.show("avatar_tab_pane"))}},prepareAvatarTab:function(){this.authenticated()&&($("avatar_controls_guest").hide(),$("avatar_controls").show());$("avatar_save_results").hide();$("avatar_update_spinner").hide();
$("game_avatar_accept_button").show();$("avatar_prompt_content").show()},avatarUrlForFile:function(a){return"https://"+active_user.singleCDNDomain()+"/assets/imported_images/"+a},saveAvatar:function(){var a="/accounts/"+this.username()+"/update_avatar.chat";$("game_avatar_accept_button").hide();$("avatar_update_spinner").show();new Ajax.Updater({success:"avatar_save_results"},a,{method:"post",parameters:$H(this.scaledAvatarCropBoundaries()).merge({filename:this._custom_game_avatar,game_id:this.gameId()}).toObject(),
onSuccess:function(){holodeck.avatarSuccess()},onFailure:function(){holodeck.notifyKonduitOfAvatarResults(!1)},onComplete:function(){$("avatar_prompt_content").hide();$("avatar_save_results").show()}})},setAvatarCropBoundaries:function(a){this._avatar_crop_boundaries=a},scaledAvatarCropBoundaries:function(){var a=this._avatar_crop_boundaries,b=a.x1,c=a.y1,d=a.x2,a=a.y2,e=this.avatarScaleRatios();if(void 0===b||void 0===d||void 0===c||void 0===a)return{};b=parseInt(b/e.wRatio,10);d=parseInt(d/e.wRatio,
10);c=parseInt(c/e.hRatio,10);a=parseInt(a/e.hRatio,10);return{x1:b,y1:c,x2:d,y2:a}},avatarScaleRatios:function(){var a,b,c,d,e;e=$("game_supplied_avatar_image_tag");a=e.getStyle("max-height");b=e.getStyle("max-width");e.setStyle({maxHeight:""});e.setStyle({maxWidth:""});c=e.height;d=e.width;e.setStyle({maxHeight:a});e.setStyle({maxWidth:b});return{hRatio:e.height/c,wRatio:e.width/d}},avatarSuccess:function(){this.notifyKonduitOfAvatarResults(!0);active_user.pullUserData()},cancelAvatar:function(){this.notifyKonduitOfAvatarResults(!1);
this.closeAvatarTab()},closeAvatarTab:function(){this._tabs.close("avatar_tab_pane")},notifyKonduitOfAvatarResults:function(a){holodeck._avatar_cropper&&holodeck._avatar_cropper.remove();holodeck.konduit().dispatchEvent({type:KonduitEvent.IMAGE_AVATAR_COMPLETE,data:{success:a}})},showShareTab:function(){this._holodeck_event_analytics.recordEvent("TabView","Share");this._tabs.showOnTop("share_tab_pane")},showAccomplishmentsOrMoreGamesTab:function(){$("accomplishments_tab_pane")?this.showAccomplishmentsTab():
this.showMoreGamesTab()},showAccomplishmentCompletedTab:function(a){$("more_games_tab_pane").hide();this._just_earned_badge=!0;this._tabs.showOnTop("accomplishment_awarded_tab_pane");this._tabs.container("accomplishment_awarded_tab_pane").down("#accomplishment_awarded_tab_pane_content").update(a)},showProgressTab:function(a){$("more_games_tab_pane").hide();this._just_earned_badge=!0;this._tabs.showOnTop("progress_tab_pane");this._tabs.container("progress_tab_pane").down("#progress_tab_pane_content").update(a)},
showDiscountTab:function(a){this._tabs.showOnTop("cart_discount_tab_pane");this._tabs.container("cart_discount_tab_pane").down("#accomplishment_awarded_tab_pane_content");this.setTab("cart_discount_tab_pane");$j("#discount_purchase").on("click",function(){lightbox.prototype.initializeKredPurchase()});var b=setInterval(function(){var c=moment(a);if(c.isAfter(moment())){var d=c.diff(moment(),"hours"),e=c.subtract(d,"hours").diff(moment(),"minutes"),c=c.subtract(e,"minutes").diff(moment(),"seconds");
$j("#discount_hours_remaining").text(d);$j("#discount_minutes_remaining").text(e);$j("#discount_seconds_remaining").text(c)}else $j("#discount_countdown").hide(),$j("#discount_expiration").show(),clearInterval(b)},1E3)},closeDiscountTab:function(){this._tabs.close("cart_discount_tab_pane")},showMoreGamesTab:function(){this.setTab("more_games_tab_pane")},loadMoreGamesTab:function(){holodeck._more_game_tab_page=1;new Ajax.Updater({success:"more_games_tab_pane"},"/recommended_games/show_more_tab",{parameters:{game_id:this.gameId()},
method:"get"})},moreGamesNextPage:function(){new Ajax.Request("/recommended_games/show_more_tab",{parameters:{game_id:this.gameId(),page:this._more_game_tab_page+1},method:"get",onSuccess:function(a){holodeck._more_game_tab_page+=1;$$(".more_games_load_btn")[0].insert({before:a.responseText});48>4*holodeck._more_game_tab_page?$("load_more_games_button").restore():($("load_more_games_button").hide(),$$(".more_games_load_btn").each(Element.hide))}})},showChatApiTab:function(){this._tabs.show("chat_api_pane")},
closeChatApiTab:function(){this._tabs.close("chat_api_pane")},showSharedContentWelcomeTab:function(){this._tabs.show("shared_content_welcome_tab_pane")},isShowingAccomplishmentCompletedTab:function(){return $("accomplishment_awarded_tab_pane").visible()},highlightContent:function(a){var b=$(a);b&&(b.addClassName("highlighted"),setTimeout(function(){b.removeClassName("highlighted")},3E3))},revealContent:function(a,b,c){var d=$(a);b=$(b);var e;if(d&&b&&(e=b.panel))this.setTab(a),e.open(),e.scrollTab(d),
this.highlightContent(c);return!1},revealFullInstructions:function(){this._tabs.show("game_tab_pane");this.recordAnalyticsEvent("Quick","Instructions");this.revealContent("game_tab_pane","game_instructions_panel","game_instructions");var a=$("game_instructions");if(a){var b=a.down(".truncated_text"),a=a.down(".full_text");b&&(a&&b.visible())&&(b.hide(),a.show())}},hideDefaultChatTabContent:function(){$("chat_default_content").hide()},showDefaultChatTabContent:function(){$("chat_default_content").show()},
showDisconnectedAlert:function(){this._holodeck_event_analytics.recordEvent("TabView","Disconnect");this.showDefaultChatTabContent();this._tabs.showAlert("disconnected_alert")},showSessionAlert:function(){this.showSessionAlertContentInChatTab();this._holodeck_event_analytics.recordEvent("TabView","SessionAlert");this._tabs.showAlert("session_conflict_alert")},showSessionExpiredAlert:function(){this.showSessionAlertContentInChatTab();this._tabs.showAlert("session_expired_alert")},showCannotConnectAlert:function(){this._has_shown_cannot_connect_alert||
this._holodeck_event_analytics.recordEvent("TabView","CannotConnect");this._tabs.showAlert("cannot_connect_alert");this._has_shown_cannot_connect_alert=!0},updateTabCookie:function(a){this.authenticated()&&!a.closeable&&(this._suppress_setting_preference_cookie?this._suppress_setting_preference_cookie=!1:Cookie.get("holodeck_tab_override")!=a.id&&Cookie.set(Holodeck.HOLODECK_TAB_COOKIE_NAME,this.makeCookieValue(a.id),12,"/"))},getTabsFromCookie:function(){var a=Cookie.get("kong_opened_panel"),b=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME),
c=Cookie.get("holodeck_tab_override"),d=this;return c?[c]:a?(Cookie.erase("kong_opened_panel"),["game_tab_pane"]):b&&(a=b.split("|").select(function(a){return(a=d._tabs.tab(d._tabs.linkForKey(a)))&&a.visible()}),0<a.length)?a:["chat_tab_pane"]},getTabFromCookie:function(){return this.getTabsFromCookie()[0]},makeCookieValue:function(a){var b=Cookie.get(Holodeck.HOLODECK_TAB_COOKIE_NAME);return b?(b=b.split("|").select(function(b){return b!=a}),b.unshift(a),b.join("|")):a},registerKonduitCallback:function(a,
b){this._event_dispatcher.register(a,b)},konduit:function(){return this._konduit},konduitEvent:function(a){a=Base64.decode(a).evalJSON(!0);this._event_dispatcher.fire(a)},getGameRoomCookie:function(){var a=Cookie.get(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId());if(a)return a.evalJSON()},setGameRoomCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_GAME_ROOM_COOKIE_PREFIX+this.gameId(),a,7,this._game_path)},getGuildRoomForCurrentGameCookie:function(){if(this.authenticated()){var a=
Cookie.get(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId());if(a)return a.evalJSON()}else this.setGuildRoomForCurrentGameCookie()},setGuildRoomForCurrentGameCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_GUILD_ROOM_FOR_CURRENT_GAME_COOKIE_PREFIX+this.gameId(),a,7,this._game_path)},getSitewideGuildRoomCookie:function(){if(this.authenticated()){var a=Cookie.get(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE);if(a)return a.evalJSON()}else this.setSitewideGuildRoomCookie()},
setSitewideGuildRoomCookie:function(a){a=Object.toJSON(a);Cookie.set(Holodeck.LAST_SITEWIDE_GUILD_ROOM_COOKIE,a,void 0,"/")},deletePrivateRoomCookie:function(){$.jStorage.deleteKey(Holodeck.LAST_PRIVATE_ROOM_KEY)},initializeChatWindow:function(a){a.gameRoomEnabled&&(a.previousGameRoom=this.getGameRoomCookie(),a.gameRoomJoin=Holodeck.GAME_ROOM_JOIN);if(!page_data.opted_out_of_guilds){var b=this.getGuildRoomForCurrentGameCookie();b&&(a.previousGuildChatRoomForCurrentGameCallback=this.setGuildRoomForCurrentGameCookie.bind(this),
a.previousGuildChatRoomForCurrentGame=b);if(b=this.getSitewideGuildRoomCookie())a.previousSitewideGuildChatRoomCallback=this.setSitewideGuildRoomCookie.bind(this),a.previousSitewideGuildChatRoom=b}if(b=$.jStorage.get(Holodeck.LAST_PRIVATE_ROOM_KEY))a.previousPrivateRoomCallback=this.deletePrivateRoomCookie.bind(this),a.previousPrivateRoom=b;this._chat_window.setRooms(a)},joinRoom:function(a){this._chat_window.joinRoom(a)},addChatCommand:function(a,b){this._chat_commands[a]||(this._chat_commands[a]=
[]);this._chat_commands[a].push(b)},processChatCommand:function(a){var b=((a.match(/^\/([^\s]+)/)||[])[1]||"").toLowerCase();if(this._chat_commands[b]){var c=this;return void 0===this._chat_commands[b].detect(function(b){return!1===b(c,a)})}return!0},sendWhisper:function(a,b){var c=b.match(/^\/([^\s]+)\s+([^\s]+)\s+([\s\S]+)/)||[],d=c[2],c=c[3],e=a.chatWindow(),f=a.activeDialogue();d&&c&&(f?f.sendPrivateMessage(d,c):e.sendPrivateMessage(d,c));return!1},setPresenceAway:function(a){a==holodeck&&(a=
null);this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.AWAY,room_name:a}});return!1},setPresenceChat:function(a){a==holodeck&&(a=null);this.konduit().dispatchEvent({type:KonduitEvent.SET_PRESENCE,data:{presence:KonduitPresenceType.CHAT,room_name:a}});return!1},setStatisticsAndAccomplishments:function(a,b){this._accomplishment_tracker.setStatistics(a);this._accomplishment_tracker.setAccomplishments(b)},setAccomplishmentsProgress:function(a){a&&(this._accomplishment_tracker.setAccomplishmentsProgress(a),
this.updateAccomplishmentPaneTitle(),this.insertTemplateForNextActionSuggestion({},this.suggestNextAction.bind(this)),this.konduit().dispatchEvent({type:KonduitEvent.SET_ACCOMPLISHMENT_PROGRESS,data:a}))},addFriends:function(a){this._chat_window.addFriends(a)},addMutings:function(a){this._chat_window.addMutings(a)},addFavoriteRooms:function(a){this._chat_window.addFavoriteRooms(a)},roomGroups:function(a){this._chat_window.roomGroups(a)},redoRoomList:function(){this._chat_window.redoRoomList()},addChatNags:function(a){this._chat_nag=
new ChatNag(this._chat_window,a)},switchUser:function(a,b,c,d,e,f){this._active_user.updateAttributes({chat_username:a,chat_password:b,special_chat_vars:c.extra_vars});this._active_user.updateGameAttributes({game_auth_token:d,user_vars:c.user_vars,user_vars_sig:c.user_vars_sig});this._suppress_disconnect=f;this.chatWindow().onLogout();this.konduit().dispatchEvent({type:KonduitEvent.SWITCH_USER,data:{username:a,user_id:e,slk:b,variables:c,game_auth_token:d}});this.requestAnalyticsInfo()},isGuestUsername:function(a){return/^Guest/i.match(a)},
setUsername:function(a){var b=this.isGuestUsername(this._username);if(!1===this._has_logged_in||a!=this._username)if(this._username=a,!this.isGuestUsername(a))this.onAuthenticated(b)},username:function(){return!this._active_user?"Guest":this._active_user.username()},onAuthenticated:function(a){a=a&&this._has_submitted_stats;this.updateUsernameIndicator();this.loadAccomplishments(a);this.hideNextActionSuggestion()},hasAccomplishments:function(){return 0<this._accomplishments.length},updateUsernameIndicator:function(){var a=
$$(".user_connection .logged_in_user")[0];a.down(".logged_in_user_username").update(this.username());a.show()},authenticated:function(){return this._active_user&&this._active_user.isAuthenticated()},gameId:function(){return this._game_id},addFriend:function(a){this._chat_window.addFriends([a])},removeFriend:function(a){this._chat_window.removeFriends([a])},addMuting:function(a){this._chat_window.addMutings([a]);this._chat_window.updateRolloverMutingLink(a)},removeMuting:function(a){this._chat_window.removeMutings([a]);
this._chat_window.updateRolloverMutingLink(a)},alertLog:function(){return this.konduit().alertLog()},insertPrivateMessagePrefixFor:function(a){this._chat_window.insertPrivateMessagePrefixFor(a)},selectRoom:function(a){a.premium_only&&!active_user.isPremium()?lightbox.prototype.initializePremiumMembershipPurchase("premium_only_chatroom","chat_features_tab"):(holodeck._chat_window._online_friends.deactivate(),this.joinRoom(a))},loadFriendsPage:function(a){this._chat_window.loadFriendsPage(a)},loadAccomplishments:function(a){var b=
this._on_loaded_accomplishments_callbacks,c=function(){for(;b;)b.pop()()};!this._authenticated_and_loaded_accomplishments&&(this.hasAccomplishments()&&this.authenticated())&&(a||(this._authenticated_and_loaded_accomplishments=!0),new Ajax.Request(this._accomplishments_bootstrap_url,{method:"get",onComplete:c}))},addKongpanionInfoToBotdTab:function(){$j(".kongpanion_botd_award_name").text(active_user.kongpanionInfo().name);$j(".kongpanion_botd_award_link").attr("href","/accounts/"+active_user.username()+
"/kongpanions");var a=$j("<img />");0===active_user.botdsThisWeek()?(a.attr("src",active_user.kongpanionInfo().normal_url),$j("#kongpanion_botd_award_icon_normal_target").append(a),$j("#kongpanion_botd_award_content_normal").show()):active_user.botdsThisWeek()==active_user.shinyThreshold()-1&&(a.attr("src",active_user.kongpanionInfo().shiny_url),$j("#kongpanion_botd_award_icon_shiny_target").append(a),$j("#kongpanion_botd_award_content_shiny").show());$j("#award_tab_botd_info").show()},prepareBadgeOfTheDayAwardTab:function(a){active_user.kongpanionInfo()&&
(0===active_user.botdsThisWeek()||active_user.botdsThisWeek()==active_user.shinyThreshold()-1)?this.addKongpanionInfoToBotdTab():this.authenticated()&&$("award_tab_botd_check_tomorrow_content")&&($("award_tab_botd_check_tomorrow_content").show(),$("award_tab_botd_info").show())},prioritizeBadgeOfTheDay:function(a){if(a=this._accomplishment_tracker.accomplishmentForId(a))a._level="badge_of_the_day"},addOnLoadedAccomplishmentsCallback:function(a){this._on_loaded_accomplishments_callbacks.push(a)},tabbifyAccomplishments:function(){var a=
this;(function(){a.showAccomplishmentTab(a.nextAccomplishment())}).defer();this.buildAccomplishmentVtabSet()},buildAccomplishmentVtabSet:function(){this._accomplishment_vtab_set=new HolodeckTabs("accomplishment_vtab_set",{tabSelector:".vtab"})},loadScoresPage:function(a,b,c){this._high_scores.getHighScores(a,b,c)},loadHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this));this._high_scores.getHighScores()},showHighScores:function(a){this._tabs.show("accomplishments_tab_pane");
this._high_scores||(this._high_scores=new HighScores(this));this._high_scores.activate(a)},hideHighScores:function(){this._high_scores||(this._high_scores=new HighScores(this));this._high_scores.deactivate()},registerAccomplishmentCompletionCallback:function(a,b){this._accomplishment_tracker.registerAccomplishmentCompletionCallback(a,b)},registerAccomplishmentProgressCallback:function(a,b,c,d){this._accomplishment_tracker.registerAccomplishmentProgressCallback(a,b,c,d)},accomplishmentTemplates:function(){return this._accomplishment_notifications_node},
accomplishmentCompletionTemplate:function(a){return this.accomplishmentTemplates().down(".accomplishment_"+a).down(".accomplishment_completed")},accomplishmentTaskCompletionTemplate:function(a){if(a=$("completed_accomplishment_task_"+a))return a.down(".task_completed")},accomplishmentSuggestionTemplate:function(a){return this.accomplishmentTemplates().down(".accomplishment_"+a).down(".accomplishment_suggested")},accomplishmentFromOtherGameSuggestionTemplate:function(){var a=this.accomplishmentTemplates().down("#suggestibles").select(".suggestible");
return a[parseInt(Math.random()*a.length,10)]},claimAwardTemplate:function(){return this.accomplishmentTemplates().down(".claim_award_box")},showDisconnectedIndicator:function(){this._chat_connected_indicator_node.hide();this._chat_limited_connection_indicator_node.hide();this._chat_disconnected_indicator_node.show()},showConnectedIndicator:function(){this._chat_disconnected_indicator_node.hide();this._chat_limited_connection_indicator_node.hide();this._chat_connected_indicator_node.show()},showLimitedConnectionIndicator:function(){this._chat_disconnected_indicator_node.hide();
this._chat_connected_indicator_node.hide();this._chat_limited_connection_indicator_node.show()},showCloudSavesIndicator:function(a){var b=this,c=function(){b._chat_connected_indicator_node.addClassName("cloud-mode");if("sync"===a){var c=$j("#cloud_sync_indicator");c.tooltip({content:function(){return $j("#cloud_save_info_template").html()},position:{my:"right+21 top+10",at:"bottom"}});var e=JSON.parse(Cookie.get("cloud_saves_game_ids_"+active_user.id()))||[];0>e.indexOf(active_user.gameId())&&(c.tooltip("open"),
setTimeout(function(){c.tooltip("close")},1E4),e.push(active_user.gameId()),Cookie.set("cloud_saves_game_ids_"+active_user.id(),JSON.stringify(e)))}};$$(".js-cloud-indicator").invoke("hide");$("cloud_"+a+"_indicator").show();this.ready?c():document.observe("holodeck:ready",function(){c()}.bind(this))},reconnect:function(){this.konduit().dispatchEvent({type:KonduitEvent.CONNECT})},setupBanAndSilencingControls:function(){this._chat_window.setupBanAndSilencingControls()},hideNextActionSuggestion:function(){var a=
$("accomplishment_awarded_tab_pane").down(".suggestion_placeholder");a&&a.update("")},suggestionLocationNodes:function(){return[$("accomplishment_awarded_tab_pane"),$("high_score_alert_tab_pane")].compact().map(function(a){return a.down(".suggestion_placeholder")}).compact()},suggestNextAction:function(a){this.suggestionLocationNodes().each(function(b){a.insertAt(b)})},setAccomplishmentGroupSuggestions:function(a){var b=this;a.each(function(a){var d=a[1];b._accomplishment_tracker.getAccomplishmentById(a[0]).setAccomplishmentGroupProgressContent(d)})},
showAccomplishmentGroupCompletionTab:function(a){if(a=$("accomplishment_group_completion_tab_content_"+a))this._accomplishment_group_award_tab_node.update(a.innerHTML),this._active_user.populateUserSpecificLinks(this._accomplishment_group_award_tab_node),this._tabs.showOnTop("accomplishment_group_awarded_tab_pane")},notifyOnGameTab:function(a){this._tabs.showOnTop("game_tab_pane");$("game_tab_pane").scrollTop=0;$("rating_message").update(a);$("rating_message").addClassName("highlighted")},insertTemplateForNextActionSuggestion:function(a,
b){var c;c=this.authenticated()?(c=this.nextAccomplishment())?this.accomplishmentSuggestionTemplate(c.id()):this.accomplishmentFromOtherGameSuggestionTemplate():this.claimAwardTemplate();b(new SuggestionTemplate(c,a))},nextAccomplishment:function(){return this._accomplishment_tracker.nextAccomplishment()},showMiniProfile:function(a){this.showChatTab();this._chat_window.showProfile(a)},updateDefaultChatNag:function(a){this._chat_nag&&this._chat_nag.updateDefaultNag(a)},showChatTab:function(){this._tabs.show("chat_tab_pane")},
showAccomplishmentTab:function(a){a&&this._accomplishment_vtab_set.show(a.domId())},setSilenceScheduledEnd:function(a){this._chat_window.updateSilenceScheduledEnd(a)},isChatModerator:function(){return active_user.isChatModerator()},activeDialogue:function(){return this._active_dialogue},receivedPrivateMessage:function(a){var b=this._active_dialogue;b&&b.receivedPrivateMessage(a)},sendPrivateRoomInvitation:function(a){this.premiumUserOnly(function(){holodeck._users_invited[a]=!0;holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_INVITATION,
data:{username:a}})},"chat_features_tab")},receivedPrivateRoomInvitation:function(a){this._ignored_invitations[a.username]||this._chat_window.receivedPrivateRoomInvitation(a)},hasActiveShoutCall:function(){return!!this._currentRequestId},sendPrivateMessage:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");new Ajax.Request("/api/shout.json",{method:"post",parameters:{game_id:active_user.gameId(),game_message:b,from_game:!0,"shout[private]":!0,
game_auth_token:active_user.gameAuthToken(),username:active_user.username()},onSuccess:function(a){holodeck.invokeShoutCallback({message_type:"private",success:a.responseJSON.success,error:a.responseJSON.error})}})},displayShoutBox:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");setTimeout(function(){lightbox.prototype.initializeShoutFrame(holodeck.gameId(),b)},0)},displayInvitationBox:function(a){var b=a.data.invitation_message;
this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");var c=a.data.filter;void 0===c&&(c="");lightbox.prototype.initializeInvitationFrame(holodeck.gameId(),b,c,a.data.kv_params)},displayFeedPostBox:function(a){var b=a.data.shout_message;this._currentRequestId=a.data[KonduitEvent.PARAM_REQUEST_ID];void 0===b&&(b="");var c=a.data.image_uri;void 0===c&&(c="");var d=a.data.kv_params;void 0===d&&(d={});setTimeout(function(){var a=function(){active_user.shoutForGame(active_user.gameId(),
function(a){if(a){a={game_id:holodeck.gameId(),image_uri:c,game_auth_token:active_user.gameAuthToken(),game_message:b,from_game:!0,username:active_user.username()};var e={};$H(d).each(function(a){e["shout_api_params["+a[0]+"]"]=a[1]});new Ajax.Request("/api/shout.json",{method:"post",parameters:$H(a).merge(e),onSuccess:function(a){holodeck.invokeShoutCallback({message_type:"feed",success:a.responseJSON.success,error:a.responseJSON.error})}})}else lightbox.prototype.initializeFeedPostFrame(holodeck.gameId(),
b,c,d)})};active_user.isAuthenticated()?a():(lightbox.prototype.addOnCloseCallback(function(){active_user.isAuthenticated()&&a()}),lightbox.prototype.initializeKongregateLightboxFromAjax("/accounts/new/behind_login?game_id="+holodeck.gameId(),{done_class_name:"lightbox_login"}))},0)},invokeShoutCallback:function(a){var b={};b[KonduitEvent.PARAM_REQUEST_ID]=this._currentRequestId;b[KonduitEvent.PARAM_MESSAGE_TYPE]=a.message_type;b[KonduitEvent.PARAM_MESSAGE_RECIPIENTS]=a.recipients;b[KonduitEvent.PARAM_SUCCESS]=
a.success;b[KonduitEvent.PARAM_ERROR]=a.error;this._currentRequestId=null;holodeck.konduit().dispatchEvent({type:KonduitEvent.OP_SHOUT_CALLBACK,data:b})},invokeShoutDialogClosedCallback:function(a){holodeck.hasActiveShoutCall()&&holodeck.invokeShoutCallback({message_type:a,success:!1,error:"User closed dialog"})},destroyPrivateRoom:function(){holodeck._users_invited={};holodeck.konduit().dispatchEvent({type:KonduitEvent.DESTROY_PRIVATE_ROOM,data:{}})},leaveRoom:function(a){holodeck.konduit().dispatchEvent({type:KonduitEvent.LEAVE_ROOM,
data:{room_type:a}})},leavePrivateRoom:function(){this.leaveRoom("private")},leaveGuildRoom:function(){this.leaveRoom("guild")},invitationIgnoredBy:function(a){this._ignored_invitations[a]=!0},privateRoomKick:function(a){holodeck.konduit().dispatchEvent({type:KonduitEvent.PRIVATE_ROOM_KICK,data:{username:a}})},hasInvited:function(a){return this._users_invited[a]},premiumUserOnly:function(a,b){active_user.isPremium()?a():lightbox.prototype.initializePremiumMembershipPurchase("private_chat",b)},height:function(){return this._html_dimensions.game_frame_height},
checkChatScroll:function(){this._tabs&&"chat_tab_pane"==this._tabs.activeContainer.id&&this._chat_window.scrollToBottom()},recordAnalyticsEvent:function(a,b,c){this._holodeck_event_analytics.recordEvent(a,b,c)},recordMappedEventAnalytic:function(a){this._holodeck_event_analytics.recordMappedEventAnalytic(a)},setMetricTracker:function(a){this._holodeck_event_analytics.setMetricTracker(a)},startWatchingStats:function(){this._accomplishment_tracker.startWatchingStats()},scheduleRender:function(a){this._queued_renders||
(this._queued_renders=[]);this._queued_renders.push(a);if(!this._queued_render_worker){var b=this;this._queued_render_worker=setTimeout(function(){b.processRenderQueue()},this._interval_between_renders)}},processRenderQueue:function(){var a=this._queued_renders.shift();if(this._queued_renders.length){var b=this;this._queued_render_worker=setTimeout(function(){b.processRenderQueue()},this._interval_between_renders)}else this._queued_render_worker=null;a&&a()},showSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").show();
$j("#chat_window").css({opacity:0})},hideSessionAlertContentInChatTab:function(){$("session_conflict_content_for_chat_tab").hide();$j("#chat_window").css({opacity:"inherit"})},updateDefaultChatTabMessage:function(a){$("chat_default_content").down("p").update(a)},submitGameBug:function(a,b){var c=$H(b).merge({method:"post",parameters:{type:"GameBugReport","feedback[game_bug_content]":a,"feedback[game_id]":this.gameId(),"alert[log]":JSON.stringify(this.alertLog())}}).toObject();new Ajax.Request("/feedbacks",
c);this.recordAnalyticsEvent("Game","Bug")},showSignupTab:function(){this.authenticated()||(this._tabs.showOnTop("signup_tab_pane"),new Effect.Highlight("signup_tab_pane",{startcolor:"#ffff99",endcolor:"#dddddd",restorecolor:"#dddddd"}))},closeSignupTab:function(a){this._tabs.closeSignupTab(a)},closeSigninTab:function(a){this._tabs.closeSigninTab(a)},addSignupTabOnCloseCallback:function(a){this._tabs.addOnCloseCallback("signup_tab_pane",a)},isShowingSignupTab:function(){return $("signup_tab_pane").visible()},
_purgeTabCookies:function(){Cookie.erase("kong_opened_panel");Cookie.erase(Holodeck.HOLODECK_TAB_COOKIE_NAME);Cookie.erase("holodeck_tab_override")},loadCollaborators:function(){new Ajax.Request(this._game_path+"/collaborations.js",{method:"get",onSuccess:function(a){var b=$("collaborators_placeholder");b&&b.update(a.responseText)}})},sharedContentData:function(){if(this._shared_content_data)return this._shared_content_data.content},promptSaveSharedContent:function(a){this._permissions.save_shared_content?
this.authenticated()?(this._shared_content_data=a,a=Object.extend({},a),delete a.content,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+"/shared_contents/new?"+Object.toQueryString(a),"kred_purchase")):(this._shared_content_data=a,this._lightbox.wait_for_shutdown=!0,this._lightbox.reloadInfoFromUrl(this._login_url,"kred_purchase lightbox_login")):this.alertSharedContentSavingNotPermitted(a.contentType)},redoPromptSavedSharedContent:function(){this._shared_content_data&&(this._lightbox.wait_for_shutdown=
!1,this._lightbox.reloadInfoFromUrl(this._active_user.gameResourcePath()+"/shared_contents/new?"+Object.toQueryString(this._shared_content_data),"kred_purchase"))},promptProcessingSaveSharedContent:function(a){var b=this;this._lightbox.addOnCloseCallback(function(){b.saveSharedContentFailed()});this._lightbox.initializeKongregateLightboxFromContent('<p class="shared_content_loading_message">Processing Thumbnail (<a href="#" onclick="holodeck.closeLightbox();return false;">cancel</a>)</p>',{afterStaticContentLoad:function(){$("kongregate_lightbox_spinner").show()}})},
saveSharedContentFailed:function(){this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,data:{success:!1}});this._lightbox.deactivate()},saveSharedContentSuccessful:function(a){this._lightbox.clearOnCloseCallbacks();this.konduit().dispatchEvent({type:KonduitEvent.SAVE_SHARED_CONTENT_COMPLETE,data:{success:!0,content:a.content,name:a.name,permalink:a.permalink,id:a.id,label:a.label}});a.externally_submitted?this.loadSharedContentWithoutClosingLightbox(a):this.showSharedContent(a.tab_link,
a.tab_contents_url)},loadSharedContentWithoutClosingLightbox:function(a){var b=this;this._last_loaded_shared_content_id&&this._last_loaded_shared_content_id==a.id||(this._shared_content_timer&&clearTimeout(this._shared_content_timer),this._last_loaded_shared_content_id=a.id,this._shared_content_timer=setTimeout(function(){b._last_loaded_shared_content_id=null},5E3),this.konduit().dispatchEvent({type:KonduitEvent.LOAD_SHARED_CONTENT,data:{contentType:a.contentType,content:a.content,name:a.name,permalink:a.permalink,
id:a.id,label:a.label}}),this.showSharedContent(a.tab_link,a.tab_contents_url))},loadSharedContent:function(a){this.closeLightbox();this.loadSharedContentWithoutClosingLightbox(a)},loadSharedContentFromUrl:function(){var a=this,b=document.location.search.parseQuery(),c=this._shared_content_type_permalinks.find(function(a){return b[a]});c&&new Ajax.Request(this._active_user.gameResourcePath()+"/shared_contents/"+b[c]+".json",{method:"get",onSuccess:function(b){b=b.responseText.evalJSON();a.loadSharedContent(b)}})},
alertSharedContentSavingNotPermitted:function(a){alert(a+" saving is not permitted for this game.")},saveSharedContentFromUrl:function(){if(!this._shared_content_saved_from_url){this._shared_content_saved_from_url=!0;var a=document.location.search.parseQuery();a.type&&(this._permissions.save_shared_content?this._permissions.save_external_shared_content?!this._shared_content_type_names.include(a.type.toLowerCase())||!a.content||!/&z$/.match(document.location.href)?alert("This "+a.type+" could not be saved."):
this.promptSaveSharedContent({contentType:a.type,label:a.label,content:a.content,fromUrl:!0}):alert(a.type+" saving is only enabled on Kongregate.com."):this.alertSharedContentSavingNotPermitted(a.type))}},showSharedContent:function(a,b){var c=a+"_pane",d=c+"_spinner",e=$("shared_content_tab_content"),f=$(d);f&&f.show();e&&e.remove();this._tabs.ajaxUpdateTab(c,b,function(){f&&f.hide();(e=$("shared_content_tab_content"))&&e.select(".collapsible_panel").each(function(a){new CollapsiblePanel(a)})});
this._tabs.show(c);Element.scrollTo("maingame")},showSharedContentsIndex:function(a,b,c){this._permissions.save_shared_content&&(a=this._active_user.gameResourcePath()+"/shared/"+encodeURIComponent(a)+(b?"?"+Object.toQueryString({sort:b,label:c}):""),!this.authenticated()&&b&&this._authenticated_only_shared_content_sorts.include(b.toLowerCase())?(this._show_shared_contents_index_url=a,this._lightbox.wait_for_shutdown=!0,this.showLightbox(this._login_url)):this.showLightbox(a))},redoShowSharedContentsIndex:function(){this._show_shared_contents_index_url&&
this._lightbox.reloadInfoFromUrlFromUrl(this._show_shared_contents_index_url)},updateSharedContentsIndex:function(a){new Ajax.Updater({success:"lightbox_form"},a,{asynchronous:!0,evalScripts:!0,method:"get",onLoading:function(a){Element.show("shared_content_sorting_indicator")}})},showLightbox:function(a){this._lightbox.initializeKongregateLightboxFromAjax(a)},closeLightbox:function(){this._lightbox&&this._lightbox.deactivate()},recordGuestCompletion:function(a){this.authenticated()||this._accomplishment_tracker.recordGuestAccomplishment(a)},
loadAdminControls:function(){this._active_user.isAdmin()&&new Ajax.Updater({success:"admin_control_container"},this._active_user.gameResourcePath()+"/admin_controls",{method:"get"})},loadDeveloperControls:function(){active_user.animationThrowdownSteam()||this._active_user.isDeveloperOfGame()&&!this._active_user.isAdmin()&&new Ajax.Updater({success:"developer_control_container"},this._active_user.gameResourcePath()+"/developer_controls",{method:"get"})},loadDiscussions:function(){this._game_discussions.loadDiscussions()},
loadRateThisGameTab:function(a){var b=new UserActionCounter({username:this._active_user.username(),counterName:"rate_this_game_closure_user_action_counter"});!this.userRating()&&!$j(document.activeElement).hasClass("chat_input")&&($("rate_this_game_tab").show(),0>=this.userRating()&&$$(".rate_this_game_tab_unrated").invoke("show"),this._tabs.showOnTop("rate_this_game_tab_pane"),3<=a&&($j("#rate_this_game_tab_pane_content div#opt_out").show(),$j("#rate_this_game_tab_pane_content div#opt_out input#rate_game_opt_out").change(function(){var a=
"/accounts/"+holodeck._active_user.username()+"/user_preferences";$j(this).is(":checked")?$j.csrfPost({url:a,data:{preference:"hide_rate_this_game_tab"}}):$j.csrfDelete({url:a+"/1",data:{preference:"hide_rate_this_game_tab"}})})),$j(".rate_later_link").click(function(a){a.preventDefault();holodeck.closeRateThisGameTab();holodeck.trackRateThisGameTabClosure(b)}),$j("li.tab#rate_this_game_tab span.close_tab_link").click(function(){holodeck.trackRateThisGameTabClosure(b)}))},trackRateThisGameTabClosure:function(a){a.increment(function(){})},
closeRateThisGameTab:function(){this._tabs.close("rate_this_game_tab_pane")},hasSharedContent:function(){return this._shared_content_type_names&&this._shared_content_type_names.length},showPlayLaterLinks:function(){$("quicklinks_play_later_block").show();$("below_game_play_later_block").show()},addIncomingMessageFilter:function(a){this._incoming_message_filters.unshift(a)},filterIncomingMessage:function(a,b){this.filterMessage(a,this._incoming_message_filters,b)},addOutgoingMessageFilter:function(a){this._outgoing_message_filters.unshift(a)},
filterOutgoingMessage:function(a,b){this.filterMessage(a,this._outgoing_message_filters,b)},filterMessage:function(a,b,c){b.inject(c,function(a,b){return function(c){b(c,a)}})(a)},addMessageFilters:function(){if(this._active_user){var a=this._active_user.domain().gsub(".","\\."),b=RegExp("\\b((?:https?://)?www\\."+a+'(?:/[^\\s"]*)*\\b/?)',"i"),c=new Element("p");this.addIncomingMessageFilter(function(a,b){c.setText(a);b(c.innerHTML.gsub("\\\\","\\").gsub("<br>",""),b)});this.addIncomingMessageFilter(function(a,
c){c(a.gsub(b,function(a){return'<a href="'+(0===a[0].indexOf("http")?"":"http://")+a[0]+'" target="_blank">'+a[0]+"</a>"}),c)})}},resizeGame:function(a,b){function c(a,b,c,d){var s={};$A([e,g,h]).each(function(b){c.hasOwnProperty(b)&&(s[b]=a+c[b]+u)});$A([f,q,l]).each(function(a){c.hasOwnProperty(a)&&(s[a]=b+c[a]+u)});d.setStyle(s)}var d=this._html_dimensions;a=parseInt(a,10)||0;b=parseInt(b,10)||0;a<d.game_width&&(a=d.game_width);b<d.game_height&&(b=d.game_height);for(var d=[["#maingame",{width:d.divider_width+
d.chat_width,height:d.quicklinks_height}],["#maingamecontent",{width:d.divider_width+d.chat_width,height:d.quicklinks_height}],["#flashframecontent",{width:d.divider_width+d.chat_width,height:d.quicklinks_height}],["#gameholder",{width:0}],["#game",{width:0,height:0}],["#gameiframe",{width:0,height:0}],["#chat_container",{height:0}],[".game_avatar_image>img",{maxHeight:-d.avatar_image_gutter_height}],["#kong_game_ui>.tabpane",{height:-d.chat_pane_tab_height}]],e="width",f="height",h="maxWidth",l=
"maxHeight",g="minWidth",q="minHeight",u="px",s=d.length-1;0<=s;s--)$$(d[s][0]).each(c.curry(a,b,d[s][1]));CinematicMode.refreshCinematicLayout()},updateGameplay:function(a){this._gameplay_id=a},gameplay:function(){return this._gameplay_id},userRating:function(){return this._user_rating},addOnTabSelectCallback:function(a,b){this._tabs.addOnSelectCallback(a,b)},addOnTabLoadCallback:function(a,b){document.observe(a+":loaded",b);this._tabs.activeContainer.id===a&&b()},setupBelowFoldTabs:function(){$$(".game_tab_index").each(function(a){$(a).firstDescendant().addClassName("active")});
$$(".game_tab_group").each(function(a){$(a).firstDescendant().addClassName("active")});this._game_discussions.setupTabs();$(document).on("click",".game_tab_link",function(a){var b=$(a.target||a.srcElement),c=b.readAttribute("href").sub("#","");b.up().siblings().each(function(a){$(a).removeClassName("active")});b.up().addClassName("active");$(c).siblings().each(function(a){$(a).removeClassName("active")});$(c).addClassName("active");a.stop()})}};function CapturesToInlineRegistration(){}
CapturesToInlineRegistration.decorate=function(a){return active_user.capturedSelectorWrapper.bindAsEventListener(active_user,a)};HolodeckEventAnalytics=function(){this.initialize()};
HolodeckEventAnalytics.tab_mappings={chat_tab:["TabView","Chat"],game_tab:["TabView","Game"],accomplishments_tab:["TabView","Achievements"],more_games_tab:["TabView","MoreGames"],signup_tab:["TabView","Signup"],game_info_panel:["Game","InfoToggle"],game_description_panel:["Game","DescriptionToggle"],game_instructions_panel:["Game","InstructionsToggle"],game_shared_contents_panel:["Game","SharedContentToggle"],today_high_score_tab:["Achievements","ScoresToday"],weekly_high_score_tab:["Achievements",
"ScoresLast7"],all_time_high_score_tab:["Achievements","ScoresAllTime"],friends_high_score_tab:["Achievements","ScoresFriends"]};
HolodeckEventAnalytics.prototype={initialize:function(){var a=this;["chat_tab","game_tab","accomplishments_tab","more_games_tab","signup_tab"].each(function(b){var c=$(b);c&&c.observe("click",function(c){a.recordMappedEventAnalytic(b)})})},setMetricTracker:function(a){this._metric_tracker=a},recordEvent:function(a,b,c){if(this._metric_tracker){var d=this._metric_tracker;setTimeout(function(){d.trackEvent(a,b,c)},0)}},recordMappedEventAnalytic:function(a){(a=HolodeckEventAnalytics.tab_mappings[a])&&
this.recordEvent(a[0],a[1])}};
HolodeckTabs=Class.create(Control.Tabs,{initialize:function($super,b,c){c||(c={});this._closeableTabs={};this._preservableTabs={};this._closeableTabsStack=[];this._onCloseCallbacks={};this._onSelectCallbacks={};this._onChangeCallback=c.afterChange;this._tabSelector=c.tabSelector||".tab";c.hideFunction=this.hideContainer;c.showFunction=this.showContainer;c.afterChange=function(b){(b=this._onSelectCallbacks[b.id])&&b.each(function(b){b()});this._onChangeCallback&&this._onChangeCallback()};this._current_top_priority=
HolodeckTabs.Priority.ON_TOP;$super(b,c);this._holodeck=c.holodeck},addTab:function($super,b){var c=this,d=b.up(this._tabSelector),e=d.hasClassName("closeable"),f=d.hasClassName("preserve");$super(b);var h=this.containers.get(b.key);h.closeable=e;h.preservable=f;e&&(this._closeableTabs[b.key]=!0,(d=d.down(".close_tab_link"))&&d.observe("click",function(d){c.close(b);d.stop()}));f&&(this._preservableTabs[b.key]=!0)},keyForLink:function(a){var b;if(a||"undefined"!==typeof a)return b="string"==typeof a?
this.links.find(function(b){return b.key==a}).key:"number"==typeof a?this.links[a].key:a.key},linkForKey:function(a){return a.key?a:void 0===a.length?this.links[a]:"first"==a?this.links[0]:this.links.find(function(b){return b.key==a})},tab:function(a){var b=this.keyForLink(a);return(a=this.links.find(function(a){return a.key==b}))?a.up("li"):null},container:function(a){return this.containers.get(this.keyForLink(a))},addOnCloseCallback:function(a,b){var c=this._onCloseCallbacks[a]||[];c.push(b);this._onCloseCallbacks[a]=
c},addOnSelectCallback:function(a,b){var c=this._onSelectCallbacks[a]||[];c.push(b);this._onSelectCallbacks[a]=c;this.activeContainer.id==a&&b()},close:function(a,b){var c=this.linkForKey(a),d=this._onCloseCallbacks[c.key];if(this.isCloseable(c))return d&&(delete this._onCloseCallbacks[c.key],d.each(function(a){a(b)})),this._closeableTabsStack=this._closeableTabsStack.reject(function(a){return a==c}),this._closeableTabsStack.length&&(d=this._closeableTabsStack[this._closeableTabsStack.length-1],this.show(d,
d._priority)),this.hide(c),this.updateStackedTab(),!0},closeTab:function(a,b){$(a)&&this.close(a,b)},closeSignupTab:function(a){this.closeTab("signup_tab_pane",a)},closeSigninTab:function(a){this.closeTab("signin_tab_pane",a)},updateStackedTab:function(){(function(){this._closeableTabsStack.each(function(a){a.up("li").removeClassName("stacked")});1<this._closeableTabsStack.length&&this._closeableTabsStack[0].up("ul").down(".active").up("li").addClassName("stacked")}).bind(this).defer()},hide:function(a,
b){var c=this.tab(a),d=this.container(a);c.hide();d.hide();this.activeLink==a&&!b&&(c=this._holodeck.getTabFromCookie(),a.id.startsWith("signup")||c.startsWith("signup")?holodeck.showAccomplishmentsOrMoreGamesTab():this.show(c))},showOnTop:function(a){this.show(a,++this._current_top_priority)},show:function(a,b){var c=this.linkForKey(a),d=c;if(this.isCloseable(c)){for(var d=this._closeableTabsStack.reject(function(a){return a==c}),e=d.length-1;0<=e;e--)c!=d[e]&&this.hide(d[e],!0);c._priority=b||0;
d.push(c);this._closeableTabsStack=d.sortBy(function(a){return a._priority});d=this._closeableTabsStack[this._closeableTabsStack.length-1]}this.updateStackedTab();var e=this.tab(d),f=this.container(d);e&&f&&(e.show(),f.show(),this.setActiveTab(d))},isCloseable:function(a){return this._closeableTabs[this.keyForLink(a)]},ajaxUpdateTab:function(a,b,c,d){var e=this;new Ajax.Request(b,{method:"get",onSuccess:function(b){var h=e.container(a);d&&(h=h.down(d));h.update(b.responseText);c&&c()},onFailure:function(b){e.close(a)}})},
showAlert:function(a){this._alert_tab_pane_content||(this._alert_tab_pane_content=$("alert_tab_pane_content"));alert_div=$(a);this._alert_tab_pane_content.innerHTML=alert_div.innerHTML;a.startsWith("session_")&&($("session_conflict_content_for_chat_tab").innerHTML=alert_div.innerHTML);this.show("alert_tab_pane",HolodeckTabs.Priority.ERROR)},hideContainer:function(a){a.preservable?(a.setStyle({visibility:"hidden"}),a.select(".hideable").each(function(a){a.setStyle({visibility:"hidden"})})):a.hide()},
showContainer:function(a){a.preservable?(a.setStyle({visibility:"visible"}),a.select(".hideable").each(function(a){a.setStyle({visibility:"visible"})})):a.show()}});HolodeckTabs.Priority={ERROR:1,ON_TOP:2,CLOUD_SAVES:100};IntervalManager=function(a,b,c){this.initialize(a,b,c)};
IntervalManager.prototype={initialize:function(a,b,c){this._func=a;this._interval=b;this._deadline=c},start:function(a){this._timeout||(a&&this._func(),this._createTimeout())},stop:function(){clearTimeout(this._timeout);this._timeout=null},_createTimeout:function(){var a=this,b;this._deadline&&(b=Date.now()+a._deadline);this._timeout=setTimeout(function(){(!b||Date.now()<b)&&a._func();a._createTimeout()},this._interval)}};function JabberChatRoom(a){this.initialize(a)}JabberChatRoom.TIME_FORMAT="YYYYMMDDTHH:mm:ss";
JabberChatRoom.USER_VAR_KEYS="username type level chat_avatar_url game_title game_url moderator_room_ids moderator_game_ids".split(" ");
JabberChatRoom.prototype={initialize:function(a){this._messageFilter=a.messageFilter||new MessageFilter;this._connection=a.connection;this._activeUser=a.activeUser;this._muc=this._connection._client.muc;this._type=a.type;this._name=a.name;this._xmppName=a.xmppName;this._gameId=a.gameId||null;this.reset();this._rateLimiters={}},join:function(){if(this._connection.connected()){var a=Kongregate.Utils.catchErrors,b=$build("status",JSON.stringify(this._userStatus())).node;this.muc().join(this.jid(),this.userNickname(),
a(this._onRoomMessage,this,!0),a(this._onRoomPresence,this,!0),a(this._onRoomRoster,this,!0),null,{seconds:60},b)}},leave:function(a){!a&&(this._joined&&this._connection.connected())&&this.muc().leave(this.jid(),this.userNickname(),null,"");this._onRoomLeave()},sendGroupMessage:function(a){this._connection.connected()&&this.muc().groupchat(this.jid(),a)},xmppName:function(){return this._xmppName},reset:function(){this._occupants={};this._joined=!1},jid:function(){return this.xmppName()+"@conference."+
this._connection.serverName()},userNickname:function(){return this._activeUser.chatUsername()},isMyPrivateRoom:function(){var a=JabberConnection.PRIVATE_ROOM_PREFIX+this.userNickname().toLowerCase();return"private"===this._type&&this._xmppName==a},userJid:function(){return this.jid()+"/"+this.userNickname()},muc:function(){return this._connection._client.muc},toObject:function(){return{xmpp_name:this._xmppName,id:this._xmppName,name:this._name,type:this._type,game_id:this._gameId}},_dispatchEvent:function(a,
b){this._connection.trigger(a,b)},_userStatus:function(){return[this._activeUser.userVarsSig(),this._activeUser.userVars(),{special_chat_vars:JSON.stringify(this._activeUser.specialChatVars())}]},_parsePresence:function(a){return XmppRoom._parsePresence(a)},_parseMessage:function(a){var b={history:!1,timestamp:null};b.nick=Strophe.getResourceFromJid(a.getAttribute("from"));$j.map(a.childNodes,function(a){switch(a.nodeName){case "body":b.body=a.textContent||a.text;break;case "subject":b.subject=a.textContent||
a.text;break;case "x":"jabber:x:delay"===a.getAttribute("xmlns")&&(b.history=!0,a=a.getAttribute("stamp"),b.timestamp=moment.utc(a,JabberChatRoom.TIME_FORMAT).valueOf())}});return b},_onRoomMessage:function(a,b){var c=this._parseMessage(a),d=c.nick,e=this._occupants[d];Kongregate.Log.debug("RoomMessage",c,a);if(!c.history&&this._checkRateLimitViolation(c.nick))return!0;c.subject?(c=JSON.parse(c.subject).g,void 0!==c&&this._dispatchEvent(KonduitEvent.GUEST_COUNT,{room:this.toObject(),guests:c})):e&&
this._dispatchEvent(KonduitEvent.ROOM_MESSAGE,{user:{username:d,variables:e},room:this.toObject(),message:this._filterMessage(c.body),history:c.history,timestamp:c.timestamp||null});return!0},_checkRateLimitViolation:function(a){"undefined"===typeof this._rateLimiters[a]&&(this._rateLimiters[a]=new JabberRateLimiter);return this._rateLimiters[a].ruleViolated()},_filterMessage:function(a){return this._messageFilter.filterMessage(a)},_deleteMucRoom:function(){var a=this.muc();if(a&&a.rooms&&a.roomNames){delete a.rooms[this.jid()];
var b=a.roomNames.indexOf(this.jid());0<=b&&a.roomNames.splice(b,1)}},_onRoomPresence:function(a,b){var c=this._parsePresence(a);if("error"===c.type)return this._onRoomError(c),!0;var d=c.nick||"",e=this._createUserPayload(c),f={user:e,room:this.toObject()};Kongregate.Log.debug("RoomPresence",c,e);"unavailable"===c.type?(delete this._occupants[d],this._dispatchEvent(KonduitEvent.USER_DEPARTURE,f),d.toLowerCase()===this.userNickname().toLowerCase()&&this._onUserKicked(c)):e.variables.valid?(c=!!this._occupants[d],
this._occupants[d]=e.variables,this._dispatchEvent(c?KonduitEvent.USER_CHANGED:KonduitEvent.USER_JOIN,f)):0!==d.toLowerCase().indexOf("guest")&&Kongregate.Log.error("Invalid user ignored: "+d,a,c);return!0},_onRoomRoster:function(a,b){this.reset();this._joined=!0;this._dispatchEvent(KonduitEvent.JOIN_ROOM,{room:this.toObject()})},_onRoomLeave:function(a){this._joined&&(a=a||{kicked:!1,owner_destroyed:!1,owner_left:!1},a=$j.extend({room:this.toObject()},a),this.reset(),this._dispatchEvent(KonduitEvent.LEAVE_ROOM,
a),this._deleteMucRoom())},_onUserKicked:function(a){var b=!1,c=this;$j.each(a.states,function(a,e){if("321"===e)b=!0;else if("307"===e)return Kongregate.Log.info("Kicked from room due to premium-only"),c._onRoomLeave(),c._onRoomError({errorcode:"404"})});"private"===this._type&&(this.isMyPrivateRoom()?this._onRoomLeave():(a={kicked:b,owner_left:!b,owner_destroyed:!1},Kongregate.Log.info("Kicked from room",a),this._onRoomLeave(a)))},_onRoomError:function(a){Kongregate.Log.error("Room error",a);switch(a.errorcode){case "407":case "405":this._onRoomNotFound();
break;case "503":this._onRoomFull();break;case "404":this._onRoomLocked();break;default:Kongregate.Log.warn("Unknown room error, treating as not found"),this._onRoomNotFound()}},_onRoomNotFound:function(){this._dispatchEvent(KonduitEvent.ROOM_NOT_FOUND,{room:this.toObject()})},_onRoomFull:function(){this._dispatchEvent(KonduitEvent.ROOM_FULL,{room:this.toObject()})},_onRoomLocked:function(){Kongregate.Log.warn("Room is locked",this.toObject());"game"===this._type?(Kongregate.Log.warn("Requested game room is locked, requesting another"),
this._connection.joinRoom({type:"game"})):"chat"===this._type?(Kongregate.Log.warn("Requested chat room is locked, requesting another"),this._dispatchEvent(KonduitEvent.REQUEST_CHAT_ROOM,{room:this.toObject()})):Kongregate.Log.error("Unknown locked room type: "+this._type)},_createUserPayload:function(a){var b,c=a.nick;b=a.status||!this._occupants[c]?this._parseUserVariables(c,a.status):this._occupants[c];b={username:c,variables:b};b.variables.username=a.nick;b.variables.role=a.role;b.variables.presence=
a.show;return b},_parseUserVariables:function(a,b){try{b=(JSON.parse(b)||[]).slice()}catch(c){Kongregate.Log.error("Error while parsing user variables for "+a+" - "+c.message,b),b=[]}var d=b[1]||[];if("string"===typeof d)try{d=JSON.parse(d)}catch(e){Kongregate.Log.error("Error while parsing variables array for"+a+" - "+e.message,d),d=[]}var f={special_chat_vars:(b[2]||{}).special_chat_vars};$j.map(JabberChatRoom.USER_VAR_KEYS,function(a,b){f[a]=d[b]});var h=f.type||"";f.developer=0<=h.indexOf("d");
f.admin=0<=h.indexOf("a");f.moderator=0<=h.indexOf("m");f.curator=0<=h.indexOf("c");f.premium=0<=h.indexOf("p");f.chat_avatar_url=this._parseAvatarUrl(f.chat_avatar_url);f.valid=this._validateUserVariables(a,d,f);return f},_validateUserVariables:function(a,b,c){if(a!==c.username)return Kongregate.Log.error("Username mismatch for "+a+" != "+c.username),!1;if(b.length!==JabberChatRoom.USER_VAR_KEYS.length)return Kongregate.Log.error("Invalid user variables array length: "+b.length),!1;if("number"!==
typeof c.level||1>c.level||75<c.level)return Kongregate.Log.error("Invalid level: "+c.level),!1;a=/<.+?>/;if(a.test(c.chat_avatar_url)||a.test(c.game_url)||a.test(c.game_title))return Kongregate.Log.error("Invalid tag found in user data"),!1;a=/['" ]+/;return a.test(c.chat_avatar_url)||a.test(c.game_url)?(Kongregate.Log.error("Invalid avatar or game url"),!1):!0},_parseAvatarUrl:function(a){return a&&0!==a.indexOf("http")&&0<a.indexOf(":")?(a=a.split(":"),"https://"+a.shift()+"."+this._activeUser.bareCDNhost()+
a.join(":")):a}};$j.extend(JabberChatRoom.prototype,Evented);function JabberConnection(a){this.initialize(a)}
(function(){JabberConnection.CONNECTION_MONITOR_INTERVAL=1E4;JabberConnection.WEBSOCKET_PING_INTERVAL=3E4;JabberConnection.PING_INTERVAL=6E4;JabberConnection.IDLE_INCOMING_TIMEOUT=2.1*JabberConnection.PING_INTERVAL;JabberConnection.RECONNECT_INTERVAL=1E4;JabberConnection.MAX_RECONNECT_INTERVAL=3E4;JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS=1;JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=10;JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS=4;JabberConnection.WEBSOCKET_CONNECTION_DURATION=
3E4;JabberConnection.SET_PRESENCE_INTERVAL=3E3;JabberConnection.KONGREGATE_IQ_NAMESPACE="kongregate:iq:msg";JabberConnection.KONGREGATE_MESSAGE_EVENT="kongregate_message";JabberConnection.PRIVATE_ROOM_PREFIX="kpr-";JabberConnection.OP_REQUEST_GAME_ROOM="room.rq";JabberConnection.OP_PRIVATE_MESSAGE="chat.pm";JabberConnection.OP_STATS_SUBMIT="stat.submit";JabberConnection.OP_SET_PRESENCE="set_presence";JabberConnection.OP_CREATE_PRIVATE_ROOM="room.create";JabberConnection.OP_DESTROY_PRIVATE_ROOM="room.destroy";
JabberConnection.OP_PRIVATE_ROOM_INVITE="room.invite.private";JabberConnection.OP_PRIVATE_ROOM_KICK="room.kick.private";JabberConnection.OP_SILENCED="silenced";JabberConnection.OP_PARTICIPATE="participate";var a=Kongregate.Utils.catchErrors;Strophe.log=function(a,c){try{Kongregate.Log.debug("Strophe["+a+"]: "+c)}catch(d){}};JabberConnection.prototype={initialize:function(a){var c=this;this._setupWsPolyfill(a);this._messageFilter=a.messageFilter||new MessageFilter;this._wsEndpoint=a.wsEndpoint?a.wsEndpoint.replace(/\/?$/,
"/"):null;this._boshEndpoint=a.boshEndpoint?a.boshEndpoint.replace(/\/?$/,"/"):null;this._host=a.host;this._activeUser=a.activeUser;this._rooms={};this._traceXmpp=a.traceXmpp;this._presence={};this._webSocketsSuccessful=this._webSocketsReliable=!1;this._forceBosh=this._boshEndpoint&&!this.webSocketsEnabled();this._connectionAttempts=0;this._numConnections={websocket:0,bosh:0};this._stanzasSent=this._stanzasReceived=this._numTimeouts=0;this._sessionId=uuid.v4();this._patchStrophe();this._createClient();
this._messageFilter.on(KonduitEvent.MESSAGE_ERROR,function(a){c._onFilterError(a)});this._rateLimiter=new JabberRateLimiter},shutdown:function(){this._stopConnectionMonitor();clearTimeout(this._reconnectTimeout)},connect:function(){if(!this.connected()){this._shouldSwitchConnectionType()?this._switchConnectionType():this._invalidSession?(Kongregate.Log.debug("Creating new client due to invalid session"),this._createClient()):this._resetClient();var b=this.myNode()+"@"+this._host+"/xiff",c=JSON.stringify({k:this._activeUser.chatPassword()});
this._client.connect(b,c,a(this._onConnectionStatus,this,!0));this._connectionAttempts+=1;Kongregate.Log.info("Chat connection attempt #"+this._connectionAttempts+" type="+this.connectionType())}},disconnect:function(){this.connected()&&this._client.disconnect()},switchUser:function(){Kongregate.Log.debug("Switching user to: "+this._activeUser.chatUsername());this.disconnect();this.connect()},sendGroupMessage:function(a,c){if(this._validate()){c=this._filterMessage(c);var d=this.room(a);d&&d.sendGroupMessage(c)}},
sendPrivateMessage:function(a,c){this._validate()&&(c=this._filterMessage(c),Kongregate.Log.debug("Sending private message to "+a+", msg: "+c),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_MESSAGE,{from:this._activeUser.chatUsername(),to:a,data:c}))},inviteUserToPrivateRoom:function(a){this._validate()&&(Kongregate.Log.info("Inviting user "+a+" to my private room"),this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_INVITE,{from:this._activeUser.chatUsername(),to:a}))},destroyPrivateRoom:function(){this.sendKongregateMessage(JabberConnection.OP_DESTROY_PRIVATE_ROOM,
{})},kickUserFromPrivateRoom:function(a){Kongregate.Log.info("Kicking user "+a+" from my private room");this.sendKongregateMessage(JabberConnection.OP_PRIVATE_ROOM_KICK,{user:a})},flushStatistics:function(a){this.connected()&&(a.game_id=this._activeUser.gameId(),this.sendKongregateMessage(JabberConnection.OP_STATS_SUBMIT,a))},room:function(a){return this._rooms[a]},joinRoom:function(a){if("game"!==a.type||this._validateGameRoom(a)){if("private"===a.type){if(!this._validatePrivateRoom(a))return;var c=
this._rooms.private,d=JabberConnection.PRIVATE_ROOM_PREFIX+this.myNode();c&&c.xmpp_name===d&&this.destroyPrivateRoom()}this.leaveRoom(a.type);c=this._createRoom(a);this._rooms[a.type]=c;c.join()}},leaveRoom:function(a){var c=this.room(a);c&&(c.leave(),delete this._rooms[a])},connected:function(){return this._client.connected},host:function(){return this._host},supportsWebSockets:function(){return"undefined"!==typeof window.WebSocket},webSocketsEnabled:function(){return!this._boshEndpoint||this.supportsWebSockets()&&
this._activeUser.webSocketsEnabled()},webSocketEndpoint:function(){return this._wsEndpoint},boshEndpoint:function(){return this._boshEndpoint},connectionEndpoint:function(){return(this._forceBosh?this.boshEndpoint():this.webSocketsEnabled()?this.webSocketEndpoint():this.boshEndpoint())+"?"+this._connectionQueryString()},connectionType:function(){return 0===this.connectionEndpoint().indexOf("ws")?"websocket":"bosh"},jid:function(){return this._client.jid},myNode:function(){return this._activeUser.chatUsername().toLowerCase()},
serverName:function(){return this.jid().split("@")[1].split("/")[0]},sendKongregateMessage:function(a,c){var d=this._buildKongregateIQ(a,c).tree();this._client.send(d)},_patchStrophe:function(){if("undefined"!==typeof Strophe){Kongregate.Log.debug("Patching BOSH error handler");var a=Strophe.Bosh.prototype._hitError;Strophe.Bosh.prototype._hitError=function(c){a.bind(this)(c);3<=this.errors&&this._conn._onDisconnectTimeout()}}},_connectionQueryString:function(){var a={sid:this._sessionId,svid:this._activeUser.siteVisitorUID(),
wsr:this._webSocketsReliable,wss:this._webSocketsSuccessful,ca:this._connectionAttempts,wc:this._numConnections.websocket,bc:this._numConnections.bosh,tc:this._numTimeouts,sr:this._stanzasReceived,ss:this._stanzasSent,pb:!0};return Object.toQueryString(a)},_setupWsPolyfill:function(a){if(WebSocket&&"function"===typeof WebSocket.loadFlashPolicyFile){-1!==a.wsEndpoint.indexOf("chat-proxy")&&(a.wsEndpoint=a.wsEndpoint.replace("chat-proxy","chat-proxy-flash"),Kongregate.Log.debug("Using WebSocket endpoint: "+
a.wsEndpoint));var c=a.wsEndpoint.match(/:\/\/([^:]+):?(\d*)$/),d=c[1];if((c=c[2])&&"80"!==c&&"443"!==c)c=parseInt(c,10)+1,Kongregate.Log.debug("Loading Flash policy file from non-standard port: "+c),WebSocket.loadFlashPolicyFile("xmlsocket://"+d+":"+c);a.boshEndpoint=null}},_requestJoinGameRoom:function(){this.sendKongregateMessage(JabberConnection.OP_REQUEST_GAME_ROOM,{game_id:this._activeUser.gameId(),permalink:this._activeUser.gamePermalink(),game_name:this._activeUser.gameName()})},_validateGameRoom:function(a){if(!a.xmpp_name||
0===a.xmpp_name.length)return Kongregate.Log.info("Game room join request received with no roomID, requesting one from server"),this._requestJoinGameRoom(),!1;if(0!==a.xmpp_name.indexOf(this._activeUser.gameId()+"-"+this._activeUser.gamePermalink()+"-")){if("en"===a.language)return Kongregate.Log.warn("Invalid English game room: "+a.xmpp_name),!1;if(isNaN(parseInt(a.xmpp_name,10)))return Kongregate.Log.warn("Invalid non-English game room: "+a.xmpp_name),!1}return!0},_validatePrivateRoom:function(a){a=
a.xmpp_name;return 0!==a.indexOf(JabberConnection.PRIVATE_ROOM_PREFIX)?(Kongregate.Log.warn("Invalid private room name: "+a),!1):!0},_buildKongregateIQ:function(a,c){var d=Base64.encode(JSON.stringify(c||{}));return $iq({type:"get",id:this._client.getUniqueId()}).c("query",{xmlns:JabberConnection.KONGREGATE_IQ_NAMESPACE}).c("msg",{opcode:a}).t(d).up().up()},_parseKongregateIQ:function(a){var c=Strophe.getNodeFromJid(a.getAttribute("from")),d=a.childNodes[0].childNodes[0];a=d.getAttribute("opcode");
d=JSON.parse(Base64.decode(d.textContent||d.text));Kongregate.Log.debug("Kongregate Packet["+c+"] "+a+": "+JSON.stringify(d));if("admin"===c||0===c.indexOf("kong_"))return{opcode:a,params:d};throw Error("Ignoring Kongregate IQ packet from incorrect sender");},_createClient:function(){this._resetClient();this.connectionEndpoint();this._client=new Strophe.Connection(this.connectionEndpoint(),{contentType:"text/plain; charset=utf-8",withCredentials:!0});this._resetClient()},_shouldSwitchConnectionType:function(){if(!this.webSocketsEnabled())return!1;
var a="bosh"===this.connectionType();return 0===this._connectionAttempts?a:a?this._connectionAttempts>JabberConnection.MAX_BOSH_CONNECTION_ATTEMPTS:this._connectionAttempts>=(this._webSocketsReliable?JabberConnection.RELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS:JabberConnection.UNRELIABLE_WEBSOCKET_CONNECTION_ATTEMPTS)},_switchConnectionType:function(){this._wasOffline?(Kongregate.Log.info("Was offline, will attempt to reconnect with websocket"),this._forceBosh=!1):(Kongregate.Log.info("Switching connection type due to failures, attempts="+
this._connectionAttempts),this._forceBosh=!this._forceBosh);this._wasOffline=!1;this._createClient();this._connectionAttempts=0;this._webSocketsReliable=!1},_resetClient:function(){this._client&&(this._client.reset(),this._resetRooms(),this._client.rawOutput=a(this._onOutgoingData,this,!0),this._client.rawInput=a(this._onIncomingData,this,!0),this._client.addHandler(a(this._onKongregateIQ,this,!0),JabberConnection.KONGREGATE_IQ_NAMESPACE,"iq"),this._client.service=this.connectionEndpoint(),this._invalidSession=
this._loginFailed=this._banned=this._sessionConflict=!1)},_startConnectionMonitor:function(){this._stopConnectionMonitor();this._connectionMonitorInterval=setInterval(this._connectionMonitor.bind(this),JabberConnection.CONNECTION_MONITOR_INTERVAL)},_stopConnectionMonitor:function(){this._connectionMonitorInterval&&(clearInterval(this._connectionMonitorInterval),this._connectionMonitorInterval=void 0)},_sendEmptyWebsocketPacket:function(){try{"websocket"===this.connectionType()&&this._client._proto.socket&&
(this._client._proto.socket.send(""),this._lastWebsocketPing=(new Date).getTime())}catch(a){Kongregate.Log.error("Error while sending empty websocket packet",a)}},_connectionMonitor:function(){if(this.connected()){var a=(new Date).getTime(),c=a-this._lastOutgoingPacket,d=a-this._lastIncomingPacket,e=a-this._connectionTime,a=a-this._lastWebsocketPing;0>c||c>=JabberConnection.PING_INTERVAL?this._client.ping.ping():a>=JabberConnection.WEBSOCKET_PING_INTERVAL&&this._sendEmptyWebsocketPacket();d>=JabberConnection.IDLE_INCOMING_TIMEOUT?
(this._numTimeouts+=1,this.disconnect("timeout")):!this._webSocketsReliable&&("websocket"===this.connectionType()&&e>=JabberConnection.IDLE_INCOMING_TIMEOUT)&&(Kongregate.Log.debug("Marking WebSocket connections as reliable"),this._webSocketsReliable=!0)}},_scheduleReconnect:function(){this._reconnectTimeout=setTimeout(this.connect.bind(this),this._reconnectTime)},_createRoom:function(a){return new JabberChatRoom({connection:this,activeUser:this._activeUser,xmppName:a.xmpp_name,gameId:a.game_id,name:a.name,
type:a.type})},_resetRooms:function(){var a=this._client.muc;a.rooms={};a.roomNames=[];a._muc_handler=null;$j.each(this._rooms,function(a,b){b.leave(!0)})},_joinRooms:function(){$j.each(this._rooms,function(a,c){c.join()})},setPresence:function(a,c){if(this._presence[c]!=a){if(null===c){var d=(new Date).getTime();if(this._lastSetPresence&&d-this._lastSetPresence<JabberConnection.SET_PRESENCE_INTERVAL)return;this._lastSetPresence=d;$j.each(this._rooms,function(c,d){this._presence[d]=a}.bind(this))}this._presence[c]=
a;Kongregate.Log.info("Changing user presence to "+a);this.sendKongregateMessage(JabberConnection.OP_SET_PRESENCE,{from:this._activeUser.chatUsername(),presence:a,room_name:c})}},_isBlankBoshStanza:function(a){return/^<body/.test(a)&&!/<\/body>$/.test(a)},_onIncomingData:function(a){Kongregate.Log.spam(" IN: "+a);this._isBlankBoshStanza(a)||(this._stanzasReceived+=1,this._lastIncomingPacket=(new Date).getTime())},_onOutgoingData:function(a){Kongregate.Log.spam("OUT: "+a);this._isBlankBoshStanza(a)||
(a=(new Date).getTime(),this._stanzasSent+=1,this._lastWebsocketPing=this._lastOutgoingPacket=a)},_onKongregateIQ:function(a){try{var c=this._parseKongregateIQ(a);this._onServerMessage(c);this.trigger(JabberConnection.KONGREGATE_MESSAGE_EVENT,c)}catch(d){Kongregate.Log.error("Error handling kongregate packet",d)}return!0},_onServerMessage:function(a){var c=a.params;switch(a.opcode){case JabberConnection.OP_REQUEST_GAME_ROOM:this._onGameRoomResult(c);break;case JabberConnection.OP_PRIVATE_MESSAGE:this._onPrivateMessage(c);
break;case JabberConnection.OP_STATS_SUBMIT:this._onStatSubmissionResult(c);break;case JabberConnection.OP_CREATE_PRIVATE_ROOM:this._onPrivateRoomCreated(c);break;case JabberConnection.OP_PRIVATE_ROOM_INVITE:this._onPrivateRoomInvite(c);break;case JabberConnection.OP_SILENCED:this._onSilenced(c);break;case JabberConnection.OP_PARTICIPATE:this._onParticipate(c)}},_onPrivateRoomCreated:function(a){if(a.success){var c=a["room.name"];a=a["room.natural"];Kongregate.Log.info("Private room created: "+c+
", name="+a);this.joinRoom({type:"private",id:c,xmpp_name:c,name:a})}else Kongregate.Log.info("Private room creation failed")},_onPrivateRoomInvite:function(a){var c=a["room.name"],d=a["room.natural"],e=a.from;e.toLowerCase()===this.myNode()?(c=a.success,d=a.error,Kongregate.Log.info("Private room invitation sent, sucess="+c+", error="+d),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,{username:a.to,success:c,error:d})):(Kongregate.Log.info("Private room invitation (from "+e+"): "+c+", name="+
d),this.trigger(KonduitEvent.PRIVATE_ROOM_INVITATION,{username:e,xmpp_name:c,name:d,type:"private"}))},_onGameRoomResult:function(a){Kongregate.Log.debug("Game room result",a);this.joinRoom({type:"game",id:a["room.name"],xmpp_name:a["room.name"],name:a["room.natural"],game_id:this._activeUser.gameId()})},_onSilenced:function(a){this.trigger(KonduitEvent.SILENCED,a)},_onParticipate:function(a){this.trigger(KonduitEvent.PARTICIPATE,a)},_onConnectionStatus:function(a,c){Kongregate.Log.debug("Connection status changed, status="+
a+", err="+c);switch(a){case Strophe.Status.ERROR:this._onError(c);break;case Strophe.Status.CONNECTING:this.trigger(KonduitEvent.CONNECT);break;case Strophe.Status.CONNECTED:this._onConnected();break;case Strophe.Status.DISCONNECTED:this._onDisconnected(c);break;case Strophe.Status.AUTHFAIL:this._onAuthFailure();break;default:Kongregate.Log.debug("Unknown status: "+a)}},_onConnected:function(){clearTimeout(this._reconnectTimeout);var a=this.connectionType();"websocket"===a&&(Kongregate.Log.info("Marking websocket connection successful"),
this._webSocketsSuccessful=!0);var c=(new Date).getTime();this._numConnections[a]+=1;this._reconnectTime=void 0;this._connectionTime=this._lastWebsocketPing=this._lastIncomingPacket=this._lastOutgoingPacket=c;this._shutdown=!1;this._connectionAttempts=0;this._startConnectionMonitor();this._setRosterPresence("chat");this.trigger(KonduitEvent.LOGIN);this._joinRooms()},_onDisconnected:function(){this._stopConnectionMonitor();this._resetRooms();navigator.onLine||(this._wasOffline=!0,Kongregate.Log.info("Network unavailable, setting offline flag"));
this.trigger(KonduitEvent.DISCONNECT,{conflict:this._sessionConflict,login_failed:this._loginFailed,banned:this._banned});if(!this._sessionConflict&&!this._banned&&!this._loginFailed){var a=Math.random()*JabberConnection.RECONNECT_INTERVAL/2+JabberConnection.RECONNECT_INTERVAL/2,c=JabberConnection.MAX_RECONNECT_INTERVAL;this._reconnectTime=this._reconnectTime?Math.min(c,1.5*this._reconnectTime):a;Kongregate.Log.warn("Disconnected, reconnecting in: "+this._reconnectTime);this._scheduleReconnect()}},
_onError:function(a){Kongregate.Log.warn("Connection error",a);"conflict"===a?(Kongregate.Log.debug("Session conflict detected"),this._sessionConflict=!0):"policy-violation"===a?(Kongregate.Log.debug("Ban detected"),this._banned=!0):"system-shutdown"===a||"remote-stream-error"===a?(Kongregate.Log.debug("System shutdown detected"),this._shutdown=!0):"item-not-found"===error&&(this._invalidSession=!0,Kongregate.Log.debug("Invalid session detected"))},_onAuthFailure:function(){Kongregate.Log.debug("Login failure detected");
this._loginFailed=!0;this._onDisconnected()},_onPrivateMessage:function(a){var c=a.from,d=a.to,e=a.success;a=a.data;!0===e&&0===c.toLowerCase().indexOf("guest")||this.trigger(KonduitEvent.PRIVATE_MESSAGE,{success:e,from:c,to:d,message:a})},_onStatSubmissionResult:function(a){a.result=!0;this.trigger(KonduitEvent.STATISTICS_FLUSH,a)},_setRosterPresence:function(a){this._client.send($pres().c("show").t(a))},_validate:function(){return!this._activeUser.isAuthenticated()||this._checkRateLimitViolation()?
!1:!0},_filterMessage:function(a){return a=this._messageFilter.filterMessage(a)},_checkRateLimitViolation:function(){var a=this._rateLimiter.ruleViolated();return a?(this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.RATE_LIMITED,ruleViolated:a}),!0):!1},_onFilterError:function(a){this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:a.errorType})}};$j.extend(JabberConnection.prototype,Evented)})();
function JabberRateLimiter(){this._timestamps=[];this._rules=[{duration:1E3,capacity:2},{duration:6E4,capacity:8}]}JabberRateLimiter.prototype={ruleViolated:function(){var a=(new Date).getTime(),b=!1,c=this;this._timestamps=this._timestamps.filter(function(b){return b>=a-6E4});$j.each(this._rules,function(d,e){c._timestamps.filter(function(b){return b>=a-e.duration}).length>=e.capacity&&(b=!0)});b||this._timestamps.push(a);return b}};Konduit=function(a){this.initialize(a)};
Konduit.prototype={initialize:function(){this.queuedEvents=[];this.setupComplete=!1},setup:function(a){this.setupComplete||(this.flashAdapter=new KonduitFlashAdapter(a),this.fayeAdapter=new KonduitFayeAdapter(a),this.jabberAdapter=new KonduitJabberAdapter($j.extend(a,{connect:!0,traceXmpp:5<=active_user.debugLevel(),activeUser:active_user,host:a.chatHost,wsEndpoint:a.chatProxyWebsocket,boshEndpoint:a.chatProxyBosh,flashEventDispatcher:this.flashAdapter})),this.jsAdapter=new KonduitJavascriptAdapter($j.extend(a,
{activeUser:active_user})),this.setupComplete=!0,this.flushEventQueue())},dispatchEvent:function(a){if(this.setupComplete){if(!this.fayeAdapter.dispatchEvent(a)&&(!this.jabberAdapter||!this.jabberAdapter.dispatchEvent(a)))(!this.jsAdapter||!this.jsAdapter.dispatchEvent(a))&&this.flashAdapter.dispatchEvent(a)}else Kongregate.Log.debug("Queueing konduit event",a),this.queuedEvents.push(a)},flushEventQueue:function(){var a=this;this.queuedEvents.forEach(function(b){a.dispatchEvent(b)});this.queuedEvents=
[]},alertLog:function(){return this.flashAdapter&&this.flashAdapter.alertLog()},jabberConnected:function(){return this.jabberAdapter&&this.jabberAdapter.connected()}};KonduitFayeAdapter=function(a){this.initialize(a)};
KonduitFayeAdapter.prototype={initialize:function(a){this._fayeEventDispatcher=new FayeEventDispatcher({holodeckEventDispatcher:a.eventDispatcher});this._authenticator=a.authenticator||new GuildChatAuthenticator;this._fayeService=new FayeService({authenticator:this._authenticator,fayeConnection:a.fayeConnection});this._fayeRoomListService=a.fayeRoomListService||new FayeRoomListService({authenticator:this._authenticator});this._fayeHistoryService=a.fayeHistoryService||new FayeHistoryService({authenticator:this._authenticator});
this._registerEvents()},_registerEvents:function(){this._fayeService.on("joinRoom",this._fayeEventDispatcher,"joinRoom");this._fayeService.on("joinRoom",this._fayeRoomListService,"subscribe");this._fayeService.on("roomNotFound",this._fayeEventDispatcher,"roomNotFound");this._fayeService.on("messageRateLimited",this._fayeEventDispatcher,"messageRateLimited");this._fayeService.on("messageTooLong",this._fayeEventDispatcher,"messageTooLong");this._fayeService.on("message",this._fayeEventDispatcher,"message");
this._fayeService.on("message",this._fayeRoomListService,"message");this._fayeService.on("disconnect",this._fayeEventDispatcher,"disconnect");this._fayeService.on("connect",this._fayeEventDispatcher,"connect");this._fayeService.on("connect",this._fayeRoomListService,"connect");this._fayeService.on("leaveRoom",this._fayeEventDispatcher,"leaveRoom");this._fayeService.on("leaveRoom",this._fayeRoomListService,"unsubscribe");this._fayeRoomListService.on("userJoin",this._fayeEventDispatcher,"userJoin");
this._fayeRoomListService.on("userChanged",this._fayeEventDispatcher,"userChanged");this._fayeRoomListService.on("userDeparture",this._fayeEventDispatcher,"userDeparture");this._fayeHistoryService.on("message",this._fayeEventDispatcher,"message");this._fayeHistoryService.on("history",this._fayeEventDispatcher,"history");this._authenticator.on("kick",this._fayeService,"leaveCurrentGuildRoom",!0)},dispatchEvent:function(a){switch(a.type){case KonduitEvent.SET_PRESENCE:return this._handleSetPresence(a.data);
case KonduitEvent.JOIN_GUILD_ROOM:return this._handleJoinGuildRoom(a.data);case KonduitEvent.ROOM_MESSAGE:return this._handleRoomMessage(a.data);case KonduitEvent.LEAVE_ROOM:return this._handleLeaveRoom(a.data);case KonduitEvent.FETCH_HISTORY:return this._fetchHistory(a.data)}return!1},_handleSetPresence:function(a){return this._fayeService.isCurrentRoomName(a.room_name)?(this._fayeService.setPresence(a.room_name,"chat"===a.presence),!0):!1},_handleLeaveRoom:function(a){return"guild"===a.room_type?
(this._fayeService.leaveCurrentGuildRoom(!1),!0):!1},_handleRoomMessage:function(a){return this._fayeService.isCurrentRoomId(a.room.id)?(this._fayeService.sendMessage(a.message,a.room),!0):!1},_handleJoinGuildRoom:function(a){this._fayeService.subscribe(a);return!0},_fetchHistory:function(a){this._fayeHistoryService.fetchHistory(a.room,a.maxTime)}};KonduitFlashAdapter=function(){this.initialize()};
KonduitFlashAdapter.prototype={initialize:function(){this.swf=$j("#konduit")[0]},dispatchEvent:function(a){this.enabled()&&this.swf.dispatchJSONEvent(Object.toJSON(a))},alertLog:function(){return this.enabled()?this.swf.alertLog():[]},enabled:function(){return this.swf&&"function"===typeof this.swf.dispatchJSONEvent}};KonduitJabberAdapter=function(a){this.initialize(a)};
KonduitJabberAdapter.PASS_THROUGH_EVENTS=[KonduitEvent.JOIN_ROOM,KonduitEvent.USER_JOIN,KonduitEvent.USER_CHANGED,KonduitEvent.USER_DEPARTURE,KonduitEvent.ROOM_MESSAGE,KonduitEvent.GUEST_COUNT,KonduitEvent.LEAVE_ROOM,KonduitEvent.DISCONNECT,KonduitEvent.PRIVATE_MESSAGE,KonduitEvent.MESSAGE_ERROR,KonduitEvent.STATISTICS_FLUSH,KonduitEvent.PRIVATE_ROOM_INVITATION,KonduitEvent.PRIVATE_ROOM_INVITATION_SENT,KonduitEvent.REQUEST_CHAT_ROOM,KonduitEvent.ROOM_FULL,KonduitEvent.ROOM_NOT_FOUND,KonduitEvent.SILENCED,
KonduitEvent.PARTICIPATE];
KonduitJabberAdapter.prototype={initialize:function(a){this._activeUser=a.activeUser;this._connection=new JabberConnection(a);this._eventDispatcher=a.eventDispatcher;this._flashEventDispatcher=a.flashEventDispatcher;this._registerEvents();a.connect&&this._connection.connect()},connected:function(a){return this._connection.connected()},dispatchEvent:function(a){switch(a.type){case KonduitEvent.CONNECT:return this._connection.connect(),!0;case KonduitEvent.JOIN_ROOM:return this._connection.joinRoom(a.data.room),!0;
case KonduitEvent.LEAVE_ROOM:return this._connection.leaveRoom(a.data.room_type),!0;case KonduitEvent.ROOM_MESSAGE:return this._connection.sendGroupMessage(a.data.room.type,a.data.message),!0;case KonduitEvent.SWITCH_USER:return this._connection.switchUser(),!1;case KonduitEvent.PRIVATE_MESSAGE:return this._connection.sendPrivateMessage(a.data.username,a.data.message),!0;case KonduitEvent.STATISTICS_FLUSH:if(a.data.result)return!1;this._connection.flushStatistics(a.data);return!0;case KonduitEvent.SET_PRESENCE:return this._connection.setPresence(a.data.presence,
a.data.room_name),!0;case KonduitEvent.PRIVATE_ROOM_INVITATION:return this._connection.inviteUserToPrivateRoom(a.data.username),!0;case KonduitEvent.PRIVATE_ROOM_KICK:return this._connection.kickUserFromPrivateRoom(a.data.username),!0;case KonduitEvent.DESTROY_PRIVATE_ROOM:return this._connection.destroyPrivateRoom(),!0;default:return!1}},_registerEvents:function(){this._connection.on(KonduitEvent.CONNECT,this._onConnect.bind(this));this._connection.on(KonduitEvent.LOGIN,this._onAuthenticated.bind(this));
this._connection.on(KonduitEvent.ROOM_MESSAGE,this._onRoomMessage.bind(this));var a=this;$j.map(KonduitJabberAdapter.PASS_THROUGH_EVENTS,function(b){a._connection.on(b,function(c){a._eventDispatcher.fire({type:b,data:c})})})},_onConnect:function(){this._eventDispatcher.fire({type:KonduitEvent.CONNECT,data:{success:!0}})},_onAuthenticated:function(){this._eventDispatcher.fire({type:KonduitEvent.LOGIN,data:{success:!0,username:this._activeUser.username(),bosh:"bosh"===this._connection.connectionType()}})},
_onRoomMessage:function(a){this._flashEventDispatcher.dispatchEvent({type:KonduitEvent.ROOM_MESSAGE,data:a})}};
(function(){var a="fuck;cocksuck;nigger;faggot;nigga;kike;fags;pornhub;youporn;brazzers;redtube;xhamster;xvideos;xnxx;youjizz;tube8;spankbang;chaturbate;blue waffle;lemon party;meatspin".split(";"),b=["fag"],c=/(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(c|c( )*;|C( )*;)(u|u( )*;|U( )*;)(n|n( )*;|N( )*;)(t|t( )*;|T( )*;)|(c|c( )*;|C( )*;)(o|o( )*;|O( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)(s|s( )*;|S( )*;)(u|u( )*;|U( )*;)(c|c( )*;|C( )*;)(k|k( )*;|K( )*;)|(n|n( )*;|N( )*;)(i|i( )*;|I( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(e|e( )*;|E( )*;)(r|r( )*;|R( )*;)|(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)(g|g( )*;|G( )*;)(o|o( )*;|O( )*;)(t|t( )*;|T( )*;)|\b(f|f( )*;|F( )*;|\u0192( )*;|\u0493( )*)(a|a( )*;|A( )*;)(g|g( )*;|G( )*;)\b/gi,d=
function(){for(var c=[],d=0;d<a.length;d++)c.push("("+a[d].replace(/\w(?=\w)/g,"$&[\\s;]*")+")");for(d=0;d<b.length;d++)c.push("\\b("+b[d].replace(/\w(?=\w)/g,"$&[\\s;]*")+")\\b");return RegExp(c.join("|"),"gi")}();Kongregate.LanguageFilter={filter:function(a){if("string"!==typeof a)return a;for(var b="",h=0;h<a.length;h++){var l=a.charCodeAt(h);32>l&&9!=l&&10!=l&&13!=l||(b+=a.charAt(h))}return b.replace(c,"****").replace(d,"****")}}})();
LocalMuteService=function(){function a(){var a=$.jStorage.get(b);return a?JSON.parse(a):{}}var b="KWAK-MUTINGS";return{mute:function(c){var d=a();d[c]=!0;$.jStorage.set(b,JSON.stringify(d))},unmute:function(c){var d=a();delete d[c];$.jStorage.set(b,JSON.stringify(d))},isMuted:function(b){return!!a()[b]},mutings:function(){return Object.keys(a())}}}();function MessageFilter(a){this.initialize(a)}
MessageFilter.prototype={initialize:function(a){this.maxLength=250},filterMessage:function(a){return a=this._truncateMessage(a)},_truncateMessage:function(a){a.length>this.maxLength&&(a=a.substring(0,this.maxLength-1)+"\u2026",this.trigger(KonduitEvent.MESSAGE_ERROR,{errorType:KonduitChatErrorMessage.MESSAGE_TOO_LONG}));return a}};$j.extend(MessageFilter.prototype,Evented);MiniProfile=function(a){this.initialize(a)};
MiniProfile.prototype={initialize:function(a){this._chat_window=a.chat_window;this._holodeck=a.holodeck;var b=this;(this._container=$("user_mini_profile_container"))&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a,b){this._chat_window.setActiveTempPane(this);this._current_username=a;this._current_room=b;var c=this._container,d=this._chat_window,e=this;$("user_mini_profile").update("");c.down(".room_name").update(b.name());d.hideChatWindow();
d._chat_tab_clicked=!1;c.ieHappyShow();d.showSpinner();new Ajax.Updater({success:"user_mini_profile"},"/accounts/"+a+".chat",{method:"get",onComplete:function(){!1===d._chat_tab_clicked&&(d.hideSpinner(),e.setupBanAndSilencingControls(a),active_user.addCapturedSelector("#add_friend"),active_user.addCapturedSelector("#mute_user"))}})},deactivate:function(){this._chat_window.clearActiveTempPane();this._container.ieHappyHide();this._chat_window.hideSpinner();this._chat_window.showChatWindow()},updateManualBanReasonField:function(a){$("ban_ban_reason_id").value?
$("ban_reason_block").hide():$("ban_reason_block").show()},updateManualSilencingReasonField:function(a){$("silencing_silencing_reason_id").value?$("silencing_reason_block").hide():$("silencing_reason_block").show()},setupBanAndSilencingControls:function(a){this._chat_window.isModeratableUser(a)&&(["silencings","bans"].each(Element.show),$("ban_ban_reason_id")&&($("ban_ban_reason_id").observe("click",this.updateManualBanReasonField),$("ban_ban_reason_id").observe("change",this.updateManualBanReasonField),
$("ban_ban_reason_id").observe("keypress",this.updateManualBanReasonField),this.updateManualBanReasonField(null)),$("silencing_silencing_reason_id")&&($("silencing_silencing_reason_id").observe("click",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("change",this.updateManualSilencingReasonField),$("silencing_silencing_reason_id").observe("keypress",this.updateManualSilencingReasonField),this.updateManualSilencingReasonField(null)))}};OnlineFriends=function(a){this.initialize(a)};
OnlineFriends.prototype={initialize:function(a){this._chat_window=a;var b=this;this._container=$("friends_online_container");this._friend_list_node=$("friends_online");this._container&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a){var b=this._chat_window;this._container.down(".room_name").update(a);b.hideChatWindow();this.getOnlineFriends()},getOnlineFriends:function(a){var b=this._container,c=this._chat_window,d=this._friend_list_node;
d.hide();c.showSpinner();c._chat_tab_clicked=!1;new Ajax.Updater({success:"friends_online"},"/accounts/"+c.username()+"/online_friends.chat"+(a?"?page="+a:""),{method:"get",onSuccess:function(a){!1===c._chat_tab_clicked&&(c.hideChatWindow(),c.hideSpinner(),d.show(),b.show())}})},deactivate:function(){this._container.hide();this._chat_window.showChatWindow()}};
Array.prototype.binarySearch=function(a,b,c){b||(b=function(a,b){return a==b?0:a<b?-1:1});for(var d=0,e=this.length-1,f,h;d<=e;)if(f=Math.floor((d+e)/2),h=b(this[f],a),0>h)d=f+1;else if(0<h)e=f-1;else return f;return c?d:-1};Array.prototype.orderedInsert=function(a,b){var c=this.binarySearch(a,b,!0);this.splice(c,0,a);return c};
Array.prototype.orderedDelete=function(a,b){var c=this.binarySearch(a,b);if(0<=c)return this.splice(c,1),c;for(c=0;c<this.length;c++)if(this[c]===a)return this.splice(c,1),c;return-1};RoomInfo=function(a){this.initialize(a)};
RoomInfo.prototype={initialize:function(a){this._chat_window=a.chat_window;this._holodeck=a.holodeck;var b=this;(this._container=$("room_info_container"))&&this._container.down(".return_to_room").observe("click",function(a){b.deactivate();a.stop()})},activate:function(a){this._chat_window._chat_tab_clicked=!1;this._chat_window.setActiveTempPane(this);this._current_room=a;var b=this._container,c=this._chat_window;b.down(".room_name").update(a.name());c.hideChatWindow();c.showSpinner();new Ajax.Updater({success:"room_info"},
"/rooms/"+a.getId()+".chat",{method:"get",onSuccess:function(a){!1===c._chat_tab_clicked&&(c.hideChatWindow(),c.hideSpinner(),b.ieHappyShow())}})},deactivate:function(){this._chat_window.clearActiveTempPane();this._container.ieHappyHide();this._chat_window.showChatWindow()}};SharedContentWelcomeTab=function(a){this.initialize(a)};
SharedContentWelcomeTab.prototype={initialize:function(a){this._active_user=a.active_user;this._holodeck=a.holodeck;this._active_user&&(this._active_user.isAuthenticated()&&this._holodeck.hasSharedContent()&&!this._active_user.seenSharedContentWelcome())&&this.update()},update:function(){var a=this._holodeck,b=this._active_user.gameResourcePath()+"/featured_shared_contents.chat";this._active_user.setSeenSharedContentWelcome(!0);new Ajax.Updater({success:"shared_content_welcome_tab_pane_content"},
b,{method:"get",on200:a.showSharedContentWelcomeTab.bind(a)})}};SuggestionTemplate=function(a,b){this.initialize(a,b)};
SuggestionTemplate.prototype={initialize:function(a,b){var c=$(a);this._source=c?c.cloneNode(!0):void 0;this._substitutions=$H(b||{})},source:function(){return this._source?this._source.cloneNode(!0):void 0},substitutions:function(){return this._substitutions},insertAt:function(a){if(this.source()){var b=$(a);b&&(b.update(this.source()),this.substitutions().each(function(a){var d=a.value;(a=b.down(a.key))&&a.update(d)}))}}};UserRollover=function(a){this.initialize(a)};
UserRollover.USER_TOP_FUDGE=9;UserRollover.BASE_LEFT_VALUE=54;
UserRollover.prototype={initialize:function(a){this._chat_window=a;this._rollover_template_node=$("user_rollover_template");this._gamelink_node=$("rollover_game_link");this._profile_node=$("rollover_profile_link");this._add_friend_node=$("rollover_add_friend_link");this._private_message_node=$("rollover_private_message_link");this._private_room_invite_node=$("rollover_private_room_invite_link");this._private_room_kick_node=$("rollover_private_room_kick_link");this._mute_node=$("rollover_mute_link");
this._add_friend_observer=function(){};this._profile_observer=function(){};this._private_message_observer=function(){};this._mute_observer=function(){};if(this._rollover_template_node){var b=this;this._rollover_template_node.observe("mouseover",function(a){b.stopHide();Event.stop(a)});this._rollover_template_node.observe("mouseout",function(a){b.beginHide();Event.stop(a)})}},show:function(a,b){this._hideTimer&&clearTimeout(this._hideTimer);this.updateCurrentGame(a);this.updateProfileLink(a);this.updateAddFriendLink(a.username);
this.updatePrivateMessageLink(a.username);this.updatePrivateRoomInviteLink(a.username);this.updatePrivateRoomKickLink(a.username);this.updateMutingLink(a.username);this.toggleApplicableLinks(a);this.setRolloverPosition(b);this._rollover_template_node.show()},setRolloverPosition:function(a){var b=this._chat_window.activeRoomUserListScrollTop(),c=a.positionedOffset(),d=c[0],e=c[1],c=e-=UserRollover.USER_TOP_FUDGE;b<e&&(c=e-b);a=a.getWidth();this._rollover_template_node.setStyle({left:d+a+"px",top:c+
"px"})},updateCurrentGame:function(a){a.gameTitle()?(this._gamelink_node.up().show(),this._gamelink_node.writeAttribute("href",a.gameUrl()),this._gamelink_node.update(a.gameTitle())):this._gamelink_node.up().hide()},updateAddFriendLink:function(a){this._chat_window.username();this._chat_window.isFriend(a)?this._add_friend_node.hide():(this._add_friend_node.update("Add Friend"),this._add_friend_node.stopObserving("click",this._add_friend_observer),this._add_friend_observer=CapturesToInlineRegistration.decorate(function(b){Element.show("add_as_friend_indicator");
var c="/accounts/"+this._chat_window.username()+"/friends/"+a+"?friend_from=chat";new Ajax.Request(c,{asynchronous:!0,evalScripts:!0,method:"put"});Event.stop(b);return!1}.bind(this)),this._add_friend_node.observe("click",this._add_friend_observer),this._add_friend_node.show())},updatePrivateMessageLink:function(a){var b=this._chat_window;this._private_message_node.stopObserving("click",this._private_message_observer);this._private_message_observer=CapturesToInlineRegistration.decorate(function(c){b.insertPrivateMessagePrefixFor(a);
Event.stop(c);return!1}.bind(this));this._private_message_node.observe("click",this._private_message_observer)},updatePrivateRoomInviteLink:function(a){var b=this._private_room_invite_node,c=this._chat_window.roomByType("private");c&&c.isMyPrivateRoom()&&c.user(a)?b.hide():(b.show(),holodeck.hasInvited(a)?(b.down(".invite").hide(),b.down(".retry").show()):(b.down(".invite").show(),b.down(".retry").hide()));b.stopObserving("click");b.observe("click",function(c){b.down(".invite").hide();b.down(".retry").show();
holodeck.sendPrivateRoomInvitation(a);Event.stop(c);return!1})},updatePrivateRoomKickLink:function(a){var b=this._chat_window._active_room,c=this._private_room_kick_node,d=this;b.isPrivate()&&b.isMyPrivateRoom()?(c.show(),c.stopObserving("click"),c.observe("click",function(b){holodeck.privateRoomKick(a);d.hide();Event.stop(b);return!1})):c.hide()},updateMutingLink:function(a){var b;if(this._chat_window.isAdmin(a))this._mute_node.hide();else{this._mute_node.show();var c=a.match(/^_/),d=this._chat_window.username();
this._chat_window.isMuted(a)?(this._mute_node.update("Unmute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=function(e){c?(holodeck.removeMuting(a),LocalMuteService.unmute(a)):(Element.show("muting_indicator"),b="/accounts/"+d+"/muted_users/"+a+"?from_chat=true",new Ajax.Request(b,{asynchronous:!0,evalScripts:!0,method:"delete"}));Event.stop(e);return!1}):(this._mute_node.update("Mute"),this._mute_node.stopObserving("click",this._mute_observer),this._mute_observer=
CapturesToInlineRegistration.decorate(function(e){c?(holodeck.addMuting(a),LocalMuteService.mute(a)):(b="/accounts/"+d+"/muted_users?username="+a+"&from_chat=true",Element.show("muting_indicator"),new Ajax.Request(b,{asynchronous:!0,evalScripts:!0,method:"post"}));Event.stop(e);return!1}.bind(this)));this._mute_node.observe("click",this._mute_observer)}},updateProfileLink:function(a){var b=this._chat_window,c=this;this._profile_node.stopObserving("click",this._profile_observer);this._profile_observer=
function(d){c.hide();b.showProfile(a.username);Event.stop(d);return!1};this._profile_node.observe("click",this._profile_observer)},beginHide:function(){var a=this;this._hideTimer&&clearTimeout(this._hideTimer);this._hideTimer=setTimeout(function(){a.hide()},500)},stopHide:function(){clearTimeout(this._hideTimer)},hide:function(){this._rollover_template_node.hide()},toggleApplicableLinks:function(a){a.isGuest()?(this._private_room_invite_node.hide(),this._private_message_node.hide(),this._profile_node.hide(),
this._add_friend_node.hide()):(a.isMobile()?(this._private_room_invite_node.hide(),this._private_message_node.hide()):(this._private_room_invite_node.show(),this._private_message_node.show()),this._profile_node.show())}};window.WEB_SOCKET_DEBUG=!1;window.WEB_SOCKET_SWF_LOCATION="https://assets.kongregate.com/flash/WebSocketMain.swf";window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0;
(function(){if(!window.WEB_SOCKET_FORCE_FLASH){if(window.WebSocket)return;if(window.MozWebSocket){window.WebSocket=MozWebSocket;return}}var a;a=window.WEB_SOCKET_LOGGER?WEB_SOCKET_LOGGER:window.console&&window.console.log&&window.console.error?window.console:{log:function(){},error:function(){}};10>swfobject.getFlashPlayerVersion().major?a.error("Flash Player >= 10.0.0 is required."):("file:"==location.protocol&&a.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://..."),
window.WebSocket=function(a,c,d,e,f){var h=this;h.__id=WebSocket.__nextId++;WebSocket.__instances[h.__id]=h;h.readyState=WebSocket.CONNECTING;h.bufferedAmount=0;h.__events={};c?"string"==typeof c&&(c=[c]):c=[];h.__createTask=setTimeout(function(){WebSocket.__addTask(function(){h.__createTask=null;WebSocket.__flash.create(h.__id,a,c,d||null,e||0,f||null)})},0)},WebSocket.prototype.send=function(a){if(this.readyState==WebSocket.CONNECTING)throw"INVALID_STATE_ERR: Web Socket connection has not been established";
a=WebSocket.__flash.send(this.__id,encodeURIComponent(a));if(0>a)return!0;this.bufferedAmount+=a;return!1},WebSocket.prototype.close=function(){this.__createTask?(clearTimeout(this.__createTask),this.__createTask=null,this.readyState=WebSocket.CLOSED):this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING||(this.readyState=WebSocket.CLOSING,WebSocket.__flash.close(this.__id))},WebSocket.prototype.addEventListener=function(a,c,d){a in this.__events||(this.__events[a]=[]);this.__events[a].push(c)},
WebSocket.prototype.removeEventListener=function(a,c,d){if(a in this.__events){a=this.__events[a];for(d=a.length-1;0<=d;--d)if(a[d]===c){a.splice(d,1);break}}},WebSocket.prototype.dispatchEvent=function(a){for(var c=this.__events[a.type]||[],d=0;d<c.length;++d)c[d](a);(c=this["on"+a.type])&&c.apply(this,[a])},WebSocket.prototype.__handleEvent=function(a){"readyState"in a&&(this.readyState=a.readyState);"protocol"in a&&(this.protocol=a.protocol);var c;if("open"==a.type||"error"==a.type)c=this.__createSimpleEvent(a.type);
else if("close"==a.type)c=this.__createSimpleEvent("close"),c.wasClean=a.wasClean?!0:!1,c.code=a.code,c.reason=a.reason;else if("message"==a.type)a=decodeURIComponent(a.message),c=this.__createMessageEvent("message",a);else throw"unknown event type: "+a.type;this.dispatchEvent(c)},WebSocket.prototype.__createSimpleEvent=function(a){if(document.createEvent&&window.Event){var c=document.createEvent("Event");c.initEvent(a,!1,!1);return c}return{type:a,bubbles:!1,cancelable:!1}},WebSocket.prototype.__createMessageEvent=
function(a,c){if(window.MessageEvent&&"function"==typeof MessageEvent&&!window.opera)return new MessageEvent("message",{view:window,bubbles:!1,cancelable:!1,data:c});if(document.createEvent&&window.MessageEvent&&!window.opera){var d=document.createEvent("MessageEvent");d.initMessageEvent("message",!1,!1,c,null,null,window,null);return d}return{type:a,data:c,bubbles:!1,cancelable:!1}},WebSocket.CONNECTING=0,WebSocket.OPEN=1,WebSocket.CLOSING=2,WebSocket.CLOSED=3,WebSocket.__isFlashImplementation=!0,
WebSocket.__initialized=!1,WebSocket.__flash=null,WebSocket.__instances={},WebSocket.__tasks=[],WebSocket.__nextId=0,WebSocket.loadFlashPolicyFile=function(a){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(a)})},WebSocket.__initialize=function(){if(!WebSocket.__initialized)if(WebSocket.__initialized=!0,WebSocket.__swfLocation&&(window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation),window.WEB_SOCKET_SWF_LOCATION){if(!window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&!WEB_SOCKET_SWF_LOCATION.match(/(^|\/)WebSocketMainInsecure\.swf(\?.*)?$/)&&
WEB_SOCKET_SWF_LOCATION.match(/^\w+:\/\/([^\/]+)/)){var b=RegExp.$1;location.host!=b&&a.error("[WebSocket] You must host HTML and WebSocketMain.swf in the same host ('"+location.host+"' != '"+b+"'). See also 'How to host HTML file and SWF file in different domains' section in README.md. If you use WebSocketMainInsecure.swf, you can suppress this message by WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR = true;")}b=document.createElement("div");b.id="webSocketContainer";b.style.position="absolute";WebSocket.__isFlashLite()?
(b.style.left="0px",b.style.top="0px"):(b.style.left="-100px",b.style.top="-100px");var c=document.createElement("div");c.id="webSocketFlash";b.appendChild(c);document.body.appendChild(b);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:!0,swliveconnect:!0,allowScriptAccess:"always"},null,function(b){b.success||a.error("[WebSocket] swfobject.embedSWF failed")})}else a.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf")},
WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash");WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var a=0;a<WebSocket.__tasks.length;++a)WebSocket.__tasks[a]();WebSocket.__tasks=[]},0)},WebSocket.__onFlashEvent=function(){setTimeout(function(){try{for(var b=WebSocket.__flash.receiveEvents(),c=0;c<b.length;++c)WebSocket.__instances[b[c].webSocketId].__handleEvent(b[c])}catch(d){a.error(d)}},
0);return!0},WebSocket.__log=function(b){a.log(decodeURIComponent(b))},WebSocket.__error=function(b){a.error(decodeURIComponent(b))},WebSocket.__addTask=function(a){WebSocket.__flash?a():WebSocket.__tasks.push(a)},WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes)return!1;var a=window.navigator.mimeTypes["application/x-shockwave-flash"];return!a||!a.enabledPlugin||!a.enabledPlugin.filename?!1:a.enabledPlugin.filename.match(/flashlite/i)?!0:!1},window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION||
swfobject.addDomLoadEvent(function(){WebSocket.__initialize()}))})();
var GameBelowFold={isSetup:!1,setup:function(){this.isSetup||($j("#highscoresholder").on("change","#stat_selector",function(a){a.preventDefault();a=$j(this).val();GameBelowFold.updateScores(a,1,"today_page")}),$j("#highscoresholder").on("click",".js-high-scores-paginate",function(a){a.preventDefault();var b=$j(this);a=b.data("statistic-id");var c=b.data("page"),b=b.data("page-param");GameBelowFold.updateScores(a,c,b)}),$j("#highscoresholder").on("click",".tab_title.dormant",function(a){a.preventDefault();
$j("#highscoresholder dd.tab_box").html('<span class="spinner spinner_big">Loading...</span>');GameBelowFold.updateScores($j("#stat_selector").val(),1,$j(a.currentTarget).data("tab")+"_page")}),this.isSetup=!0)},updateScores:function(a,b,c){a={game_id:active_user.gameId(),statistic_id:a,page_param:c};a[c]=b;$j.get("/high_scores/game_below_fold",a,function(a){$j("#highscoresholder").html(a)})}},CinematicMode={initialize:function(a){this._disallow_cinematic_scaling=a;this._cinematic_mode_active=this._hooked_up_cinematic_mode_link=
!1;this._suppress_room_not_found=null;this._showingCinematicMessage=!1;this._cinematic_messages=[];this._game_standard_layout=null},hookUpCinematicQuicklink:function(){this._hooked_up_cinematic_mode_link||($("cinematic_mode_link").removeClassName("disabled"),$("cinematic_mode_link").observe("click",function(a){a.stop();CinematicMode.activateCinematicMode()}),this._hooked_up_cinematic_mode_link=!0)},isInCinematicMode:function(){return $("play").hasClassName("cinematic_mode")},addCinematicMessage:function(a){this.isInCinematicMode()&&
($("cinematic_close_link").addClassName("alt"),this._cinematic_messages.push(a),this.showNextCinematicMessage())},gameElement:function(){return $("gamediv")||$("gameiframe")},gameWrapper:function(){return $("game_wrapper")||$("gameiframe")},showNextCinematicMessage:function(){if(!this._showingCinematicMessage&&0<this._cinematic_messages.length){this._showingCinematicMessage=!0;var a=CinematicMode._cinematic_messages.shift();$("game").insert('<p id="overlay_message" class="cinematic_alert" style="opacity:0;"><span class="spritegame cinematic_alert_ico mrm"></span><span class="cinematic_alert_text">'+
a+"</span></p>");$("overlay_message").fade({duration:2,from:0,to:1,afterFinish:function(){setTimeout(function(){$("overlay_message").fade({duration:2,from:1,to:0,afterFinish:function(){$("overlay_message")&&($("overlay_message").remove(),$("cinematic_close_link").removeClassName("alt"));CinematicMode._showingCinematicMessage=!1;CinematicMode.showNextCinematicMessage()}})},3E4)}});this.refreshCinematicLayout()}},activateCinematicMode:function(){if(!this._cinematic_mode_active)if(active_user.isAuthenticated()){holodeck.recordAnalyticsEvent("CinematicMode",
"Enter");var a=$("play");a.addClassName("cinematic_mode");a.insert({top:(new Element("div")).addClassName("cinematic_overlay")});$("cinematic_close_link").show();document.viewport.getDimensions();$("game").getLayout();110<$("game").cumulativeOffset()[1]&&($("play").hasClassName("premium_user")?$("game").setStyle({top:"50px"}):$("game").setStyle({top:"130px"}));this._game_standard_layout=this.gameWrapper().getLayout();$("cinematic_close_container").setStyle({width:this._game_standard_layout.get("width")+
"px"});Event.observe(document,"click",this.handleClickInCinematicMode);window.scrollTo(0,0);Event.observe(window,"resize",this.refreshCinematicLayout);$$(".square_ad").each(function(a){a.hide()});this._cinematic_mode_active=!0;this.refreshCinematicLayout()}else active_user.activateInlineLogin({from_upsell:"cinematic_mode"},!0)},deactivateCinematicMode:function(){if(this._cinematic_mode_active){holodeck.recordAnalyticsEvent("CinematicMode","Exit");this._cinematic_mode_active=!1;Event.stopObserving(window,
"resize",this.refreshCinematicLayout);Event.stopObserving(document,"click",this.deactivateCinematicMode);if(!CinematicMode._disallow_cinematic_scaling){var a=this._game_standard_layout;this.gameWrapper().setStyle({width:a.get("width")+"px",height:a.get("height")+"px"});$("cinematic_close_container").setStyle({width:a.get("width")+"px"})}$("play").removeClassName("cinematic_mode");$("cinematic_close_link").hide();$$(".cinematic_overlay").each(Element.remove);$("play").removeClassName("cinematic_small");
$$(".square_ad").each(function(a){a.show()});$("game").setStyle({left:"",top:"",width:this._game_standard_layout.get("width")+"px"})}this._cinematic_messages=[];$("cinematic_close_link").removeClassName("alt");$("overlay_message")&&$("overlay_message").remove();$("play").removeClassName("cinematic_mode");$("cinematic_close_link").hide();$$(".cinematic_overlay").each(Element.remove);$$(".square_ad").each(function(a){a.show()})},handleClickInCinematicMode:function(a){if(!a.findElement("#gamediv")&&
!a.findElement("#gameiframe")){var b=CinematicMode,c=b.gameWrapper(),d=c.getDimensions(),c=c.cumulativeOffset(),e=a.pointerX();a=a.pointerY();e>c.left-30&&e<c.left+d.width+30&&a>c.top-30&&a<c.top+d.height+30||b.deactivateCinematicMode()}},refreshCinematicLayout:function(){var a=CinematicMode;if(a._cinematic_mode_active){if(!a._disallow_cinematic_scaling){var b=50;$("play").hasClassName("premium_user")&&(b=80);var c=a._game_standard_layout,d=c.get("width")/c.get("height"),e=document.viewport.getWidth()-
110,f=e/d,h=a.gameElement().viewportOffset();f+h.top+b>document.viewport.getHeight()&&(f=document.viewport.getHeight()-h.top-b,e=f*d);e<c.get("width")&&(e=c.get("width"),f=c.get("height"));a.gameWrapper().setStyle({width:e.toFixed()+"px",height:f.toFixed()+"px"})}a=$("gamediv")||$("gameiframe");b=a.getWidth()+60;$("cinematic_close_container").setStyle({width:b+"px"});$("game").setStyle({width:b+"px"});a=(document.viewport.getWidth()-a.getWidth()-60)/2;b=document.viewport.getDimensions().height;$("game").setStyle({left:Math.max(0,
a)+"px"});b>$("game").getHeight()+129?$("play").hasClassName("cinematic_small")||$("play").addClassName("cinematic_small"):$("play").hasClassName("premium_user")&&b>$("game").getHeight()+39?$("play").hasClassName("cinematic_small")||$("play").addClassName("cinematic_small"):$("play").hasClassName("cinematic_small")&&$("play").removeClassName("cinematic_small");if(a=$("overlay_message"))b=$("cinematic_close_container").getWidth(),c=($("game").getWidth()-20-b)/2,a.setStyle({width:b+"px",left:c+"px"})}}};
KONGREGATE={};
KONGREGATE.cloudSavesHandler=function(){var a={SYNC:"sync",REMOTE_ONLY:"remoteOnly",LOCAL_ONLY:"localOnly"},b={},c=[],d=[],e,f="gamediv";return{MODES:a,clearConfig:function(a){b={}},configure:function(a){$j.extend(b,a)},swf:function(){return $j("#"+f)[0]},setSwfObjectId:function(a){null!==a&&("undefined"!=typeof a&&""!==a)&&(f=a)},enterConflict:function(){b.mode===a.SYNC&&this.swf().enterConflict();this.runConflictCallbacks()},addConflictCallback:function(a){d.push(a)},runConflictCallbacks:function(){$j.each(d,function(a,
b){setTimeout(function(){b()},0)})},readAllSyncedSharedObjectKeys:function(){return b.syncedSharedObjects.keys()},determineSyncMode:function(c,d,f,q){e=d;if(b.mode)return this.runModeDeterminedCallbacks(b.mode,f),b.mode;if(!b.enabled)return b.mode=a.LOCAL_ONLY,!this.getUserId()&&q&&this.runModeDeterminedCallbacks(b.mode,f,q),b.mode;b.mode=c&&!d||f?a.LOCAL_ONLY:a.SYNC;this.runModeDeterminedCallbacks(b.mode,f);return b.mode},addModeDeterminedCallback:function(a){c.push(a)},runModeDeterminedCallbacks:function(a,
b,d){$j.each(c,function(c,e){setTimeout(function(){e(a,b,d)},0)})},getSyncMode:function(){return b.mode},getSyncedSharedObject:function(a){return b.syncedSharedObjects.get(a)},updateSyncedSharedObject:function(a,c){var d={};d[a]=c;b.syncedSharedObjects.processData({data:d,watermark:b.syncWatermark})},clearSyncedSharedObject:function(a){b.syncedSharedObjects.clear(a,b.syncWatermark)},getSyncedSharedObjectWatermark:function(){return b.syncWatermark},setSyncedSharedObjectWatermark:function(a){b.syncWatermark=
a},getUserId:function(){return b.userId},getUsername:function(){return b.username},forceUpdates:function(){this.swf().resolveConflict();b.syncedSharedObjects.forceUpdates()},zeroLocalMetadata:function(){this.swf().resolveConflict();this.swf().zeroLocalMetadata()},touchLocalMetadata:function(){this.swf().touchLocalMetadata()},localWatermark:function(){return e},pollData:function(){return this.swf().pollData()},beginPolling:function(){setInterval(KONGREGATE.cloudSavesHandler.processData,Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME)},
processData:function(){b.syncedSharedObjects.processData(KONGREGATE.cloudSavesHandler.pollData())},flush:function(c){b.mode!==a.LOCAL_ONLY&&"undefined"!==typeof b.syncedSharedObjects&&b.syncedSharedObjects.flush(KONGREGATE.cloudSavesHandler.pollData(),c)}}}();
(function(){function a(){try{lightbox.prototype.deactivate()}catch(a){}}"undefined"!=typeof cloudSaves&&cloudSaves&&active_user.addRunWhenAuthenticatedObserver(function(b){b.isPremium()&&null===b.areCloudSavesEnabled()&&(lightbox.prototype.initializeKongregateLightboxFromAjax("/cloud_saves_preference/new",{done_class_name:"kred_purchase lightbox_login cloud_lb",afterStaticContentLoad:function(){$j(".js-cloud-saves-game-name").text(active_user.gameName())}}),$j(document).on("click",".js-cloud-saves-preference",
function(b){b=$j(b.target);var d=b.data("enabled");b.parent("p").html('<span class="spinner">Loading...</span>');$j.ajax("/cloud_saves_preference",{type:"post",data:{cloud_saves_preference:{enabled:d}}}).done(function(){d?window.location.reload():a()}).fail(function(){a()})}))})}).runWhenReady();
var GameIframe=function(a,b,c){active_user.forceSSLIframe()&&(Kongregate.Log.warn("Forcing SSL iframe"),a.iframe_url&&(a.iframe_url=a.iframe_url.replace(/^http:/,"https:")),a.iframe_host&&(a.iframe_host=a.iframe_host.replace(/^http:/,"https:")));this.config=a;this.urlOptions=b;this.channelId=c};
GameIframe.prototype.createGameIframeElement=function(){var a=new Element("iframe",{id:"gameiframe",name:"gameiframe",style:"border:none;position:relative;z-index:1;",scrolling:"auto",border:0,frameborder:0,style:"width: "+this.config.game_width+"px; height: "+this.config.game_height+"px; position: absolute; top: "+this.config.game_top+"px; left: "+this.config.game_left+"px;","class":this.config.iframe_class,allowfullscreen:!this.config.max_game_height});$("gameiframe").replace(a);this.getGameIframeUrl(function(b){a.contentWindow.location.replace(b)});
if(this.config.post_message){var b=function(b){b.origin===this.config.iframe_host&&"kongregate_request_params"===b.data&&(b={type:"params",data:this.iframeOptions()},Kongregate.PostMessage.supportsObjects()||(b=JSON.stringify(b)),a.contentWindow.postMessage(b,this.config.iframe_host))}.bind(this);Kongregate.PostMessage.addMessageListener(window,b)}this.config.max_game_width&&this.config.max_game_height&&(function(){this.setSizeToMaxForWindow()}.bind(this).runWhenGameLoaded(),document.observe("holodeck:ready",
function(a){this.setSizeToMaxForWindow()}.bind(this)),$j(window).resize(function(a){this.setSizeToMaxForWindow()}.bind(this)));this.setupErrorListener()};
GameIframe.prototype.getGameIframeUrl=function(a){var b=this,c=window.location.search.match(/forceWebPlayer/);unityObject.detectUnity(function(d){var e=b.config.iframe_url;d="installed"===d||"running"===d;"unity"===b.config.game_type&&(b.config.alternate_game_file_url&&!c?(e=b.config.alternate_game_file_url,b.config.iframe_host=e.split("/",3).join("/")):d||(e=window.location.protocol+"//"+window.location.host+window.location.pathname+"/browser_upsell",document.observe("holodeck:ready",function(a){b.setSize(800,
800)})));b.config.post_message||(e+=0>e.indexOf("?")?"?":"&",e+=Object.toQueryString(b.iframeOptions()));a(e)})};
GameIframe.prototype.iframeOptions=function(){var a={DO_NOT_SHARE_THIS_LINK:1,kongregate_username:active_user.username(),kongregate_user_id:active_user.id(),kongregate_game_auth_token:active_user.gameAuthToken(),kongregate_game_id:this.config.game_id,kongregate_host:this.config.host,kongregate_game_url:this.config.game_url,kongregate_api_host:this.config.api_host,kongregate_channel_id:this.config.channel_id,kongregate_api_path:this.config.api_path,kongregate_ansible_path:this.config.ansible_path,
kongregate_preview:this.config.preview,kongregate_game_version:this.config.game_version,kongregate_language:active_user.currentLocale().slice(0,2),preview:this.config.preview,kongregate_split_treatments:encodeURIComponent(active_user.gameSplitTreatments(this.config.game_permalink)),kongregate:!0,kongregate_svid:active_user.siteVisitorUID(),kongregate_analytics_mode:this.config.analytics_mode,kongregate_debug_level:active_user.debugLevel(),kongregate_js_api:!0,kongregate_flash_postmessage:active_user.flashPostMessageEnabled(),
KEEP_THIS_DATA_PRIVATE:1},b=$H(location.search.toQueryParams()).merge(this.urlOptions.toQueryParams()).toObject();"true"===String(this.config.auto_resize)&&(a.kongregate_auto_resize=!0);for(var c in b)if(0===c.indexOf("guest_access_key")||0===c.indexOf(this.config.flash_var_prefix))a[c]=b[c];return a};
GameIframe.prototype.setSizeToMaxForWindow=function(){this.setSize(Math.max(this.config.game_width,Math.min($j(window).width()-333,this.config.max_game_width)),Math.max(this.config.game_height,Math.min($j(window).height()-150,this.config.max_game_height)))};
GameIframe.prototype.setSize=function(a,b){var c=["flashframecontent","maingamecontent","maingame"],d=["gameholder","game"],e=$("maingame");if(e){var f=e.getLayout(),h=$("gameiframe").getLayout(),e=Math.max(620,a);Math.max(527,b);f.get("width");h.get("width");var h=f.get("height")-h.get("height"),f=Math.max(e+300,923),l=b+h,h=null,h=$("gameiframe");h.style.width=a+"px";h.width=a;h.style.height=b+"px";h.height=b;for(var g=0;g<d.length;g++)h=$(d[g]),h.style.width=e+"px",h.width=e,h.style.height=b+"px",
h.height=b;for(g=0;g<c.length;g++)h=$(c[g]),h.style.width=f+"px",h.width=f,h.style.height=l+"px",h.height=l;if(c=$("chat_container"))c.style.height=l-26+"px",c.height=l-26;$$(".chat_message_window").each(function(a){a.style.height=l-283+"px";a.style["max-height"]=l-283+"px";a.height=l-283});$$(".tabpane").each(function(a){a.style.height=l-66+"px";a.height=l-66})}};
GameIframe.prototype.setupErrorListener=function(){if("undefined"!==typeof metricTracker){var a=function(a){var c;if("object"===typeof a.data&&(c=a.data.kongregateGameError))metricTracker.trackEvent("GamePage","Error",c.type,null,!0),Kongregate.Log.warn("Game error reported",c)}.bind(this);Kongregate.PostMessage.addMessageListener(window,Kongregate.Utils.catchErrors(a,this))}};
Kongregate.SyncedSharedObjects=function(a,b,c,d){function e(){!A&&!m&&(A=setTimeout(function(){A=null;f()},Math.max(Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME,v-1E3*new Date)))}function f(){m=null;$j.extend(u,s);s={};v=Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME+1E3*new Date;$j.ajax(a,{type:"POST",data:{updates:JSON.stringify(u),watermark:x,load_watermark:c,debug:d},beforeSend:function(){$j.each(l,function(a,b){setTimeout(b,0)});return!0},complete:function(a,b){var c="success"===b;
$j.each(g,function(a,b){setTimeout(function(){b(c)},0)});return!0},success:function(){$j.extend(h,u);u={};n=0;$j.isEmptyObject(s)||e()},error:function(a){409==a.status?($j.each(q,function(a,b){setTimeout(b,0)}),n=0):401==a.status?n=0:(m=setTimeout(f,1E3*Math.pow(2,n)),n++)}})}var h=b||{},l=[],g=[],q=[],u={},s={},x,m=null,n=0,A,v=0,z=this;this.processData=function(a){x=a.watermark;$j.extend(s,a.data);$j.isEmptyObject(s)||e()};this.get=function(a){return h[a]};this.clear=function(a,b){delete h[a];clearData=
{};clearData[a]=null;z.processData({data:clearData,watermark:b})};this.flush=function(b,e){clearTimeout(A);clearTimeout(m);$j.extend(u,s);b&&($j.extend(u,b.data),x=b.watermark);s={};$j.isEmptyObject(u)?e&&e():$j.ajax(a,{type:"POST",async:!!e,data:{updates:JSON.stringify(u),watermark:x,load_watermark:c,debug:d},success:e})};this.keys=function(){var a=[];$j.each(h,function(b,c){a.push(b)});return a};this.retryCount=function(){return n};this.addSyncStartedCallback=function(a){l.push(a)};this.addSyncEndedCallback=
function(a){g.push(a)};this.addConflictCallback=function(a){q.push(a)};this.forceUpdates=function(){x=c=+new Date;f()};this.hasActiveRetry=function(){return null!==m}};Kongregate.SyncedSharedObjects.REQUEST_WAIT_TIME=5E3;Kongregate.SyncedSharedObjects.REQUEST_COOLDOWN_TIME=6E4;
Kongregate.GameLoader=function(a,b,c){function d(){"undefined"===typeof active_user||("function"!==typeof active_user.areCloudSavesEnabled||"undefined"===typeof cloudSaves||"undefined"===typeof cloudSaves.syncedSharedObjects||!active_user.areCloudSavesEnabled()||h)||(KONGREGATE.cloudSavesHandler.flush(),h=!0)}var e,f=!1,h=!1,l=this;if(KONGREGATE.cloudSavesHandler)if(void 0!==window.onbeforeunload)$j(window).on("beforeunload.cloud_saves",d);else $j(window).on("unload.cloud_saves",d);this.refreshCloudData=
function(a){$j.ajax({url:b,success:function(b){cloudSaves=b;a()}})};this.loadGame=function(d){b&&"undefined"!==typeof cloudSaves&&("undefined"!==typeof cloudSaves.syncedSharedObjects?cloudSaves.syncedSharedObjects.constructor!==Kongregate.SyncedSharedObjects&&(e=new Kongregate.SyncedSharedObjects(b,cloudSaves.syncedSharedObjects,cloudSaves.loadWatermark,c),cloudSaves.syncedSharedObjects=e,e.addSyncStartedCallback(Kongregate.CloudSavesController.syncStarted.bind(Kongregate.CloudSavesController)),e.addSyncEndedCallback(Kongregate.CloudSavesController.syncEnded.bind(Kongregate.CloudSavesController)),
e.addConflictCallback(KONGREGATE.cloudSavesHandler.enterConflict.bind(KONGREGATE.cloudSavesHandler))):(e=new Kongregate.SyncedSharedObjects(b,{}),cloudSaves.syncedSharedObjects=e,c||active_user.addRunWhenAuthenticatedObserver(Kongregate.CloudSavesController.userAuthenticated.bind(Kongregate.CloudSavesController))),f||(KONGREGATE.cloudSavesHandler.addModeDeterminedCallback(Kongregate.CloudSavesController.modeDetermined.bind(Kongregate.CloudSavesController)),KONGREGATE.cloudSavesHandler.addConflictCallback(Kongregate.CloudSavesController.handleConflict.bind(Kongregate.CloudSavesController)),
f=!0),c&&(cloudSaves.mode="debug"),KONGREGATE.cloudSavesHandler.configure(cloudSaves));a(d)};this.reloadCloudSaves=function(){this.refreshCloudData(function(){l.loadGame()})};this.forceUpdate=function(){e.forceUpdate()};this.setSyncMode=function(a){KONGREGATE.cloudSavesHandler.configure({mode:a});this.loadGame()};this.getSyncMode=function(){return KONGREGATE.cloudSavesHandler.getSyncMode()};this.upgradeToSync=function(a){"localOnly"===this.getSyncMode()&&!a?(KONGREGATE.cloudSavesHandler.touchLocalMetadata(),
this.setSyncMode("sync")):a?l.refreshAndSync():KONGREGATE.cloudSavesHandler.flush(function(){l.refreshAndSync()})};this.reloadGame=function(){KONGREGATE.cloudSavesHandler.clearConfig();this.loadGame()};this.refreshAndSync=function(){l.refreshCloudData(function(){KONGREGATE.cloudSavesHandler.zeroLocalMetadata();l.setSyncMode("sync")})}};
var GameMetricsUpdater=function(){return{update:function(){new Ajax.Request(active_user.gameResourcePath()+"/metrics.json",{method:"get",onSuccess:function(a){a=a.responseJSON;[[".favorites_count",a.favorites_count_with_delimiter],[".gameplays_count",a.gameplays_count_with_delimiter],["#game_statistics",a.game_statistics],[".average_rating",a.average_rating_text],[".average_rating_with_count",a.average_rating_with_count],["#rating_message",a.rating_message],["#below_game_rating_message",a.below_game_rating_message],
["#star_ratings_block",a.user_rating],["#below_game_star_ratings_block",a.below_game_user_rating],["#quicklinks_star_ratings_block",a.quicklinks_user_rating],[".flag_game",a.flagged],["#favorite_game",a.favorite_message],["#below_game_favorite_game",a.below_game_favorite_message],["#quicklinks_favorite_block",a.quicklinks_favorite_message],["#quicklinks_play_later_block",a.quicklinks_play_later_message],["#below_game_play_later_block",a.below_game_play_later_message],["#user_donation_holder",a.last_tip_message],
["#combined_favorites_js",a.combined_favorites_js],["#game_block",a.block_game_js]].each(function(a){var c=a[0],d=a[1];d&&$$(c).each(function(a){a.update(d)})});holodeck._user_rating=a.user_rating_value},onFailure:function(a){console.error("Error loading game metrics: %o",a.responseText)}})}}}();
(function(){HyprMXAdManager=function(a){this.initialize(a)};HyprMXAdManager.AD_AVAILABLE_URL="https://live.hyprmx.com/embedded_offers/videos_available_jsonp?";HyprMXAdManager.EMBED_AD_URL="https://live.hyprmx.com/embedded_offers/player?";HyprMXAdManager.AD_COMPLETE_WAIT_TIME=5E3;HyprMXAdManager.prototype={initialize:function(a){this._distributorId=a.distributorId;this._site=a.site;this._enabled=!(!a.distributorId||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._serviceNotified=this._adCompleted=
!1},setReceiver:function(a){this._receiver=a},readyForAds:function(){this._enabled&&this._distributorId&&this._checkForAds()},handleHyprMXResponse:function(a){a?(Kongregate.Log.info("HyprMX: ad available"),this._receiver.onCampaignsReady()):(Kongregate.Log.info("HyprMX: no ad available for this user"),this._receiver.onNoAdAvailable())},onAdComplete:function(){Kongregate.Log.info("HyprMX ad complete!");this._adCompleted=!0;this._trackMetricsEvent("IncentivizedAdFinish");this._receiver.onCampaignCompleted();
this._loadPostAdContentIntoLightbox()},onAdClose:function(){Kongregate.Log.info("HyprMX ad closed");this._serviceNotified||(this._receiver.onCampaignClose(),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon"));this._checkForAds()},showAd:function(){this._serviceNotified=this._adCompleted=!1;Kongregate.Log.info("HyprMX: show ad");var a={distributorid:this._distributorId,uid:active_user.siteVisitorUID(),partner_code:active_user.gameId(),site:this._site},a=HyprMXAdManager.EMBED_AD_URL+
Object.toQueryString(a);this._trackMetricsEvent("IncentivizedAdStart");var b=this;lightbox.prototype.initializeHyprMXVideoFrame(a,function(){b.onAdClose()},{width:800,height:550})},_checkForAds:function(){var a={distributorid:this._distributorId,uid:active_user.siteVisitorUID()},a=HyprMXAdManager.AD_AVAILABLE_URL+Object.toQueryString(a);this._loadScript(a)},_loadScript:function(a){$j.getScript(a)},_loadPostAdContentIntoLightbox:function(){var a=$j("<div>",{id:"hyprmx_complete"});a.append($j("<p>").text("Thanks for watching!"));
var b=$j("<input>",{type:"button",value:"Close"});b.addClass("btn btn_action");b.click(function(){lightbox.prototype.shutdown()});a.append(b);setTimeout(function(){lightbox&&lightbox.prototype&&lightbox.prototype.updateWithContent(a);$j("#lightbox").removeClass("hyprmx_video").addClass("lightbox_login")},HyprMXAdManager.AD_COMPLETE_WAIT_TIME)},_trackMetricsEvent:function(a){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",a)}}})();
function IMAVideoBumper(a){this.initialize(a)}IMAVideoBumper.AD_BLOCK_TIMEOUT=5E3;IMAVideoBumper.CLOSE_LINK_TIMEOUT=1E4;IMAVideoBumper.ON_COMPLETE_PAUSE=1E3;IMAVideoBumper.CLOSE_LINK_FADE_IN=1E3;IMAVideoBumper.FAILSAFE_TIMEOUT=12E4;
IMAVideoBumper.prototype={initialize:function(a){this._targetingParams=a.targetingParams;this._baseUrl=a.baseUrl;this._metricTracker=a.metricTracker;this._topKredsGame=!1;this._targetingParams&&this._targetingParams.gamegroup&&(this._targetingParams.gamegroup.include("top-kreds")&&(this._topKredsGame=!0),this._targetingParams.gamegroup.include("no-preroll")&&(this._suppressPrerollGroup=!0))},loadGame:function(a){if(a&&this.getsBumper())this.showPreroll();else this.onComplete()},hasBadIEVersion:function(){return Prototype.Browser.IE9||
Prototype.Browser.IE8||Prototype.Browser.IE7},suppressForTopKredsGame:function(){return!this._topKredsGame?!1:active_user.inTopKredGracePeriod()},getsBumper:function(){return this._suppressPrerollGroup||this.hasBadIEVersion()||active_user.getsRegistrationLightbox()||active_user.isPremium()||this.suppressForTopKredsGame()?!1:!0},showPreroll:function(){this.trackEvent("PrerollInitiated");this.adBlockTimeout=setTimeout(this.abortAd.bind(this),IMAVideoBumper.AD_BLOCK_TIMEOUT);this.failsafeTimeout=setTimeout(this.reachedFailsafe.bind(this),
IMAVideoBumper.FAILSAFE_TIMEOUT);$j("#noflash").is(":visible")&&(this.hidFlashMessage=!0,$j("#noflash").hide());$j("#bumper_premium_header").show();$j("#ad_skip_controls").show();$j("#ima_bumper").show();$j("#game").css("visibility","hidden");$j("#bumper_premium_header").show();this.createAdPlayer();this.player.play()},createAdPlayer:function(){this.player=videojs("ima_bumper");this.player.ima({id:"ima_bumper",debug:null===window.location.hostname.match(/kongregate\.com/),adTagUrl:this.createAdTagUrl()});
this.setupEventListeners();this.player.ima.requestAds();var a=$j("#game").height()-$j("#bumper_premium_header").height()-$j("#ad_skip_controls").height();$j("#ima_bumper").css("height",a)},createAdTagUrl:function(){this._convertTargetingArraysToStrings();return this.adTagUrl=this._baseUrl+"&cust_params="+encodeURIComponent(decodeURIComponent($j.param(this._targetingParams)))},setupEventListeners:function(){this.player.on("adend",this.onAdEnd.bind(this));this.player.on("adserror",this.onComplete.bind(this));
this.player.on("adsready",this.onAdsReady.bind(this))},trackEvent:function(a){this._metricTracker&&this._metricTracker.trackEvent("GamePage",a)},onAdsReady:function(){this.trackEvent("PrerollAdsReady");clearTimeout(this.adBlockTimeout);active_user.isAuthenticated()&&!active_user.inCloseLinkTest()&&setTimeout(this.showCloseLink,IMAVideoBumper.CLOSE_LINK_TIMEOUT)},onAdEnd:function(){this.trackEvent("PrerollEnded");this.clearFailsafeTimeout();this.onComplete()},showCloseLink:function(){var a=$j("#bumper_close_link");
a.click(function(){setTimeout(window.imaVideoBumper.closeAd.bind(window.imaVideoBumper),0)});a.fadeIn(IMAVideoBumper.CLOSE_LINK_FADE_IN)},abortAd:function(){this.trackEvent("PrerollAdLoadAborted");this.clearFailsafeTimeout();this.onComplete()},closeAd:function(){this.trackEvent("PrerollAdSkipped");this.clearFailsafeTimeout();this.onComplete()},reachedFailsafe:function(){this.trackEvent("PrerollFailsafeTimeoutReached");this.onComplete()},clearFailsafeTimeout:function(){clearTimeout(this.failsafeTimeout)},
onComplete:function(){var a=this;setTimeout(function(){$j("#bumper_premium_header").remove();try{$j("#ima_bumper").remove()}catch(b){}$j("#ad_skip_controls").remove();$j("#game").css("visibility","visible");activateGame();a.hidFlashMessage&&$j("#noflash").show()},IMAVideoBumper.ON_COMPLETE_PAUSE)},_convertTargetingArraysToStrings:function(){var a=this;$j.each(this._targetingParams,function(b,c){Array.isArray(c)&&(a._targetingParams[b]=c.join(","))})}};
function GameLoadObserver(a){this.initialize(a)}
GameLoadObserver.prototype=function(){return{initialize:function(a){this._loaded=!1;this._startTime=(new Date).getTime();this._timeout=a.timeout||3E3;this._interval=null;this._debug=a.debug;this._queue=[];this.startObserving.bind(this).runWhenDomLoaded()},percentLoaded:function(){if($("gamediv"))try{return $("gamediv").PercentLoaded()}catch(a){return-1}},observeGameLoad:function(){var a=(new Date).getTime()-this._startTime,b=a>=this._timeout,c=this.percentLoaded();0<c||b?(this._debug&&console.log("Firing onGameLoaded, percentLoaded: "+
c+", timeElapsed: "+a+", timedOut: "+b),this.onGameLoaded()):0>c&&(this._debug&&console.log("Firing onGameLoaded, no flash gamediv found, percentLoaded: "+c+", timeElapsed: "+a),this.onGameLoaded())},onGameLoaded:function(){this._loaded||(this._loaded=!0,clearInterval(this._interval),this._queue.each(function(a){a.defer()}),this._queue=[])},runWhenGameLoaded:function(a){this._loaded?a.defer():this._queue.push(a)},startObserving:function(){this._interval&&clearInterval(this._interval);this._interval=
setInterval(this.observeGameLoad.bind(this),100)}}}();Function.prototype.runWhenGameLoaded=function(){window.gameLoadObserver?window.gameLoadObserver.runWhenGameLoaded(this):this.runWhenDomLoaded()};window.gameLoadObserver=new GameLoadObserver({timeout:2E3,debug:!1});function ShareWithUsersTab(a,b,c){this.initialize(a,b,c)}
ShareWithUsersTab.prototype={initialize:function(a,b,c){this._share_dialog=b;this._tab_id=a;this._current_page=0;this._request_more_func=c;(a=$(a+"_tab"))&&a.observe("click",this.handleShowTab.bindAsEventListener(this))},getMore:function(){this._current_page++;this._request_more_func();$(this._tab_id+"_indicator").show()},handleShowTab:function(a){this.refreshSelected()},handleScroll:function(a){$(this._tab_id).scrollTop+$(this._tab_id).getHeight()>=$(this._tab_id).scrollHeight&&(Event.stopObserving($(this._tab_id),
"scroll"),this.getMore())},onRequestSuccess:function(){$(this._tab_id).observe("scroll",this.handleScroll.bindAsEventListener(this))},onRequestComplete:function(){$(this._tab_id+"_indicator").hide();this.refreshSelected()},refreshSelected:function(){for(var a=$(this._tab_id).select(".user"),b=0;b<a.length;++b){var c=a[b].select("#recipient_ids_").first();c.checked=this._share_dialog.isSelected(c.value);this._share_dialog.isSelected(c.value)?a[b].addClassName("selected"):a[b].removeClassName("selected")}}};
function ShareWithFriendsDialog(a){this.initialize(a)}
ShareWithFriendsDialog.prototype={initialize:function(a){this._selected_users=[];this._user_limit=a;this._error_msg_timer=this._search_box_timer=null;$("max_users_error").hide();$("new_game_invite_feed_item").setAttribute("action","javascript:;")},setRequestFunctions:function(a,b,c){this._friends_tab=new ShareWithUsersTab("share_with_friends",this,a);this._friends_tab.getMore();this._fans_tab=new ShareWithUsersTab("share_with_fans",this,b);this._fans_tab.getMore();this._chat_members_tab=new ShareWithUsersTab("share_with_chat_members",
this,c);this._chat_members_tab.getMore()},toggleSelected:function(a,b){var c=this.findSelected(a),d=!1;-1<c?(this._selected_users.splice(c,1),d=!0,$("error_messages").update("")):this._selected_users.length<this._user_limit?(this._selected_users.push({user_id:a,username:b}),d=!0,$("error_messages").update("")):this._selected_users.length>=this._user_limit&&($("max_users_error").show(),$("max_users_error").removeClassName("hidden"),null!==this._error_msg_timer&&clearTimeout(this._search_box_timer),
this._error_msg_timer=setTimeout(function(){this._error_msg_timer=null;$("max_users_error").hide()},2500));this.friends_tab&&this._friends_tab.refreshSelected();this._fans_tab&&this._fans_tab.refreshSelected();this._chat_members_tab&&this._chat_members_tab.refreshSelected();$("selected_users").update(this.selectedUsersMessage());$("recipients").value=this.getSelectedUserIds();return d},selectedUsersMessage:function(){var a=this._selected_users.length;return 0===a?"no users selected":1==a?this._selected_users[0].username+
" selected":2==a?this._selected_users[0].username+" and "+this._selected_users[1].username+" selected":3==a?this._selected_users[0].username+", "+this._selected_users[1].username+" and "+this._selected_users[2].username+" selected":4==a?this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and 1 other user selected":this._selected_users[0].username+", "+this._selected_users[1].username+", "+this._selected_users[2].username+" and "+(a-3)+" other users selected"},
refreshSearchDropdown:function(){for(var a=$$(".recipient_chooser").first().select(".user"),b=0;b<a.length;++b){var c=eval("("+a[b].down(".metadata").innerHTML+")");this.isSelected(c.user_id)?a[b].addClassName("chosen"):a[b].removeClassName("chosen")}},searchUserSelected:function(a){var b=shareWithFriendsDialog.toggleSelected(a.user_id,a.username);$("recipient_search").value="";b&&($("recipient_search_container").hide(),this.isSelected(a.user_id)?$("recipient_list_updated_msg").innerHTML=a.username+
" was added to the recipient list":$("recipient_list_updated_msg").innerHTML=a.username+" was removed from the recipient list",$("recipient_list_updated_msg").show(),null!==this._search_box_timer&&clearTimeout(this._search_box_timer),this._search_box_timer=setTimeout(function(){this._search_box_timer=null;$("recipient_list_updated_msg").hide();$("recipient_search_container").show()},2500))},findSelected:function(a){for(var b=0;b<this._selected_users.length;b++)if(this._selected_users[b].user_id==
a)return b;return-1},isSelected:function(a){return-1<this.findSelected(a)},getSelectedUserIds:function(){for(var a="",b=0;b<this._selected_users.length;++b)a+=this._selected_users[b].user_id,b+1<this._selected_users.length&&(a+=",");return a}};
SharedLinksController=function(a){this.container=$(a.id);this.select=this.container.down("select");this.checkbox=this.container.down("input[type=checkbox]");this.reload=this.container.down(".shared_link_reload");this.url=a.url;this.out_of_links=this.fetching=!1;this.shown_items=0;this.addFormHandlers();this.addShowMoreHandler();this.addScrollHandler()};
SharedLinksController.prototype={fetch:function(a){if(!this.fetching){this.fetching=!0;var b=this,c=this.container.down("ul");$("shared_link_list_container");var d=this.select.getValue();a||(a={});"All"!=d&&(a.shared_link_type_id=d);new Ajax.Request(b.url,{method:"get",parameters:a,onCreate:function(){c.insert((new Element("li",{id:"shared_links_loading"})).insert((new Element("span",{"class":"spinner spinner_big"})).update("Loading...")));b.hideShowMoreLink()},onComplete:function(){$("shared_links_loading").remove();
b.fetching=!1},onSuccess:function(a){a=$A(a.responseJSON);var d;a.each(function(a){d=b.renderLink(a);c.insert(d);(b.showHidden()||!d.hasClassName("visited"))&&b.shown_items++});0<a.length&&(b.maxId=a.last().id);b.showShowMoreLink();25>a.length?(b.out_of_links=!0,b.shown_items=0):(b.out_of_links=!1,17>b.shown_items?(b.fetching=!1,b.fetch({max_id:b.maxId})):b.shown_items=0)}})}},renderLink:function(a){var b=$.jStorage.get(this.storageKey(a)),c=new Element("li",{id:"shared_link_"+a.id,"class":"shared_link"}),
d=(new Element("a",{"class":"shared_title_link"})).update(a.name),e;b&&(c.addClassName("visited"),this.showHidden()||c.hide());d.observe("click",this.handleClick.bindAsEventListener(this,a,c));c.insert((new Element("div",{"class":"shared_link_title truncate_one_line"})).insert(d));c.observe("click",function(){c.hasClassName("open")?c.removeClassName("open"):c.addClassName("open")});a.additional_params&&(c.addClassName("expandable"),e=new Element("dl",{"class":"link_info mvm"}),$H(a.additional_params.evalJSON()).each(function(a){e.insert((new Element("dt",
{"class":"truncate_one_line"})).update(a.key.stripTags()));e.insert((new Element("dd",{"class":"truncate_one_line"})).update(a.value.toString().stripTags()))}),c.insert(e));return c},handleClick:function(a,b,c){$("gameiframe")?activateGame(b.link_params):(a=$H(document.location.search.toQueryParams()).merge(b.link_params.toQueryParams()).toQueryString(),window.open(document.location.pathname+"?"+a,"_blank"));$.jStorage.set(this.storageKey(b),!0,{TTL:b.ttl});c.addClassName("visited");this.showHidden()||
c.hide()},addFormHandlers:function(){var a=this.container.down("ul");this.select.observe("change",function(){a.update();this.maxId=0;this.hideShowMoreLink();this.fetch()}.bind(this));this.reload.observe("click",function(){a.update();this.maxId=0;this.hideShowMoreLink();this.fetch()}.bind(this));this.checkbox.observe("change",function(){a.select("li.visited").invoke("Y"==this.checkbox.getValue()?"show":"hide")}.bind(this))},addShowMoreHandler:function(){$("shared_link_show_more").observe("click",function(){this.fetch({max_id:this.maxId});
this.hideShowMoreLink()}.bind(this))},showShowMoreLink:function(){$("shared_link_show_more").show()},hideShowMoreLink:function(){$("shared_link_show_more").hide()},storageKey:function(a){return active_user.gameId()+"-"+a.id},addScrollHandler:function(){var a=$("shared_link_show_more"),b=0,c=$("shared_link_list_container");c.observe("scroll",function(){var d=0===c.scrollTop?c.parentNode.scrollTop:c.scrollTop;!this.out_of_links&&(d+window.innerHeight>a.positionedOffset().top&&d>b)&&this.fetch({max_id:this.maxId});
b=d}.bind(this))},showHidden:function(){return"Y"==this.checkbox.getValue()}};
(function(){SupersonicAdManager=function(a){this.initialize(a)};SupersonicAdManager.prototype={initialize:function(a){this._key=a.key;this._element=a.element;this._enabled=!(!a.key||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._adCompleted=!1;if("gamediv"===this._element){var b=this;window.readyForAds=function(){b.readyForAds()}}},setReceiver:function(a){this._receiver=a},readyForAds:function(){if(this._enabled){var a=this;this._receiver||(this._receiver=$j("#"+this._element)[0]);
window.ssa_json={applicationUserId:active_user.siteVisitorUID(),applicationKey:this._key,fitToFrame:!0,verticalAlign:"top",scrollToEngagement:!0,onCampaignsReady:function(){a._receiver.onCampaignsReady.apply(a._receiver,arguments)},onCampaignsDone:function(){a._receiver.onCampaignsDone.apply(a._receiver,arguments)},onCampaignOpen:function(){a._adCompleted=!1;lightbox.prototype.hideHiddenElements();"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdStart")},onCampaignCompleted:function(){a._receiver.onCampaignCompleted.apply(a._receiver,
arguments);a._adCompleted=!0;"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdFinish")},onCampaignClose:function(){lightbox.prototype.showHiddenElements();a._receiver.onCampaignClose.apply(a._receiver,arguments);!a._adCompleted&&"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage","IncentivizedAdAbandon")}};this._loadScript()}},showAd:function(){this._enabled&&"undefined"!==typeof SSA_CORE&&SSA_CORE.BrandConnect.engage();lightbox.prototype.dispatchLightboxOpened({width:700,
height:800})},_loadScript:function(){var a=document.createElement("script"),b=document.getElementsByTagName("script")[0];a.async=!0;a.src="https://a248.e.akamai.net/ssastatic.s3.amazonaws.com/inlineDelivery/delivery.min.gz.js";b.parentNode.insertBefore(a,b)}}})();
(function(){TrueXAdManager=function(a){this.initialize(a)};TrueXAdManager.prototype={initialize:function(a){this._key=a.key;this._enabled=!(!a.key||!a.enabled||Prototype.Browser.IE7||Prototype.Browser.IE8);this._adCompleted=!1;this._truexActivity=this._truexClient=null;this._serviceNotified=!1},setReceiver:function(a){this._receiver=a},readyForAds:function(){this._enabled&&this._loadScript()},showAd:function(){this._serviceNotified=!1;Kongregate.Log.info("TrueX: show ad");var a=this,b=this._truexActivity;
lightbox.prototype.initializeTrueXVideoFrame(function(){a._truexClient.loadActivityIntoContainer(b,"truex_target")},a.onAdClose.bind(a),{width:960,height:600})},onAdClose:function(){this._serviceNotified||(this._receiver.onCampaignClose.apply(this._receiver,arguments),this._serviceNotified=!0,this._adCompleted||this._trackMetricsEvent("IncentivizedAdAbandon"));lightbox.prototype.shutdown()},onCreditEvent:function(a){if(a&&a.signature_argument_string&&a.signature){var b=this;$j.post("/truex_ad_engagements/verify_signature",
{sig_string:a.signature,arg_string:a.signature_argument_string},function(){b._adCompleted=!0;b._receiver.onCampaignCompleted.apply(b._receiver,arguments);b._trackMetricsEvent("IncentivizedAdFinish");Kongregate.Log.info("TrueX: ad credit received and verified");b._setUpClient()})}},_trackMetricsEvent:function(a){"undefined"!=typeof metricTracker&&metricTracker.trackEvent("GamePage",a)},_setUpClient:function(){var a={network_user_id:active_user.siteVisitorUID(),partner_config_hash:this._key,game_id:active_user.gameId(),
dimension_1:active_user.gameId()},b=this;truex.client(a,function(a){b._truexClient=a;b._truexClient.requestActivity(function(a){a?(b._truexActivity=a,a.onStart(function(a){b._adCompleted=!1;b._trackMetricsEvent("IncentivizedAdStart")}),a.onFinish(function(a){Kongregate.Log.info("TrueX: ad finish")}),a.onCredit(function(a){b.onCreditEvent(a)}),a.onClose(function(){b.onAdClose()}),b._receiver.onCampaignsReady.apply(b._receiver,arguments)):(Kongregate.Log.info("TrueX: No activity available for this user"),
b._receiver.onNoAdAvailable())})})},_loadScript:function(){var a=this;(function(b,c){var d=b.createElement(c),e=b.getElementsByTagName(c)[0];d.async=!0;d.src="https://static.truex.com/js/client.js";d.readyState?d.onreadystatechange=function(){if("loaded"==d.readyState||"complete"==e.readyState)d.onreadystatechange=null,a._setUpClient()}:d.onload=function(){a._setUpClient()};e.parentNode.insertBefore(d,e)})(document,"script")}}})();function GameDiscussions(a){this.initialize(a)}
GameDiscussions.prototype={initialize:function(a){this.gameUrl=a.gameUrl;this.inGuilds=a.inGuilds;this.hasGameSpecificForum=a.hasGameSpecificForum},loadForum:function(){new Ajax.Request(this.gameUrl+"/forum",{method:"get",onSuccess:function(a){$("latest_posts").update(a.responseText)}})},loadGuildForum:function(){new Ajax.Request(this.gameUrl+"/forum/guild",{method:"get",onSuccess:function(a){$("guild_posts_container").update(a.responseText).select(".game_tab_index > :first-child, .game_tab_group > :first-child").invoke("addClassName",
"active")}})},loadDiscussions:function(){this.hasGameSpecificForum&&this.loadForum();this.inGuilds&&this.loadGuildForum()},setupTabs:function(){var a=this;$$(".game_discussions .game_tab_index").each(function(b){!0!==a.inGuilds&&($(b).down(".game_tab_item",0).removeClassName("active"),$(b).down(".game_tab_item",1).addClassName("active"))});$$(".game_discussions .game_tab_group").each(function(b){!0!==a.inGuilds&&($(b).down(".tab",0).removeClassName("active"),$(b).down(".tab",1).addClassName("active"))})}};
(function(a){function b(b){if(b.valueExtensions)return!0;if(!("INPUT"===b.nodeName&&("text"===b.type||"password"===b.type)||"TEXTAREA"===b.nodeName))return!1;b.valueExtensions={current:null};if(b.constructor&&b.constructor.prototype){var c=Object.getOwnPropertyDescriptor(b.constructor.prototype,"value");Object.defineProperty(b,"value",{get:function(){return c.get.call(this)},set:function(a){b.valueExtensions.current=a;c.set.call(this,a)}})}a(b).on("propertychange",e).on("dragend",function(a){window.setTimeout(function(){e(a)},
0)});return!0}function c(){var b=h;h=[];var c,d,e,f;e=0;for(f=b.length;e<f;e+=1)c=b[e],d=c.value,c.valueExtensions.current!==d&&(c.valueExtensions.current=d,a(c).trigger("textchange"))}function d(){f&&(a(f).off(l,e),f=null)}if(void 0!==document.createElement("input").oninput&&9<(document.documentMode||100))a(document).on("input",function(b){a(b.target).trigger("textchange")});else{var e=null,f=null,h=[],l="keyup keydown",e=function(a){a=a.target;if(b(a)&&a.valueExtensions.current!==a.value){var d,
e;d=0;for(e=h.length;d<e&&h[d]!==a;d+=1);d>=e&&(h.push(a),0===e&&window.setTimeout(c,0))}};a(document).on("focusin",function(c){d();b(c.target)&&(f=c.target,a(f).on(l,e))}).on("focusout",d).on("input",e).on("selectionchange",function(a){if(document.selection){var b=document.selection.createRange();if(b&&(b=b.parentElement()))a.target=b,e(a)}})}})(jQuery);
